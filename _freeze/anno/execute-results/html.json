{
  "hash": "448c29bb1f209385c9fcb18c71546b54",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Count gene, exon, junction and SNV expression from a BAM file\nformat:\n  html:\n    code-overflow: wrap\n    include-in-header:\n      - text: |\n          <style>\n           .cell-output-stdout code {\n            word-break: break-wor !important;\n            white-space: pre-wrap !important;\n            }\n          </style>\n---\n\nThe following vignette demonstrates how to generate various feature counts from an alignment BAM file. Here we use a 10X demo data of human glioblastoma cells. The description of data can be found at <https://www.10xgenomics.com/datasets/human-glioblastoma-multiforme-3-v-3-whole-transcriptome-analysis-3-standard-4-0-0>.\n\n## Prepare the raw data and reference\n\n-   Download [alignment data (BAM)](https://cf.10xgenomics.com/samples/cell-exp/4.0.0/Parent_SC3v3_Human_Glioblastoma/Parent_SC3v3_Human_Glioblastoma_possorted_genome_bam.bam). (~14G).\n\n#### The following file is used for variant calling and allele specific gene expression. It can be skipped for alternative splicing analysis.\n- BAM Index File (for variant calling):\n[Download BAM index](https://cf.10xgenomics.com/samples/cell-exp/4.0.0/Parent_SC3v3_Human_Glioblastoma/Parent_SC3v3_Human_Glioblastoma_possorted_genome_bam.bam.bai)\n- Human Reference Databases and Gene Annotation Files:\n    - [GRCh38.p13 genome](https://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_32/GRCh38.p13.genome.fa.gz)\n    - [Gencode v44 annotation](https://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_44/gencode.v44.annotation.gtf.gz)\n\n\n## Programs we will use\n\n-   PISA (>=v1.3) (<https://github.com/shiquan/PISA>)\n-   bcftools (<https://github.com/samtools/bcftools>)\n-   samtools (<https://github.com/samtools/samtools>)\n\n## Step by step tutorial\n\n### 1. Genetic variants calling\n\n```bash\n# Unpack the FASTA file\ngzip -d GRCh38.p13.genome.fa.gz\n\n# Build the FASTA index\nsamtools faidx GRCh38.p13.genome.fa\n\n# Perform variant calling\nbcftools mpileup -Ou -f GRCh38.p13.genome.fa ./Parent_SC3v3_Human_Glioblastoma_possorted_genome_bam.bam  | bcftools call -vmO z -o var.vcf.gz\n```\n\n**Notes:**\n\n  - While several new methods for genetic variant calling have been developed, the basic principle remains the same: identifying differences between sequence reads and the reference genome. For simplicity, we are using the 'traditional' bcftools approach.\n  - There is no need to filter raw genetic variants by sequencing depth or strand bias tests. Since this is strand-specific RNA sequencing data, strand bias is expected in many cases. Instead, the feature expression matrix can be filtered by cells during downstream analysis.\n\n### 2. Annotate various features\n\nThe following command generates gene, transcript, exon, exon skipped reads, junction and genetic variant for each alignment:\n``` bash\nPISA anno -gtf gencode.v44.annotation.gtf.gz -exon -psi -vcf var.vcf.gz -ref-alt -o anno.bam Parent_SC3v3_Human_Glioblastoma_possorted_genome_bam.bam \n```\n\nThe above command will annotate genes, exons, junctions, and genetic variants all at once. However, it is also possible to annotate different features sequentially. For example, the command below produces the same results as the previous one, but allows for stepwise annotation.\n\n```bash\nPISA anno -gtf gencode.v44.annotation.gtf.gz -exon -psi -o anno1.bam Parent_SC3v3_Human_Glioblastoma_possorted_genome_bam.bam \nPISA anno -vcf var.vcf.gz -ref-alt -o anno2.bam anno1.bam\n```\n**Notes:**\n\n  - `-exon`: Generates exon and junction names.\n  - `-psi`: Generate labels for exon skipped reads, named after the skipped exons.\n  - `-ref-alt`: For genetic variants, both reference allele and alternative allele will be annotated. If not set, reference allele will be ignored. This option is important for alelle-specific gene expression.\n\nComparing raw and annotated records.\n\n::: {.cell}\n\n```{.bash .cell-code .code-overflow-wrap}\n# A original record\nsamtools view Parent_SC3v3_Human_Glioblastoma_possorted_genome_bam.bam  |head -n 3000|grep 'A00836:286:HMTMVDMXX:2:2354:8422:1391'\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\nA00836:286:HMTMVDMXX:2:2354:8422:1391\t16\tchr1\t89995\t255\t56M236N35M\t*\t0\t0\tTTGGTCTCTCTTGCTGCCCTGGAGACCAGCTGCCCCACGAAGGAACCAGAGCCAACCTGCTGCTTCCTGGAGGAAGACAGTCCCTCTGTCC\tFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF,FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF:FFFF\tNH:i:6\tHI:i:3\tAS:i:89\tnM:i:1\tRG:Z:Parent_SC3v3_Human_Glioblastoma:0:1:HMTMVDMXX:2\tTX:Z:ENST00000495576,+784,91M\tGX:Z:ENSG00000239945\tGN:Z:AL627309.3\tfx:Z:ENSG00000239945\tRE:A:E\tMM:i:1\txf:i:25\tCR:Z:AGATGAATCTACGCGG\tCY:Z:FFFFFFFFFF,FFFFF\tCB:Z:AGATGAATCTACGCGG-1\tUR:Z:TTTCATGCCTCA\tUY:Z:FFFFFFFFFFFF\tUB:Z:TTTCATGCCTCA\n```\n\n\n:::\n:::\n\n\n::: {.cell}\n\n```{.bash .cell-code}\n# the same record after annotation\nsamtools view anno.bam | head -n 3000|grep 'A00836:286:HMTMVDMXX:2:2354:8422:1391'\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\nA00836:286:HMTMVDMXX:2:2354:8422:1391\t16\tchr1\t89995\t255\t56M236N35M\t*\t0\t0\tTTGGTCTCTCTTGCTGCCCTGGAGACCAGCTGCCCCACGAAGGAACCAGAGCCAACCTGCTGCTTCCTGGAGGAAGACAGTCCCTCTGTCC\tFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF,FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF:FFFF\tNH:i:6\tHI:i:3\tAS:i:89\tnM:i:1\tRG:Z:Parent_SC3v3_Human_Glioblastoma:0:1:HMTMVDMXX:2\tfx:Z:ENSG00000239945\tMM:i:1\txf:i:25\tCR:Z:AGATGAATCTACGCGG\tCY:Z:FFFFFFFFFF,FFFFF\tCB:Z:AGATGAATCTACGCGG-1\tUR:Z:TTTCATGCCTCA\tUY:Z:FFFFFFFFFFFF\tUB:Z:TTTCATGCCTCA\tRE:A:S\tGX:Z:ENSG00000239945.1\tGN:Z:ENSG00000239945\tTX:Z:ENST00000495576.1\tEX:Z:chr1:89551-90050/-/ENSG00000239945,chr1:90287-91105/-/ENSG00000239945\tJC:Z:chr1:90050-90287/-/ENSG00000239945\tVR:Z:chr1:90040A>C/-\n```\n\n\n:::\n:::\n\n\n**Notes:**\n\n  - PISA anno generates `GN`, `TX`, `RE`, and `GX` tags when the `-gtf` option is set. Original tag values are replaced, and PISA uses a slightly different annotation strategy than CellRanger, see [details](https://shiquan.github.io/PISA.html#difference-in-alignment-annotation-between-pisa-and-cellranger) here. In the example above, the `RE` tag has been changed from `E` (exon) to `S` (spliced).\n  - When the `-exon` option is used, `EX` and `JC` tags are annotated only if the read has a `GN` tag.\n  - When the `-psi` option is used, `ER` tag is annotated, the label for ER is the exon name which indicate the read skip this exon.\n  \n### 3. Generate Cell X feature expression matrix\n\n``` bash\nmkdir exp \nmkdir exon\nmkdir exclude\nmkdir junction\nmkdir var\n\nPISA count -tags CB -anno-tag GN -umi UB -outdir exp anno.bam\nPISA count -tags CB -anno-tag EX -umi UB -outdir exon anno.bam\nPISA count -tags CB -anno-tag ER -umi UB -outdir exclude anno.bam\nPISA count -tags CB -anno-tag JC -umi UB -outdir junction anno.bam\nPISA count -tags CB -anno-tag VR -umi UB -outdir var anno.bam\n```\n\n\n**Notes:**  These commands will generate raw counts for all droplets. Although the `-list` parameter can be used to export only selected cells with `PISA anno`, cell selection may sometimes lack robustness. Therefore, it is safer to store the raw matrix file for long-term storage.\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nls exp/\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\nbarcodes.tsv.gz\nfeatures.tsv.gz\nmatrix.mtx.gz\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nzless exp/barcodes.tsv.gz|head\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTTCCACGGTTCGGCTG-1\nGTGCTTCGTAATGTGA-1\nCACAGGCAGCTGGTGA-1\nTGGCGTGGTGCAACGA-1\nATCTCTAGTCCATAGT-1\nAGCGCCACAAGCGATG-1\nCGAGTTAGTGTCGATT-1\nGTCAAGTCAGGCTCTG-1\nGGGTAGATCCCGTTGT-1\nGGGACAAAGAGGTATT-1\n```\n\n\n:::\n:::\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nzless exp/features.tsv.gz|head\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMIR1302-2HG\nENSG00000238009\nENSG00000239945\nENSG00000268903\nENSG00000241860\nWASH9P\nENSG00000228463\nENSG00000286448\nENSG00000236601\nENSG00000230021\n```\n\n\n:::\n:::\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nzless exp/matrix.mtx.gz|head\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\n%%MatrixMarket matrix coordinate integer general\n% Generated by PISA v1.6\n37716\t971962\t23795359\n1\t1\t1\n1\t2\t1\n2\t3\t1\n2\t4\t1\n2\t5\t1\n2\t6\t1\n2\t7\t1\n```\n\n\n:::\n:::\n\n\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nzless exon/features.tsv.gz|head\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\nchr1:29554-30039/+/MIR1302-2HG\nchr1:30564-30667/+/MIR1302-2HG\nchr1:89295-91629/-/ENSG00000238009\nchr1:89551-90050/-/ENSG00000239945\nchr1:90287-91105/-/ENSG00000239945\nchr1:135141-135895/-/ENSG00000268903\nchr1:141474-143011/-/ENSG00000241860\nchr1:146386-149707/-/ENSG00000241860\nchr1:142808-143011/-/ENSG00000241860\nchr1:146386-146509/-/ENSG00000241860\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nzless junction/features.tsv.gz|head\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\nchr1:30039-30564/+/MIR1302-2HG\nchr1:90050-90287/-/ENSG00000239945\nchr1:143011-146386/-/ENSG00000241860\nchr1:165942-168100/-/ENSG00000241860\nchr1:168165-168610/-/ENSG00000241860\nchr1:805891-808574/-/ENSG00000290784\nchr1:805891-808574/-/ENSG00000230092\nchr1:827775-829003/+/LINC01128\nchr1:829104-847654/+/LINC01128\nchr1:852110-852671/+/LINC01128\n```\n\n\n:::\n:::\n\n\nThe format for exon and junction names is \"chr:pos reference_allele>alternative_allele/strand\" for alternative alleles, or \"chr:pos=/strand\" for reference allele.\n\n::: {.cell}\n\n```{.bash .cell-code}\n# the format of expressed genetic variant is \nzless var/features.tsv.gz|head\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\nchr1:51716G>A/+\nchr1:90040A>C/-\nchr1:136048C>T/+\nchr1:187485G>A/-\nchr1:511685T>C/-\nchr1:511685T=/-\nchr1:629072A>G/+\nchr1:629081A>G/+\nchr1:629087A>G/+\nchr1:629087A=/+\n```\n\n\n:::\n:::\n\n**Notes:** By default, the parameters for `PISA anno` are strand-sensitive. For non-strand-sensitive libraries, such as Smartseq2, the strand should be ignored by using the `-is` option.\n\n### Questions?\nIf you have any questions regarding this workflows, please feel free to report them through the [github issues](https://github.com/shiquan/PISA/issues).\n\nIf you have any ideas or suggestions regarding PISA annotation, please refer to the [Yano discussion forum](https://github.com/shiquan/Yano/discussions). Since PISA is commonly used alongside Yano, it may not be necessary to host separate forums for each.\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}