{
  "hash": "63c38512d2bd8b6623031ca38acb67b3",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: From fastq to feature counts with PISA\ndate: 2024-07-08\n---\n\nThe following vignette demonstrates how to parse raw FASTQ files to FASTQ+ format and perform alignment, feature annotation, and counting using PISA. For simplification, we use minimap2 to align reads in this example, but other tools such as STAR can also be used.\n\n## Prepare the raw data and reference\n\n-   Download raw data: <http://cf.10xgenomics.com/samples/cell-exp/3.0.0/pbmc_1k_v3/pbmc_1k_v3_fastqs.tar> (5.2G)\n-   Download the human reference databases and gene annotation files:\n    -   <https://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_32/GRCh38.p13.genome.fa.gz>\n    -   <https://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_32/gencode.v32.annotation.gtf.gz>\n\n## The third-party programs we will use\n\n-   minimap2 (<https://github.com/lh3/minimap2>)\n-   samtools (<https://github.com/samtools/samtools>)\n\n## Step by step tutorial\n\n### 1. Parse cell barcode and UMI\n\n``` bash\n# Unpack the raw fastq\ntar xvf pbmc_1k_v3_fastqs.tar \ngzip -d GRCh38.p13.genome.fa.gz\n\n# Convert raw fastq to fastq+\nPISA parse -rule 'CB,R1:1-16;UR,R1:17-28;R1,R2' pbmc_1k_v3_fastqs/pbmc_1k_v3_S1_L001_R1_001.fastq.gz,pbmc_1k_v3_fastqs/pbmc_1k_v3_S1_L002_R1_001.fastq.gz pbmc_1k_v3_fastqs/pbmc_1k_v3_S1_L001_R2_001.fastq.gz,pbmc_1k_v3_fastqs/pbmc_1k_v3_S1_L002_R2_001.fastq.gz -nw -report fastq_qc.csv -1 reads.fq \n```\n\n\n::: {.cell}\n\n```{.bash .cell-code}\n# Check the fastq+ records\nhead reads.fq\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\n@A00228:279:HFWFVDMXX:1:1101:8486:1000|||CB:Z:NGTGATTAGCTGTACT|||UR:Z:CGTATGTAAGGT\nNACAAAGTCCCCCCCATAATACAGGGGGAGCCACTTGGGCAGGAGGCAGGGAGGGGTCCATTCCCCCTGGTGGGGCTGGTGGGGAGCTGTA\n+\n#FFFFFFFFFFFFFFF:FFFFFFF:FFFFFFFFFFFFFFFFFFFFFFFFFF:FFFFFFFFFFFFFFFF:FFFFFFFFFFFFFFFFFFFFFF\n@A00228:279:HFWFVDMXX:1:1101:10782:1000|||CB:Z:NTCATGAAGTTTGGCT|||UR:Z:AGTTATGTTCAT\nNTTGCAGCTGAACTGGTAAACTTGTCCCTAAAGAGACATAAGAATGGTCAACTGGAATGTGGATTCATCTGTAACATTACTCAGTGGGCCT\n+\n#FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF\n@A00228:279:HFWFVDMXX:1:1101:12626:1000|||CB:Z:NACCAAAAGGACATCG|||UR:Z:CGGTAGAGGCTT\nGCTCCGTAGCCCTGACTGCCTTGGTGACTGTATCCTCAGAAGAATTTGAAGACAAGTGGTTCAGAAAGATCAAAGACCATTTCTGTCCATT\n```\n\n\n:::\n:::\n\n\n::: {.cell}\n\n```{.bash .cell-code}\n# Check the report\ncat fastq_qc.csv\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNumber of Fragments,66601887\nFragments pass QC,66601887\nFragments with Exactly Matched Barcodes,0\nFragments with Failed Barcodes,0\n```\n\n\n:::\n:::\n\n\n### 2. Align reads with minimap2\n\nTo get identical results with 10X's Cell Ranger, you need use 10X's gtf to index genome and annotate BAM as they modified it from original ENSEMBL gtf.\n\n``` bash\nminimap2 -t 8 -ax splice GRCh38.p13.genome.fa reads.fq > aln.sam\n```\n\nNotice : Please do NOT use samtools view to convert the SAM to BAM. Because the barcode information still store in the read name. Using PISA sam2bam instead.\n\nFASTQ+ aligned SAM records can be look like this.\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nsamtools view aln.sam|head -n 1\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\nA00228:279:HFWFVDMXX:1:1101:8486:1000|||CB:Z:NGTGATTAGCTGTACT|||UR:Z:CGTATGTAAGGT\t0\tchr19\t12748180\t60\t1S90M\t*\t0\t0\tNACAAAGTCCCCCCCATAATACAGGGGGAGCCACTTGGGCAGGAGGCAGGGAGGGGTCCATTCCCCCTGGTGGGGCTGGTGGGGAGCTGTA\t#FFFFFFFFFFFFFFF:FFFFFFF:FFFFFFFFFFFFFFFFFFFFFFFFFF:FFFFFFFFFFFFFFFF:FFFFFFFFFFFFFFFFFFFFFF\tNM:i:0\tms:i:90\tAS:i:90\tnn:i:0\ttp:A:P\tcm:i:25\ts1:i:85\ts2:i:0\tde:f:0\trl:i:0\n```\n\n\n:::\n:::\n\n\n### 3. Convert SAM to BAM\n\nThis step will convert the SAM to BAM, while generating the summary of alignments and parse the tags from the read id to SAM optional field. If `-adjust-mapq` and `-gtf` parameters set, mapping quality of multi-reads (reads mapped to one gene region and more than one integenic region) will be adjusted.\n\n``` bash\nPISA sam2bam -report alignment_report.csv -@ 5 -adjust-mapq -gtf gencode.v32.annotation.gtf.gz -o aln.bam aln.sam\n```\n\nConverted records can be look like this.\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nsamtools view aln.bam|head -n 1\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\nA00228:279:HFWFVDMXX:1:1101:8486:1000\t0\tchr19\t12748180\t60\t1S90M\t*\t0\t0\tNACAAAGTCCCCCCCATAATACAGGGGGAGCCACTTGGGCAGGAGGCAGGGAGGGGTCCATTCCCCCTGGTGGGGCTGGTGGGGAGCTGTA\t#FFFFFFFFFFFFFFF:FFFFFFF:FFFFFFFFFFFFFFFFFFFFFFFFFF:FFFFFFFFFFFFFFFF:FFFFFFFFFFFFFFFFFFFFFF\tNM:i:0\tms:i:90\tAS:i:90\tnn:i:0\ttp:A:P\tcm:i:25\ts1:i:85\ts2:i:0\tde:f:0\trl:i:0\tCB:Z:NGTGATTAGCTGTACT\tUR:Z:CGTATGTAAGGT\n```\n\n\n:::\n:::\n\n\nAnd the summary.\n\n\n::: {.cell}\n\n```{.bash .cell-code}\ncat alignment_report.csv\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRaw reads,66601887\nMapped reads,52693779 (79.12%)\nPlus strand,29523622\nMinus strand,23170157\nMitochondria ratio,7.66%\nMapping quality corrected reads,889117\n```\n\n\n:::\n:::\n\n\n### 4. Gene annotations\n\n``` bash\nPISA anno -gtf gencode.v32.annotation.gtf.gz -o anno.bam aln.bam -t 5 -report anno.csv\n```\n\n\n::: {.cell}\n\n```{.bash .cell-code}\ncat anno.csv\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReads Mapped to Genome (Map Quality >= 0),79.1%\nReads Mapped to Exonic Regions,61.9%\nReads Mapped to Intronic Regions,24.2%\nReads Mapped to both Exonic and Intronic Regions,0.0%\nReads Mapped Antisense to Exon,1.0%\nReads Mapped Antisense to Intron,6.3%\nReads Mapped to Intergenic Regions,5.6%\nReads Mapped to Gene but Failed to Interpret Type,0.0%\nReads Mapped to Overlapped genes,1.7%\n```\n\n\n:::\n:::\n\n\n### 5. Sort BAM by genomics coordinate (Optional)\n\nA sorted and indexed BAM file can be useful for many secondary analyses, but it is not mandatory if you only need the gene expression count matrix. The annotation and expression count steps do not require a sorted BAM. However, if two similar UMIs have the same supporting reads, the first one will always be selected, and the second will be corrected during the `corr` step. If the records are not sorted, this may lead to non-robust results.\n\n``` bash\n## sambamba can also be used to sort bam for better performance. For simplication, we use samtools here.\nsamtools sort -@ 5 -o sorted.bam anno.bam\n```\n\n### 6. UMIs correction for one cell in one gene\n\n``` bash\nPISA corr -tag UR -new-tag UB -tags-block CB,GN -cr -o final.bam -@ 5 sorted.bam\n```\n\n### 7. Generate Cell X Gene expression matrix\n\n``` bash\nmkdir raw_gene_expression\nPISA count -tags CB -anno-tag GN -umi UB -outdir raw_gene_expression -@ 5 final.bam\n```\n\n`PISA count` will write the feature counts in MEX format.\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nls raw_gene_expression\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\nbarcodes.tsv.gz\nfeatures.tsv.gz\nmatrix.mtx.gz\n```\n\n\n:::\n:::\n\n\n### 8. Cell selection with DropletUtils\n\nIn the last step, we generate a raw gene expression matrix. By using R package [DropletUtils](https://bioconductor.org/packages/release/bioc/vignettes/DropletUtils/inst/doc/DropletUtils.html), we select \"valid' cell barcodes from this raw matrix and generate a filtered gene expression matrix in the end.\n\n``` r\n# load required packages\nrequire(DropletUtils)\nrequire(Yano)\n\n# Read raw MEX file into a sparse matrix\ncounts <- ReadPISA(\"raw_gene_expression/\")\n\n# Read sparse matrix as a SingleCellExperiment object\nsce <- SingleCellExperiment(list('counts' = counts))\n\n# Run barcodeRanks function from DropletUtils, see ref for details\nbr.out <- barcodeRanks(sce)\n\n# Get all barcodes above the inflection point\nfilter_bcs <- rownames(br.out)[br.out$total >metadata(br.out)$inflection]\n\n# the filer matrix\nfilter_counts <- counts[,filter_bcs]\n\n# write file to new folder in 10X format for further use\nwrite10xCounts(\"filtered_gene_expression\", filter_counts)\n```\n\n## Useful resorces\n\n-   <https://bioconductor.org/packages/release/bioc/vignettes/DropletUtils/inst/doc/DropletUtils.html>\n-   <https://support.10xgenomics.com/single-cell-gene-expression/datasets/3.0.0/pbmc_1k_v3>\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}