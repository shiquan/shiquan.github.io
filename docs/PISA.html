<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.53">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>PISA User Guide</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="index.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
          <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Overview</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./fastq.html"> 
<span class="menu-text">FASTQ+</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./PISA.html" aria-current="page"> 
<span class="menu-text">PISA</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Yano.html"> 
<span class="menu-text">Yano</span></a>
  </li>  
</ul>
          <div class="quarto-navbar-tools">
    <div class="dropdown">
      <a href="" title="GitHub" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="GitHub"><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/shiquan">
            My GitHub Page
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/shiquan/Yano/discussions">
            Discussions
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
            <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content column-page" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">PISA User Guide</h1>
</div>



<div class="quarto-title-meta column-page">

    
  
    
  </div>
  


</header>


<h2 id="synopsis" class="anchored">Synopsis</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PISA</span> <span class="pp">[</span><span class="ss">tool</span><span class="pp">]</span> <span class="pp">[</span><span class="ss">options</span><span class="pp">]</span> <span class="pp">[</span><span class="ss">input</span><span class="pp">-</span><span class="ss">file</span><span class="pp">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h2 id="install" class="anchored">Install</h2>
<p>PISA source code can be downloaded at <a href="https://github.com/shiquan/PISA/releases" class="uri">https://github.com/shiquan/PISA/releases</a>, or the development version from <a href="https://github.com/shiquan/PISA/" class="uri">https://github.com/shiquan/PISA/</a>. To compile PISA from sources run <strong>make</strong> in the source directory.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git clone https://github.com/shiquan/PISA</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd PISA</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> make</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h2 id="get-started" class="anchored">Get Started</h2>
<p>The code snippet below demonstrates how to use the PISA tools to process test data and generate various feature counts. You can find the test data in the PISA/demo directory. This example provides a practical approach to familiarize yourself with the functionality of PISA and to validate its operations with provided sample data.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd demo</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="ex">aln.sam.gz</span>  barcodes.txt  demo_1.fq.gz  demo_2.fq.gz  demo.gtf.gz  peaks.bed  README.md  var.vcf.gz</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> zcat demo_1.fq.gz<span class="kw">|</span><span class="fu">head</span> <span class="at">-n</span> 4</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="ex">@A00984:220:HNJ7KDRXX:1:1118:2510:4586</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="ex">AAGCATCCACACAGAGCACCCCGTTCTT</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="ex">FFFFFFFFFFFFFFFFFFFFFFFFFFFF</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> zcat demo_2.fq.gz<span class="kw">|</span><span class="fu">head</span> <span class="at">-n</span> 4</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="ex">@A00984:220:HNJ7KDRXX:1:1118:2510:4586</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="ex">GCAGTGGTATCAACGCAGAGTACATGGGGAGCCTCATTGCCCAGCGGACCCCAGCCTCTGCCAGGTTCGGTCCGCCATCCTCGTCCCGTCC</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="ex">FFFFF:FFFFFF:FFFFFFFFFF,FFFFFFFFF:FFFFFFFFF,FFFF:FFF,FFFFF:FFF:FFFFFFFFFFFFFFFFFFFF:FFFFFFF</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert raw FASTQ to FASTQ+ format</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA parse <span class="at">-rule</span> <span class="st">'CR,R1:1-16,barcodes.txt,CB,1;UR,R1:17-28;R1,R2'</span> demo_1.fq.gz demo_2.fq.gz <span class="at">-1</span> demo.fq</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="ex">Number</span> of Fragments,825</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="ex">Fragments</span> pass QC,825</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="ex">Fragments</span> with Exactly Matched Barcodes,805</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="ex">Fragments</span> with Failed Barcodes,0</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 12:21:35] Real time: 0.003 sec<span class="kw">;</span> <span class="ex">CPU:</span> 0.009 sec<span class="kw">;</span> <span class="ex">Peak</span> RSS: 0.010 GB.</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> head <span class="at">-n</span> 4 demo.fq</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="ex">@A00984:220:HNJ7KDRXX:1:1118:2510:4586</span><span class="kw">|||</span><span class="ex">CR:Z:AAGCATCCACACAGAG</span><span class="kw">|||</span><span class="ex">CB:Z:AAGCATCCACACAGAG</span><span class="kw">|||</span><span class="ex">UR:Z:CACCCCGTTCTT</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="ex">GCAGTGGTATCAACGCAGAGTACATGGGGAGCCTCATTGCCCAGCGGACCCCAGCCTCTGCCAGGTTCGGTCCGCCATCCTCGTCCCGTCC</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="ex">FFFFF:FFFFFF:FFFFFFFFFF,FFFFFFFFF:FFFFFFFFF,FFFF:FFF,FFFFF:FFF:FFFFFFFFFFFFFFFFFFFF:FFFFFFF</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Alignment results of FASTQ+ </span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> samtools view aln.sam.gz<span class="kw">|</span><span class="fu">head</span> <span class="at">-n</span> 1</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="ex">A00984:220:HNJ7KDRXX:1:1118:2510:4586</span><span class="kw">|||</span><span class="ex">CR:Z:AAGCATCCACACAGAG</span><span class="kw">|||</span><span class="ex">CB:Z:AAGCATCCACACAGAG</span><span class="kw">|||</span><span class="ex">UR:Z:CACCCCGTTCTT</span>   0   chr11   35139165    255 26S65M  <span class="pp">*</span>   0   0   GCAGTGGTATCAACGCAGAGTACATGGGGAGCCTCATTGCCCAGCGGACCCCAGCCTCTGCCAGGTTCGGTCCGCCATCCTCGTCCCGTCC FFFFF:FFFFFF:FFFFFFFFFF,FFFFFFFFF:FFFFFFFFF,FFFF:FFF,FFFFF:FFF:FFFFFFFFFFFFFFFFFFFF:FFFFFFF NH:i:1  HI:i:1  AS:i:61 nM:i:1</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert format alignment records from SAM to BAM</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA sam2bam aln.sam.gz <span class="at">-o</span> aln.bam</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="ex">Raw</span> reads,825</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="ex">Mapped</span> reads,820 <span class="er">(</span><span class="ex">99.39%</span><span class="kw">)</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="ex">Plus</span> strand,820</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="ex">Minus</span> strand,0</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="ex">Mitochondria</span> ratio,0.00%</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 12:26:31] Real time: 0.005 sec<span class="kw">;</span> <span class="ex">CPU:</span> 0.009 sec<span class="kw">;</span> <span class="ex">Peak</span> RSS: 0.010 GB.</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> samtools view aln.bam<span class="kw">|</span><span class="fu">head</span> <span class="at">-n</span> 1</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="ex">A00984:220:HNJ7KDRXX:1:1118:2510:4586</span>   0   chr11   35139165    255 26S65M  <span class="pp">*</span>   0   0   GCAGTGGTATCAACGCAGAGTACATGGGGAGCCTCATTGCCCAGCGGACCCCAGCCTCTGCCAGGTTCGGTCCGCCATCCTCGTCCCGTCC FFFFF:FFFFFF:FFFFFFFFFF,FFFFFFFFF:FFFFFFFFF,FFFF:FFF,FFFFF:FFF:FFFFFFFFFFFFFFFFFFFF:FFFFFFF NH:i:1  HI:i:1  AS:i:61 nM:i:1  CR:Z:AAGCATCCACACAGAG   CB:Z:AAGCATCCACACAGAG   UR:Z:CACCCCGTTCTT</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Annotate gene names for BAM</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA anno <span class="at">-gtf</span> ./demo.gtf.gz aln.bam <span class="at">-o</span> anno_gtf.bam</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 12:28:38] GTF loading..</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 12:28:38] Load 2 genes.</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 12:28:38] Load time : 0.003 sec</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="ex">Reads</span> Mapped to Genome <span class="er">(</span><span class="ex">Map</span> Quality <span class="op">&gt;</span>= 0<span class="kw">)</span><span class="ex">,99.4%</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a><span class="ex">Reads</span> Mapped to Exonic Regions,99.3%</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a><span class="ex">Reads</span> Mapped to Intronic Regions,0.0%</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a><span class="ex">Reads</span> Mapped to both Exonic and Intronic Regions,0.7%</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="ex">Reads</span> Mapped Antisense to Gene,0.0%</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a><span class="ex">Reads</span> Mapped to Intergenic Regions,0.0%</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a><span class="ex">Reads</span> Mapped to Gene but Failed to Interpret Type,0.0%</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 12:28:38] Real time: 0.026 sec<span class="kw">;</span> <span class="ex">CPU:</span> 0.086 sec<span class="kw">;</span> <span class="ex">Speed</span> : 9528 records/sec<span class="kw">;</span> <span class="ex">Peak</span> RSS: 0.034 GB.</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Correct UMIs amongst other UMIs from the same cell and mapped to the same gene, and create new tag UB for corrected UMIs</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA corr <span class="at">-tag</span> UR <span class="at">-new-tag</span> UB <span class="at">-tags-block</span> CB,GN anno_gtf.bam <span class="at">-o</span> corr.bam</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 12:36:21] Building index ..</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 12:36:21] Build time : 0.002 sec</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 12:36:21] Real time: 0.077 sec<span class="kw">;</span> <span class="ex">CPU:</span> 0.085 sec</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> samtools view corr.bam<span class="kw">|</span><span class="fu">head</span> <span class="at">-n</span> 1</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a><span class="ex">A00984:220:HNJ7KDRXX:1:1118:2510:4586</span>   0   chr11   35139165    255 26S65M  <span class="pp">*</span>   0   0   GCAGTGGTATCAACGCAGAGTACATGGGGAGCCTCATTGCCCAGCGGACCCCAGCCTCTGCCAGGTTCGGTCCGCCATCCTCGTCCCGTCC FFFFF:FFFFFF:FFFFFFFFFF,FFFFFFFFF:FFFFFFFFF,FFFF:FFF,FFFFF:FFF:FFFFFFFFFFFFFFFFFFFF:FFFFFFF NH:i:1  HI:i:1  AS:i:61 nM:i:1  CR:Z:AAGCATCCACACAGAG   CB:Z:AAGCATCCACACAGAG   UR:Z:CACCCCGTTCTT   RE:A:E  GX:Z:ENSG00000026508.18 GN:Z:CD44   TX:Z:ENST00000263398.10,ENST00000428726.7,ENST00000526025.2 UB:Z:CACCCCGTTCTT</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Count gene X cell features</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mkdir exp</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA count  <span class="at">-cb</span> CB <span class="at">-anno-tag</span> GN <span class="at">-outdir</span> exp <span class="at">-umi</span> UB corr.bam </span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 12:38:44] Real time: 0.033 sec<span class="kw">;</span> <span class="ex">CPU:</span> 0.013 sec<span class="kw">;</span> <span class="ex">Peak</span> RSS: 0.010 GB.</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Gene expression matrix generated in the Market Exchange format </span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls exp/</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a><span class="ex">barcodes.tsv.gz</span>  features.tsv.gz  matrix.mtx.gz</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Not just gene features, we can also annotate variants and functional regions to reads</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA anno <span class="at">-bed</span> peaks.bed <span class="at">-tag</span> PK <span class="at">-vcf</span> var.vcf.gz <span class="at">-vtag</span> VR  corr.bam <span class="at">-o</span> anno_vcf_bed.bam    </span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a><span class="ex">Reads</span> Mapped to Genome <span class="er">(</span><span class="ex">Map</span> Quality <span class="op">&gt;</span>= 0<span class="kw">)</span><span class="ex">,99.4%</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a><span class="ex">Reads</span> Mapped to BED regions / Peaks,0.0%</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 12:43:01] Real time: 0.027 sec<span class="kw">;</span> <span class="ex">CPU:</span> 0.090 sec<span class="kw">;</span> <span class="ex">Speed</span> : 9085 records/sec<span class="kw">;</span> <span class="ex">Peak</span> RSS: 0.034 GB.</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> samtools view anno_vcf_bed.bam<span class="kw">|</span><span class="fu">grep</span> <span class="st">"VR:Z"</span><span class="kw">|</span><span class="fu">grep</span> <span class="st">"PK:Z"</span><span class="kw">|</span><span class="fu">head</span> <span class="at">-n</span> 1</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a><span class="ex">A00984:220:HNJ7KDRXX:1:2266:27597:30843</span> 0   chr11   35229688    255 91M <span class="pp">*</span>   0   0   CCCAGGGTTAATAGGGCCTGGTCCCTGGGAGGAAATTTGAATGGGTCCATTTTGCCCTTCCATAGCCTAATCCCGGGGCATTGTTTTCCAC</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a><span class="ex">FFFF,FFFFFFFFFF,FFFFFFF:,:FFFFFF,FF:FFFFFFFFFFF:,,:F:F:F,F:F:F,FFFF,F:FFFF,FF,FF:FFFFFFF:F:</span> NH:i:1  HI:i:1  AS:i:85 nM:i:2  CR:Z:ATTGTTCCAAGTCCCG   CB:Z:ATTGTTCCAAGTCCCG   UR:Z:TCTTTAAGTCAG   RE:A:E  GX:Z:ENSG00000026508.18 GN:Z:CD44   TX:Z:ENST00000263398.10,ENST00000428726.7,ENST00000425428.6,ENST00000433892.6,ENST00000525469.1 UB:Z:TCTTTAAGTCAG   PK:Z:demo_peak_14a<span class="kw">;</span><span class="ex">demo_peak_14b</span>    VR:Z:chr11:35229771C<span class="op">&gt;</span>T</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the reads, UMIs, genes, peaks, and variants per cell</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA attrcnt <span class="at">-cb</span> CB <span class="at">-tags</span> UB,GN,PK,VR anno_vcf_bed.bam <span class="at">-dedup</span> <span class="kw">|</span><span class="fu">head</span> <span class="at">-n</span> 5</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a><span class="ex">BARCODE</span> Raw UB  GN  PK  VR</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a><span class="ex">AAGCATCCACACAGAG</span>    503 132 1   15  1</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a><span class="ex">ATTGTTCCAAGTCCCG</span>    533 124 1   13  1</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a><span class="ex">AAGCATCCACACNGAG</span>    3   1   1   1   0</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a><span class="ex">AAGCNTCCACACAGAG</span>    3   1   1   1   0</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a><span class="co"># Deduplicate BAM file for each cell</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA rmdup <span class="at">-tags</span> CB corr.bam <span class="at">-o</span> rmdup.bam <span class="at">-nw</span> </span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 12:59:39] Deduplicating chr11</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 12:59:39] All reads,820</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 12:59:39] Duplicate reads,125</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 12:59:39] Duplicate ratio,0.1524</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 12:59:39] Real time: 0.008 sec<span class="kw">;</span> <span class="ex">CPU:</span> 0.015 sec<span class="kw">;</span> <span class="ex">Peak</span> RSS: 0.010 GB.</span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Deduplicate BAM file for each molecular</span></span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA rmdup <span class="at">-tags</span> CB,UR corr.bam <span class="at">-o</span> rmdup1.bam <span class="at">-nw</span></span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 13:00:35] Deduplicating chr11</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 13:00:35] All reads,820</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 13:00:35] Duplicate reads,0</span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 13:00:35] Duplicate ratio,0.0000</span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 13:00:35] Real time: 0.009 sec<span class="kw">;</span> <span class="ex">CPU:</span> 0.015 sec<span class="kw">;</span> <span class="ex">Peak</span> RSS: 0.011 GB.</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Select all reads annotated to gene CD44</span></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a gene candidate list</span></span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span>  echo <span class="st">"CD44"</span> <span class="op">&gt;</span> gene.txt</span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA pick <span class="at">-tags</span> GN <span class="at">-list</span> gene.txt anno_vcf_bed.bam  <span class="at">-o</span> picked.bam</span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 13:03:01] Real time: 0.009 sec<span class="kw">;</span> <span class="ex">CPU:</span> 0.016 sec</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a><span class="co"># Select reads with more features</span></span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> awk <span class="st">'{printf("%s\tCD44\n", $1)}'</span> barcodes.txt <span class="op">&gt;</span> candidates.txt</span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat candidates.txt </span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a><span class="ex">AAGCATCCACACAGAG</span>    CD44</span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a><span class="ex">ATTGTTCCAAGTCCCG</span>    CD44</span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a><span class="ex">GCACATAGTCAGTTTG</span>    CD44</span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA pick <span class="at">-tags</span> CB,GN <span class="at">-list</span> candidates.txt anno_vcf_bed.bam <span class="at">-o</span> picked.bam </span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 13:09:28] Real time: 0.007 sec<span class="kw">;</span> <span class="ex">CPU:</span> 0.013 sec</span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert BAM to FASTQ+</span></span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA bam2fq <span class="at">-tags</span> CB,GN picked.bam <span class="at">-o</span> pick.fq</span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> head <span class="at">-n</span> 4 pick.fq </span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a><span class="ex">@A00984:220:HNJ7KDRXX:1:1118:2510:4586</span><span class="kw">|||</span><span class="ex">CB:Z:AAGCATCCACACAGAG</span><span class="kw">|||</span><span class="ex">GN:Z:CD44</span></span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a><span class="ex">GCAGTGGTATCAACGCAGAGTACATGGGGAGCCTCATTGCCCAGCGGACCCCAGCCTCTGCCAGGTTCGGTCCGCCATCCTCGTCCCGTCC</span></span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span></span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a><span class="ex">FFFFF:FFFFFF:FFFFFFFFFF,FFFFFFFFF:FFFFFFFFF,FFFF:FFF,FFFFF:FFF:FFFFFFFFFFFFFFFFFFFF:FFFFFFF</span></span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort FASTQ+ reads by CB and GN</span></span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA fsort <span class="at">-tags</span> CB,GN pick.fq <span class="at">-o</span> fsort.fq.gz</span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 13:22:50] Write 795 records to fsort.fq.gz.0000.bgz.</span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 13:22:50] Unlink fsort.fq.gz.0000.bgz</span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 13:22:50] Create fsort.fq.gz from 1 files.</span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 13:22:50] Real time: 0.021 sec<span class="kw">;</span> <span class="ex">CPU:</span> 0.020 sec</span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> zcat fsort.fq.gz<span class="kw">|</span><span class="fu">head</span> <span class="at">-n</span> 8</span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a><span class="ex">@A00984:220:HNJ7KDRXX:1:1118:2510:4586</span><span class="kw">|||</span><span class="ex">CB:Z:AAGCATCCACACAGAG</span><span class="kw">|||</span><span class="ex">GN:Z:CD44</span></span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a><span class="ex">GCAGTGGTATCAACGCAGAGTACATGGGGAGCCTCATTGCCCAGCGGACCCCAGCCTCTGCCAGGTTCGGTCCGCCATCCTCGTCCCGTCC</span></span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span></span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a><span class="ex">FFFFF:FFFFFF:FFFFFFFFFF,FFFFFFFFF:FFFFFFFFF,FFFF:FFF,FFFFF:FFF:FFFFFFFFFFFFFFFFFFFF:FFFFFFF</span></span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a><span class="ex">@A00984:220:HNJ7KDRXX:1:2143:21640:21496</span><span class="kw">|||</span><span class="ex">CB:Z:AAGCATCCACACAGAG</span><span class="kw">|||</span><span class="ex">GN:Z:CD44</span></span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a><span class="ex">CCTGCCCCGCGCCCAGAGATCCTCCAGCTCCTTTCGCCCGCGCCCTACGTTCGCTCCGGACACCATGGACAAGTATTGGTGGAACACAGCC</span></span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span></span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a><span class="ex">,,FFFFFFFF,F,,:F,F,F:FFF,FFFFFF,F::F,FF,F:FF:,,FF:FFF,:FFFF:FFF,::FFFF,F:F,FFFF,,F,FFF,F,::</span></span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a><span class="co"># Assembly reads mapped to CD44 of the same cell into contigs</span></span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a><span class="co"># This step requires Trinity software and seqtk already installed in your environment</span></span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA stream <span class="at">-tags</span> CB,GN <span class="at">-script</span> <span class="st">'Trinity --seqType fq --SS_lib_type F --single ${FQ} --max_memory 1G 2&gt;/dev/null 1&gt;/dev/null; seqtk rename trinity_out_dir.Trinity.fasta ${UBI}_ 2&gt;/dev/null'</span> <span class="at">-t</span> 10 <span class="at">-fa</span>  <span class="at">-nw</span> ./fsort.fq.gz <span class="at">-o</span> assem.fa</span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 13:24:21] Real time: 5.607 sec<span class="kw">;</span> <span class="ex">CPU:</span> 0.010 sec<span class="kw">;</span> <span class="ex">Peak</span> RSS: 0.010 GB.</span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> seqtk seq assem.fa <span class="at">-l</span> 100 <span class="kw">|</span><span class="fu">head</span> </span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span>Z_AAGCATCCACACAGAG_Z_CD44_1<span class="kw">|||</span><span class="ex">CB:Z:AAGCATCCACACAGAG</span><span class="kw">|||</span><span class="ex">GN:Z:CD44</span> len=439 path=<span class="pp">[</span><span class="ss">0:0</span><span class="pp">-</span><span class="ss">438</span><span class="pp">]</span></span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a><span class="ex">GAAATTAGGGCCCAATTAATAATCAGCAAGAATTTGATCGTTCCAGTTCCCACTTGGAGGCCTTTCATCCCTCGGGTGTGCTATGGATGGCTTCTAACAA</span></span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a><span class="ex">AAACTACACATATGTATTCCTGATCGCCAACCTTTCCCCCACCAGCTAAGGACATTTCCCAGGGTTAATAGGGCCTGGTCCCTGGGAGGAAATTTGAATG</span></span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a><span class="ex">GGTCCATTTTGCCCTTCCATAGCCTAATCCCTGGGCATTGTTTTCCACTGAGGTTGGGGGTTGGGGTGTACTAGTTACACATCTTCAACAGACCCCCTCT</span></span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a><span class="ex">AGAAATTTTTCAGATGCTTCTGGGAGACACCCAAAGGGTGAAGCTATTTATCTGTAGTAAACTATTTATCTGTGTTTTTGAAATATTAAACCCTGGATCA</span></span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a><span class="ex">GTCCTTTGATCAGTATAATTTTTTAAAGTTACTTTGTCA</span></span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span>Z_AAGCATCCACACAGAG_Z_CD44_2<span class="kw">|||</span><span class="ex">CB:Z:AAGCATCCACACAGAG</span><span class="kw">|||</span><span class="ex">GN:Z:CD44</span> len=384 path=<span class="pp">[</span><span class="ss">0:0</span><span class="pp">-</span><span class="ss">383</span><span class="pp">]</span></span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a><span class="ex">CCTGGTAGAATTGGCTTTTCTAGCAGAACCTTTCCAAAAGTTTTATATTGAGATTCATAACAACACCAAGAATTGATTTTGTAGCCAACATTCATTCAAT</span></span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a><span class="ex">ACTGTTATATCAGAGGAGTAGGAGAGAGGAAACATTTGACTTATCTGGAAAAGCAAAATGTACTTAAGAATAAGAATAACATGGTCCATTCACCTTTATG</span></span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a><span class="ex">TTATAGATATGTCTTTGTGTAAATCATTTGTTTTGAGTTTTCAAAGAATAGCCCATTGTTCATTCTTGTGCTGTACAATGACCACTGTTATTGTTACTTT</span></span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a><span class="co"># Align assembled reads to reference and convert to BAM file</span></span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a><span class="co"># Here I use minimap2 for simplicity</span></span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> minimap2 <span class="at">-x</span> splice <span class="at">-a</span> ~/Documents/datasets/GRCh38/fasta/genome.fasta assem.fa <span class="dv">1</span><span class="op">&gt;</span> asm_aln.sam</span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a><span class="ex">[M::mm_idx_gen::50.495*1.81]</span> collected minimizers</span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a><span class="ex">[M::mm_idx_gen::71.980*2.16]</span> sorted minimizers</span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a><span class="ex">[M::main::71.980*2.16]</span> loaded/built the index for 194 target sequence<span class="er">(</span><span class="ex">s</span><span class="kw">)</span></span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a><span class="ex">[M::mm_mapopt_update::75.057*2.11]</span> mid_occ = 767</span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a><span class="ex">[M::mm_idx_stat]</span> kmer size: 15<span class="kw">;</span> <span class="ex">skip:</span> 5<span class="kw">;</span> <span class="ex">is_hpc:</span> 0<span class="kw">;</span> <span class="co">#seq: 194</span></span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a><span class="ex">[M::mm_idx_stat::77.004*2.09]</span> distinct minimizers: 167225302 <span class="er">(</span><span class="ex">35.42%</span> are singletons<span class="kw">);</span> <span class="ex">average</span> occurrences: 6.036<span class="kw">;</span> <span class="ex">average</span> spacing: 3.071<span class="kw">;</span> <span class="ex">total</span> length: 3099750718</span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a><span class="ex">[M::worker_pipeline::77.010*2.09]</span> mapped 13 sequences</span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a><span class="ex">[M::main]</span> Version: 2.21-r1071</span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a><span class="ex">[M::main]</span> CMD: minimap2 <span class="at">-x</span> splice <span class="at">-a</span> /home/shiquan/Documents/datasets/GRCh38/fasta/genome.fasta assem.fa</span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a><span class="ex">[M::main]</span> Real time: 77.358 sec<span class="kw">;</span> <span class="ex">CPU:</span> 161.000 sec<span class="kw">;</span> <span class="ex">Peak</span> RSS: 18.519 GB</span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA sam2bam asm_aln.sam <span class="at">-o</span> asm_aln.bam</span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true" tabindex="-1"></a><span class="ex">Raw</span> reads,13</span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true" tabindex="-1"></a><span class="ex">Mapped</span> reads,13 <span class="er">(</span><span class="ex">100.00%</span><span class="kw">)</span></span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true" tabindex="-1"></a><span class="ex">Plus</span> strand,13</span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true" tabindex="-1"></a><span class="ex">Minus</span> strand,0</span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true" tabindex="-1"></a><span class="ex">Mitochondria</span> ratio,0.00%</span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true" tabindex="-1"></a><span class="ex">[2022-04-22</span> 13:30:20] Real time: 0.001 sec<span class="kw">;</span> <span class="ex">CPU:</span> 0.006 sec<span class="kw">;</span> <span class="ex">Peak</span> RSS: 0.010 GB.</span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> samtools view asm_aln.bam<span class="kw">|</span><span class="fu">head</span> <span class="at">-n</span> 1</span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true" tabindex="-1"></a><span class="ex">Z_AAGCATCCACACAGAG_Z_CD44_1</span> 0   chr11   35229531    60  439M    <span class="pp">*</span>   0   0   GAAATTAGGGCCCAATTAATAATCAGCAAGAATTTGATCGTTCCAGTTCCCACTTGGAGGCCTTTCATCCCTCGGGTGTGCTATGGATGGCTTCTAACAA</span>
<span id="cb3-200"><a href="#cb3-200" aria-hidden="true" tabindex="-1"></a><span class="ex">AAACTACACATATGTATTCCTGATCGCCAACCTTTCCCCCACCAGCTAAGGACATTTCCCAGGGTTAATAGGGCCTGGTCCCTGGGAGGAAATTTGAATG</span></span>
<span id="cb3-201"><a href="#cb3-201" aria-hidden="true" tabindex="-1"></a><span class="ex">GGTCCATTTTGCCCTTCCATAGCCTAATCCCTGGGCATTGTTTTCCACTGAGGTTGGGGGTTGGGGTGTACTAGTTACACATCTTCAACAGACCCCCTCT</span></span>
<span id="cb3-202"><a href="#cb3-202" aria-hidden="true" tabindex="-1"></a><span class="ex">AGAAATTTTTCAGATGCTTCTGGGAGACACCCAAAGGGTGAAGCTATTTATCTGTAGTAAACTATTTATCTGTGTTTTTGAAATATTAAACCCTGGATCA</span></span>
<span id="cb3-203"><a href="#cb3-203" aria-hidden="true" tabindex="-1"></a><span class="ex">GTCCTTTGATCAGTATAATTTTTTAAAGTTACTTTGTCA</span> <span class="pp">*</span>   NM:i:1  ms:i:436    AS:i:436    nn:i:0  tp:A:P  cm:i:137    s1:i:430    s2:i:0  de:f:0.0023 rl:i:0  CB:Z:AAGCATCCACACAGAG   GN:Z:CD44</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h2 id="list-of-commands" class="anchored">List of commands</h2>
<table class="table-striped table-hover caption-top table">
<colgroup>
<col style="width: 23%">
<col style="width: 76%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Tool</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;"><strong><em>The following tools are used to process FASTQ/FASTQ+ files.</em></strong></td>
</tr>
<tr class="even">
<td style="text-align: left;">parse</td>
<td style="text-align: left;">Parse barcodes from FASTQ reads to FASTQ+.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fsort</td>
<td style="text-align: left;">Sort FASTQ+ records by barcodes.</td>
</tr>
<tr class="even">
<td style="text-align: left;">stream</td>
<td style="text-align: left;">Perform user-defined process for each read block.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">addtags</td>
<td style="text-align: left;">Add tag string to FASTQ reads.</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;"><strong><em>The following tools are used to process BAM files.</em></strong></td>
</tr>
<tr class="odd">
<td style="text-align: left;">sam2bam</td>
<td style="text-align: left;">Parse FASTQ+ read name and convert SAM to BAM.</td>
</tr>
<tr class="even">
<td style="text-align: left;">rmdup</td>
<td style="text-align: left;">Remove PCR duplicates per molecular.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pick</td>
<td style="text-align: left;">Pick alignments with tags.</td>
</tr>
<tr class="even">
<td style="text-align: left;">anno</td>
<td style="text-align: left;">Annotate functional regions or gene names.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">corr</td>
<td style="text-align: left;">Correct error prone UMIs. 1 mismatch considered.</td>
</tr>
<tr class="even">
<td style="text-align: left;">attrcnt</td>
<td style="text-align: left;">Count raw reads and tag values per cell.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">extract</td>
<td style="text-align: left;">Extract tag value from BAM.</td>
</tr>
<tr class="even">
<td style="text-align: left;">count</td>
<td style="text-align: left;">Count feature X cell matrix from BAMs.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bam2fq</td>
<td style="text-align: left;">Convert BAM to FASTQ+ file with selected tags.</td>
</tr>
<tr class="even">
<td style="text-align: left;">bam2frag</td>
<td style="text-align: left;">Generate fragment file.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">depth</td>
<td style="text-align: left;">Coverage depth/UMI for target regions.</td>
</tr>
<tr class="even">
<td style="text-align: left;">addtags</td>
<td style="text-align: left;">Add tag string to BAM alignments.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">callept</td>
<td style="text-align: left;">Call expressed peak tags (EPTs) for RNA library.</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;"><strong><em>The following tool used to process fragment file.</em></strong></td>
</tr>
<tr class="odd">
<td style="text-align: left;">count2</td>
<td style="text-align: left;">Count peak X cell matrix from fragment file.</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;"><strong><em>The following tools used to process BED files.</em></strong></td>
</tr>
<tr class="odd">
<td style="text-align: left;">mergebed</td>
<td style="text-align: left;">Merge BED files.</td>
</tr>
<tr class="even">
<td style="text-align: left;">annobed</td>
<td style="text-align: left;">Annotate BED files with genes and functional elements.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">flatten</td>
<td style="text-align: left;">Flatten overlapped regions to nonoverlaps.</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;"><strong><em>The following tools used to process GTF files.</em></strong></td>
</tr>
<tr class="odd">
<td style="text-align: left;">gtffmt</td>
<td style="text-align: left;">Format and reorder GTF file.</td>
</tr>
<tr class="even">
<td style="text-align: left;">gtf2bed</td>
<td style="text-align: left;">Convert GTF to BED.</td>
</tr>
</tbody>
</table>
<h2 id="commands-and-options" class="anchored">Commands and options</h2>
<h3 id="common-options-for-all-tools" class="anchored">Common options for all tools</h3>
<dl>
<dt>
<strong>-h</strong>
</dt>
<dd>
Help information
</dd>
<dt>
<strong>-o</strong> <em>FILE</em>
</dt>
<dd>
Output file.
</dd>
<dt>
<strong>-tags</strong> <em>tag(s)</em>
</dt>
<dd>
Barcode tags to group reads, usually be cell barcode tag.
</dd>
<dt>
<strong>-umi</strong> <em>tag</em>
</dt>
<dd>
UMI tag.
</dd>
<dt>
<strong>-t/-@</strong> <em>number</em>
</dt>
<dd>
Multithreads to process data.
</dd>
<dt>
<strong>-report</strong> <em>FILE.csv</em>
</dt>
<dd>
Summary report in csv format.
</dd>
</dl>
<h3 id="parse" class="anchored">parse</h3>
<p>The parse tool is specifically designed to convert FASTQ files into the extended FASTQ+ format. It utilizes the -rule option to define the library structure, accommodating various sequencing setups. For ease of use, this tool has included predefined common library structures in the release; these can be applied using the -x option. This tool is optimized for speed and supports the correction of barcodes that have up to one mismatch.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parse cell barcode and UMI string from raw FASTQ.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA parse <span class="at">-rule</span> CB,R1:1-10,whitelist.txt,CB,1<span class="kw">;</span><span class="ex">R1,R1:11-60</span><span class="kw">;</span><span class="ex">R2,R2</span> <span class="at">-report</span> fastq.csv lane1_1.fq.gz,lane02_1.fq.gz lane1_2.fq.gz,lane2_2.fq.gz</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> :</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-1</span>       <span class="pp">[</span><span class="ss">fastq</span><span class="pp">]</span>   Read 1 output.</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">-2</span>       <span class="pp">[</span><span class="ss">fastq</span><span class="pp">]</span>   Read 2 output.</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">-rule</span>    <span class="pp">[</span><span class="ss">STRING</span><span class="pp">]</span>  Read structure in line. See Notice.</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">-p</span>                 Read 1 and read 2 interleaved in the input file.</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">-q</span>       <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>     Drop reads if average sequencing quality below this value.</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">-dropN</span>             Drop reads if N base in sequence or barcode.</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">-report</span>  <span class="pp">[</span><span class="ss">csv</span><span class="pp">]</span>     Summary report.</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">-t</span>       <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>     Threads. <span class="pp">[</span><span class="ss">4</span><span class="pp">]</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">-order</span>             Keep input order.</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a> <span class="ex">-x</span>                 Predefined code for specific library.</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>          <span class="ex">*</span> C4      Library structure for DNBelab C4 RNA kit v1.</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="ex">Notice</span> :</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> <span class="at">-rule</span> accept tag rule STRING to parse input fastq following format <span class="st">"TAG,location,whitelist,corrected TAG,allow mismatch"</span>.</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>   <span class="ex">For</span> each tag rule, location part should be format like R<span class="pp">[</span><span class="ss">12</span><span class="pp">]</span>:start-end. Both start and end location start from 1.</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>   <span class="ex">TAG</span> and locaion parts are mandatory, and whitelist, corrected TAG and mismatch are optional.</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Futhermore,</span> multiply tags seperated by <span class="st">';'</span>. In location part, R1 stands for raw read 1, R2 stands for raw read 2.</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>   <span class="ex">In</span> tag part, R1 stands for output read 1 while R2 stands for output read 2. Here are some examples.</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA parse <span class="at">-rule</span> <span class="st">'CR,R1:1-18,barcodes.txt,CB,1;UR,R1:19-30;R1,R2:1-100'</span> <span class="at">-1</span> read_1.fq raw_read_1.fq raw_read_2.fq</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co"># CR,R1:1-18,barcodes.txt,CB,1  - CR tag start from 1 to 18 in read 1, and barcodes.txt are barcode whitelist,</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="co">#   each barcode per line. Cell barcode will be corrected while hamming distance &lt;= 1.</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co">#   Corrected cell barcode tag is CB. </span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co"># UR,R1:19-30 - UR tag start from 19-30 in read 1.</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co"># R1,R2:1-100 - Sequence from 1 to 100 in read 2 output to read 1 file. </span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA parse <span class="at">-rule</span> <span class="st">'CR,R1:1-10,bc1.txt,CB,1;CR,R1:11-20,bc2.txt,CB,1;R1,R2:1-100'</span> <span class="at">-1</span> read_1.fq raw_read_1.fq raw_read_2.fq</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="co"># CR,R1:1-10,bc1.txt,CB,1;CR,R1:11-20,bc2.txt,CB,1 - This cell barcode consist of two segments, first segment start</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="co">#   from 1 to 10 in read 1, and whitelist is bc1.txt, and second segment start from 11 to 20, and whitelist is bc2.txt.</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="co">#   These two segments will be combined after correction, because the corrected tag are the same.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Option -report can specify a quality control report in CSV format. Here is the explanation of each term in this file.</p>
<div class="center">
<table class="caption-top table">
<colgroup>
<col style="width: 36%">
<col style="width: 63%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Terms</strong></th>
<th style="text-align: left;"><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Number of Fragments</td>
<td style="text-align: left;">The number of records in the FASTQ(s). For paired reads, each pair only count once.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fragments pass QC</td>
<td style="text-align: left;">Reads or paired reads pass QC.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Fragments with Exactly Matched Barcodes</td>
<td style="text-align: left;">Barcodes exactly matched with any barcode in the candidate list.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fragments with Failed Barcodes</td>
<td style="text-align: left;">No barcode found in the candidate list with similar search.</td>
</tr>
</tbody>
</table>
</div>
<h3 id="fsort" class="anchored">fsort</h3>
<p>The fsort tool is engineered to order FASTQ+ records based on specified tags, which can be defined using the -tags option. This tool efficiently handles file sorting: for files smaller than 1 gigabyte, it performs the sort directly. However, for larger FASTQ files, where caching the entire file in memory is impractical, fsort employs a different strategy. It splits the large file into smaller segments, sorts each segment individually, and then merges the sorted segments. This method ensures efficient handling of large datasets while maintaining the integrity and order of the FASTQ+ records.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort reads by tags.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA fsort <span class="at">-tags</span> CB,UR <span class="at">-list</span> cell_barcodes_top10K.txt <span class="at">-@</span> 5 <span class="at">-o</span> sorted.fq.gz in.fq</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Options:</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-tags</span>    <span class="pp">[</span><span class="ss">TAGS</span><span class="pp">]</span>     Tags, such as CB,UR. Order of these tags is sensitive.</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">-@</span>       <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>      Threads to compress file.</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">-o</span>       <span class="pp">[</span><span class="ss">fq.gz</span><span class="pp">]</span>    bgzipped output fastq file.</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">-m</span>       <span class="pp">[</span><span class="ss">mem</span><span class="pp">]</span>      Memory per thread. <span class="pp">[</span><span class="ss">1G</span><span class="pp">]</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">-p</span>                  Input fastq is smart pairing.</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">-T</span>       <span class="pp">[</span><span class="ss">prefix</span><span class="pp">]</span>   Write temporary files to PREFIX.nnnn.tmp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="stream" class="anchored">stream</h3>
<p>The stream tool is designed as a framework to process FASTQ+ files, where each FASTQ+ blockdefined by having identical tags and grouped together in the fileis handled individually. The -script option allows users to specify a custom bash script that processes each block. This user-defined script reads a small FASTQ+ file, generating FASTQ or FASTA output that is then sent to stdout. The stream tool captures this output via a pipe and updates the tags to ensure that each block of reads retains its original tags. Finally, it consolidates all outputs into a single file. In essence, this tool efficiently divides and processes each FASTQ+ block through a user-defined method, then seamlessly merges the results.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform user-defined script for each FASTQ+ block.</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA stream <span class="at">-script</span> run.sh reads.fq.gz</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> :</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-tags</span>    <span class="pp">[</span><span class="ss">TAGS</span><span class="pp">]</span>     Tags to define read blocks.</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">-script</span>  <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>     User defined bash script, process <span class="va">$FQ</span> and generate results to stdout.</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">-min</span>     <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>      Mininal reads per block to process.  <span class="pp">[</span><span class="ss">2</span><span class="pp">]</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">-keep</span>               Output unprocessed FASTQ+ records.</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">-fa</span>                 Stream FASTQ output instead of FASTQ.</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">-tmpdir</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">-t</span>                  Threads.</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">-o</span>       <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>     Path to output file.</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">-nw</span>                 Disable warning messages.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h4 id="write-a-script-for-pisa-stream" class="anchored">Write a script for PISA stream</h4>
<p>The PISA stream tool generates a temporary file named _block.fq for each block of reads, storing this file in a designated temporary directory. The path to this file is set in the environment variable ${FQ} for accessibility by subprocesses. Additionally, to ensure the uniqueness of each block, an alias named the unique block index is exported to the environment as ${UBI}.</p>
<p>The following example script demonstrates how to convert FASTQ+ to FASTA and rename the sequence ID. It is crucial for users to ensure that the scripts final output (either FASTQ+ or FASTA) is directed to stdout. All other script steps should avoid producing output to stdout or stderr, except for the last step. This precaution is necessary because PISA captures the scripts output through a pipe, and any unintended characters could disrupt the data format. Scripts can be written in a bash file or specified inline within the command.</p>
<div class="framed">
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat run.sh</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">seqtk</span> rename <span class="va">${FQ}</span> <span class="op">&gt;</span> test.fa<span class="kw">;</span> <span class="ex">seqtk</span> rename test.fa <span class="va">${UBI}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<h3 id="addtags" class="anchored">addtags</h3>
<p>The addtags tool is designed to put the new tags or update tags for FASTQ+ or BAM files.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Just add tags to reads.</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA addtags <span class="at">-str</span> CB:Z:CELL1,LB:Z:PoII2 <span class="at">-o</span> out.bam in.bam</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA addtags <span class="at">-str</span> CB:Z:CELL1,LB:Z:PoII2 <span class="at">-o</span> out.fastq in.fastq</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Options:</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="ex">-o</span>    <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>    Output file, bam or fastq, depends on input format</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="ex">-str</span>  <span class="pp">[</span><span class="ss">string</span><span class="pp">]</span>  TAGs.</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="ex">-@</span>    <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>     Threads to pack file.</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="ex">-mapq</span> <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>     Mapping quality score to filter mapped reads.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="sam2bam" class="anchored">sam2bam</h3>
<p>After alignment, the sequence ID from the FASTQ+ records is retained in the RNAME field of the SAM file. Given that the RNAME field is limited to 254 characters, we also restrict the sequence ID and any optional tag fields in FASTQ+ to this length to ensure compatibility. The sam2bam tool processes these details by parsing the tags from the RNAME and appending them to the end of the SAM optional fields.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parse FASTQ+ read name and convert SAM to BAM.</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA sam2bam <span class="at">-report</span> alignment.csv <span class="at">-@</span> 5 <span class="at">-adjust-mapq</span> <span class="at">-gtf</span> genes.gtf <span class="at">-o</span> aln.bam in.sam<span class="pp">[</span><span class="ss">.gz</span><span class="pp">]</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> :</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-o</span>       <span class="pp">[</span><span class="ss">BAM</span><span class="pp">]</span>       Output file <span class="pp">[</span><span class="ss">stdout</span><span class="pp">]</span>.</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">-t</span>       <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>       Work threads.</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">-mito</span>    <span class="pp">[</span><span class="ss">string</span><span class="pp">]</span>    Mitochondria name. Used to stat ratio of mitochondria reads.</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">-maln</span>    <span class="pp">[</span><span class="ss">BAM</span><span class="pp">]</span>       Export mitochondria reads into this file instead of standard output file.</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">-@</span>       <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>       Threads to compress bam file.</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">-report</span>  <span class="pp">[</span><span class="ss">csv</span><span class="pp">]</span>       Alignment report.</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="ex">Note</span> :</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> Reads map to multiple loci usually be marked as low quality and filtered at downstream analysis.</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="ex">But</span> for RNAseq library, if reads map to an exonic locus but also align to 1 or more non-exonic loci,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="ex">the</span> exonic locus can be prioritized as primary alignments, and mapping quality adjusts to 255. Tag</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="ex">MM:i:1</span> will also be added for this record. Following options used to adjust mapping quality.</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> Input SAM need be sorted by read name, and aligner should output all hits of a read in this SAM.</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a> <span class="ex">-adjust-mapq</span>         Enable adjusts mapping quality score.</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a> <span class="ex">-gtf</span>     <span class="pp">[</span><span class="ss">GTF</span><span class="pp">]</span>       GTF annotation file. This file is required to check the exonic regions.</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a> <span class="ex">-qual</span>    <span class="pp">[</span><span class="ss">255</span><span class="pp">]</span>       Updated quality score.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Option -t is to set the threads to parse the SAM records. The -@ option is to set the threads to compress alignments in BGZF format. The default compress level of BGZF is 6 in the htslib, but here PISA has reset this value to 2 to decrease the CPU times. Its not a good design to have both -t and -@, but will require a lot work to redesign the multithreads strategy, I have put this work in my todo list.</p>
<p>Option -report can specify a quality control report in CSV format. Here is the explanation of each term in this file.</p>
<div class="center">
<table class="caption-top table">
<colgroup>
<col style="width: 26%">
<col style="width: 73%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Terms</strong></th>
<th style="text-align: left;"><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Raw reads</td>
<td style="text-align: left;">Raw reads in the BAM files, secondary alignment will be skipped.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Mapped reads</td>
<td style="text-align: left;">Reads mapped to reference, and the ratio of raw reads.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Plus strand</td>
<td style="text-align: left;">Reads mapped to forward strand of reference.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Minus strand</td>
<td style="text-align: left;">Reads mapped to backward strand of reference.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Mitochondria ratio</td>
<td style="text-align: left;">Ratio of reads mapped to chromosome mitochondria. The default mito name is chrM, user should change it by -mito option if reference is different. Otherwise this value will always be 0.</td>
</tr>
</tbody>
</table>
</div>
<h4 id="mapq-adjust-method" class="anchored">MapQ adjust method</h4>
<p>For RNA libraries, if a read from cDNA maps to an exonic locus but also maps to one or more non-exonic regions, the exonic locus can be prioritized as primary alignments, and mapping quality adjusts to 255. In the below records below, read DP8400008965TLL1C001R0102043364 mapped to three loci, and the aligner random pick one as the primary alignment and others as secondary. Each of these alignments has low mapping quality (MAPQ == 2, is usually filtered at downstream analysis). Our adjustment method will check if only one of these alignments overlaps with exonic regions. In our example, the last alignment overlapped with gene EEF1A1, and the other two hit intergenic regions. After adjustment, the last record has been flagged as a primary hit, and the mapping quality adjusted to 255, and other alignments of the same read are updated as secondary, MAPQ adjust to 0. MM:i:1 tag also is added to the primary record after adjustment. Option -adjust-mapq is reimplemented to mirror the 10X CellRangers MAPQ adjustment method (<a href="https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/latest/algorithms/overview#alignment" class="uri">https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/latest/algorithms/overview#alignment</a>).</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a> <span class="co">#  Output by aligner:</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="ex">DP8400008965TLL1C001R0102043364</span> 0   9   133020979   2   100M    <span class="pp">*</span>   0   0   GTTAATGATAACAATGCATCGTAAAACCTTCAGAAGGAAAGGAGAATGTTTTGTGGACCACTTTGGTTTTCTTGTTTGCGTGTGGCAGTTTTAAGTTTTT    ...</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="ex">DP8400008965TLL1C001R0102043364</span> 272 7   22510408    2   100M    <span class="pp">*</span>   0   0   AAAAACTTAAAACTGCCACACGCAAACAAGAAAACCAAAGTGGTCCACAAAACATTCTCCTTTCCTTCTGAAGGTTTTACGATGCATTGTTATCATTAAC    ...</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ex">DP8400008965TLL1C001R0102043364</span> 272 6   73517606    2   100M    <span class="pp">*</span>   0   0   AAAAACTTAAAACTGCCACACGCAAACAAGAAAACCAAAGTGGTCCACAAAACATTCTCCTTTCCTTCTGAAGGTTTTACGATGCATTGTTATCATTAAC    ...</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"># After adjustment (Seq and Qual in secondary alignments masked as *):</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="ex">DP8400008965TLL1C001R0102043364</span> 256 9   133020979   0   100M    <span class="pp">*</span>   0   0   <span class="pp">*</span>   ...</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="ex">DP8400008965TLL1C001R0102043364</span> 272 7   22510408    0   100M    <span class="pp">*</span>   0   0   <span class="pp">*</span>   ...</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="ex">DP8400008965TLL1C001R0102043364</span> 16  6   73517606    255 100M    <span class="pp">*</span>   0   0   AAAAACTTAAAACTGCCACACGCAAACAAGAAAACCAAAGTGGTCCACAAAACATTCTCCTTTCCTTCTGAAGGTTTTACGATGCATTGTTATCATTAAC    ... MM:i:1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>An example list here to show how to enable mapq adjuestment.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PISA</span> sam2bam <span class="at">-report</span> alignment.csv <span class="at">-o</span> out.bam <span class="at">-adjust-mapq</span> <span class="at">-gtf</span> hg38.gtf in.sam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="rmdup" class="anchored">rmdup</h3>
<p>To effectively manage PCR duplication in single-cell experiments, it is essential to consider both cell and molecular barcodes. During the feature counting stage facilitated by PISA count, deduplication is efficiently handled by relying solely on unique UMIs. This reliance makes traditional PCR deduplication unnecessary for libraries that use UMIs. Nonetheless, producing a deduplicated BAM file remains beneficial for other analytical processes, such as variant calling, or simply to reduce file size.</p>
<p>The rmdup tool is specifically designed to remove duplicate reads that share identical barcodes, such as UMIs and cell barcodes. This selective deduplication approach ensures that only truly redundant data is removed, thus preserving the integrity and completeness of the dataset for comprehensive downstream analyses.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Deduplicate PCR reads with same barcodes.</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA rmdup <span class="at">-tags</span> CB,UR <span class="at">-o</span> rmdup.bam in.bam</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> :</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>   <span class="ex">-tags</span>  <span class="pp">[</span><span class="ss">TAGS</span><span class="pp">]</span>       Barcode tags to group reads.</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>   <span class="ex">-@</span>     <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>        Threads to unpack BAM.</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>   <span class="ex">-o</span>     <span class="pp">[</span><span class="ss">BAM</span><span class="pp">]</span>        Output bam.</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>   <span class="ex">-q</span>     <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>        Map Quality Score cutoff.</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>   <span class="ex">-k</span>                  Keep duplicates, make flag instead of remove them.</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>   <span class="ex">-nw</span>                 Disable warnings.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this version, PISA rmdup only supports single-end reads. For paired-end reads, such as scATAC data, PCR deduplication can be performed by the PISA bam2frag tool.</p>
<h3 id="pick" class="anchored">pick</h3>
<p>The PISA pick tool is designed to select alignments with predefined tags and candidate values.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA pick <span class="at">-tags</span> CB,GN <span class="at">-list</span> cell_barcodes.txt in.bam</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> :</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a> <span class="ex">-tags</span>    <span class="pp">[</span><span class="ss">TAGS</span><span class="pp">]</span>       Barcode tags.</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">-list</span>    <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>       Barcode white list, tag values in related column will be apply.</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-o</span>       <span class="pp">[</span><span class="ss">BAM</span><span class="pp">]</span>        Output file.</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">-q</span>       <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>        Map Quality Score cutoff.</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">-@</span>       <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>        Threads to unpack BAM.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Depending on the number of tags specified by the user, the candidate list for tags can consist of either a single column or multiple columns. If multiple tags are specified but only one column is present in the list, the program will primarily compare the value of the first tag in the alignments with the list.</p>
<h3 id="anno" class="anchored">anno</h3>
<p>Connecting alignment results with genomic features is essential in single-cell data analysis. PISA categorizes features into three main types: gene annotation, functional regions, and genetic or sequence variations. For gene annotation, the PISA anno tool efficiently organizes all exons, transcripts, and genes from a GTF database into a sorted hierarchical tree structure.</p>
<p>Based on their alignment status, reads are then classified into one of nine distinct types, see illustrate below <a href="#fig:fig01" data-reference-type="ref" data-reference="fig:fig01">Figure 1</a>. This detailed categorization helps in accurately assessing the transcriptional landscape and understanding the complex genomic architecture within single-cell datasets.</p>
<div id="fig:fig01" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="anno_type.png" class="img-fluid figure-img"></p>
<figcaption>Figure 1: Read types.</figcaption>
</figure>
</div>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># annotate strand-specific reads</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA anno <span class="at">-gtf</span> genes.gtf <span class="at">-o</span> anno.bam sorted.bam</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># annotate non-strand-specific reads, for Smartseq or bulk RNAseq</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA anno <span class="at">-is</span> <span class="at">-gtf</span> genes.gtf <span class="at">-o</span> anno.bam sorted.bam</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># also label gene name for intronic reads, i.e. RNA velocity analysis</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA anno <span class="at">-intron</span> <span class="at">-gtf</span> genes.gtf <span class="at">-o</span> anno.bam sorted.bam</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># annotate expressed peaks and genetic variants (both reference allele and alternative allele) </span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA anno <span class="at">-bed</span> peak.bed <span class="at">-vcf</span> in.vcf.gz <span class="at">-vcf-ss</span> <span class="at">-ref-alt</span> <span class="at">-o</span> anno.bam in.bam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Besides these annotation methods, PISA anno also supports a -chr-species method. This method requires a binding list for chromosome and related label relationships. The software will check the chromosome and add the related tag for each chromosome. This method, combined with PISA attrcnt can help to summarize the mixed two cell lines from different species.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A binding list is tab-separated two columns txt file.</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat binding_list.txt</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="ex">GRCh38_chr1</span>    Human</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="ex">GRCh38_chr21</span>   Human</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="ex">mm10_chr21</span>     Mouse</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA anno <span class="at">-chr-species</span> binding.txt <span class="at">-btag</span> SP <span class="at">-o</span> anno_species.bam sorted.bam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The full options and descriptions list below.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Annotate SAM/BAM records with overlapped function regions. Such as gene, transcript etc.</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA anno <span class="at">-bed</span> peak.bed <span class="at">-tag</span> PK <span class="at">-vcf</span> in.vcf.gz <span class="at">-vtag</span> VF <span class="at">-vcf-ss</span> <span class="at">-ref-alt</span> <span class="at">-o</span> anno.bam in.bam</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA anno <span class="at">-gtf</span> genes.gtf <span class="at">-o</span> anno.bam in.bam</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA anno <span class="at">-gtf</span> genes.gtf <span class="at">-o</span> anno.bam <span class="at">-sam</span> in.sam</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> :</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">-o</span>        <span class="pp">[</span><span class="ss">BAM</span><span class="pp">]</span>       Output bam file.</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">-report</span>   <span class="pp">[</span><span class="ss">csv</span><span class="pp">]</span>       Summary report.</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">-@</span>        <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>       Threads to compress bam file.</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">-q</span>        <span class="pp">[</span><span class="ss">0</span><span class="pp">]</span>         Map Quality Score cutoff. MapQ smaller than this value will not be annotated.</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">-t</span>        <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>       Threads to annotate.</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">-chunk</span>    <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>       Chunk size per thread.</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">-anno-only</span>            Export annotated reads only.</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a> <span class="ex">-sam</span>                  Input is SAM file, parse tags from read name.</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a> <span class="ex">-rev</span>                  Annotation in reverse strand<span class="kw">;</span> <span class="ex">Some</span> probe ligation library for FFPE samples create reverse fragments.</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a> <span class="ex">-is</span>                   Disable strand sensitive annotation of gene, genomic region and genetic variants.</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> for BED file :</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a> <span class="ex">-bed</span>      <span class="pp">[</span><span class="ss">BED</span><span class="pp">]</span>       Function regions. Three or four columns bed file. Col 4 could be empty or names of this region.</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a> <span class="ex">-tag</span>      <span class="pp">[</span><span class="ss">TAG</span><span class="pp">]</span>       Attribute tag name. Set with <span class="at">-bed.</span> Default is PK.</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> for mixed samples.</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a> <span class="ex">-chr-species</span>  <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>  Chromosome name and related species binding list.</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a> <span class="ex">-btag</span>     <span class="pp">[</span><span class="ss">TAG</span><span class="pp">]</span>       Species tag name. Set with <span class="at">-chr-species.</span> Default is SP.</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> for GTF file :</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a> <span class="ex">-gtf</span>      <span class="pp">[</span><span class="ss">GTF</span><span class="pp">]</span>       GTF annotation file. gene_id,transcript_id is required for each record.</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a> <span class="ex">-tags</span>     <span class="pp">[</span><span class="ss">TAGs</span><span class="pp">]</span>      Attribute names, more details see <span class="kw">`</span><span class="ex">Notice</span><span class="kw">`</span> below. <span class="pp">[</span><span class="ss">TX,GN,GX,RE,EX,JC</span><span class="pp">]</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a> <span class="ex">-splice</span>               Reads covered exon-intron edge <span class="er">(</span><span class="ex">ExonIntron</span> type<span class="kw">)</span> <span class="ex">will</span> also be annotated with all tags.</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a> <span class="ex">-intron/-velo</span>         Reads covered intron regions will also be annotated with all tags.</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a> <span class="ex">-exon</span>                 Generate exon level and junction annotation. Put exon name <span class="er">(</span><span class="ex">chr:start-end/[[+-]/Gene</span><span class="kw">)</span> <span class="er">in</span> <span class="ex">EX</span> tag.<span class="dt">\ </span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>                       <span class="ex">Also</span> generate junction name <span class="er">(</span><span class="ex">chr:exon1_end-exon2_start/[+-]/Gene</span><span class="kw">)</span> <span class="er">in</span> <span class="ex">JC</span> tag.</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a> <span class="ex">-flatten</span>              Split overlapped exons into nonoverlapped bins.</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a> <span class="ex">-psi</span>                  Annotate exclude reads tag <span class="er">(</span><span class="ex">ER</span><span class="kw">)</span> <span class="cf">for</span> each <span class="ex">exon.</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a> <span class="ex">-tss</span>                  Annotate reads start from TSS, designed for capped library. <span class="pp">**</span>experiment<span class="pp">**</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a> <span class="ex">-ctag</span>     <span class="pp">[</span><span class="ss">TAG</span><span class="pp">]</span>       Tag name for TSS annotation. Need set with <span class="at">-tss.</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> for VCF file :</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a> <span class="ex">-vcf</span>      <span class="pp">[</span><span class="ss">VCF/BCF</span><span class="pp">]</span>   Varaints file in vcf or bcf format. In default, only annotate alternative alleles.</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a> <span class="ex">-vtag</span>     <span class="pp">[</span><span class="ss">TAG</span><span class="pp">]</span>       Tag name for variants. Set with <span class="at">-vcf.</span> Default is VR.</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a> <span class="ex">-ref-alt</span>              Annotate ref allele.</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a><span class="ex">Notice</span> :</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> If input is SAM format, will try to parse the tags in the read name.</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> For GTF mode, this program will set tags in default, you could also reset them by <span class="at">-tags.</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>   <span class="ex">TX</span> : Transcript id.</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>   <span class="ex">GN</span> : Gene name.</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>   <span class="ex">GX</span> : Gene ID.</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>   <span class="ex">RE</span> : Region type, E <span class="er">(</span><span class="ex">exon</span><span class="kw">)</span><span class="ex">,</span> N <span class="er">(</span><span class="ex">intron</span><span class="kw">)</span><span class="ex">,</span> C <span class="er">(</span><span class="ex">exon</span> and intron<span class="kw">)</span><span class="ex">,</span> S <span class="er">(</span><span class="ex">junction</span> reads cover isoforms properly<span class="kw">)</span><span class="ex">,</span> V <span class="er">(</span><span class="ex">ambiguous</span> reads<span class="kw">)</span><span class="ex">,</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>        <span class="ex">I</span> <span class="er">(</span><span class="ex">intergenic</span><span class="kw">)</span><span class="ex">,</span> A <span class="er">(</span><span class="ex">antisense</span> or antisense exon<span class="kw">)</span><span class="ex">,</span> B <span class="er">(</span><span class="ex">antisense</span> intron<span class="kw">)</span><span class="ex">,</span> X <span class="er">(</span><span class="ex">one</span> or more exons are excluded in transcrpit<span class="kw">)</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> The following tags set with <span class="at">-exon.</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>   <span class="ex">EX</span> : Exon name tag.</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>   <span class="ex">JC</span> : Isoform junction name.</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>   <span class="ex">FL</span> : Flatten exon name. Only generate it with <span class="at">-flatten.</span></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> The following tags set with <span class="at">-psi.</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>   <span class="ex">ER</span> : Excluded exons.</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> PSI = EX/<span class="er">(</span><span class="ex">EX+ER</span><span class="kw">);</span> <span class="ex">EX</span> is the exon tag, which indicate include reads in exon.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="corr" class="anchored">corr</h3>
<p>The diversity of UMIs of each gene in one cell is used to evaluate the gene expression level, but the error of UMI comes from sequencing or PCR may introduce bias. PISA corr is designed to correct the UMI or barcode sequence based on Hamming distance. In default, two groups of UMI from the same gene of one cell with Hamming distance equal to 1, will be considered to originate from the same transcript. The group with high frequency will be selected as a real one, and another one will be corrected to the high one.</p>
<p>Because PISA corr does not require a sorted BAM, this tool will first build a correction list by caching all the raw UMIs and barcodes and then correct them in memory. After these steps, this tool will reread the file and update these records by order. This design can avoid potential bias for the same gene from different chromosomes (i.e., the HLA genes in alternative locus). However, this design also required a lot of memory for a big BAM.</p>
<p>CellRanger also introduces an algorithm to correct reads with the same UMI of one cell but mapping to more than one gene (<a href="https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/latest/algorithms/overview" class="uri">https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/latest/algorithms/overview</a>). PISA implements this method but does not enable it in default. The -cr option can be used by users to enable this function. The reason for not enable it by default is PISA corr not only is used to correct UMIs, but also can be used to correct any other types of barcodes. The following example shows how to use PISA corr to correct cell barcodes for reads in the same gene.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">//</span> Reads with same gene tag <span class="er">(</span><span class="ex">GN</span><span class="kw">)</span> <span class="ex">and</span> UMI <span class="er">(</span><span class="ex">UB</span><span class="kw">)</span> <span class="ex">will</span> be grouped and calculate the Hamming distance between each other. </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ex">//</span> Only if Hamming distance == 1 will be corrected.</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="ex">PISA</span> corr <span class="at">-tag</span> CR <span class="at">-new-tag</span> CB <span class="at">-tags-block</span> GN,UB <span class="at">-o</span> cell_barcode_corrected.bam in.bam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Full options of PISA corr list below.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Correct similar barcodes (hamming distance == 1).</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA corr <span class="at">-tag</span> UR <span class="at">-new-tag</span> UB <span class="at">-tags-block</span> CB,GN <span class="at">-@</span> 5 <span class="at">-o</span> corr.bam in.bam</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> :</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-o</span>        <span class="pp">[</span><span class="ss">BAM</span><span class="pp">]</span>       Output bam.</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">-tag</span>      <span class="pp">[</span><span class="ss">TAG</span><span class="pp">]</span>       Tag to correct.</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">-new-tag</span>  <span class="pp">[</span><span class="ss">TAG</span><span class="pp">]</span>       Create a new tag for corrected barcodes.</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">-tags-block</span>  <span class="pp">[</span><span class="ss">TAGS</span><span class="pp">]</span>   Tags to define read group. For example, if set to GN <span class="er">(</span><span class="ex">gene</span><span class="kw">)</span><span class="ex">,</span> reads in the same gene will be grouped together.</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">-cr</span>                   Enable CellRanger like UMI correction method. See <span class="kw">`</span><span class="ex">Examples</span><span class="kw">`</span> for details.</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">-e</span>                    Maximal hamming distance to define similar barcode, default is 1.</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">-@</span>        <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>       Thread to compress BAM file.</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="ex">Examples</span> :</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a> <span class="ex">//</span> Two groups of reads have same cell barcode <span class="er">(</span><span class="ex">CB</span><span class="kw">)</span> <span class="ex">and</span> gene <span class="er">(</span><span class="ex">GN</span><span class="kw">)</span> <span class="ex">but</span> their raw UMIs <span class="er">(</span><span class="ex">UR</span><span class="kw">)</span> <span class="ex">differ</span> by only one base. The UMI of less </span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a> <span class="ex">//</span> supported is corrected to the UMI with higher support. UB save the checked or corrected UMI.</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA corr <span class="at">-tag</span> UR <span class="at">-new-tag</span> UB <span class="at">-tags-block</span> CB,GN in.bam <span class="at">-o</span> corr.bam </span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a> <span class="ex">//</span> Same with above. Besides, if two or more groups of reads have same CB and UB but different GN, the GN with the most supporting reads</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a> <span class="ex">//</span> is kept for UMI counting, and the other read groups are discarded. In case of a tie for maximal read support, all read groups are</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a> <span class="ex">//</span> discarded, as the gene cannot be confidently assigned <span class="er">(</span><span class="ex">Cell</span> Ranger method<span class="kw">)</span><span class="bu">.</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA corr <span class="at">-cr</span> <span class="at">-tag</span> UR <span class="at">-new-tag</span> UB <span class="at">-tags-block</span> CB,GN in.bam <span class="at">-o</span> corr.bam </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="attrcnt" class="anchored">attrcnt</h3>
<p>PISA attrcnt is used to summarize the meta information of the library. We start introduce this tool with few examples.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count reads per cell, -cb option is required to specify cell barcode tag</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA attrcnt <span class="at">-cb</span> CB in.bam</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="ex">//</span> the summary information output in tsv format</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="ex">BARCODE</span> Raw                           // the title</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="ex">AGCTATGCTTCTAGTGTAAC-1</span>  38            // cell barcode and raw reads per cell, separated by a tab</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="ex">GCCGCTGATCGGCCTGCACA-1</span>  12</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="ex">GTCGCGATTCTGCTCAGAAG-1</span>  13</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="ex">GTCAGTACCATGCTCAGAAG-1</span>  27</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="ex">CAACTCGTCGGTTGTCTGAC-1</span>  23</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Count raw reads and reads in the peaks per cell</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA attrcnt <span class="at">-cb</span> CB <span class="at">-tags</span> PK             // PK tag is annotated for reads in peak</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>             <span class="ex">-o</span> summary.tsv              // Summary file</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>             <span class="ex">example/anno/demo_1.bam</span> </span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> head summary.tsv </span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="ex">BARCODE</span> Raw PK</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="ex">GGCATTATCGGCTCGGTATG</span>    2   2</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="ex">TGAGTTGTGTATACTCCTAC</span>    2   2</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="ex">CCGCGGCACTACACACCAGA</span>    1   1</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="ex">ATTAGTGGTCTCCTGGTCGG</span>    1   1</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="ex">TTATTGGACCACGTTGAATA</span>    1   1</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="ex">GGAATGCCACAAGCGCCGTA</span>    1   1</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="ex">AGTCTATCGTGGCCTGCACA</span>    5   5</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="ex">AGGCACACCTCGCTGAATTC</span>    3   3</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="ex">GTCAGGATCGATAACATACG</span>    2   2</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Count UMIs per cell</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA attrcnt <span class="at">-cb</span> CB <span class="at">-tags</span> UB      // UB is tag of corrected UMIs</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>             <span class="ex">-dedup</span>               // <span class="at">-dedup</span> option used to remove duplication of tag values, if not set, this </span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>                                  <span class="ex">//</span> command will export reads with UB tag but not the unique UMIs per cell</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>             <span class="ex">-o</span> summary.tsv anno.bam</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Count UMIs and Genes per cell</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA attrcnt <span class="at">-cb</span> CB <span class="at">-tags</span> UB,GN  // GN is tag for annotated gene<span class="kw">;</span> <span class="ex">-tags</span> can accept multiple tag names, and seperated by <span class="st">","</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>             <span class="ex">-dedup</span> <span class="at">-o</span> summary.tsv anno.bam</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> head summary.tsv</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="ex">BARCODE</span> Raw UB  GN</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a><span class="ex">AGCTATGCTTCTAGTGTAAC-1</span>  38  35  0</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a><span class="ex">GCCGCTGATCGGCCTGCACA-1</span>  12  12  0</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a><span class="ex">GTCGCGATTCTGCTCAGAAG-1</span>  13  11  0</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a><span class="ex">GTCAGTACCATGCTCAGAAG-1</span>  27  26  0</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a><span class="ex">CAACTCGTCGGTTGTCTGAC-1</span>  23  21  0</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a><span class="ex">GGTACACCACAGTAGTTACG-1</span>  12  10  0</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a><span class="ex">GCGCGCCGAGGGACACTCTT-1</span>  1   1   0</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a><span class="ex">CTCTAAGCATCGAGGTTAAC-1</span>  162 138 50</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a><span class="ex">TTCGTAGCACCGATACTAGC-1</span>  51  48  46</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Full list of options list below.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the frequency of tag values.</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA attrcnt <span class="at">-cb</span> CB <span class="at">-tags</span> UR,GN <span class="at">-dedup</span> <span class="at">-all-tags</span> in.bam</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> :</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-cb</span>       <span class="pp">[</span><span class="ss">TAG</span><span class="pp">]</span>      Cell Barcode, or other tag used for grouping reads.</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">-list</span>     <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>     Cell barcode white list.</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">-tags</span>     <span class="pp">[</span><span class="ss">TAGS</span><span class="pp">]</span>     Tags to count.</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">-dedup</span>               Deduplicate the atrributes in each tag.</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">-all-tags</span>            Only records with all tags be count.</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">-group</span>    <span class="pp">[</span><span class="ss">TAG</span><span class="pp">]</span>      Group tag, count all tags for each group seperately.</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">-o</span>        <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>     Output count table.</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">-q</span>        <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>      Map Quality to filter bam.</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">-no-header</span>           Ignore header in the output.</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a> <span class="ex">-@</span>        <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>      Thread to unpack bam.</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a> <span class="ex">-ttag</span>     <span class="pp">[</span><span class="ss">TAG</span><span class="pp">]</span>      Region type tag. <span class="pp">[</span><span class="ss">RE</span><span class="pp">]</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a> <span class="ex">-ttype</span>               Region type used to count. Set <span class="kw">`</span><span class="ex">E,S</span><span class="kw">`</span> to count exon enclosed reads. Set <span class="kw">`</span><span class="ex">N,C</span><span class="kw">`</span> to count intron overlapped reads.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="extract" class="anchored">extract</h3>
<p>PISA extract is designed to extract the values of tags from BAM records and generate a tab-separated file.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract tag values from alignments.</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA extract <span class="at">-tags</span> CB,UR,GN <span class="at">-o</span> tags.tsv in.bam</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> :</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-tags</span>     <span class="pp">[</span><span class="ss">TAGS</span><span class="pp">]</span>     Tags to be extracted.</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">-o</span>        <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>     Output file. tsv format</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">-n</span>                   Print read name.</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">-q</span>                   Map Quality Score threshold.</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">-all</span>                 Only export if all tags have value.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="count" class="anchored">count</h3>
<p>The PISA count tool is designed to generate a counts matrix for various features or tags, traditionally outputting a gene-by-cell digit matrix. Starting with version 0.4, this tool now supports the MEX format output, which is highly recommended for use in downstream analyses due to its superior performance. Its important to note that MEX format consists of three files, so you should use the -outdir option to specify the directory where the output files will be saved.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count reads or fragments matrix for single-cell datasets.</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA count <span class="at">-cb</span> CB <span class="at">-anno-tag</span> GN <span class="at">-umi</span> UB <span class="at">-outdir</span> exp aln.bam</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA count <span class="pp">[</span><span class="ss">options</span><span class="pp">]</span> aln1.bam,aln2.bam</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA count <span class="at">-cb</span> RG <span class="at">-sample-list</span> bam_files.txt <span class="at">-outdir</span> exp</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA count <span class="at">-tags</span> Cx,Cy <span class="at">-anno-tag</span> GN <span class="at">-umi</span> UB <span class="at">-outdir</span> exp <span class="at">-velo</span> aln.bam</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> :</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">-tags/-cb</span> <span class="pp">[</span><span class="ss">TAGs</span><span class="pp">]</span>     A cell barcode tag or two tags of spatial coordinates for spatial data.</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">-anno-tag</span> <span class="pp">[</span><span class="ss">TAG</span><span class="pp">]</span>      Annotation tag, gene or peak.</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">-genome-bin</span> <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>    If genome bin size set, genome bin count matrix will be generated, conflict with <span class="at">-anno-tag</span> and <span class="at">-chr.</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">-is</span>                  Ignore strand for bin counting.</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">-chr</span>                 Count chromosome expression level, conflict with <span class="at">-anno-tag</span> and <span class="at">-genome-bin.</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">-list</span>     <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>     Barcode white list, used as column names at matrix. If not set, all barcodes will be count.</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a> <span class="ex">-outdir</span>   <span class="pp">[</span><span class="ss">DIR</span><span class="pp">]</span>      Output matrix in MEX format into this folder.</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a> <span class="ex">-umi</span>      <span class="pp">[</span><span class="ss">TAG</span><span class="pp">]</span>      UMI tag. Count once if more than one record has same UMI in one gene or peak.</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a> <span class="ex">-one-hit</span>             Skip if a read hits more than 1 gene or peak.</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a> <span class="ex">-q</span>        <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>      Minimal map quality to filter. Default is 20.</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a> <span class="ex">-t</span>        <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>      Threads.</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a> <span class="ex">-ttag</span>     <span class="pp">[</span><span class="ss">TAG</span><span class="pp">]</span>      Region type tag. <span class="pp">[</span><span class="ss">RE</span><span class="pp">]</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a> <span class="ex">-velo</span>                Generate spliced and unspliced matrix files for RNA velocity analysis.</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a> <span class="ex">-ttype</span>    <span class="pp">[</span><span class="ss">TYPE</span><span class="pp">]</span>     Region type used to count. Set <span class="kw">`</span><span class="ex">E,S</span><span class="kw">`</span> to count exon enclosed reads. Set <span class="kw">`</span><span class="ex">N,C</span><span class="kw">`</span> to count intron overlapped reads.</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a> <span class="ex">-sample-list</span> <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>  A list of bam files. Each path per line.</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> for Stereoseq:</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a> <span class="ex">-stereoseq</span>           Stereoseq pipeline pack UMI to hex string. Need set this option to decode UMIs.</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a> <span class="ex">-spatial-bin</span> <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>   Bin size for spatial coordiate. Can be set if <span class="at">-tags</span> specify spatial coordinates.<span class="pp">[</span><span class="ss">1</span><span class="pp">]</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a> <span class="ex">-dup</span>                 Do NOT skip duplicate reads.</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="ex">Notice</span> :</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> Region type <span class="er">(</span><span class="ex">RE</span><span class="kw">)</span><span class="ex">,</span> which label functional region reads mapped, is annotated by <span class="kw">`</span><span class="ex">PISA</span> anno<span class="kw">`</span>. Optional <span class="at">-ttype</span> can be set</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>   <span class="ex">to</span> one of region types<span class="er">(</span><span class="ex">E/S/C/N</span><span class="kw">)</span> <span class="ex">or</span> combination to count reads mapped to these functional regions only.</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> If you want count from more than one bam file, there are two ways to set the parameter. By seperating bam files with <span class="st">','</span> or by</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>   <span class="ex">setting</span> <span class="at">-sample-list</span> option.</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> If <span class="at">-velo</span> set, spliced and unspliced folders will be created at outdir.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h4 id="for-smartseq-user" class="anchored">For Smartseq user</h4>
<p>PISA count also support counting gene expression from multiple bam files.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA count <span class="at">-file-barcode</span>             // use alias name for each bam file as cell barcode. If this flag is not set <span class="at">-cb</span> must be specified.</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ex">-tags</span> CB                   // Cell barcode</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="ex">-sample-list</span> bam_list.txt // bam file path and alias name</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="ex">-outdir</span> exp/ <span class="at">-anno-tag</span> GN </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co"># The `-sample-list' specify multiply files, each BAM path per line.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h4 id="description-of-mex-file" class="anchored">Description of MEX file</h4>
<p>The Market Exchange (MEX) format (<a href="https://math.nist.gov/MatrixMarket/formats.html" class="uri">https://math.nist.gov/MatrixMarket/formats.html</a>) is designed for representing the sparse matrix. The -outdir option specifies the output directory for one MEX fold. The MEX format consists of three files, one is cell barcodes, one is feature names (genes or peak names), and the third one defines the expression or signal values.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="ex">barcodes.tsv.gz</span>  features.tsv.gz  matrix.mtx.gz</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> zcat barcodes.tsv.gz<span class="kw">|</span><span class="fu">head</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="ex">AACCTGGTGAAGTTGTCGAA</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="ex">AAGGAACTAAGCGCAGCACC</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="ex">CGATAGAATACTTCTTCGTA</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="ex">TACTATCCTCTAGCTGCTAC</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="ex">TGACCATCCTACAGTCCACC</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="ex">CAGATTCAACTACGAAGTGC</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="ex">TTCGTAGCACTCTTCATCTC</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="ex">GGCACCTTGCTTAACGTAGG</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="ex">ACTTCGGATACGTATCGCCT</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="ex">GACTCGCTAGTAGTCGGAAT</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> zcat features.tsv.gz<span class="kw">|</span><span class="fu">head</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="ex">RP11-34P13.7</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="ex">RP11-34P13.8</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="ex">RP11-34P13.9</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="ex">FO538757.3</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="ex">FO538757.2</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="ex">AP006222.2</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="ex">RP4-669L17.10</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="ex">RP5-857K21.4</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="ex">RP11-206L10.4</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="ex">RP11-206L10.9</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> zcat matrix.mtx.gz<span class="kw">|</span><span class="fu">head</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="ex">%%MatrixMarket</span> matrix coordinate integer general</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="ex">%</span> Generated by PISA v0.4-alpha-72-g09c4ded</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="ex">23900</span>   782761  11533380</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="ex">1</span>   1   2</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="ex">1</span>   2   2</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="ex">1</span>   3   2</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="ex">1</span>   4   1</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="ex">1</span>   5   2</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="ex">1</span>   6   1</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="ex">1</span>   7   2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The MEX file can be read by R package Yano::ReadPISA.</p>
<h3 id="bam2fq" class="anchored">bam2fq</h3>
<p>PISA bam2fq is designed to convert alignment records to FATSQ+ records. Option -tags specify which tags will be kept in the FASTQ+. Full options list below.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert BAM into fastq.</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA bam2fq <span class="at">-tags</span> CB,UB,GN <span class="at">-o</span> out.fq aln.bam</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> :</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">-tags</span>     <span class="pp">[</span><span class="ss">TAGS</span><span class="pp">]</span>     Export tags in read name.</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-f</span>                   Filter records if specified tags not all exist.</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">-fa</span>                  Output fasta instead of fastq.</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">-o</span>        <span class="pp">[</span><span class="ss">fastq</span><span class="pp">]</span>    Output file.</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">-@</span>        <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>      Threads to unpack BAM.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="bam2frag" class="anchored">bam2frag</h3>
<p>The fragment file is a five columns tab-separated flat file which is designed for scATAC-seq. The first column is the chromosome name, the second column is the start location of this fragment (0 based), and the third column is the end position in 1 based of this fragment. The fourth column is the cell barcode of this fragment and the last column is how many duplicates of this fragment.</p>
<p>PISA bam2frag requires the input BAM file to be sorted by coordinate. This tool will check the cell barcode and the fragment position for each paired reads, duplicates in one cell will only keep one record, and the numeber of copies for this fragment will be updated in column four.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert sam record to fragment file.</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA bam2frag <span class="at">-cb</span> CB <span class="at">-list</span> cell_barcodes.txt <span class="at">-o</span> out.tsv.gz in.bam</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Options:</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-o</span>       <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>    Output file. This file will be bgzipped and indexed.</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">-cb</span>      <span class="pp">[</span><span class="ss">TAG</span><span class="pp">]</span>     Cell barcode tag.</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">-list</span>    <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>    Cell barcode white list.</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">-q</span>       <span class="pp">[</span><span class="ss">20</span><span class="pp">]</span>      Mapping quality score to filter reads.</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">-isize</span>   <span class="pp">[</span><span class="ss">2000</span><span class="pp">]</span>    Skip if insert size greater than this. <span class="pp">[</span><span class="ss">2KB</span><span class="pp">]</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">-bed</span>     <span class="pp">[</span><span class="ss">BED</span><span class="pp">]</span>     Only convert fragments overlapped with target regions.</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">-black-region</span> <span class="pp">[</span><span class="ss">BED</span><span class="pp">]</span> Skip convert fragments overlapped with black regions.</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">-stat</span>    <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>    Transposition events per cell.</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">-@</span>       <span class="pp">[</span><span class="ss">4</span><span class="pp">]</span>       Thread to unpack and pack files.<span class="pp">[</span><span class="ss">4</span><span class="pp">]</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a> <span class="ex">-disable-offset</span>    Disable Tn5 offset for each fragment.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="depth" class="anchored">depth</h3>
<p>PISA depth generates coverage information for each position of the predefined region(s). The significant difference between PISA depth and samtools depth (<a href="http://www.htslib.org/doc/samtools-depth.html" class="uri">http://www.htslib.org/doc/samtools-depth.html</a>) is that PISA depth use UMI rather than reads. Besides, PISA depth is strand sensitive, and can produce results for target cells.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count coverage depth or unique UMIs for genome locations.</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Usage</span> : PISA depth <span class="pp">[</span><span class="ss">options</span><span class="pp">]</span> sorted.bam <span class="pp">[</span><span class="ss">region</span><span class="pp">]</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA depth <span class="at">-cb</span> CB <span class="at">-umi</span> UB <span class="at">-tags</span> GN <span class="at">-region</span> in.bed <span class="at">-o</span> depth.tsv sorted.bam</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA depth <span class="at">-cb</span> CB <span class="at">-umi</span> UB sorted.bam chr1:1-2:+</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> : </span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">-tag</span>      <span class="pp">[</span><span class="ss">TAG</span><span class="pp">]</span>      Tag used for grouping reads.</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">-list</span>     <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>     Candidate list for <span class="at">-tag.</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">-umi</span>      <span class="pp">[</span><span class="ss">TAG</span><span class="pp">]</span>      UMI tag. If set, only count unique UMIs for each location.</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">-bed</span>      <span class="pp">[</span><span class="ss">BED</span><span class="pp">]</span>      Target BED region file. If the strand in column six set, only count reads with the same strand.</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">-o</span>        <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>     Output depth file. <span class="pp">[</span><span class="ss">stdout</span><span class="pp">]</span>.</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">-q</span>        <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>      Minimal map quality to filter. <span class="pp">[</span><span class="ss">20</span><span class="pp">]</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a> <span class="ex">-@</span>        <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>      Threads to unpack bam. <span class="pp">[</span><span class="ss">4</span><span class="pp">]</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="ex">Notice</span> :</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> Require sorted and indexed BAM as input.</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> Compare with <span class="kw">`</span><span class="ex">samtools</span> depth<span class="st">', PISA depth considers UMIs and strand of reads.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="callept" class="anchored">callept</h3>
<p>The term EPT stands for Expressed Peak Tag. EPTs can be identified by PISA within aligned reads from RNA libraries. Once identified, the relationship between each EPT and its corresponding gene can be annotated and analyzed using the Yano package. This analysis helps in understanding the functional implications of EPTs in gene expression regulation.</p>
<p>The callept tool is designed to call expressed peak tags (EPTs) for indexed BAM files. The peaks are defined with UMI depth &gt;= cutoff.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA cellept <span class="at">-o</span> epts.bed sorted.bam</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA cellept <span class="at">-tag</span> CB <span class="at">-list</span> cells.txt <span class="at">-umi</span> UB <span class="at">-o</span> epts.bed sorted.bam</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> :</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">-tag</span>      <span class="pp">[</span><span class="ss">TAG</span><span class="pp">]</span>      Tag used for grouping reads.</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-list</span>     <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>     Candidate list for <span class="at">-tag.</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">-umi</span>      <span class="pp">[</span><span class="ss">TAG</span><span class="pp">]</span>      UMI tag. If set, only count unique UMIs for each location.</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">-is</span>                  Ignore strand.</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">-gap</span>      <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>      Maximum gap to merge nearby peaks. <span class="pp">[</span><span class="ss">50</span><span class="pp">]</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">-min-length</span>  <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>   Minimum peak length. <span class="pp">[</span><span class="ss">50</span><span class="pp">]</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">-cutoff</span>   <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>      Cutoff of depth. <span class="pp">[</span><span class="ss">10</span><span class="pp">]</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">-o</span>        <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>     Output EPTs in bed format. <span class="pp">[</span><span class="ss">stdout</span><span class="pp">]</span>.</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">-q</span>        <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>      Minimal map quality to filter. <span class="pp">[</span><span class="ss">20</span><span class="pp">]</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">-t</span>        <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>      Threads. <span class="pp">[</span><span class="ss">4</span><span class="pp">]</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="ex">Notice</span> :</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> Requires sorted and indexed BAM as input.</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> Compares with <span class="kw">`</span><span class="ex">MACS2</span><span class="kw">`</span> and other peak callers, PISA callept considers UMIs and strand of reads.</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> For paired reads, strand of read 2 will be reversed to revert fragment strand.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="count2" class="anchored">count2</h3>
<p>PISA count generates the MEX format matrix for fragments per peak.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count fragments per peak per cell matrix.</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA count2 <span class="at">-bed</span> peaks.bed <span class="at">-t</span> 10 <span class="at">-list</span> barcodes.txt <span class="at">-outdir</span> exp fragments.tsv.gz</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> :</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-list</span>     <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>     Barcode white list, used as column names at matrix. If not set, all barcodes will be count.</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">-outdir</span>   <span class="pp">[</span><span class="ss">DIR</span><span class="pp">]</span>      Output matrix in MEX format into this fold.</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">-prefix</span>   <span class="pp">[</span><span class="ss">STR</span><span class="pp">]</span>      Prefix of output files.</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">-t</span>        <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>      Threads.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="mergebed" class="anchored">mergebed</h3>
<p>Merge overlapped regions by strand and name.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA mergebed <span class="at">-o</span> merged.bed sample1.bed sample2.bed</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA mergebed <span class="at">-up</span> 500 <span class="at">-down</span> 500 <span class="at">-o</span> flank.bed peaks.bed</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Options:</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="ex">-o</span>    <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>    Output bed file.</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="ex">-s</span>              Ignore strand.</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="ex">-up</span>   <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>     Enlarge regions upstream.</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="ex">-down</span> <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>     Enlarge regions downstream.</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="ex">-name</span>           Merge regions by bed name.</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="ex">Notice</span> :</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> This tool accepts 3 columns or 6 columns bed file<span class="er">(</span><span class="ex">s</span><span class="kw">)</span><span class="ex">,</span> strand <span class="er">(</span><span class="ex">+/-</span><span class="kw">)</span> <span class="ex">is</span> set in column 6.</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> By default, merging is done with respect to strandness unless <span class="at">-s</span> is set.</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> <span class="at">-up</span>/-down is set respect to strandness, so upstream of plus strand is downstream of minus strand.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="annobed" class="anchored">annobed</h3>
<p>Annotate the type of region and output in a BED like file. The region type can be defined into.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA annobed <span class="at">-gtf</span> genes.gtf <span class="at">-o</span> anno.bed in.bed</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Options:</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="ex">-gtf</span>    <span class="pp">[</span><span class="ss">GTF</span><span class="pp">]</span>     GTF database.</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="ex">-o</span>      <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>    Output bed file.</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="ex">-report</span> <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>    Summary report. Export in STDERR by default.</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="ex">-is</span>               Ignore strand.</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="ex">-gene-name</span>        Set annatated gene as bed name <span class="er">(</span><span class="ex">column</span> 4<span class="kw">)</span><span class="bu">.</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="ex">-skip-chrs</span>        Skip chromosomes if not exist in GTF. Defa</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="ex">-up</span>  <span class="pp">[</span><span class="ss">1000</span><span class="pp">]</span>         Annotate intergenic regions at upstream of gene.</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="ex">-down</span>  <span class="pp">[</span><span class="ss">1000</span><span class="pp">]</span>       Annotate intergenic regions at downstream of gene.</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="ex">Output</span> format :</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="ex">chromosome,start</span><span class="er">(</span><span class="ex">0based</span><span class="kw">)</span><span class="ex">,end</span><span class="er">(</span><span class="ex">1based</span><span class="kw">)</span><span class="ex">,name,score,strand,number</span> of covered genes, cover gene name<span class="er">(</span><span class="ex">s</span><span class="kw">)</span><span class="ex">,type,nearest</span> gene name,distance to nearby gene</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="ex">Notice</span> :</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> This tool accepts 3 columns or 6 columns bed file<span class="er">(</span><span class="ex">s</span><span class="kw">)</span><span class="ex">,</span> strand <span class="er">(</span><span class="ex">+/-</span><span class="kw">)</span> <span class="ex">is</span> set in column 6.</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a> <span class="ex">*</span> By default, annotation is done with respect to strandness unless <span class="at">-s</span> is set.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="flatten" class="anchored">flatten</h3>
<p>Convert overlapped into flatten records. If strand exist, the flatten records will be strand sensitive.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA flatten <span class="at">-o</span> flatten.bed overlapped.bed</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Options:</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="ex">-o</span>    <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>    Output bed file.</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="ex">For</span> example:</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="ex">reg1</span> ===========</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="ex">reg2</span>       ===========</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="ex">flattening</span> of regions:</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="ex">reg1</span> ======</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="ex">reg2</span>       =====</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="ex">reg3</span>            ======</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="gtffmt" class="anchored">gtffmt</h3>
<p>Format and reorder GTF records.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA gtffmt in.gtf</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Options:</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a> <span class="ex">-o</span>      <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>    Output GTF file</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">-f</span>                Only export gene, transcript, exon and CDS records.</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-key</span>    <span class="pp">[</span><span class="ss">all</span><span class="pp">]</span>     Export selected keys in optional fields.</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">-report</span> <span class="pp">[</span><span class="ss">stderr</span><span class="pp">]</span>  Summary report file.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="gtf2bed" class="anchored">gtf2bed</h3>
<p>Convert GTF file to BED format.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA gtf2bed <span class="at">-o</span> merged.bed in.gtf.gz</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Options:</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-o</span>    <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>                          Output bed file.</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-type</span> [gene<span class="kw">|</span><span class="ex">transcript</span><span class="kw">|</span><span class="ex">exon]</span>          Covert to bed.</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-name</span> [none<span class="kw">|</span><span class="ex">gene</span><span class="kw">|</span><span class="ex">transcript</span><span class="kw">|</span><span class="ex">exon]</span>     Set name for bed.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h2 id="deprecated-commands" class="anchored">Deprecated commands</h2>
<h3 id="parse0" class="anchored">parse0</h3>
<p>Since v1.0, the old parse tool has been replaced by parse2, and renamed to parse0 for backup purposes. Due to its lower performance compared to parse, parse0 will be deleted from v2 onwards. The parse0 tool requires a configuration file to describe the library structure, including cell barcode locations, UMI locations, and tag names. Additionally, it generates various quality control reports and outputs cell barcode distributions to stdout. Below is the complete options list and a general workflow for filtering and counting reads.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA parse <span class="at">-config</span> read_struct.json <span class="at">-report</span> fastq.csv <span class="at">-cbdis</span> cell_dist.tsv <span class="dt">\</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">-1</span> out.fq lane1_1.fq.gz,lane02_1.fq.gz  lane1_2.fq.gz,lane2_2.fq.gz</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Options</span> :</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">-1</span>       <span class="pp">[</span><span class="ss">fastq</span><span class="pp">]</span>   Read 1 output. Default is stdout.</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-2</span>       <span class="pp">[</span><span class="ss">fastq</span><span class="pp">]</span>   Read 2 output.</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">-config</span>  <span class="pp">[</span><span class="ss">json</span><span class="pp">]</span>    Read structure configure file in JSON format. Required.</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">-run</span>     <span class="pp">[</span><span class="ss">string</span><span class="pp">]</span>  Run code, used for different library.</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">-cbdis</span>   <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>    Read count per cell barcode.</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">-p</span>                 Read 1 and read 2 interleaved in the input file.</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">-q</span>       <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>     Drop reads if average sequencing quality below this value.</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">-dropN</span>             Drop reads if N base in sequence or barcode.</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">-report</span>  <span class="pp">[</span><span class="ss">csv</span><span class="pp">]</span>     Summary report.</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">-t</span>       <span class="pp">[</span><span class="ss">INT</span><span class="pp">]</span>     Threads. <span class="pp">[</span><span class="ss">4</span><span class="pp">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>-config requires a JSON file to tell software the locations of cell barcodes and/or UMIs. An example configured file can be found at demo/demo.json.</p>
<div class="framed">
<div class="sourceCode" id="cb36"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cell barcode tag"</span><span class="ex">:</span><span class="st">"CB"</span><span class="ex">,</span>  </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cell barcode"</span><span class="ex">:[</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">"location"</span><span class="ex">:</span><span class="st">"R1:1-16"</span> <span class="co"># the location is 1 based</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">],</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"UMI tag"</span><span class="ex">:</span><span class="st">"UR"</span><span class="ex">,</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"UMI"</span><span class="ex">:{</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"location"</span><span class="ex">:</span><span class="st">"R1:17-28"</span><span class="ex">,</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"read 1"</span><span class="ex">:{</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"location"</span><span class="ex">:</span><span class="st">"R2:1-91"</span><span class="ex">,</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Option -report can specify a quality control report in CSV format. Here is the explanation of each term in this file.</p>
<div class="center">
<table class="caption-top table">
<colgroup>
<col style="width: 36%">
<col style="width: 63%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Terms</strong></th>
<th style="text-align: left;"><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Number of Fragments</td>
<td style="text-align: left;">The number of records in the FASTQ(s). For paired reads, each pair only count once.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fragments pass QC</td>
<td style="text-align: left;">Reads or paired reads pass QC.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Fragments with Exactly Matched Barcodes</td>
<td style="text-align: left;">Cell barcode exactly matched with any barcode in the candidate list.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fragments with Failed Barcodes</td>
<td style="text-align: left;">No cell barcode found in the candidate list with similar search.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Fragments Filtered on Low Quality</td>
<td style="text-align: left;">Mean sequence quality of the records smaller than threshold.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fragments Filtered on Unknown Sample Barcodes</td>
<td style="text-align: left;">Sample barcodes not matched with any barcode in the candidate list.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q30 bases in Cell Barcode</td>
<td style="text-align: left;">Ratio of bases in cell barcode sequence with quality <span class="math inline">\(&gt;=\)</span> 30.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q30 bases in Sample Barcode</td>
<td style="text-align: left;">Ratio of bases in sample barcode sequence with quality <span class="math inline">\(&gt;=\)</span> 30.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q30 bases in UMI</td>
<td style="text-align: left;">Ratio of bases in UMI sequence with quality <span class="math inline">\(&gt;=\)</span> 30.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q30 bases in Reads</td>
<td style="text-align: left;">Ratio of bases in read sequence with quality <span class="math inline">\(&gt;=\)</span> 30.</td>
</tr>
</tbody>
</table>
</div>
<p>Here is an example to parse barcodes and reads with a predefined configure JSON file, the test files can be found at demo directory.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> PISA parse0 <span class="at">-config</span> demo/demo.json <span class="at">-report</span> demo/parse.csv demo/demo_1.fq.gz demo/demo_2.fq.gz <span class="op">&gt;</span> demo/demo.fq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h2 id="difference-between-pisa-and-cellranger" class="anchored">Difference between PISA and CellRanger</h2>
<h2 id="changelog" class="anchored">Changelog</h2>
<details>
<summary>
v1.3 2024/10/10
</summary>
<ul>
<li>Remove <code>-vcf-ss</code> option for <code>PISA anno</code>. Enable strand sensitive mode in default for genetic variant annotation.</li>
</ul>
</details>
<details>
<summary>
v1.2 2024/9/7
</summary>
<ul>
<li>Fix a bug of <code>PISA corr</code>. This bug was caused by the recent update to <code>dict.c</code>. The<code>PISA cor</code>r function was not updated accordingly. This issue will not influence the result.</li>
</ul>
</details>
<details>
<summary>
v1.1 2024/6/11
</summary>
<ul>
<li>-psi and -flatten added for <code>PISA anno</code>;</li>
<li>Add new tools <code>gtf2bed</code> and <code>flatten</code>.</li>
</ul>
</details>
<details>
<summary>
v1.0 2023/12/2
</summary>
<ul>
<li>EPT calling method added.</li>
<li><code>mergebed</code> and <code>annobed</code> for BED file added.</li>
<li>New parameters added to <code>anno</code>.</li>
</ul>
</details>
<details>
<summary>
v1.0a 2023/10/20
</summary>
<ul>
<li>Major update.</li>
<li>New <code>callept</code> method introduced. Check EPT paper for details.</li>
<li>New <code>mergebed</code> and <code>annobed</code> methods added.</li>
<li>New <code>-vcf-ss</code> and <code>-alt-ref</code> now added to <code>PISA anno</code></li>
<li><code>PISA count</code> can count bin and chromosome expression.</li>
</ul>
</details>
<details>
<summary>
v0.12 2022/06/18
</summary>
<ul>
<li>Fix the number of records in MEX file.</li>
</ul>
</details>
<details>
<summary>
v0.12b 2022/04/26
</summary>
<ul>
<li>Bugs fixed.</li>
<li>Change compress level of BGZF from 6 to 2, speed up few tools.</li>
<li>Now accept unorder GTFs</li>
<li>New tool <code>gtfmt</code> introduced to format a GTF file.</li>
<li>Add manual and FASTQ+ specification.</li>
</ul>
</details>
<details>
<summary>
v0.12a 2022/03/31
</summary>
<ul>
<li>Add <code>parse2</code>.</li>
</ul>
</details>
<details>
<summary>
v0.11a 2022/03/13
</summary>
<ul>
<li>Add <code>counts2</code>, count peaks X cells matrix from the fragment file.</li>
</ul>
</details>
<details>
<summary>
v0.10 2022/01/06
</summary>
<ul>
<li>Update <code>bam2frag</code>, export a fragment file compatible with 10X cellranger-ATAC.</li>
</ul>
</details>
<details>
<summary>
v0.10b 2021/12/09
</summary>
<ul>
<li><code>PISA count</code> now has <code>-velo</code> option to export unspliced and spliced matrix together. For velocity analysis, remember to use <code>-intron</code> to annotate reads.</li>
<li><code>PISA parse</code> support multi-threads.</li>
</ul>
</details>
<details>
<summary>
v0.10a 2021/11/06
</summary>
<ul>
<li><code>PISA count</code> support count spliced and unspliced reads.</li>
<li><code>PISA count</code> support count from multiple bam files.</li>
</ul>
</details>
<details>
<summary>
v0.9 2021/10/14
</summary>
<ul>
<li>Rewrite <code>rmdup</code>. Not support paired reads for now.</li>
</ul>
</details>
<details>
<summary>
v0.8 2021/07/20
</summary>
<ul>
<li>Reduce memory usage of <code>count</code></li>
<li>Fix region query bug of <code>anno -bed</code></li>
<li>Add <code>anno -vcf</code> method</li>
</ul>
</details>
<details>
<summary>
v0.7 2020/11/20
</summary>
<ul>
<li>Introduce the PCR deduplicate method <code>rmdup</code>.</li>
<li>Mask read and qual field as * instead of sequence for secondary alignments in the BAM file.</li>
</ul>
</details>
<details>
<summary>
v0.6 2020/10/29
</summary>
<ul>
<li><code>PISA attrcnt</code>, Skip secondary alignments before counting reads</li>
<li><code>PISA anno</code> fix segments fault bugs when loading malformed GTF</li>
</ul>
</details>
<details>
<summary>
v0.5 2020/08/27
</summary>
<ul>
<li>Add <code>PISA bam2frag</code> function (experimental).</li>
<li><code>PISA anno</code> Skip secondary alignments when counting total reads.</li>
</ul>
</details>
<details>
<summary>
v0.4 2020/07/14
</summary>
<ul>
<li><code>PISA sam2bam</code> add mapping quality adjustment method;</li>
<li>Rewrite UMI correction index structure to reduce memory use;</li>
<li>Fix bugs.</li>
</ul>
</details>
<details>
<summary>
v0.4alpha 2020/05/2
</summary>
<ul>
<li><code>PISA anno</code> use UCSC bin scheme instead of linear search for reads query gene regions. Fix the bug of misannotated antisense reads.</li>
<li><code>PISA count</code> use MEX output instead of plain cell vs gene table.</li>
</ul>
</details>
<details>
<summary>
v0.3 2020/03/26
</summary>
<p>Fix bugs and improve preformance.</p>
</details>
<details>
<summary>
0.0.0.9999 2019/05/19
</summary>
<p>Init version.</p>
</details>
<h2 id="todo-list" class="anchored">TODO list</h2>
<ul>
<li>Improve multi-threads performance.</li>
<li><s>Support Stereo-seq and Visium </s></li>
<li><s>Speed up <code>PISA count</code> and <code>PISA corr</code>.</s></li>
<li><em>Implement parse strategy for cell hash and CITEseq (frozen)</em>.</li>
<li><s>Assemble reads original from one molecule;</s></li>
<li><s>Implement new designed and more user-friendly <code>parse</code>;</s></li>
<li><em>Support loom output (frozen)</em>;</li>
<li><s>Export unspliced matrix for velocity;</s></li>
<li><s>Upgrade <code>PISA parse</code> for faster process fastqs.</s></li>
</ul>
<h2 id="reporting-issues" class="anchored">Reporting Issues</h2>
<p>If you have any suggestion or report issues, please using Github issues page <a href="https://github.com/shiquan/PISA/issues" class="uri">https://github.com/shiquan/PISA/issues</a>.</p>
<h2 id="citation" class="anchored">Citation</h2>
<p>Shi Q, Liu S, Kristiansen K, Liu L. The FASTQ+ format and PISA. Bioinformatics. 2022 Sep 30;38(19):4639-4642. doi: 10.1093/bioinformatics/btac562. PMID: 35993907.</p>



<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>