[
  {
    "objectID": "Yano_trajectory.html",
    "href": "Yano_trajectory.html",
    "title": "Spatial dissimilarity analysis for single-cell trajectories and supervised embeddings",
    "section": "",
    "text": "In the previous vignette, we performed cell clustering using unsupervised methods. Typically, a PCA or integrated space (e.g., Harmony) is generated during this process, and we then calculate the cell weight matrix directly from the cell embedding space. This approach is convenient for running the pipeline, and provide the general result in all cell population. Furthermore, for specific signaling or biological pathways, it is often more informative to focus on a ‘supervised’ cell ordering. This vignette demonstrates how to perform spatial dissimilarity test in low-dimensional spaces, such as cell trajectory.\n\nPrepare raw data\nWe used the human testis single-cell atlas dataset for this analysis. The full dataset is publicly available at GSE112013. For this vignette, we only used replicate 1.\n## We first download the BAM files and GTF file\nwget -c https://sra-pub-src-1.s3.amazonaws.com/SRR6860519/14515X1.bam.1 -O donor1_rep1.bam\nwget -c https://sra-pub-src-1.s3.amazonaws.com/SRR6860520/14606X1.bam.1 -O donor1_rep2.bam\n\n## Please Note: we use a different annotation file from previos vignette, because the BAM file use NCBI style chromosome name here.\nwget https://ftp.ensembl.org/pub/release-114/gtf/homo_sapiens/Homo_sapiens.GRCh38.114.chr.gtf.gz\n\n## Index the bam files for track plots\nsamtools index donor1_rep1.bam\nsamtools index donor1_rep2.bam\n\n## Then we use PISA to generate feature counts\nPISA anno -gtf Homo_sapiens.GRCh38.114.chr.gtf.gz -exon -psi -o d1_rep2_anno.bam donor1_rep2.bam\nPISA anno -gtf Homo_sapiens.GRCh38.114.chr.gtf.gz -exon -psi -o d1_rep1_anno.bam donor1_rep1.bam\n\nmkdir exp1\nmkdir exp2\nmkdir exon1\nmkdir exon2\nmkdir junction1\nmkdir junction2\nmkdir exclude1\nmkdir exclude2\n\nPISA count -tag CB -umi UB -anno-tag GN -outdir exp1 d1_rep1_anno.bam\nPISA count -tag CB -umi UB -anno-tag GN -outdir exp2 d1_rep2_anno.bam\nPISA count -tag CB -umi UB -anno-tag EX -outdir exon1 d1_rep1_anno.bam\nPISA count -tag CB -umi UB -anno-tag EX -outdir exon2 d1_rep2_anno.bam\nPISA count -tag CB -umi UB -anno-tag JC -outdir junction1 d1_rep1_anno.bam\nPISA count -tag CB -umi UB -anno-tag JC -outdir junction2 d1_rep2_anno.bam\n\n# Note: Although we generate the excluded reads here, we do not use them in this demonstration for the sake of simplicity. However, it is recommended to test them in real cases, so I’ve kept the data available for you to use in your own analyses.\nPISA count -tag CB -umi UB -anno-tag ER -outdir exclude1 d1_rep1_anno.bam\nPISA count -tag CB -umi UB -anno-tag ER -outdir exclude2 d1_rep2_anno.bam\n\n\nCell clustering and annotation\n\nrequire(Yano)\n\nexp1 &lt;- ReadPISA(\"exp1/\", prefix = \"d1-rep1-\")\nexp2 &lt;- ReadPISA(\"exp2/\", prefix = \"d1-rep2-\")\n\nexp &lt;- mergeMatrix(exp1, exp2)\n\nobj &lt;- QuickRecipe(exp, min.features = 800, min.cells = 100, resolution=0.2)\n\nWarning: Feature names cannot have underscores ('_'), replacing with dashes\n('-')\n\n\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 4400\nNumber of edges: 134553\n\nRunning Louvain algorithm...\nMaximum modularity in 10 random starts: 0.9639\nNumber of communities: 13\nElapsed time: 0 seconds\n\n\nWarning: The default method for RunUMAP has changed from calling Python UMAP via reticulate to the R-native UWOT using the cosine metric\nTo use Python UMAP via reticulate, set umap.method to 'umap-learn' and metric to 'correlation'\nThis message will be shown once per session\n\nrm(exp1, exp2, exp)\n\nobj$replicate &lt;- gsub(\"d1-(.*)-.*-1\", \"\\\\1\", colnames(obj))\nDimPlot(obj, label = TRUE, label.size = 5)\n\n\n\n\n\n\n\nFeaturePlot(obj, features = c(\"CD14\", \"VIM\", \"VWF\", \"ACTA2\", \"DLK1\", \"DAZL\", \"MAGEA4\", \"UTF1\", \"ID4\", \"FGFR3\", \"KIT\", \"DMRT1\", \"DMRTB1\", \"STRA8\", \"SYCP3\", \"SPO11\", \"MLH3\", \"ZPBP\", \"TNP1\", \"PRM2\"), ncol=5, order=TRUE) & NoAxes() & NoLegend()\n\nWarning: The `slot` argument of `FetchData()` is deprecated as of SeuratObject 5.0.0.\nℹ Please use the `layer` argument instead.\nℹ The deprecated feature was likely used in the Seurat package.\n  Please report the issue at &lt;https://github.com/satijalab/seurat/issues&gt;.\n\n\n\n\n\n\n\n\nnew.cluster.ids &lt;- c(\"Sperm\", \"Early primary S'cytes\", \"Leydig cells\", \"Round S'tids\", \"Differentiating S'gonia\", \"Elongated S'tids\", \"Endothelial cells\", \"SSCs\", \"Myoid cells\", \"Sertoli cells\", \"Macrophages\", \"Later primary S'cytes\", \"Sertoli-like\")\nnames(new.cluster.ids) &lt;- levels(obj)\nobj &lt;- RenameIdents(obj, new.cluster.ids)\nDimPlot(obj, reduction = \"umap\", label = TRUE, pt.size = 0.5) + NoLegend()\n\n\n\n\n\n\n\n\n\n\nCell development trajetory construction\nWe now select germline cells from the dataset and construct the cell development trajectory using a principal curve. Although there are many well-documented methods for constructing linear trajectories, here we use a straightforward and perhaps the simplest approach purely for demonstration purposes.\nsel &lt;- DimSelector(obj)\nobj.sel &lt;- obj[,sel]\n\n\nrequire(princurve)\n\nLoading required package: princurve\n\nemb &lt;- Embeddings(obj.sel, 'umap')\nemb0 &lt;- as.data.frame(emb)\nemb0$idents &lt;- Idents(obj)[rownames(emb0)]\nemb0 %&gt;% group_by(idents) %&gt;% summarize(x=median(umap_1),y=median(umap_2)) -&gt; emb1\nemb2 &lt;- as.matrix(emb1[,c(\"x\",\"y\")])\nrownames(emb2) &lt;- emb1$idents\nemb2 &lt;- emb2[c(\"SSCs\", \"Differentiating S'gonia\", \"Early primary S'cytes\", \"Later primary S'cytes\", \"Round S'tids\", \"Elongated S'tids\", \"Sperm\"),]\npc &lt;- princurve::principal_curve(x = emb, start = emb2)\ns &lt;- as.data.frame(pc$s)\ncolnames(s) &lt;- c(\"x\", \"y\")\nemb0 &lt;- cbind(emb0, s)\nemb0 &lt;- emb0[pc$ord, ]\n\nggplot(emb0)+ geom_point(aes(umap_1, umap_2, color = idents)) + geom_path(aes(x,y), color = \"blue\", linewidth=1)+ geom_point(data = emb2, aes(x, y), size=2) \n\n\n\n\n\n\n\n\n\n\nPerform alternative splicing analysis along the cell trajetory\n\ncells &lt;- colnames(obj.sel)\n\nexon1 &lt;- ReadPISA(\"exon1/\", prefix = \"d1-rep1-\", cells = cells)\nexon2 &lt;- ReadPISA(\"exon2/\", prefix = \"d1-rep2-\", cells = cells)\nexon &lt;- mergeMatrix(exon1, exon2)\n\njunction1 &lt;- ReadPISA(\"junction1/\", prefix = \"d1-rep1-\", cells = cells)\njunction2 &lt;- ReadPISA(\"junction2/\", prefix = \"d1-rep2-\", cells = cells)\njunction &lt;- mergeMatrix(junction1, junction2)\n\nobj.sel[['exon']] &lt;- CreateAssayObject(exon, min.cells = 100)\nobj.sel[['junction']] &lt;- CreateAssayObject(junction, min.cells = 100)\nrm(exon, exon1,exon2, junction, junction1, junction2)\n\norder.cells &lt;- rownames(emb0)\n\nDefaultAssay(obj.sel) &lt;- \"exon\"\nobj.sel &lt;- NormalizeData(obj.sel)\n\nWarning: The `slot` argument of `SetAssayData()` is deprecated as of SeuratObject 5.0.0.\nℹ Please use the `layer` argument instead.\nℹ The deprecated feature was likely used in the Seurat package.\n  Please report the issue at &lt;https://github.com/satijalab/seurat/issues&gt;.\n\n\nWarning: The `slot` argument of `GetAssayData()` is deprecated as of SeuratObject 5.0.0.\nℹ Please use the `layer` argument instead.\nℹ The deprecated feature was likely used in the Seurat package.\n  Please report the issue at &lt;https://github.com/satijalab/seurat/issues&gt;.\n\nobj.sel &lt;- ParseExonName(obj.sel)\n\nWhen setup order cells, the weight matrix name will be named to “trajectory_wm”.\n\nobj.sel &lt;- RunAutoCorr(obj.sel, order.cells = order.cells, wm.name = \"trajectory_wm\")\n\nWorking on assay : exon\n\n\nRun autocorrelation test for 72346 features.\n\n\nRuntime : 9.621753 secs\n\n\n58448 autocorrelated features.\n\nobj.sel &lt;- RunBlockCorr(obj.sel, wm.name = \"trajectory_wm\", bind.name = \"gene_name\", bind.assay = \"RNA\")\n\nWorking on assay exon.\n\n\nWorking on binding assay RNA.\n\n\nUse predefined weight matrix \"trajectory_wm\".\n\n\nProcessing 58448 features.\n\n\nProcessing 14246 binding features.\n\n\nRetrieve binding data from assay RNA.\n\n\nUse \"data\" layer for test features and binding features.\n\n\nUsing 7 threads.\n\n\nRuntime : 11.97247 mins.\n\nDefaultAssay(obj.sel) &lt;- \"junction\"\nobj.sel &lt;- NormalizeData(obj.sel)\nobj.sel &lt;- ParseExonName(obj.sel)\n\nWorking on assay junction\n\nobj.sel &lt;- RunAutoCorr(obj.sel, order.cells = order.cells, wm.name = \"trajectory_wm\")\n\nWorking on assay : junction\n\n\nRun autocorrelation test for 7583 features.\n\n\nRuntime : 1.558353 secs\n\n\n6466 autocorrelated features.\n\nobj.sel &lt;- RunBlockCorr(obj.sel, wm.name = \"trajectory_wm\", bind.name = \"gene_name\", bind.assay = \"RNA\")\n\nWorking on assay junction.\n\n\nWorking on binding assay RNA.\n\n\nUse predefined weight matrix \"trajectory_wm\".\n\n\nProcessing 6466 features.\n\n\nProcessing 3811 binding features.\n\n\nRetrieve binding data from assay RNA.\n\n\nUse \"data\" layer for test features and binding features.\n\n\nUsing 7 threads.\n\n\nRuntime : 1.419886 mins.\n\nFbtPlot(obj.sel, val = \"gene_name.padj\", assay = c(\"exon\", \"junction\"), shape.by = \"assay\", color.by = \"assay\")\n\n\n\n\n\n\n\nMeta(obj.sel, assay = \"exon\") %&gt;% filter(gene_name.padj &lt;1e-10) %&gt;% knitr::kable()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nchr\nstart\nend\ngene_name\nstrand\nmoransi.pval\nmoransi\nautocorr.variable\ngene_name.t\ngene_name.pval\ngene_name.padj\n\n\n\n\n1:211398036-211399220/+/LINC00467\n1\n211398036\n211399220\nLINC00467\n+\n0.00e+00\n0.0797745\nTRUE\n8.960026\n0\n0\n\n\n7:4984910-4985075/+/RBAK-RBAKDN\n7\n4984910\n4985075\nRBAK-RBAKDN\n+\n0.00e+00\n0.1330786\nTRUE\n9.834596\n0\n0\n\n\n7:74196642-74197050/+/EIF4H\n7\n74196642\n74197050\nEIF4H\n+\n0.00e+00\n0.1397753\nTRUE\n13.460503\n0\n0\n\n\n7:96645724-96645936/-/SEM1\n7\n96645724\n96645936\nSEM1\n-\n1.45e-05\n0.0494136\nTRUE\n9.409201\n0\n0\n\n\n7:96645390-96645932/-/SEM1\n7\n96645390\n96645932\nSEM1\n-\n0.00e+00\n0.0720516\nTRUE\n9.437117\n0\n0\n\n\n7:96645391-96645932/-/SEM1\n7\n96645391\n96645932\nSEM1\n-\n0.00e+00\n0.0748368\nTRUE\n9.336731\n0\n0\n\n\n7:96645588-96645936/-/SEM1\n7\n96645588\n96645936\nSEM1\n-\n0.00e+00\n0.0796474\nTRUE\n9.965071\n0\n0\n\n\n7:127591409-127591951/+/FSCN3\n7\n127591409\n127591951\nFSCN3\n+\n0.00e+00\n0.2950965\nTRUE\n14.584563\n0\n0\n\n\n\n\nMeta(obj.sel, assay = \"junction\") %&gt;% filter(gene_name.padj &lt;1e-10) %&gt;% knitr::kable()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nchr\nstart\nend\ngene_name\nstrand\nmoransi.pval\nmoransi\nautocorr.variable\ngene_name.t\ngene_name.pval\ngene_name.padj\n\n\n\n\n3:52414048-52414496/+/PHF7\n3\n52414048\n52414496\nPHF7\n+\n0\n0.133177\nTRUE\n9.968743\n0\n0\n\n\n\n\nFeaturePlot(obj.sel, features = c(\"3:52413996-52414048/+/PHF7\", \"3:52414048-52414496/+/PHF7\", \"PHF7\"), ncol=3, order=TRUE)\n\nWarning: Could not find 3:52413996-52414048/+/PHF7 in the default search\nlocations, found in 'exon' assay instead\n\n\nWarning: Could not find PHF7 in the default search locations, found in 'RNA'\nassay instead\n\n\n\n\n\n\n\n\n\n\n\nPerform alternative splicing analysis for all cell space\nTo use all cell space, we do not need to specify a name for the weight matrix here, because it will default to using the PCA reduction map to generate the weight matrix. The resulting matrix will be named “reduction_wm”.\n\nDefaultAssay(obj.sel) &lt;- \"exon\"\nobj.sel &lt;- RunAutoCorr(obj.sel)\n\nWorking on assay : exon\n\n\nRun autocorrelation test for 72346 features.\n\n\nRuntime : 20.68586 secs\n\n\n70882 autocorrelated features.\n\n\nNow we have two weight matrices. If no name is specified in RunBlockCorr(), the first matrix will always be used by default, so we need to explicitly specify “pca_wm” to avoid misusing the weight matrix here.\n\ngrep(\"_wm\", names(obj.sel), value=TRUE)\n\n[1] \"trajectory_wm\" \"pca_wm\"       \n\nobj.sel &lt;- RunBlockCorr(obj.sel, bind.name = \"gene_name\", bind.assay = \"RNA\", wm.name = \"pca_wm\", prefix=\"all\")\n\nWorking on assay exon.\n\n\nWorking on binding assay RNA.\n\n\nUse predefined weight matrix \"pca_wm\".\n\n\nProcessing 70882 features.\n\n\nProcessing 14246 binding features.\n\n\nRetrieve binding data from assay RNA.\n\n\nUse \"data\" layer for test features and binding features.\n\n\nUsing 7 threads.\n\n\nRuntime : 28.21338 mins.\n\nDefaultAssay(obj.sel) &lt;- \"junction\"\nobj.sel &lt;- RunAutoCorr(obj.sel)\n\nWorking on assay : junction\n\n\nRun autocorrelation test for 7583 features.\n\n\nRuntime : 2.483815 secs\n\n\n7545 autocorrelated features.\n\nobj.sel &lt;- RunBlockCorr(obj.sel, bind.name = \"gene_name\", bind.assay = \"RNA\", wm.name = \"pca_wm\", prefix=\"all\")\n\nWorking on assay junction.\n\n\nWorking on binding assay RNA.\n\n\nUse predefined weight matrix \"pca_wm\".\n\n\nProcessing 7545 features.\n\n\nProcessing 3811 binding features.\n\n\nRetrieve binding data from assay RNA.\n\n\nUse \"data\" layer for test features and binding features.\n\n\nUsing 7 threads.\n\n\nRuntime : 3.167435 mins.\n\n\nBy comparing the use of cell trajectory ordering with the PCA space, we found that using the PCA approach can detect more alternatively expressed genes. This is because forcing all cells into a 1D trajectory ordering preserves only the rank of each cell, but loses much of the neighborhood information about cells in the broader context. Since cell trajectories are typically constructed based on cell–cell distances in high-dimensional space, regardless of the algorithm used to build the trajectory, I personally recommend using the cell space directly rather than relying solely on 1D cell ordering, unless you have specific reasons or detailed knowledge.\n\nFbtPlot(obj.sel, val = \"all.padj\", assay = c(\"exon\", \"junction\"), shape.by = \"assay\", color.by = \"assay\")\n\n\n\n\n\n\n\nMeta(obj.sel, assay = \"exon\") %&gt;% filter(all.padj &lt;1e-20) %&gt;% knitr::kable()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nchr\nstart\nend\ngene_name\nstrand\nmoransi.pval\nmoransi\nautocorr.variable\ngene_name.t\ngene_name.pval\ngene_name.padj\nall.t\nall.pval\nall.padj\n\n\n\n\n1:25901491-25901682/-/STMN1\n1\n25901491\n25901682\nSTMN1\n-\n0\n0.5365729\nTRUE\n-0.7992579\n0.7869728\n1.0000000\n13.21821\n0\n0\n\n\n1:211398036-211399150/+/LINC00467\n1\n211398036\n211399150\nLINC00467\n+\n0\n0.0471558\nTRUE\n8.6032147\n0.0000000\n0.0000000\n14.10142\n0\n0\n\n\n1:211398036-211399220/+/LINC00467\n1\n211398036\n211399220\nLINC00467\n+\n0\n0.0489784\nTRUE\n8.9600263\n0.0000000\n0.0000000\n14.49493\n0\n0\n\n\n1:211398036-211399145/+/LINC00467\n1\n211398036\n211399145\nLINC00467\n+\n0\n0.0474023\nTRUE\n8.6223275\n0.0000000\n0.0000000\n14.15347\n0\n0\n\n\n1:244854973-244855044/-/HNRNPU\n1\n244854973\n244855044\nHNRNPU\n-\n0\n0.1066201\nTRUE\n-4.7022753\n0.9999958\n1.0000000\n14.75014\n0\n0\n\n\n1:244855424-244855608/-/HNRNPU\n1\n244855424\n244855608\nHNRNPU\n-\n0\n0.1499542\nTRUE\n-2.8217189\n0.9971134\n1.0000000\n16.89717\n0\n0\n\n\n1:244855424-244855597/-/HNRNPU\n1\n244855424\n244855597\nHNRNPU\n-\n0\n0.1448451\nTRUE\n-2.4163719\n0.9912460\n1.0000000\n16.16669\n0\n0\n\n\n1:244855424-244856096/-/HNRNPU\n1\n244855424\n244856096\nHNRNPU\n-\n0\n0.1290502\nTRUE\n-2.2955697\n0.9880950\n1.0000000\n15.76749\n0\n0\n\n\n10:35179134-35179769/+/CREM\n10\n35179134\n35179769\nCREM\n+\n0\n0.2795176\nTRUE\n6.3537107\n0.0000000\n0.0000079\n18.49192\n0\n0\n\n\n10:35179134-35179847/+/CREM\n10\n35179134\n35179847\nCREM\n+\n0\n0.2965156\nTRUE\n6.4506658\n0.0000000\n0.0000055\n19.27363\n0\n0\n\n\n10:35179134-35179843/+/CREM\n10\n35179134\n35179843\nCREM\n+\n0\n0.2963525\nTRUE\n6.4103138\n0.0000000\n0.0000063\n19.36009\n0\n0\n\n\n10:84371014-84372469/+/CCSER2\n10\n84371014\n84372469\nCCSER2\n+\n0\n0.0694474\nTRUE\n7.9171110\n0.0000000\n0.0000000\n14.02871\n0\n0\n\n\n11:10798992-10799113/-/EIF4G2\n11\n10798992\n10799113\nEIF4G2\n-\n0\n0.0653547\nTRUE\n3.7486258\n0.0001496\n0.1987880\n13.16633\n0\n0\n\n\n13:25349562-25349963/+/NUP58\n13\n25349562\n25349963\nNUP58\n+\n0\n0.0673922\nTRUE\n-4.2250674\n0.9999734\n1.0000000\n13.61898\n0\n0\n\n\n13:27622875-27623449/+/POLR1D\n13\n27622875\n27623449\nPOLR1D\n+\n0\n0.1353060\nTRUE\n3.6943987\n0.0001806\n0.2346310\n17.72233\n0\n0\n\n\n13:27622841-27623452/+/POLR1D\n13\n27622841\n27623452\nPOLR1D\n+\n0\n0.1352448\nTRUE\n3.7576058\n0.0001450\n0.1971341\n17.78757\n0\n0\n\n\n15:80131180-80131293/+/ZFAND6\n15\n80131180\n80131293\nZFAND6\n+\n0\n0.1415461\nTRUE\n2.5101809\n0.0068438\n1.0000000\n14.95305\n0\n0\n\n\n15:80137480-80137678/+/ZFAND6\n15\n80137480\n80137678\nZFAND6\n+\n0\n0.1506118\nTRUE\n2.7766824\n0.0032843\n1.0000000\n13.45450\n0\n0\n\n\n16:1883196-1883296/-/MEIOB\n16\n1883196\n1883296\nMEIOB\n-\n0\n0.1565362\nTRUE\n5.1270712\n0.0000007\n0.0014728\n14.18799\n0\n0\n\n\n16:1884097-1884294/-/MEIOB\n16\n1884097\n1884294\nMEIOB\n-\n0\n0.1760430\nTRUE\n4.8653746\n0.0000022\n0.0042026\n14.42375\n0\n0\n\n\n17:1345258-1345499/-/YWHAE\n17\n1345258\n1345499\nYWHAE\n-\n0\n0.0589847\nTRUE\n7.0735110\n0.0000000\n0.0000003\n14.17253\n0\n0\n\n\n17:75778810-75778963/-/H3-3B\n17\n75778810\n75778963\nH3-3B\n-\n0\n0.6555098\nTRUE\n-2.6202842\n0.9949154\n1.0000000\n14.34747\n0\n0\n\n\n17:75778810-75779184/-/H3-3B\n17\n75778810\n75779184\nH3-3B\n-\n0\n0.6255431\nTRUE\n-2.5937958\n0.9945343\n1.0000000\n13.51358\n0\n0\n\n\n17:82615718-82616025/-/WDR45B\n17\n82615718\n82616025\nWDR45B\n-\n0\n0.1523974\nTRUE\n-1.2576225\n0.8942566\n1.0000000\n15.59748\n0\n0\n\n\n18:49482152-49482410/-/RPL17-C18orf32\n18\n49482152\n49482410\nRPL17-C18orf32\n-\n0\n0.1626891\nTRUE\n2.9991263\n0.0017122\n1.0000000\n14.51277\n0\n0\n\n\n18:49482176-49482410/-/RPL17-C18orf32\n18\n49482176\n49482410\nRPL17-C18orf32\n-\n0\n0.1629240\nTRUE\n2.9661873\n0.0018897\n1.0000000\n14.35161\n0\n0\n\n\n18:49483584-49483771/-/RPL17-C18orf32\n18\n49483584\n49483771\nRPL17-C18orf32\n-\n0\n0.2033912\nTRUE\n2.5249051\n0.0065805\n1.0000000\n13.48824\n0\n0\n\n\n19:18309678-18309861/-/LSM4\n19\n18309678\n18309861\nLSM4\n-\n0\n0.1256588\nTRUE\n3.9306248\n0.0000785\n0.1119750\n13.31364\n0\n0\n\n\n19:23357696-23362725/-/ZNF91\n19\n23357696\n23362725\nZNF91\n-\n0\n0.0885371\nTRUE\n3.2359176\n0.0008247\n1.0000000\n13.77934\n0\n0\n\n\n2:61141592-61143945/-/C2orf74-AS1\n2\n61141592\n61143945\nC2orf74-AS1\n-\n0\n0.1129809\nTRUE\n7.0808615\n0.0000000\n0.0000003\n17.34218\n0\n0\n\n\n2:61143545-61143945/-/C2orf74-AS1\n2\n61143545\n61143945\nC2orf74-AS1\n-\n0\n0.0887566\nTRUE\n5.9691076\n0.0000000\n0.0000389\n14.61573\n0\n0\n\n\n2:61143543-61144266/-/C2orf74-AS1\n2\n61143543\n61144266\nC2orf74-AS1\n-\n0\n0.0886694\nTRUE\n5.9873356\n0.0000000\n0.0000386\n14.66861\n0\n0\n\n\n2:61143549-61143945/-/C2orf74-AS1\n2\n61143549\n61143945\nC2orf74-AS1\n-\n0\n0.0887566\nTRUE\n5.9691076\n0.0000000\n0.0000389\n14.61573\n0\n0\n\n\n3:45007420-45007575/+/EXOSC7\n3\n45007420\n45007575\nEXOSC7\n+\n0\n0.1241484\nTRUE\n1.1387188\n0.1287842\n1.0000000\n14.02988\n0\n0\n\n\n3:45011235-45011393/+/EXOSC7\n3\n45011235\n45011393\nEXOSC7\n+\n0\n0.1563919\nTRUE\n2.0895937\n0.0196089\n1.0000000\n16.35988\n0\n0\n\n\n3:45011235-45011471/+/EXOSC7\n3\n45011235\n45011471\nEXOSC7\n+\n0\n0.1772089\nTRUE\n2.5267252\n0.0065486\n1.0000000\n17.32798\n0\n0\n\n\n3:45011235-45011470/+/EXOSC7\n3\n45011235\n45011470\nEXOSC7\n+\n0\n0.1777901\nTRUE\n2.6478939\n0.0047130\n1.0000000\n17.54029\n0\n0\n\n\n3:52413996-52414048/+/PHF7\n3\n52413996\n52414048\nPHF7\n+\n0\n0.1410946\nTRUE\n7.4297447\n0.0000000\n0.0000001\n15.73955\n0\n0\n\n\n3:52414496-52414844/+/PHF7\n3\n52414496\n52414844\nPHF7\n+\n0\n0.1455321\nTRUE\n8.1524615\n0.0000000\n0.0000000\n15.76698\n0\n0\n\n\n5:28810519-28810897/+/LINC02109\n5\n28810519\n28810897\nLINC02109\n+\n0\n0.1095984\nTRUE\n4.7385760\n0.0000036\n0.0065834\n14.79149\n0\n0\n\n\n5:28810550-28810903/+/LINC02109\n5\n28810550\n28810903\nLINC02109\n+\n0\n0.0895162\nTRUE\n3.2672818\n0.0007465\n0.9283249\n13.27736\n0\n0\n\n\n7:2234198-2235564/-/ENSG00000286192\n7\n2234198\n2235564\nENSG00000286192\n-\n0\n0.1514527\nTRUE\n2.4989783\n0.0070504\n1.0000000\n14.05543\n0\n0\n\n\n7:4983718-4983773/+/RBAK-RBAKDN\n7\n4983718\n4983773\nRBAK-RBAKDN\n+\n0\n0.0914201\nTRUE\n6.7731463\n0.0000000\n0.0000013\n13.46936\n0\n0\n\n\n7:4984910-4985075/+/RBAK-RBAKDN\n7\n4984910\n4985075\nRBAK-RBAKDN\n+\n0\n0.1729539\nTRUE\n9.8345955\n0.0000000\n0.0000000\n22.70183\n0\n0\n\n\n7:74196642-74197050/+/EIF4H\n7\n74196642\n74197050\nEIF4H\n+\n0\n0.1499599\nTRUE\n13.4605033\n0.0000000\n0.0000000\n24.10042\n0\n0\n\n\n7:92244902-92245171/-/ENSG00000285953\n7\n92244902\n92245171\nENSG00000285953\n-\n0\n0.1247589\nTRUE\n3.0311662\n0.0015545\n1.0000000\n13.36004\n0\n0\n\n\n7:92244002-92244149/-/ENSG00000285953\n7\n92244002\n92244149\nENSG00000285953\n-\n0\n0.2155620\nTRUE\n4.7410539\n0.0000036\n0.0065834\n17.06790\n0\n0\n\n\n7:92244902-92245134/-/ENSG00000285953\n7\n92244902\n92245134\nENSG00000285953\n-\n0\n0.1772488\nTRUE\n4.0354096\n0.0000537\n0.0785030\n15.03518\n0\n0\n\n\n7:96645724-96645936/-/SEM1\n7\n96645724\n96645936\nSEM1\n-\n0\n0.0720968\nTRUE\n9.4092010\n0.0000000\n0.0000000\n17.10629\n0\n0\n\n\n7:96645390-96645932/-/SEM1\n7\n96645390\n96645932\nSEM1\n-\n0\n0.0827188\nTRUE\n9.4371173\n0.0000000\n0.0000000\n16.84536\n0\n0\n\n\n7:96645391-96645932/-/SEM1\n7\n96645391\n96645932\nSEM1\n-\n0\n0.0817727\nTRUE\n9.3367314\n0.0000000\n0.0000000\n16.81729\n0\n0\n\n\n7:96645588-96645936/-/SEM1\n7\n96645588\n96645936\nSEM1\n-\n0\n0.0857761\nTRUE\n9.9650711\n0.0000000\n0.0000000\n17.34514\n0\n0\n\n\n7:96645724-96645932/-/SEM1\n7\n96645724\n96645932\nSEM1\n-\n0\n0.0615317\nTRUE\n8.1064788\n0.0000000\n0.0000000\n14.73627\n0\n0\n\n\n7:127591409-127591951/+/FSCN3\n7\n127591409\n127591951\nFSCN3\n+\n0\n0.3332084\nTRUE\n14.5845629\n0.0000000\n0.0000000\n30.00146\n0\n0\n\n\n8:101198726-101199239/-/ZNF706\n8\n101198726\n101199239\nZNF706\n-\n0\n0.1575763\nTRUE\n2.6305174\n0.0049439\n1.0000000\n16.45881\n0\n0\n\n\n8:124579578-124580637/+/NDUFB9\n8\n124579578\n124580637\nNDUFB9\n+\n0\n0.1533252\nTRUE\n2.1165144\n0.0184042\n1.0000000\n13.22148\n0\n0\n\n\n8:124579578-124580648/+/NDUFB9\n8\n124579578\n124580648\nNDUFB9\n+\n0\n0.1536218\nTRUE\n2.1284192\n0.0178922\n1.0000000\n13.25118\n0\n0\n\n\n9:79571941-79572835/+/TLE4\n9\n79571941\n79572835\nTLE4\n+\n0\n0.3425540\nTRUE\n1.6940251\n0.0467022\n1.0000000\n14.59999\n0\n0\n\n\n9:79571965-79572835/+/TLE4\n9\n79571965\n79572835\nTLE4\n+\n0\n0.3129983\nTRUE\n1.3884364\n0.0840602\n1.0000000\n13.50719\n0\n0\n\n\n9:124858458-124858537/-/RPL35\n9\n124858458\n124858537\nRPL35\n-\n0\n0.3502975\nTRUE\n3.0339673\n0.0015414\n1.0000000\n16.62285\n0\n0\n\n\n9:128500067-128501292/+/ODF2\n9\n128500067\n128501292\nODF2\n+\n0\n0.0466525\nTRUE\n8.7278912\n0.0000000\n0.0000000\n15.07683\n0\n0\n\n\n9:128500067-128501260/+/ODF2\n9\n128500067\n128501260\nODF2\n+\n0\n0.0466525\nTRUE\n8.7278912\n0.0000000\n0.0000000\n15.07683\n0\n0\n\n\n9:128500067-128500960/+/ODF2\n9\n128500067\n128500960\nODF2\n+\n0\n0.0458747\nTRUE\n8.6377721\n0.0000000\n0.0000000\n14.81459\n0\n0\n\n\n\n\nMeta(obj.sel, assay = \"junction\") %&gt;% filter(all.padj &lt;1e-20) %&gt;% knitr::kable()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nchr\nstart\nend\ngene_name\nstrand\nmoransi.pval\nmoransi\nautocorr.variable\ngene_name.t\ngene_name.pval\ngene_name.padj\nall.t\nall.pval\nall.padj\n\n\n\n\n1:244855044-244855424/-/HNRNPU\n1\n244855044\n244855424\nHNRNPU\n-\n0\n0.1372512\nTRUE\n-3.314295\n0.9993578\n1.0000000\n16.00218\n0\n0\n\n\n19:18307555-18309678/-/LSM4\n19\n18307555\n18309678\nLSM4\n-\n0\n0.1389093\nTRUE\n3.939400\n0.0000761\n0.0820182\n13.71596\n0\n0\n\n\n3:45007575-45011235/+/EXOSC7\n3\n45007575\n45011235\nEXOSC7\n+\n0\n0.1611300\nTRUE\n3.981837\n0.0000653\n0.0820182\n17.02165\n0\n0\n\n\n3:52412920-52413996/+/PHF7\n3\n52412920\n52413996\nPHF7\n+\n0\n0.1512534\nTRUE\n8.193898\n0.0000000\n0.0000000\n17.45568\n0\n0\n\n\n3:52414048-52414496/+/PHF7\n3\n52414048\n52414496\nPHF7\n+\n0\n0.1885870\nTRUE\n9.968743\n0.0000000\n0.0000000\n18.29820\n0\n0\n\n\n7:4983773-4984910/+/RBAK-RBAKDN\n7\n4983773\n4984910\nRBAK-RBAKDN\n+\n0\n0.1228286\nTRUE\n7.639434\n0.0000000\n0.0000000\n15.63948\n0\n0\n\n\n9:124858067-124858458/-/RPL35\n9\n124858067\n124858458\nRPL35\n-\n0\n0.3729386\nTRUE\n2.641968\n0.0047906\n1.0000000\n16.15946\n0\n0\n\n\n\n\n\n\n\nPerform alternative splicing on a supervised two dimension space\nWe can also perform the analysis using a supervised two-dimensional cell space. As an example, we utilize Seurat’s built-in cell cycle scoring scheme for demonstration purposes.\n\nDefaultAssay(obj.sel) &lt;- \"RNA\"\n\ns.genes &lt;- cc.genes$s.genes\ng2m.genes &lt;- cc.genes$g2m.genes\n\nobj.sel[['Group']] &lt;- Idents(obj.sel)\nobj.sel &lt;- CellCycleScoring(obj.sel, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)\n\nWarning: The following features are not present in the object: MLF1IP, E2F8,\nnot searching for symbol synonyms\n\n\nWarning: The following features are not present in the object: FAM64A, AURKB,\nHN1, not searching for symbol synonyms\n\ndf &lt;- obj.sel[[]]\n\np1 &lt;- ggplot(df) + geom_point(aes(x=S.Score, y = G2M.Score, color = Phase))\np2 &lt;- ggplot(df) + geom_point(aes(x=S.Score, y = G2M.Score, color = Group))\np1 + p2\n\n\n\n\n\n\n\n# Create cell cycle coordinate space with the module scores\nccc &lt;- as.matrix(df[, c(\"S.Score\", \"G2M.Score\")])\nhead(ccc)\n\n                              S.Score   G2M.Score\nd1-rep1-GACAGAGTCATACGGT-1 0.37908301  0.27462393\nd1-rep1-GCTCCTATCATCGCTC-1 0.40969930  0.24794880\nd1-rep1-GTAGTCATCCGAACGC-1 0.06002289  0.09029104\nd1-rep1-TTTCCTCCACTATCTT-1 0.37392161  0.02509706\nd1-rep1-TACGGTAGTAAGGGCT-1 0.51073399  0.28205031\nd1-rep1-AGGGTGAAGATATGCA-1 0.24597679 -0.02650419\n\ncolnames(ccc) &lt;- c(\"CCC_1\", \"CCC_2\")\n\nobj.sel[['ccc']] &lt;- CreateDimReducObject(embeddings = ccc, assay = \"RNA\")\n\nDefaultAssay(obj.sel) &lt;- \"exon\"\nobj.sel &lt;- RunAutoCorr(obj.sel, reduction = \"ccc\", wm.name = \"ccc_wm\", dims=1:2)\n\nWorking on assay : exon\n\n\nRun autocorrelation test for 72346 features.\n\n\nRuntime : 17.12698 secs\n\n\n60820 autocorrelated features.\n\nobj.sel &lt;- RunBlockCorr(obj.sel, wm.name = \"ccc_wm\", bind.name = \"gene_name\", bind.assay = \"RNA\", prefix = \"ccc\")\n\nWorking on assay exon.\n\n\nWorking on binding assay RNA.\n\n\nUse predefined weight matrix \"ccc_wm\".\n\n\nProcessing 60820 features.\n\n\nProcessing 14246 binding features.\n\n\nRetrieve binding data from assay RNA.\n\n\nUse \"data\" layer for test features and binding features.\n\n\nUsing 7 threads.\n\n\nRuntime : 18.68082 mins.\n\nDefaultAssay(obj.sel) &lt;- \"junction\"\nobj.sel &lt;- RunAutoCorr(obj.sel, reduction = \"ccc\", wm.name = \"ccc_wm\", dims=1:2)\n\nWorking on assay : junction\n\n\nRun autocorrelation test for 7583 features.\n\n\nRuntime : 1.842182 secs\n\n\n6884 autocorrelated features.\n\nobj.sel &lt;- RunBlockCorr(obj.sel, wm.name = \"ccc_wm\", bind.name = \"gene_name\", bind.assay = \"RNA\", prefix = \"ccc\")\n\nWorking on assay junction.\n\n\nWorking on binding assay RNA.\n\n\nUse predefined weight matrix \"ccc_wm\".\n\n\nProcessing 6884 features.\n\n\nProcessing 3811 binding features.\n\n\nRetrieve binding data from assay RNA.\n\n\nUse \"data\" layer for test features and binding features.\n\n\nUsing 7 threads.\n\n\nRuntime : 2.118045 mins.\n\nFbtPlot(obj.sel, val = \"ccc.padj\", assay = c(\"exon\", \"junction\"), shape.by = \"assay\", color.by = \"assay\")\n\n\n\n\n\n\n\nMeta(obj.sel, assay = \"exon\") %&gt;% filter(ccc.padj&lt;1e-30) %&gt;% knitr::kable()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nchr\nstart\nend\ngene_name\nstrand\nmoransi.pval\nmoransi\nautocorr.variable\ngene_name.t\ngene_name.pval\ngene_name.padj\nall.t\nall.pval\nall.padj\nccc.t\nccc.pval\nccc.padj\n\n\n\n\n10:35179134-35179769/+/CREM\n10\n35179134\n35179769\nCREM\n+\n0\n0.1660249\nTRUE\n6.353711\n0\n7.9e-06\n18.49192\n0\n0\n21.95846\n0\n0\n\n\n10:35179134-35179847/+/CREM\n10\n35179134\n35179847\nCREM\n+\n0\n0.1783511\nTRUE\n6.450666\n0\n5.5e-06\n19.27363\n0\n0\n23.25739\n0\n0\n\n\n10:35179134-35179843/+/CREM\n10\n35179134\n35179843\nCREM\n+\n0\n0.1765705\nTRUE\n6.410314\n0\n6.3e-06\n19.36009\n0\n0\n23.14168\n0\n0\n\n\n7:74196642-74197050/+/EIF4H\n7\n74196642\n74197050\nEIF4H\n+\n0\n0.0903061\nTRUE\n13.460503\n0\n0.0e+00\n24.10042\n0\n0\n21.33564\n0\n0\n\n\n7:127591409-127591951/+/FSCN3\n7\n127591409\n127591951\nFSCN3\n+\n0\n0.1644589\nTRUE\n14.584563\n0\n0.0e+00\n30.00146\n0\n0\n24.91348\n0\n0\n\n\n\n\nFeaturePlot(obj.sel, reduction =  \"ccc\", features = c(\"7:74196642-74197050/+/EIF4H\", \"EIF4H\"), order = TRUE)\n\nWarning: Could not find 7:74196642-74197050/+/EIF4H in the default search\nlocations, found in 'exon' assay instead\n\n\nWarning: Could not find EIF4H in the default search locations, found in 'RNA'\nassay instead\n\n\n\n\n\n\n\n\n\n\ngtf &lt;- gtf2db(\"./Homo_sapiens.GRCh38.114.chr.gtf.gz\")\n\n[2025-06-13 23:16:23] GTF loading..\n[2025-06-13 23:16:51] Load 78686 genes.\n\nbamfiles &lt;- list(rep1 = \"./donor1_rep1.bam\", rep2 = \"./donor1_rep2.bam\")\ncell.list &lt;- split(obj.sel$Phase, obj.sel$replicate)\n\ncell.list1 &lt;- lapply(cell.list, function(x) {\n  nm &lt;- names(x)\n  names(x) &lt;- gsub(\".*rep[12]-(.*)\",\"\\\\1\",nm)\n  x\n})\nstr(cell.list1)\n\nList of 2\n $ rep1: Named chr [1:954] \"S\" \"S\" \"G2M\" \"S\" ...\n  ..- attr(*, \"names\")= chr [1:954] \"GACAGAGTCATACGGT-1\" \"GCTCCTATCATCGCTC-1\" \"GTAGTCATCCGAACGC-1\" \"TTTCCTCCACTATCTT-1\" ...\n $ rep2: Named chr [1:2023] \"S\" \"S\" \"S\" \"S\" ...\n  ..- attr(*, \"names\")= chr [1:2023] \"GGCTCGACATGTCTCC-1\" \"CCTATTAGTCCAGTAT-1\" \"GTAACGTCACTTACGA-1\" \"AAGGCAGCACGTCTCT-1\" ...\n\nTrackPlot(bamfile = bamfiles, cell.group = cell.list1, gtf = gtf, gene = \"EIF4H\", highlights = c(74196642,74197050), junc=TRUE)\n\n\n\n\n\n\n\n\n\nCommand(obj.sel)\n\n [1] \"NormalizeData.RNA\"            \"FindVariableFeatures.RNA\"    \n [3] \"ScaleData.RNA\"                \"RunPCA.RNA\"                  \n [5] \"FindNeighbors.RNA.pca\"        \"FindClusters\"                \n [7] \"RunUMAP.RNA.pca\"              \"NormalizeData.exon\"          \n [9] \"ParseExonName.exon\"           \"NormalizeData.junction\"      \n[11] \"ParseExonName.junction\"       \"RunAutoCorr.exon.pca\"        \n[13] \"RunAutoCorr.junction.pca\"     \"RunAutoCorr.exon.ccc\"        \n[15] \"SetAutoCorrFeatures.exon\"     \"RunBlockCorr.exon\"           \n[17] \"RunAutoCorr.junction.ccc\"     \"SetAutoCorrFeatures.junction\"\n[19] \"RunBlockCorr.junction\"       \n\nsessionInfo()\n\nR version 4.5.0 (2025-04-11)\nPlatform: aarch64-apple-darwin24.4.0\nRunning under: macOS Sequoia 15.5\n\nMatrix products: default\nBLAS:   /opt/homebrew/Cellar/openblas/0.3.29/lib/libopenblasp-r0.3.29.dylib \nLAPACK: /opt/homebrew/Cellar/r/4.5.0/lib/R/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Asia/Shanghai\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] princurve_2.1.6    future_1.49.0      dplyr_1.1.4        Seurat_5.3.0      \n[5] SeuratObject_5.1.0 sp_2.2-0           ggplot2_3.5.2      Yano_1.1          \n\nloaded via a namespace (and not attached):\n  [1] deldir_2.0-4           pbapply_1.7-2          gridExtra_2.3         \n  [4] rlang_1.1.6            magrittr_2.0.3         RcppAnnoy_0.0.22      \n  [7] spatstat.geom_3.3-6    matrixStats_1.5.0      ggridges_0.5.6        \n [10] compiler_4.5.0         png_0.1-8              vctrs_0.6.5           \n [13] reshape2_1.4.4         stringr_1.5.1          pkgconfig_2.0.3       \n [16] fastmap_1.2.0          labeling_0.4.3         promises_1.3.2        \n [19] rmarkdown_2.29         purrr_1.0.4            xfun_0.52             \n [22] jsonlite_2.0.0         goftest_1.2-3          later_1.4.2           \n [25] spatstat.utils_3.1-4   irlba_2.3.5.1          parallel_4.5.0        \n [28] cluster_2.1.8.1        R6_2.6.1               ica_1.0-3             \n [31] stringi_1.8.7          RColorBrewer_1.1-3     spatstat.data_3.1-6   \n [34] reticulate_1.42.0      spatstat.univar_3.1-3  parallelly_1.44.0     \n [37] lmtest_0.9-40          scattermore_1.2        Rcpp_1.0.14           \n [40] knitr_1.50             tensor_1.5             future.apply_1.11.3   \n [43] zoo_1.8-14             R.utils_2.13.0         sctransform_0.4.2     \n [46] httpuv_1.6.16          Matrix_1.7-3           splines_4.5.0         \n [49] igraph_2.1.4           tidyselect_1.2.1       viridis_0.6.5         \n [52] abind_1.4-8            yaml_2.3.10            spatstat.random_3.3-3 \n [55] codetools_0.2-20       miniUI_0.1.2           spatstat.explore_3.4-2\n [58] listenv_0.9.1          lattice_0.22-6         tibble_3.2.1          \n [61] plyr_1.8.9             withr_3.0.2            shiny_1.10.0          \n [64] ROCR_1.0-11            evaluate_1.0.3         Rtsne_0.17            \n [67] fastDummies_1.7.5      survival_3.8-3         polyclip_1.10-7       \n [70] fitdistrplus_1.2-2     pillar_1.10.2          KernSmooth_2.23-26    \n [73] plotly_4.10.4          generics_0.1.4         RcppHNSW_0.6.0        \n [76] scales_1.4.0           gtools_3.9.5           globals_0.18.0        \n [79] xtable_1.8-4           glue_1.8.0             lazyeval_0.2.2        \n [82] tools_4.5.0            data.table_1.17.2      RSpectra_0.16-2       \n [85] RANN_2.6.2             dotCall64_1.2          cowplot_1.1.3         \n [88] grid_4.5.0             tidyr_1.3.1            nlme_3.1-168          \n [91] patchwork_1.3.0        cli_3.6.5              spatstat.sparse_3.1-0 \n [94] spam_2.11-1            viridisLite_0.4.2      uwot_0.2.3            \n [97] gtable_0.3.6           R.methodsS3_1.8.2      digest_0.6.37         \n[100] progressr_0.15.1       ggrepel_0.9.6          htmlwidgets_1.6.4     \n[103] farver_2.1.2           htmltools_0.5.8.1      R.oo_1.27.1           \n[106] lifecycle_1.0.4        httr_1.4.7             mime_0.13             \n[109] MASS_7.3-65           \n\n\n\n\n\n\n Back to top",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Cell trajectory analysis"
    ]
  },
  {
    "objectID": "Yano.html",
    "href": "Yano.html",
    "title": "Yano",
    "section": "",
    "text": "Yano represents an R/C toolkit designed for conducting spatial dissimilarity analysis on single-cell RNA sequencing data. This method revolves around the core concept of examining the distinct expression patterns of a given feature (e.g. exon, snp allele) in relation to its associated binding feature (typically a gene or another allele at the same genomic locus) within the context of cell lineage (1D), spatial position (2D), or the multi-dimensional PCA space. The discernible differences in feature expression patterns and their binding features provide insights into a range of biological phenomena, including alternative splicing, cis-antisense RNA regulation, allele-specific gene expression, and more.\nYano is seamlessly integrated with Seurat, building upon the Seurat object’s framework. Users can perform conventional cell clustering analyses using the state-of-the-art Seurat pipeline and then incorporate exon, SNP counts as new “assays” within the Seurat objects. Subsequently, Yano facilitates the assessment of spatial dissimilarity between these two assays. For more details about the method, please refer to our manuscript."
  },
  {
    "objectID": "Yano.html#introduction",
    "href": "Yano.html#introduction",
    "title": "Yano",
    "section": "",
    "text": "Yano represents an R/C toolkit designed for conducting spatial dissimilarity analysis on single-cell RNA sequencing data. This method revolves around the core concept of examining the distinct expression patterns of a given feature (e.g. exon, snp allele) in relation to its associated binding feature (typically a gene or another allele at the same genomic locus) within the context of cell lineage (1D), spatial position (2D), or the multi-dimensional PCA space. The discernible differences in feature expression patterns and their binding features provide insights into a range of biological phenomena, including alternative splicing, cis-antisense RNA regulation, allele-specific gene expression, and more.\nYano is seamlessly integrated with Seurat, building upon the Seurat object’s framework. Users can perform conventional cell clustering analyses using the state-of-the-art Seurat pipeline and then incorporate exon, SNP counts as new “assays” within the Seurat objects. Subsequently, Yano facilitates the assessment of spatial dissimilarity between these two assays. For more details about the method, please refer to our manuscript."
  },
  {
    "objectID": "Yano.html#install",
    "href": "Yano.html#install",
    "title": "Yano",
    "section": "INSTALL",
    "text": "INSTALL\nif (!require(\"BiocManager\")) install.packages('BiocManager') \nBiocManager::install(\"shiquan/Yano\")\nNotice: Multithread mode is disabled on macOS by default due to the lack of OpenMP support. However, data.table provides a useful tutorial on how to enable OpenMP on macOS. For more information, please refer to this guide: https://github.com/Rdatatable/data.table/wiki/Installation#enable-openmp-for-macos."
  },
  {
    "objectID": "Yano.html#get-started",
    "href": "Yano.html#get-started",
    "title": "Yano",
    "section": "Get started",
    "text": "Get started\nA typical workflow with Yano starts by using a built-in dataset.\n\nrequire(Yano)\ndata(\"glbt_small\")\nDefaultAssay(glbt_small) &lt;- \"RNA\"\nglbt_small &lt;- NormalizeData(glbt_small) %&gt;% RunUMAP(dim = 1:20)\n\nDimPlot(glbt_small, label = TRUE, label.size = 5)\n\n\n\n\n\n\n\nDefaultAssay(glbt_small) &lt;- \"exon\"\nglbt_small &lt;- NormalizeData(glbt_small)\nglbt_small &lt;- ParseExonName(glbt_small)\ngrep(\"_wm$\",names(glbt_small), value=TRUE)\n\ncharacter(0)\n\nglbt_small &lt;- RunAutoCorr(glbt_small)\ngrep(\"_wm$\",names(glbt_small), value=TRUE)\n\n[1] \"pca_wm\"\n\nglbt_small &lt;- RunBlockCorr(glbt_small, bind.name = \"gene_name\", bind.assay = \"RNA\")\n\n# Manhattan plot for spatial dissimilarity test result\nFbtPlot(glbt_small, val = \"gene_name.padj\")\n\n\n\n\n\n\n\nFeaturePlot(glbt_small, features = c(\"chr19:16095264-16095454/+/TPM4\", \"TPM4\"), order=TRUE)\n\n\n\n\n\n\n\n# Track plot for gene coverage at different cell types\ndb &lt;- gtf2db(\"./gencode.v44.annotation.gtf.gz\")\n\n[2025-06-02 21:53:40] GTF loading..\n[2025-06-02 21:54:02] Load 62700 genes.\n\nTrackPlot(bamfile=\"./Parent_SC3v3_Human_Glioblastoma_possorted_genome_bam.bam\", gtf =db, gene = \"TPM4\", junc = TRUE, cell.group = Idents(glbt_small), highlights = c(16095264,16095454))\n\n\n\n\n\n\n\n\nSee short cases for more details."
  },
  {
    "objectID": "Yano.html#short-cases",
    "href": "Yano.html#short-cases",
    "title": "Yano",
    "section": "Short cases",
    "text": "Short cases\n\nAlternative splicing analysis for scRNA-seq\nAllele-specific gene expression analysis for scRNA-seq\nAnnotating and prioritizing genetic variants for scRNA-seq\nPerform alternative splicing analysis for multiple Visium samples\nSelect cells from reduction maps\nPerform alternative splicing analysis for cell trajectory and user-defined embeddings"
  },
  {
    "objectID": "Yano.html#changelog",
    "href": "Yano.html#changelog",
    "title": "Yano",
    "section": "Changelog",
    "text": "Changelog\n\n\n1.1 2025/06/02\n\nSimplified parameters for RunBlockCorr() to streamlines the function and makes it more concise. In addition, new selector functions, *Selector(), introduced.\n\n\n\n1.0 2025/02/19\n\nFirst stable release.\n\n\n\n0.0.0.9999 2023/03/22\n\nInit version."
  },
  {
    "objectID": "Yano.html#issues-or-questions",
    "href": "Yano.html#issues-or-questions",
    "title": "Yano",
    "section": "Issues or questions",
    "text": "Issues or questions\n\nhttps://github.com/shiquan/Yano/issues\nhttps://github.com/shiquan/Yano/discussions"
  },
  {
    "objectID": "Yano_ASE.html",
    "href": "Yano_ASE.html",
    "title": "Alelle specific gene expression analysis for single cell RNA sequencing",
    "section": "",
    "text": "This vignette uses gene and single nucleotide variant (SNV) expression files generated from the Annotate Various Features for Alignment.",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Allele-specific gene expression analysis"
    ]
  },
  {
    "objectID": "Yano_ASE.html#perform-cell-clustering-with-seurat",
    "href": "Yano_ASE.html#perform-cell-clustering-with-seurat",
    "title": "Alelle specific gene expression analysis for single cell RNA sequencing",
    "section": "0. Perform cell clustering with Seurat",
    "text": "0. Perform cell clustering with Seurat\nWe begin by performing cell clustering based on gene expression, which is identical to the first step outlined in the Alternative splicing analysis for scRNA-seq. If you’re continuing from the previous vignette, you are free to skip this section.\n\nrequire(Yano)\n\nLoading required package: Yano\n\n\n── Attaching packages ────────────────────────────────────────────── Yano 1.1 ──\n✔ dplyr   1.1.4     ✔ Seurat  5.3.0\n✔ ggplot2 3.5.2     \n\nexp &lt;- ReadPISA(\"./exp/\")\n\nobj &lt;- CreateSeuratObject(exp, min.features = 1000, min.cells = 10)\nobj[[\"percent.mt\"]] &lt;- PercentageFeatureSet(obj, pattern = \"^MT-\")\nobj &lt;- subset(obj, nFeature_RNA &lt; 9000 & percent.mt &lt; 20)\n\n# Downsampling to 2000 cells for fast testing\nobj &lt;- obj[, sample(colnames(obj),2000)]\n\n# To improve visualization, we reduced the resolution when identifying cell clusters.\nobj &lt;- NormalizeData(obj) %&gt;% FindVariableFeatures() %&gt;% ScaleData() %&gt;%  RunPCA(verbose=FALSE) %&gt;% FindNeighbors(dims = 1:10, verbose=FALSE) %&gt;% FindClusters(resolution = 0.1, verbose=FALSE) %&gt;% RunUMAP(dims=1:10, verbose=FALSE)\n\nNormalizing layer: counts\nFinding variable features for layer counts\nCentering and scaling data matrix\n\nDimPlot(obj, label=TRUE, label.size = 5, label.box = TRUE)",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Allele-specific gene expression analysis"
    ]
  },
  {
    "objectID": "Yano_ASE.html#perform-allele-specific-gene-expression-analysis-by-using-snv-anchors",
    "href": "Yano_ASE.html#perform-allele-specific-gene-expression-analysis-by-using-snv-anchors",
    "title": "Alelle specific gene expression analysis for single cell RNA sequencing",
    "section": "1. Perform allele-specific gene expression analysis by using SNV anchors",
    "text": "1. Perform allele-specific gene expression analysis by using SNV anchors\nIn this vignette, when a genetic variant is detected, all possible alleles at that location, including both alternative alleles and the reference allele, are annotated and counted. Therefore, genetic variants refer to both alternative alleles and the reference allele in this context.\n\nvar &lt;- ReadPISA(\"./var\")\nobj[['var']] &lt;- CreateAssayObject(var[,colnames(obj)], min.cells = 10)\n# Switch working assay to 'var'\nDefaultAssay(obj) &lt;- \"var\"\n\nobj &lt;- NormalizeData(obj)\n\nWarning: The `slot` argument of `SetAssayData()` is deprecated as of SeuratObject 5.0.0.\nℹ Please use the `layer` argument instead.\nℹ The deprecated feature was likely used in the Seurat package.\n  Please report the issue at &lt;https://github.com/satijalab/seurat/issues&gt;.\n\n\nWarning: The `slot` argument of `GetAssayData()` is deprecated as of SeuratObject 5.0.0.\nℹ Please use the `layer` argument instead.\nℹ The deprecated feature was likely used in the Seurat package.\n  Please report the issue at &lt;https://github.com/satijalab/seurat/issues&gt;.\n\n# you can skip to read GTF again if you already load it\ngtf &lt;- gtf2db(\"./gencode.v44.annotation.gtf.gz\")\n\n[2025-06-02 15:40:10] GTF loading..\n[2025-06-02 15:41:03] Load 62700 genes.\n\n# At this moment the meta infomation for genetic variant assay is still empty\nobj[['var']][[]] %&gt;% head\n\ndata frame with 0 columns and 6 rows\n\nobj &lt;- annoVAR(obj, gtf = gtf)\n\n# After annotation, the locations are parsed from the feature name, and overlapped gene are also annotated.\nobj[['var']][[]] %&gt;% head %&gt;% knitr::kable()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nchr\nstart\nref\nalt\nstrand\nlocus\ngene_name\ntype\n\n\n\n\nchr1:631862G&gt;A/+\nchr1\n631862\nG\nA\n+\nchr1:631862/+\nMTCO1P12\nutr5\n\n\nchr1:633192G=/+\nchr1\n633192\nG\nG\n+\nchr1:633192/+\nMTCO2P12\nutr5\n\n\nchr1:634337T&gt;C/+\nchr1\n634337\nT\nC\n+\nchr1:634337/+\nMTATP6P1\nutr5\n\n\nchr1:826352C&gt;T/-\nchr1\n826352\nC\nT\n-\nchr1:826352/-\nLINC00115\nutr5\n\n\nchr1:853876T&gt;C/+\nchr1\n853876\nT\nC\n+\nchr1:853876/+\nLINC01128\nutr5\n\n\nchr1:944296G&gt;A/-\nchr1\n944296\nG\nA\n-\nchr1:944296/-\nNOC2L\nutr3\n\n\n\n\n# Select autocorrlated genetic variants \nobj &lt;- RunAutoCorr(obj)\n\nIn the alternative splicing analysis, we use mode 1 (the default mode). However, for allele-specific gene expression, we switch to mode 2 to compare the expression of an SNV with other SNVs at the same location. Since no binding assay is specified, the records at the same locus are first aggregated, and then the test feature is subtracted from the aggregated data (mode 2).\n\nobj &lt;- RunBlockCorr(object = obj, bind.name = \"locus\", mode = 2)\n\nWorking on assay var.\n\n\nUse predefined weight matrix \"pca_wm\".\n\n\nProcessing 12923 features.\n\n\nNo bind.assay specified, update min.features.per.block to 2.\n\n\nProcessing 7849 binding features.\n\n\nUse \"counts\" layer for test features.\n\n\nAggregate counts for binding features.\n\n\nUsing 7 threads.\n\n\nRuntime : 3.222085 mins.\n\nsel.chrs &lt;- c(1:21, \"X\")\nFbtPlot(obj, val = \"locus.padj\", remove.chr = TRUE, sel.chrs = sel.chrs)\n\n\n\n\n\n\n\n# Let's random pick a pair of features at the same locus\nobj[['var']][[]] %&gt;% filter(locus.padj &lt; 1e-10) %&gt;% knitr::kable()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nchr\nstart\nref\nalt\nstrand\nlocus\ngene_name\ntype\nmoransi.pval\nmoransi\nautocorr.variable\nlocus.t\nlocus.pval\nlocus.padj\n\n\n\n\nchr10:17237326C&gt;T/+\nchr10\n17237326\nC\nT\n+\nchr10:17237326/+\nVIM\nutr5\n0\n0.6896495\nTRUE\n31.57543\n0\n0\n\n\nchr10:17237326C=/+\nchr10\n17237326\nC\nC\n+\nchr10:17237326/+\nVIM\nutr5\n0\n0.5869554\nTRUE\n26.79126\n0\n0\n\n\nchr10:62069780C&gt;T/+\nchr10\n62069780\nC\nT\n+\nchr10:62069780/+\nARID5B\nexon\n0\n0.1124084\nTRUE\n11.73388\n0\n0\n\n\nchr10:62069780C=/+\nchr10\n62069780\nC\nC\n+\nchr10:62069780/+\nARID5B\nexon\n0\n0.1011137\nTRUE\n12.13146\n0\n0\n\n\nchr10:71816550C=/-\nchr10\n71816550\nC\nC\n-\nchr10:71816550/-\nPSAP\nutr3\n0\n0.2927699\nTRUE\n16.47985\n0\n0\n\n\nchr2:74969604A&gt;G/+\nchr2\n74969604\nA\nG\n+\nchr2:74969604/+\nPOLE4\nutr5\n0\n0.1265709\nTRUE\n20.64066\n0\n0\n\n\nchr6:31268945C&gt;T/-\nchr6\n31268945\nC\nT\n-\nchr6:31268945/-\nHLA-C\nutr3\n0\n0.2901833\nTRUE\n8.79429\n0\n0\n\n\n\n\nFeaturePlot(obj, features = c(\"chr10:17237326C&gt;T/+\", \"chr10:17237326C=/+\", \"VIM\" ), order=TRUE, pt.size = 1, ncol=3)\n\nWarning: The `slot` argument of `FetchData()` is deprecated as of SeuratObject 5.0.0.\nℹ Please use the `layer` argument instead.\nℹ The deprecated feature was likely used in the Seurat package.\n  Please report the issue at &lt;https://github.com/satijalab/seurat/issues&gt;.\n\n\nWarning: Could not find VIM in the default search locations, found in 'RNA'\nassay instead\n\n\n\n\n\n\n\n\n# We could also zoom in specific region\nFbtPlot(obj, val = \"locus.padj\", chr=\"chr10\", start = 17225000, end = 17240000, gtf = gtf)\n\nZoom in chr10 : 17224000-17241000\n\n\n\n\n\n\n\n\n\nIt appears that the T allele of the gene VIM is expressed in most cell groups, while the C allele seems to be primarily expressed in groups 1 and 4.\nUsing our spatial dissimilarity analysis method, we have identified many cases of allele-specific gene expression. This phenomenon can be influenced by several known and unknown mechanisms, including gene imprinting, genetic recombination, and somatic variants during cell or disease development. While we won’t explore these mechanisms in detail here, you can refer to our manuscript, which includes several case studies dedicated to this topic.\n\n# Save the Seurat object for further use\nsaveRDS(obj, file = \"glioblastoma5k.rds\")\n\n\nCommand(obj)\n\n [1] \"NormalizeData.RNA\"        \"FindVariableFeatures.RNA\"\n [3] \"ScaleData.RNA\"            \"RunPCA.RNA\"              \n [5] \"FindNeighbors.RNA.pca\"    \"FindClusters\"            \n [7] \"RunUMAP.RNA.pca\"          \"NormalizeData.var\"       \n [9] \"ParseVarName.var\"         \"annoVAR.var\"             \n[11] \"RunAutoCorr.var.pca\"      \"SetAutoCorrFeatures.var\" \n[13] \"RunBlockCorr.var\"        \n\nsessionInfo()\n\nR version 4.5.0 (2025-04-11)\nPlatform: aarch64-apple-darwin24.4.0\nRunning under: macOS Sequoia 15.5\n\nMatrix products: default\nBLAS:   /opt/homebrew/Cellar/openblas/0.3.29/lib/libopenblasp-r0.3.29.dylib \nLAPACK: /opt/homebrew/Cellar/r/4.5.0/lib/R/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Asia/Shanghai\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] future_1.49.0      dplyr_1.1.4        Seurat_5.3.0       SeuratObject_5.1.0\n[5] sp_2.2-0           ggplot2_3.5.2      Yano_1.1          \n\nloaded via a namespace (and not attached):\n  [1] deldir_2.0-4           pbapply_1.7-2          gridExtra_2.3         \n  [4] rlang_1.1.6            magrittr_2.0.3         RcppAnnoy_0.0.22      \n  [7] spatstat.geom_3.3-6    matrixStats_1.5.0      ggridges_0.5.6        \n [10] compiler_4.5.0         png_0.1-8              vctrs_0.6.5           \n [13] reshape2_1.4.4         stringr_1.5.1          pkgconfig_2.0.3       \n [16] fastmap_1.2.0          labeling_0.4.3         promises_1.3.2        \n [19] rmarkdown_2.29         purrr_1.0.4            xfun_0.52             \n [22] jsonlite_2.0.0         goftest_1.2-3          later_1.4.2           \n [25] spatstat.utils_3.1-4   irlba_2.3.5.1          parallel_4.5.0        \n [28] cluster_2.1.8.1        R6_2.6.1               ica_1.0-3             \n [31] stringi_1.8.7          RColorBrewer_1.1-3     spatstat.data_3.1-6   \n [34] reticulate_1.42.0      spatstat.univar_3.1-3  parallelly_1.44.0     \n [37] lmtest_0.9-40          scattermore_1.2        Rcpp_1.0.14           \n [40] knitr_1.50             tensor_1.5             future.apply_1.11.3   \n [43] zoo_1.8-14             R.utils_2.13.0         sctransform_0.4.2     \n [46] httpuv_1.6.16          Matrix_1.7-3           splines_4.5.0         \n [49] igraph_2.1.4           tidyselect_1.2.1       viridis_0.6.5         \n [52] abind_1.4-8            yaml_2.3.10            spatstat.random_3.3-3 \n [55] codetools_0.2-20       miniUI_0.1.2           spatstat.explore_3.4-2\n [58] listenv_0.9.1          lattice_0.22-6         tibble_3.2.1          \n [61] plyr_1.8.9             withr_3.0.2            shiny_1.10.0          \n [64] ROCR_1.0-11            evaluate_1.0.3         Rtsne_0.17            \n [67] fastDummies_1.7.5      survival_3.8-3         polyclip_1.10-7       \n [70] fitdistrplus_1.2-2     pillar_1.10.2          KernSmooth_2.23-26    \n [73] plotly_4.10.4          generics_0.1.4         RcppHNSW_0.6.0        \n [76] scales_1.4.0           gtools_3.9.5           globals_0.18.0        \n [79] xtable_1.8-4           glue_1.8.0             lazyeval_0.2.2        \n [82] tools_4.5.0            data.table_1.17.2      RSpectra_0.16-2       \n [85] RANN_2.6.2             dotCall64_1.2          cowplot_1.1.3         \n [88] grid_4.5.0             tidyr_1.3.1            nlme_3.1-168          \n [91] patchwork_1.3.0        cli_3.6.5              spatstat.sparse_3.1-0 \n [94] spam_2.11-1            viridisLite_0.4.2      uwot_0.2.3            \n [97] gtable_0.3.6           R.methodsS3_1.8.2      digest_0.6.37         \n[100] progressr_0.15.1       ggrepel_0.9.6          htmlwidgets_1.6.4     \n[103] farver_2.1.2           htmltools_0.5.8.1      R.oo_1.27.1           \n[106] lifecycle_1.0.4        httr_1.4.7             mime_0.13             \n[109] MASS_7.3-65",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Allele-specific gene expression analysis"
    ]
  },
  {
    "objectID": "Yano_AS.html",
    "href": "Yano_AS.html",
    "title": "Alternative splicing analysis for single cell RNA sequencing",
    "section": "",
    "text": "This vignette uses gene, exon, and junction expression files generated from the Annotate Various Features for Alignment. While current state-of-the-art scRNA-seq methods tend to be biased towards the 3’ or 5’ ends of transcripts, it is still possible to obtain coverage information for a subset of exons. Despite the sparsity of gene and exon expression in single cells, our spatial dissimilarity test leverages the spatial distribution properties of features. This means that even features with low overall expression but strong spatial expression patterns across cells can still be highlighted. By performing a spatial dissimilarity test between exon/junction and gene expression, we can predict potential alternative splicing events.",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Alternative splicing analysis"
    ]
  },
  {
    "objectID": "Yano_AS.html#prerequisite",
    "href": "Yano_AS.html#prerequisite",
    "title": "Alternative splicing analysis for single cell RNA sequencing",
    "section": "0. Prerequisite",
    "text": "0. Prerequisite\n\nMake sure you have installed the R environment and Yano package before proceeding with the testing.",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Alternative splicing analysis"
    ]
  },
  {
    "objectID": "Yano_AS.html#perform-cell-clustering-with-seurat",
    "href": "Yano_AS.html#perform-cell-clustering-with-seurat",
    "title": "Alternative splicing analysis for single cell RNA sequencing",
    "section": "1. Perform cell clustering with Seurat",
    "text": "1. Perform cell clustering with Seurat\nLoad Yano will automatically load Seurat.\n\nrequire(Yano)\n\nLoading required package: Yano\n\n\n── Attaching packages ────────────────────────────────────────────── Yano 1.1 ──\n✔ dplyr   1.1.4     ✔ Seurat  5.3.0\n✔ ggplot2 3.5.2     \n\n\n\n# Read raw gene expression matrix\nexp &lt;- ReadPISA(\"./exp/\")\n\nIn this section, we will perform the standard Seurat analysis pipeline. Since the spatial dissimilarity test is not rely on cell clustering so changing the resolution or other parameters for FindClusters and RunUMAP will not impact the outcome of the spatial dissimilarity test.\n\n# Create Seurat object and filter droplets with fewer than 1000 genes\nobj &lt;- CreateSeuratObject(exp, min.features = 1000, min.cells = 10)\n\n# Filter low quality droplets\nobj[[\"percent.mt\"]] &lt;- PercentageFeatureSet(obj, pattern = \"^MT-\")\nobj &lt;- subset(obj, nFeature_RNA &lt; 9000 & percent.mt &lt; 20)\n\n# Downsampling to 2000 cells for fast testing\nobj &lt;- obj[, sample(colnames(obj),2000)]\n\n# We run the cell clustering analysis with Seurat pipeline\nobj &lt;- NormalizeData(obj) %&gt;% FindVariableFeatures() %&gt;% ScaleData() %&gt;%  RunPCA(verbose=FALSE) %&gt;% FindNeighbors(dims = 1:10, verbose=FALSE) %&gt;% FindClusters(resolution = 0.5, verbose=FALSE) %&gt;% RunUMAP(dims=1:10, verbose=FALSE)\n\nNormalizing layer: counts\n\n\nFinding variable features for layer counts\n\n\nCentering and scaling data matrix\n\nDimPlot(obj, label=TRUE, label.size = 5, label.box = TRUE)",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Alternative splicing analysis"
    ]
  },
  {
    "objectID": "Yano_AS.html#perform-alternative-splicing-with-exon-assay",
    "href": "Yano_AS.html#perform-alternative-splicing-with-exon-assay",
    "title": "Alternative splicing analysis for single cell RNA sequencing",
    "section": "2. Perform alternative splicing with exon assay",
    "text": "2. Perform alternative splicing with exon assay\nIn this section, we will compare exon expression patterns with the expression patterns of their corresponding genes in a spatial context. Here, the term “spatial” refers to the organization of cells in space. In this vignette, we will use the PCA space for the analysis, but the approach can also be applied to lineage trajectories, spatial coordinates or integration space such as harmony. The spatial dissimilarity test is divided into several steps. First, we will load exon data as a new assay in the Seurat object. In the second step, we will perform a spatial autocorrelation test for all exons and select the ones that show significant autocorrelation for further analysis. Next, we will define the binding relationship between exons and their corresponding genes and run the spatial dissimilarity test. After testing, P values and adjusted P values for each exon will be provided.\n\n# Read exon count matrix file\nexon &lt;- ReadPISA(\"./exon/\")\n\n# Load the exon expression to Seurat object as a new assay, make sure the exon matrix has the same cells.\nobj[['exon']] &lt;- CreateAssayObject(exon[, colnames(obj)], min.cells=20)\n\n# Switch work assay to exon\nDefaultAssay(obj) &lt;- \"exon\"\n# Empty info for exon features\nhead(obj[['exon']][[]]) %&gt;% knitr::kable()\n\n\n\n\nchr1:135141-135895/-/ENSG00000268903\n\n\nchr1:629640-630683/+/MTND2P28\n\n\nchr1:631074-632616/+/MTCO1P12\n\n\nchr1:632757-633438/+/MTCO2P12\n\n\nchr1:633696-634376/+/MTATP6P1\n\n\nchr1:634376-634922/+/MTCO3P12\n\n\n\n\nobj &lt;- ParseExonName(obj)\n\nWorking on assay exon\n\n# Gene name and location are parsed from exon name\nhead(obj[['exon']][[]]) %&gt;% knitr::kable()\n\n\n\n\n\n\n\n\n\n\n\n\n\nchr\nstart\nend\ngene_name\nstrand\n\n\n\n\nchr1:135141-135895/-/ENSG00000268903\nchr1\n135141\n135895\nENSG00000268903\n-\n\n\nchr1:629640-630683/+/MTND2P28\nchr1\n629640\n630683\nMTND2P28\n+\n\n\nchr1:631074-632616/+/MTCO1P12\nchr1\n631074\n632616\nMTCO1P12\n+\n\n\nchr1:632757-633438/+/MTCO2P12\nchr1\n632757\n633438\nMTCO2P12\n+\n\n\nchr1:633696-634376/+/MTATP6P1\nchr1\n633696\n634376\nMTATP6P1\n+\n\n\nchr1:634376-634922/+/MTCO3P12\nchr1\n634376\n634922\nMTCO3P12\n+\n\n\n\n\n# Normalize the data for spatial autocorrelation test\nobj &lt;- NormalizeData(obj)\nobj &lt;- RunAutoCorr(obj)\n\nWorking on assay : exon\n\n\nRun autocorrelation test for 117043 features.\n\n\nRuntime : 22.25518 secs\n\n\n70909 autocorrelated features.\n\n## Select autocorrleated features for downstream test. This function is integrated with RunAutoCorr after V2, so no need to run it unless you want reselect features based on different p value or Moran's I.\n## obj &lt;- SetAutoCorrFeatures(obj)\n\nThe permutation process can be computationally expensive. In the example below, I set perm=20 to perform only 20 permutations for quicker results. However, the default setting runs 100 permutations for more accurate evaluation. While it’s possible to increase the number of permutations for even more precision, it may not always be necessary. If you’re running Yano for the first time on your dataset, setting perm=20 can help you save time and provide an initial overview of the entire dataset.\n\nobj &lt;- RunBlockCorr(obj, bind.name = \"gene_name\", bind.assay = \"RNA\", perm=20)\n\nWorking on assay exon.\n\n\nWorking on binding assay RNA.\n\n\nUse predefined weight matrix \"pca_wm\".\n\n\nProcessing 70909 features.\n\n\nProcessing 17746 binding features.\n\n\nRetrieve binding data from assay RNA.\n\n\nUse \"data\" layer for test features and binding features.\n\n\nUsing 7 threads.\n\n\nRuntime : 7.165358 mins.\n\n# Now p values and adjusted p values have been generated\nhead(obj[['exon']][[]]) %&gt;% knitr::kable()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nchr\nstart\nend\ngene_name\nstrand\nmoransi.pval\nmoransi\nautocorr.variable\ngene_name.t\ngene_name.pval\ngene_name.padj\n\n\n\n\nchr1:135141-135895/-/ENSG00000268903\nchr1\n135141\n135895\nENSG00000268903\n-\n0.0000001\n0.0222427\nTRUE\n-6.264790\n0.9999974\n1\n\n\nchr1:629640-630683/+/MTND2P28\nchr1\n629640\n630683\nMTND2P28\n+\n0.0000013\n0.0203117\nTRUE\n-8.498919\n1.0000000\n1\n\n\nchr1:631074-632616/+/MTCO1P12\nchr1\n631074\n632616\nMTCO1P12\n+\n0.7821273\n-0.0038815\nFALSE\nNA\nNA\nNA\n\n\nchr1:632757-633438/+/MTCO2P12\nchr1\n632757\n633438\nMTCO2P12\n+\n0.5700335\n-0.0012501\nFALSE\nNA\nNA\nNA\n\n\nchr1:633696-634376/+/MTATP6P1\nchr1\n633696\n634376\nMTATP6P1\n+\n0.0000000\n0.3171474\nTRUE\n-4.768099\n0.9999331\n1\n\n\nchr1:634376-634922/+/MTCO3P12\nchr1\n634376\n634922\nMTCO3P12\n+\n0.8377380\n-0.0046027\nFALSE\nNA\nNA\nNA\n\n\n\n\n# Plot feature binding test plot\nFbtPlot(obj, val = \"gene_name.padj\")\n\n\n\n\n\n\n\n\nThe chromosome names are too long and tend to overlap in the visualization. To resolve this, you can either resize the labels or remove the ‘chr’ prefix from the chromosome names. Additionally, since the Y chromosome and mitochondrial are not of particular interest to us in this analysis, they can be excluded from the visualization.\n\nsel.chrs &lt;- c(1:21, \"X\")\nFbtPlot(obj, val = \"gene_name.padj\", remove.chr = TRUE, sel.chrs = sel.chrs)\n\n\n\n\n\n\n\n# Let's see how many exons are expressed in different spatial pattern with their genes\nobj[['exon']][[]] %&gt;% filter(gene_name.padj &lt; 0.001) %&gt;% knitr::kable() \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nchr\nstart\nend\ngene_name\nstrand\nmoransi.pval\nmoransi\nautocorr.variable\ngene_name.t\ngene_name.pval\ngene_name.padj\n\n\n\n\nchr1:153990763-153991034/+/RPS27\nchr1\n153990763\n153991034\nRPS27\n+\n0.0000000\n0.1401423\nTRUE\n8.047229\n1e-07\n0.0001756\n\n\nchr1:153990914-153991034/+/RPS27\nchr1\n153990914\n153991034\nRPS27\n+\n0.0000000\n0.1365211\nTRUE\n8.225390\n1e-07\n0.0001353\n\n\nchr11:113262846-113265197/+/NCAM1\nchr11\n113262846\n113265197\nNCAM1\n+\n0.0000000\n0.3791788\nTRUE\n7.688837\n2e-07\n0.0003135\n\n\nchr12:6943817-6944173/+/C12orf57\nchr12\n6943817\n6944173\nC12orf57\n+\n0.0000000\n0.0652261\nTRUE\n7.255643\n3e-07\n0.0005847\n\n\nchr12:53303034-53306861/+/ENSG00000288663\nchr12\n53303034\n53306861\nENSG00000288663\n+\n0.0000000\n0.0259674\nTRUE\n11.684920\n0e+00\n0.0000010\n\n\nchr12:53306680-53306861/+/ENSG00000288663\nchr12\n53306680\n53306861\nENSG00000288663\n+\n0.0000000\n0.0244351\nTRUE\n10.690669\n0e+00\n0.0000039\n\n\nchr12:53306966-53307171/+/ENSG00000288663\nchr12\n53306966\n53307171\nENSG00000288663\n+\n0.0000078\n0.0187449\nTRUE\n9.609901\n0e+00\n0.0000176\n\n\nchr12:53306966-53307158/+/ENSG00000288663\nchr12\n53306966\n53307158\nENSG00000288663\n+\n0.0000019\n0.0200836\nTRUE\n9.372935\n0e+00\n0.0000250\n\n\nchr12:53306966-53307122/+/ENSG00000288663\nchr12\n53306966\n53307122\nENSG00000288663\n+\n0.0002282\n0.0151130\nTRUE\n8.278753\n1e-07\n0.0001271\n\n\nchr12:53306966-53307174/+/ENSG00000288663\nchr12\n53306966\n53307174\nENSG00000288663\n+\n0.0000058\n0.0190407\nTRUE\n9.907466\n0e+00\n0.0000120\n\n\nchr12:56161387-56161465/+/MYL6\nchr12\n56161387\n56161465\nMYL6\n+\n0.0000000\n0.2516071\nTRUE\n18.717078\n0e+00\n0.0000000\n\n\nchr12:79872808-79872938/-/PPP1R12A\nchr12\n79872808\n79872938\nPPP1R12A\n-\n0.0000000\n0.0556598\nTRUE\n8.293608\n0e+00\n0.0001271\n\n\nchr15:43801711-43804427/+/SERF2\nchr15\n43801711\n43804427\nSERF2\n+\n0.0000000\n0.1182703\nTRUE\n10.268469\n0e+00\n0.0000072\n\n\nchr15:60382342-60384827/-/ANXA2\nchr15\n60382342\n60384827\nANXA2\n-\n0.0000000\n0.0560007\nTRUE\n7.019417\n6e-07\n0.0008893\n\n\nchr18:49481681-49482410/-/RPL17-C18orf32\nchr18\n49481681\n49482410\nRPL17-C18orf32\n-\n0.0000000\n0.2771721\nTRUE\n39.196079\n0e+00\n0.0000000\n\n\nchr19:16093684-16093753/+/TPM4\nchr19\n16093684\n16093753\nTPM4\n+\n0.0000000\n0.1013825\nTRUE\n9.829923\n0e+00\n0.0000129\n\n\nchr19:16095264-16095357/+/TPM4\nchr19\n16095264\n16095357\nTPM4\n+\n0.0000000\n0.1949699\nTRUE\n19.439332\n0e+00\n0.0000000\n\n\nchr19:16095264-16096744/+/TPM4\nchr19\n16095264\n16096744\nTPM4\n+\n0.0000000\n0.2477580\nTRUE\n23.787053\n0e+00\n0.0000000\n\n\nchr19:16095264-16095454/+/TPM4\nchr19\n16095264\n16095454\nTPM4\n+\n0.0000000\n0.2432229\nTRUE\n22.448113\n0e+00\n0.0000000\n\n\nchr19:16095264-16095893/+/TPM4\nchr19\n16095264\n16095893\nTPM4\n+\n0.0000000\n0.2506281\nTRUE\n24.109840\n0e+00\n0.0000000\n\n\nchr19:16095264-16095591/+/TPM4\nchr19\n16095264\n16095591\nTPM4\n+\n0.0000000\n0.2518667\nTRUE\n24.141015\n0e+00\n0.0000000\n\n\nchr19:16095264-16095496/+/TPM4\nchr19\n16095264\n16095496\nTPM4\n+\n0.0000000\n0.2582948\nTRUE\n23.735168\n0e+00\n0.0000000\n\n\nchr19:18169087-18170494/+/ENSG00000268173\nchr19\n18169087\n18170494\nENSG00000268173\n+\n0.0000000\n0.0506799\nTRUE\n17.021419\n0e+00\n0.0000000\n\n\nchr2:218344808-218346793/+/PNKD\nchr2\n218344808\n218346793\nPNKD\n+\n0.0000000\n0.0899427\nTRUE\n14.222028\n0e+00\n0.0000000\n\n\nchr2:218344808-218346784/+/PNKD\nchr2\n218344808\n218346784\nPNKD\n+\n0.0000000\n0.0889706\nTRUE\n14.119066\n0e+00\n0.0000000\n\n\nchr2:218344808-218346756/+/PNKD\nchr2\n218344808\n218346756\nPNKD\n+\n0.0000000\n0.0887807\nTRUE\n13.874796\n0e+00\n0.0000001\n\n\nchr2:218344808-218346791/+/PNKD\nchr2\n218344808\n218346791\nPNKD\n+\n0.0000000\n0.0899427\nTRUE\n14.222028\n0e+00\n0.0000000\n\n\nchr2:218344808-218346771/+/PNKD\nchr2\n218344808\n218346771\nPNKD\n+\n0.0000000\n0.0879248\nTRUE\n13.916913\n0e+00\n0.0000001\n\n\nchr3:181175514-181176513/+/SOX2-OT\nchr3\n181175514\n181176513\nSOX2-OT\n+\n0.0000000\n0.1550510\nTRUE\n8.309848\n0e+00\n0.0001271\n\n\nchr3:181175514-181176523/+/SOX2-OT\nchr3\n181175514\n181176523\nSOX2-OT\n+\n0.0000000\n0.1550510\nTRUE\n8.309848\n0e+00\n0.0001271\n\n\nchr3:181175514-181176524/+/SOX2-OT\nchr3\n181175514\n181176524\nSOX2-OT\n+\n0.0000000\n0.1546520\nTRUE\n8.184777\n1e-07\n0.0001409\n\n\nchr5:149549328-149549513/-/CSNK1A1\nchr5\n149549328\n149549513\nCSNK1A1\n-\n0.0000000\n0.0426950\nTRUE\n7.865082\n1e-07\n0.0002388\n\n\nchr8:56067269-56068344/-/RPS20\nchr8\n56067269\n56068344\nRPS20\n-\n0.0000000\n0.0253861\nTRUE\n7.305944\n3e-07\n0.0005429\n\n\nchr8:56067295-56068530/-/RPS20\nchr8\n56067295\n56068530\nRPS20\n-\n0.0000000\n0.0269210\nTRUE\n7.612626\n2e-07\n0.0003422\n\n\nchr8:60620674-60620895/+/RAB2A\nchr8\n60620674\n60620895\nRAB2A\n+\n0.0000002\n0.0220142\nTRUE\n7.323427\n3e-07\n0.0005378\n\n\nchr8:60620674-60620938/+/RAB2A\nchr8\n60620674\n60620938\nRAB2A\n+\n0.0000000\n0.0259866\nTRUE\n7.535497\n2e-07\n0.0003859\n\n\nchr8:60620674-60620948/+/RAB2A\nchr8\n60620674\n60620948\nRAB2A\n+\n0.0000000\n0.0258978\nTRUE\n7.463271\n2e-07\n0.0004207\n\n\nchr8:60620674-60620941/+/RAB2A\nchr8\n60620674\n60620941\nRAB2A\n+\n0.0000000\n0.0258978\nTRUE\n7.463271\n2e-07\n0.0004207\n\n\nchr8:60620674-60620988/+/RAB2A\nchr8\n60620674\n60620988\nRAB2A\n+\n0.0000000\n0.0256632\nTRUE\n7.688661\n2e-07\n0.0003135\n\n\nchrX:119583127-119583347/+/UBE2A\nchrX\n119583127\n119583347\nUBE2A\n+\n0.0000000\n0.0391280\nTRUE\n7.622778\n2e-07\n0.0003422\n\n\nchrX:119583127-119584101/+/UBE2A\nchrX\n119583127\n119584101\nUBE2A\n+\n0.0000000\n0.0363548\nTRUE\n7.041901\n5e-07\n0.0008703\n\n\nchrX:119583127-119583417/+/UBE2A\nchrX\n119583127\n119583417\nUBE2A\n+\n0.0000000\n0.0428587\nTRUE\n9.134134\n0e+00\n0.0000357\n\n\nchrX:119583127-119583621/+/UBE2A\nchrX\n119583127\n119583621\nUBE2A\n+\n0.0000000\n0.0413061\nTRUE\n8.976484\n0e+00\n0.0000448\n\n\nchrX:151404916-151405157/+/VMA21\nchrX\n151404916\n151405157\nVMA21\n+\n0.0000000\n0.0550083\nTRUE\n8.746338\n0e+00\n0.0000642\n\n\n\n\n# Random select a gene and its exons and visulize with FeaturePlot.\nFeaturePlot(obj, features = c(\"chr15:43801711-43804427/+/SERF2\", \"SERF2\"), ncol=2)\n\n\n\n\n\n\n\n# The default color and parameters perhaps not easily to tell the difference between exon and its binding gene expression. Let's change the scaled colors and enlarge point size and order by expression.\nrequire(RColorBrewer)\n\nLoading required package: RColorBrewer\n\nFeaturePlot(obj, features = c(\"chr15:43801711-43804427/+/SERF2\", \"SERF2\"), ncol=2, order = TRUE, pt.size=1) & scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = \"RdBu\")))\n\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\n\n\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\n\n\n\n\n\n\n\n\n\nWe can also map the ratio of exon expression to gene expression on the UMAP. The RatioPlot function is designed for this purpose. As observed, the gene SERF2 is relatively low expressed in groups 0, 5, and 9, while the ratio of the exon chr15:43801711-43804427/+/SERF2 is higher in these groups.\n\nRatioPlot(obj, features = c(\"chr15:43801711-43804427/+/SERF2\"), assay = 'exon', bind.assay = 'RNA', bind.name = \"gene_name\", order = TRUE, pt.size=1) \n\n\n\n\n\n\n\n\nIn the feature plot and ratio plot above, the exon appears to lack a strong expression pattern across cell groups, whereas the gene SERF2 seems to be highly expressed in many groups, except for groups 0, 5 and 9. This inconsistent expression pattern between the exon and its corresponding gene may suggest differential exon usage. To explore the coverage details of both the exon and the gene body, we will generate a track plot next.\nIn our package, retrieving gene locations requires loading a GTF file instead of relying on current Bioconductor databases, such as org.Hs.eg.db. This is due to the varying versions of gene annotations provided by different institutes, which can introduce inconsistencies. To avoid potential bias during preprocessing and postprocessing, we strongly recommend using the same GTF file consistently throughout your project. The Yano package includes the gtf2db function, which enables you to load a GTF file into memory for further analysis.\n\ngtf &lt;- gtf2db(\"./gencode.v44.annotation.gtf.gz\")\n\n[2025-06-02 15:05:55] GTF loading..\n[2025-06-02 15:06:42] Load 62700 genes.\n\n\nA track plot is used to study the read coverage per cell group. In the track plot shown below, the cell group is specified by the cell.group parameter. Unlike IGV, where read depth is used, we use UMI depth in this plot. The cell barcode tag and UMI tag are predefined as “CB” and “UB” with parameter cell.tag and umi.tag. For each cell group, the UMI depth has been normalized by the number of cells in that group. This means that the depth at each location can be interpreted as the mean UMI depth per cell for the group. As a result, the tracks are directly comparable across different cell groups. If cell.group is not set, the track plot will generate the raw UMI depth per location.\n\nTrackPlot(bamfile = \"Parent_SC3v3_Human_Glioblastoma_possorted_genome_bam.bam\", gtf = gtf, gene = \"SERF2\", cell.group = Idents(obj), highlights = c(43801711,43804427) )\n\n\n\n\n\n\n\n\nIn the track plot, we can easily observe that an exon around position 43,794,000 dominates the expression of the SERF2 gene and is highly expressed in many cell groups. However, the exon ‘chr15:43801711-43804427/+/SERF2’ (highlighted) shows low expression and is not visible in the track plot. To visualize low-expressed exons, we can set the max.depth parameter to 2, which caps the UMI depth at 2. And many genes in the region, we set display.genes to SERF2 only. This adjustment allows the low-expressed exons and their related transcripts to be more clearly represented in the plot. In this case, we can found the the highlighed exon shows different expressed pattern with the gene SERF2.\n\nTrackPlot(bamfile = \"Parent_SC3v3_Human_Glioblastoma_possorted_genome_bam.bam\", gtf = gtf, gene = \"SERF2\", cell.group = Idents(obj), highlights = c(43801711,43804427), max.depth = 2, display.genes = \"SERF2\")",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Alternative splicing analysis"
    ]
  },
  {
    "objectID": "Yano_AS.html#load-junction-assay",
    "href": "Yano_AS.html#load-junction-assay",
    "title": "Alternative splicing analysis for single cell RNA sequencing",
    "section": "3. Load junction assay",
    "text": "3. Load junction assay\nIn addition to exon expression, junction expression can provide insights into different expression patterns across transcripts, offering a complementary perspective. Junction expression refers to the UMI counts of reads that span more than one exon. It’s important to note that junctions are named similarly to exons, but the start and end positions are different. The start of the junction corresponds to the end of the previous exon, while the end of the junction represents the start of the next exon.\n\njunction &lt;- ReadPISA(\"./junction/\")\nobj[['junction']] &lt;- CreateAssayObject(junction[, colnames(obj)], min.cells=20)\n\nDefaultAssay(obj) &lt;- \"junction\"\nobj &lt;- NormalizeData(obj)\n\n# select spatial autocorrelated junctions\nobj &lt;- RunAutoCorr(obj)\n\nWorking on assay : junction\n\n\nRun autocorrelation test for 14786 features.\n\n\nRuntime : 6.19428 secs\n\n\n7531 autocorrelated features.\n\nobj &lt;- SetAutoCorrFeatures(obj)\n\n7531 autocorrelated features.\n\n# Parse the gene name and coordinates from junction names\nobj &lt;- ParseExonName(obj)\n\nWorking on assay junction\n\n# perform dissimilarity test between junctions and their binding genes\nobj &lt;- RunBlockCorr(obj, bind.name = \"gene_name\", bind.assay = \"RNA\", perm=20)\n\nWorking on assay junction.\n\n\nWorking on binding assay RNA.\n\n\nUse predefined weight matrix \"pca_wm\".\n\n\nProcessing 7531 features.\n\n\nProcessing 5700 binding features.\n\n\nRetrieve binding data from assay RNA.\n\n\nUse \"data\" layer for test features and binding features.\n\n\nUsing 7 threads.\n\n\nRuntime : 51.11648 secs.\n\nFbtPlot(obj, val=\"gene_name.padj\", remove.chr=TRUE, sel.chrs = sel.chrs)\n\n\n\n\n\n\n\nobj[['junction']][[]] %&gt;% filter(gene_name.padj&lt;1e-5)\n\n                                          moransi.pval    moransi\nchr12:53306861-53306966/+/ENSG00000288663 5.685606e-22 0.04213888\nchr12:56160320-56161387/+/MYL6            0.000000e+00 0.19216492\nchr19:16093753-16095264/+/TPM4            0.000000e+00 0.19090106\n                                          autocorr.variable   chr    start\nchr12:53306861-53306966/+/ENSG00000288663              TRUE chr12 53306861\nchr12:56160320-56161387/+/MYL6                         TRUE chr12 56160320\nchr19:16093753-16095264/+/TPM4                         TRUE chr19 16093753\n                                               end       gene_name strand\nchr12:53306861-53306966/+/ENSG00000288663 53306966 ENSG00000288663      +\nchr12:56160320-56161387/+/MYL6            56161387            MYL6      +\nchr19:16093753-16095264/+/TPM4            16095264            TPM4      +\n                                          gene_name.t gene_name.pval\nchr12:53306861-53306966/+/ENSG00000288663    15.35670   1.818884e-12\nchr12:56160320-56161387/+/MYL6               12.37677   7.671803e-11\nchr19:16093753-16095264/+/TPM4               18.78667   4.951968e-14\n                                          gene_name.padj\nchr12:53306861-53306966/+/ENSG00000288663   6.849009e-09\nchr12:56160320-56161387/+/MYL6              1.925878e-07\nchr19:16093753-16095264/+/TPM4              3.729327e-10\n\n# Because both exon and junction are compared with gene, so it's reasonable to combine these two assays in one plot\nFbtPlot(obj, val=\"gene_name.padj\", assay = c(\"exon\", \"junction\"), col.by = \"assay\", shape.by = \"assay\", pt.size = 2, remove.chr = TRUE, sel.chrs = sel.chrs, cols = c(\"red\", \"blue\"))\n\n\n\n\n\n\n\n# We can find there is an exon and a junction at chromosome 12 with very low p value (&lt;1e-8), let's see which gene they are located\nobj[['exon']][[]] %&gt;% filter(chr == \"chr12\" & gene_name.pval &lt; 1e-8) %&gt;% knitr::kable()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nchr\nstart\nend\ngene_name\nstrand\nmoransi.pval\nmoransi\nautocorr.variable\ngene_name.t\ngene_name.pval\ngene_name.padj\n\n\n\n\nchr12:53303034-53306861/+/ENSG00000288663\nchr12\n53303034\n53306861\nENSG00000288663\n+\n0.0e+00\n0.0259674\nTRUE\n11.684920\n0\n1.00e-06\n\n\nchr12:53306680-53306861/+/ENSG00000288663\nchr12\n53306680\n53306861\nENSG00000288663\n+\n0.0e+00\n0.0244351\nTRUE\n10.690669\n0\n3.90e-06\n\n\nchr12:53306966-53307171/+/ENSG00000288663\nchr12\n53306966\n53307171\nENSG00000288663\n+\n7.8e-06\n0.0187449\nTRUE\n9.609901\n0\n1.76e-05\n\n\nchr12:53306966-53307158/+/ENSG00000288663\nchr12\n53306966\n53307158\nENSG00000288663\n+\n1.9e-06\n0.0200836\nTRUE\n9.372935\n0\n2.50e-05\n\n\nchr12:53306966-53307174/+/ENSG00000288663\nchr12\n53306966\n53307174\nENSG00000288663\n+\n5.8e-06\n0.0190407\nTRUE\n9.907466\n0\n1.20e-05\n\n\nchr12:56161387-56161465/+/MYL6\nchr12\n56161387\n56161465\nMYL6\n+\n0.0e+00\n0.2516071\nTRUE\n18.717078\n0\n0.00e+00\n\n\n\n\nobj[['junction']][[]] %&gt;% filter(chr == \"chr12\" & gene_name.pval &lt; 1e-8) %&gt;% knitr::kable()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nmoransi.pval\nmoransi\nautocorr.variable\nchr\nstart\nend\ngene_name\nstrand\ngene_name.t\ngene_name.pval\ngene_name.padj\n\n\n\n\nchr12:53306861-53306966/+/ENSG00000288663\n0\n0.0421389\nTRUE\nchr12\n53306861\n53306966\nENSG00000288663\n+\n15.35670\n0\n0e+00\n\n\nchr12:56160320-56161387/+/MYL6\n0\n0.1921649\nTRUE\nchr12\n56160320\n56161387\nMYL6\n+\n12.37677\n0\n2e-07\n\n\n\n\nFeaturePlot(obj, features = c(\"chr12:56161387-56161465/+/MYL6\",\"chr12:56160320-56161387/+/MYL6\", \"MYL6\"), order = TRUE, pt.size = 2, ncol=3) & scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = \"RdBu\")))\n\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\n\n\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\n\n\n\n\n\n\n\n\n# We could also plot the expression ratio of these exons or junctions on umap\np1 &lt;- RatioPlot(obj, assay = \"exon\", bind.assay = \"RNA\", bind.name = \"gene_name\", features = \"chr12:56161387-56161465/+/MYL6\")\np2 &lt;- RatioPlot(obj, assay = \"exon\", bind.assay = \"RNA\", bind.name = \"gene_name\", features = \"chr12:56160626-56160670/+/MYL6\")\np3 &lt;- RatioPlot(obj, assay = \"junction\", bind.assay = \"RNA\", bind.name = \"gene_name\", features = \"chr12:56160320-56161387/+/MYL6\")\ncowplot::plot_grid(p1,p2,p3, ncol=3)\n\n\n\n\n\n\n\n\nWe then visualize the track plot for this gene, including junction reads by setting junc=TRUE. The height of the splice paths in the plot represents the expression level of each junction within the specified cell group.\n\nTrackPlot(bamfile = \"Parent_SC3v3_Human_Glioblastoma_possorted_genome_bam.bam\", gtf = gtf, gene = \"MYL6\", cell.group = Idents(obj), junc = TRUE, highlights = list(c(56160320,56161387),c(56161387,56161465)))\n\n\n\n\n\n\n\n\nYou might be wondering why the exon chr12:56161387-56161465/+/MYL6 appears highly expressed in cell group 2 in the track plot, where the overlapping peak is clearly higher than in other groups, but its expression level in the feature plot is not as high as expected.\nThis discrepancy arises because the exon is overlapping with other exons from different transcripts. We only count reads that are fully contained within the exon as part of the exon’s expression. Therefore, reads that partially overlap with this exon are not included in the count.\nIn contrast, the overlapping exon chr12:56161387-56161575/+/MYL6 shows higher expression in group 2 compared to other groups. It’s important to note that if a read is fully contained within two or more overlapping exons, PISA will count it for all relevant exons. Check PISA’s manual for details.\n\np1 &lt;- DimPlot(obj, label=TRUE, label.size = 5, label.box = TRUE)\np2 &lt;- FeaturePlot(obj, features = c(\"chr12:56161387-56161575/+/MYL6\"), order = TRUE, pt.size = 1) & scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = \"RdBu\")))\n\nWarning: Could not find chr12:56161387-56161575/+/MYL6 in the default search\nlocations, found in 'exon' assay instead\n\n\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\n\np1 + p2",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Alternative splicing analysis"
    ]
  },
  {
    "objectID": "Yano_AS.html#heatmap-analysis-for-highlight-group-specific-alternative-splicing",
    "href": "Yano_AS.html#heatmap-analysis-for-highlight-group-specific-alternative-splicing",
    "title": "Alternative splicing analysis for single cell RNA sequencing",
    "section": "4. Heatmap analysis for highlight group specific alternative splicing",
    "text": "4. Heatmap analysis for highlight group specific alternative splicing\nThe spatial dissimilarity test method prioritizes alternatively spliced exons and junctions across all cells but does not identify which specific cell groups exhibit these splicing events. To address this, let’s manually extract the scaled expression data for the selected alternatively spliced exons and their corresponding genes, then perform a co-clustering analysis. A comprehensive heatmap will be generated using the ComplexHeatmap package, providing a visual representation of the exon and gene distribution across cell groups.\n\nobj[['exon']][[]] %&gt;% filter(gene_name.padj&lt;0.001) %&gt;% rownames -&gt; exons\nobj[['exon']][[]] %&gt;% filter(gene_name.padj&lt;0.001) %&gt;% pull(gene_name) -&gt; bind.genes\nDefaultAssay(obj) &lt;- \"RNA\"\nobj &lt;- ScaleData(obj, features = unique(bind.genes))\nDefaultAssay(obj) &lt;- \"exon\"\nobj &lt;- ScaleData(obj, features = exons)\n\ndat1 &lt;- GetAssayData(obj, assay = 'exon', layer = 'scale.data')\ndat2 &lt;- GetAssayData(obj, assay = 'RNA', layer = 'scale.data')\nidents &lt;- sort(Idents(obj))\norder.cells &lt;- names(idents)\n\ndat2 &lt;- dat2[bind.genes,]\nrownames(dat2) &lt;- exons\n\ndat &lt;- cbind(dat1, dat2)\n\nrequire(ComplexHeatmap)\nd &lt;- dist(dat)\nhc &lt;- hclust(d)\nidx &lt;- hc$labels[hc$order]\n\nha &lt;- HeatmapAnnotation(group=idents, border = TRUE)\nht1 &lt;- Heatmap(dat1[idx, order.cells], cluster_rows = FALSE, cluster_columns = FALSE, show_column_names = FALSE, border = TRUE,  top_annotation = ha, name = \"exon\", column_title = \"exon\")\nht2 &lt;- Heatmap(dat2[idx, order.cells], cluster_rows = FALSE, cluster_columns = FALSE, show_column_names = FALSE, border = TRUE,  top_annotation = ha, name = \"gene\", column_title = \"gene\", row_names_max_width = max_text_width(rownames(dat2), gp = gpar(fontsize = 12)))\n\nht &lt;- ht1 + ht2\ndraw(ht, heatmap_legend_side = \"left\",  annotation_legend_side = \"left\")",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Alternative splicing analysis"
    ]
  },
  {
    "objectID": "Yano_AS.html#test-between-exon-and-exon-skipped-reads",
    "href": "Yano_AS.html#test-between-exon-and-exon-skipped-reads",
    "title": "Alternative splicing analysis for single cell RNA sequencing",
    "section": "5. Test between exon and exon skipped reads",
    "text": "5. Test between exon and exon skipped reads\nIn the previous sections, we conducted a spatial dissimilarity test between exon/junction expression and gene expression. However, binding features are not always limited to genes; they can also correspond to other types of features. In this section, we perform a test between exon expression and reads that skip this exon (exclude assay). This approach is similar to the Percent Spliced In (PSI) method, which is widely used to analyze alternative splicing in both bulk and single-cell RNA-seq data. The PSI is calculated as: PSI = exon reads / (exon reads + reads skipping this exon).\n\n# The reads that skip exons are annotated using the `-psi` option in PISA anno, and these counts are stored in the `exclude` directory. We then load these excluded counts into a new assay.\nexclude &lt;- ReadPISA(\"exclude/\")\nobj[['exclude']] &lt;- CreateAssayObject(exclude[,colnames(obj)], min.cells = 10)\nDefaultAssay(obj) &lt;- \"exclude\"\n# Normalize counts for exon-excluded reads\nobj &lt;- NormalizeData(obj)\n# Then we switch to exon assay\nDefaultAssay(obj) &lt;- \"exon\"\n\n# Because the feature names in the exclude assay are exactly the same as those in the exon assay, they represent the reads that skip each corresponding exon. Therefore, we set up the binding feature using the exon name itself.\nobj[['exon']][['exon_name']] &lt;- rownames(obj)\nobj[['exon']][['exon_name']] %&gt;% head\n\n                                                                exon_name\nchr1:135141-135895/-/ENSG00000268903 chr1:135141-135895/-/ENSG00000268903\nchr1:629640-630683/+/MTND2P28               chr1:629640-630683/+/MTND2P28\nchr1:631074-632616/+/MTCO1P12               chr1:631074-632616/+/MTCO1P12\nchr1:632757-633438/+/MTCO2P12               chr1:632757-633438/+/MTCO2P12\nchr1:633696-634376/+/MTATP6P1               chr1:633696-634376/+/MTATP6P1\nchr1:634376-634922/+/MTCO3P12               chr1:634376-634922/+/MTCO3P12\n\n# Then we perform spatial dissimilarity test between exon and exclude, mode 1\nobj &lt;- RunBlockCorr(obj, bind.name = \"exon_name\", bind.assay = \"exclude\")\n\n# Swith to exon exluded assay\nDefaultAssay(obj) &lt;- \"exclude\"\nobj &lt;- RunAutoCorr(obj)\nobj &lt;- SetAutoCorrFeatures(obj)\nobj &lt;- ParseExonName(obj)\nobj[['exclude']][['exon_name']] &lt;- rownames(obj)\n\nobj &lt;- RunBlockCorr(obj, bind.name = \"exon_name\", bind.assay = \"exon\")\n\nFbtPlot(obj, val = \"exon_name.padj\", remove.chr = TRUE, assay = c(\"exclude\", \"exon\"), shape.by = \"assay\", col.by = \"assay\", cols = c(\"yellow\", \"green\"), pt.size = 2)\n\n\n\n\n\n\n\n\n\n# Let's how many exons can be prioritized by both exon assay and exclude assay\nobj[['exclude']][[]] %&gt;% filter(exon_name.padj&lt;1e-5) %&gt;% rownames -&gt; sel1\nobj[['exon']][[]] %&gt;% filter(exon_name.padj&lt;1e-5) %&gt;% rownames -&gt; sel2\nintersect(sel1,sel2)\n\n [1] \"chr1:19342752-19342864/-/CAPZB\"    \"chr1:153990914-153991034/+/RPS27\" \n [3] \"chr10:7806974-7807010/+/ATP5F1C\"   \"chr12:56160626-56160670/+/MYL6\"   \n [5] \"chr12:56160626-56160945/+/MYL6\"    \"chr13:28670669-28672120/+/POMP\"   \n [7] \"chr19:16095264-16095357/+/TPM4\"    \"chr19:16095264-16095454/+/TPM4\"   \n [9] \"chr19:16095264-16095496/+/TPM4\"    \"chr19:16095264-16095893/+/TPM4\"   \n[11] \"chr19:16095264-16096744/+/TPM4\"    \"chr19:16095264-16095591/+/TPM4\"   \n[13] \"chr2:197490527-197490664/-/HSPD1\"  \"chr20:37238402-37238449/+/RPN2\"   \n[15] \"chr3:197953488-197953660/+/RPL35A\" \"chr4:82425563-82425667/-/HNRNPDL\" \n[17] \"chr5:83519349-83522309/+/VCAN\"     \"chr9:35684732-35684807/-/TPM2\"    \n[19] \"chr9:35684732-35684802/-/TPM2\"     \"chrX:154400464-154400626/+/RPL10\" \n\nDefaultAssay(obj) &lt;- \"exclude\"\np1 &lt;- FeaturePlot(obj, features = c(\"chr19:16095264-16095357/+/TPM4\"),order = TRUE)\nDefaultAssay(obj) &lt;- \"exon\"\np2 &lt;- FeaturePlot(obj, features = c(\"chr19:16095264-16095357/+/TPM4\"),order = TRUE)\np3 &lt;- PSIPlot(obj, exon.assay = \"exon\", exclude.assay = \"exclude\", features = c(\"chr19:16095264-16095357/+/TPM4\"),order = TRUE)\ncowplot::plot_grid(p1,p2,p3, ncol=3)\n\n\n\n\n\n\n\n\n\nTrackPlot(bamfile = \"Parent_SC3v3_Human_Glioblastoma_possorted_genome_bam.bam\", gtf = gtf, gene = \"TPM4\", cell.group = Idents(obj), highlights = c(16095264,16095357), junc = TRUE, max.depth = 1)\n\n\n\n\n\n\n\n\nIn previous sections, we noted that exon or junction expression is part of gene expression, and inverse expression patterns can strongly indicate alternative splicing. However, exon-skipped reads are largely independent of exon expression, making them more sensitive for detecting alternative splicing and allowing for the prioritization of many events.\nBecause our spatial dissimilarity test does not account for the spatial dependency of the binding feature, numerous events may be prioritized, especially when the binding feature is sparsely expressed. While some of these events may be true, others might arise due to low coverage. To enhance detection power and reduce potential false positives, intersecting the prioritized exons with the prioritized exon-excluded features can help refine the results.\nMode 3 can be used as an alternative to mode 1 to specifically detect events with strong inverse expression patterns. In mode 3, the exon reads and exon-excluded reads are summed as the binding assay, allowing for a more targeted analysis of such patterns. It is important to note that events detected with mode 3 are always detectable with mode 1, making mode 3 a refined approach for prioritizing inverse expression events.\n\nDefaultAssay(obj) &lt;- \"exclude\"\nobj &lt;- RunBlockCorr(obj, bind.name = \"exon_name\", bind.assay = \"exon\", mode = 3, prefix = \"mode3\")\nDefaultAssay(obj) &lt;- \"exon\"\nobj &lt;- RunBlockCorr(obj, bind.name = \"exon_name\", bind.assay = \"exclude\", mode = 3, prefix = \"mode3\")\nFbtPlot(obj, val = \"mode3.padj\", remove.chr = TRUE, assay = c(\"exclude\", \"exon\"), shape.by = \"assay\", col.by = \"assay\", pt.size = 2, cols=c(\"yellow\", \"green\"))\n\n\n\n\n\n\n\n\nIn this case study, we performed a spatial dissimilarity test between various feature pairs. This method provides an overview of the entire cell population and does not rely on prior cell clustering and annotation, making it a powerful tool for analyzing cell data without any prior knowledge. It is recommended to test different features including junctions and exons, and set up different with their corresponding genes in 3’ or 5’ biased scRNA-seq. Additionally, testing between exon-included and exon-skipped reads have more power to detect exon excluded events.\nTo obtain cell-cluster-specific expression patterns, applying heatmaps and clustering in subsequent analyses is recommended.",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Alternative splicing analysis"
    ]
  },
  {
    "objectID": "Yano_AS.html#questions",
    "href": "Yano_AS.html#questions",
    "title": "Alternative splicing analysis for single cell RNA sequencing",
    "section": "Questions?",
    "text": "Questions?\nIf you have any questions regarding this vignette and the usage of Yano, please feel free to report them through the discussion forum. When submitting your query, please ensure you attach the commands you used for better clarity and support.\n\nCommand(obj)\n\n [1] \"NormalizeData.RNA\"            \"FindVariableFeatures.RNA\"    \n [3] \"RunPCA.RNA\"                   \"FindNeighbors.RNA.pca\"       \n [5] \"FindClusters\"                 \"RunUMAP.RNA.pca\"             \n [7] \"ParseExonName.exon\"           \"NormalizeData.exon\"          \n [9] \"RunAutoCorr.exon.pca\"         \"SetAutoCorrFeatures.exon\"    \n[11] \"NormalizeData.junction\"       \"RunAutoCorr.junction.pca\"    \n[13] \"SetAutoCorrFeatures.junction\" \"ParseExonName.junction\"      \n[15] \"RunBlockCorr.junction\"        \"ScaleData.RNA\"               \n[17] \"ScaleData.exon\"               \"NormalizeData.exclude\"       \n[19] \"RunAutoCorr.exclude.pca\"      \"SetAutoCorrFeatures.exclude\" \n[21] \"ParseExonName.exclude\"        \"RunBlockCorr.exclude\"        \n[23] \"RunBlockCorr.exon\"           \n\nsessionInfo()\n\nR version 4.5.0 (2025-04-11)\nPlatform: aarch64-apple-darwin24.4.0\nRunning under: macOS Sequoia 15.5\n\nMatrix products: default\nBLAS:   /opt/homebrew/Cellar/openblas/0.3.29/lib/libopenblasp-r0.3.29.dylib \nLAPACK: /opt/homebrew/Cellar/r/4.5.0/lib/R/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Asia/Shanghai\ntzcode source: internal\n\nattached base packages:\n[1] grid      stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n[1] ComplexHeatmap_2.24.0 RColorBrewer_1.1-3    future_1.49.0        \n[4] dplyr_1.1.4           Seurat_5.3.0          SeuratObject_5.1.0   \n[7] sp_2.2-0              ggplot2_3.5.2         Yano_1.1             \n\nloaded via a namespace (and not attached):\n  [1] shape_1.4.6.1          jsonlite_2.0.0         magrittr_2.0.3        \n  [4] spatstat.utils_3.1-4   farver_2.1.2           rmarkdown_2.29        \n  [7] GlobalOptions_0.1.2    vctrs_0.6.5            ROCR_1.0-11           \n [10] spatstat.explore_3.4-2 htmltools_0.5.8.1      sctransform_0.4.2     \n [13] parallelly_1.44.0      KernSmooth_2.23-26     htmlwidgets_1.6.4     \n [16] ica_1.0-3              plyr_1.8.9             plotly_4.10.4         \n [19] zoo_1.8-14             igraph_2.1.4           mime_0.13             \n [22] lifecycle_1.0.4        iterators_1.0.14       pkgconfig_2.0.3       \n [25] Matrix_1.7-3           R6_2.6.1               fastmap_1.2.0         \n [28] clue_0.3-66            fitdistrplus_1.2-2     shiny_1.10.0          \n [31] digest_0.6.37          colorspace_2.1-1       S4Vectors_0.46.0      \n [34] patchwork_1.3.0        tensor_1.5             RSpectra_0.16-2       \n [37] irlba_2.3.5.1          labeling_0.4.3         progressr_0.15.1      \n [40] spatstat.sparse_3.1-0  httr_1.4.7             polyclip_1.10-7       \n [43] abind_1.4-8            compiler_4.5.0         withr_3.0.2           \n [46] doParallel_1.0.17      viridis_0.6.5          fastDummies_1.7.5     \n [49] R.utils_2.13.0         MASS_7.3-65            rjson_0.2.23          \n [52] gtools_3.9.5           tools_4.5.0            lmtest_0.9-40         \n [55] httpuv_1.6.16          future.apply_1.11.3    goftest_1.2-3         \n [58] R.oo_1.27.1            glue_1.8.0             nlme_3.1-168          \n [61] promises_1.3.2         Rtsne_0.17             cluster_2.1.8.1       \n [64] reshape2_1.4.4         generics_0.1.4         gtable_0.3.6          \n [67] spatstat.data_3.1-6    R.methodsS3_1.8.2      tidyr_1.3.1           \n [70] data.table_1.17.2      BiocGenerics_0.54.0    spatstat.geom_3.3-6   \n [73] RcppAnnoy_0.0.22       ggrepel_0.9.6          RANN_2.6.2            \n [76] foreach_1.5.2          pillar_1.10.2          stringr_1.5.1         \n [79] spam_2.11-1            RcppHNSW_0.6.0         later_1.4.2           \n [82] circlize_0.4.16        splines_4.5.0          lattice_0.22-6        \n [85] survival_3.8-3         deldir_2.0-4           tidyselect_1.2.1      \n [88] miniUI_0.1.2           pbapply_1.7-2          knitr_1.50            \n [91] gridExtra_2.3          IRanges_2.42.0         scattermore_1.2       \n [94] stats4_4.5.0           xfun_0.52              matrixStats_1.5.0     \n [97] stringi_1.8.7          lazyeval_0.2.2         yaml_2.3.10           \n[100] evaluate_1.0.3         codetools_0.2-20       tibble_3.2.1          \n[103] cli_3.6.5              uwot_0.2.3             xtable_1.8-4          \n[106] reticulate_1.42.0      Rcpp_1.0.14            globals_0.18.0        \n[109] spatstat.random_3.3-3  png_0.1-8              spatstat.univar_3.1-3 \n[112] parallel_4.5.0         dotCall64_1.2          listenv_0.9.1         \n[115] viridisLite_0.4.2      scales_1.4.0           ggridges_0.5.6        \n[118] purrr_1.0.4            crayon_1.5.3           GetoptLong_1.0.5      \n[121] rlang_1.1.6            cowplot_1.1.3",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Alternative splicing analysis"
    ]
  },
  {
    "objectID": "Yano_anno.html",
    "href": "Yano_anno.html",
    "title": "Annotating and prioritizing genetic variants for single cell RNA sequencing",
    "section": "",
    "text": "This vignette demonstrates how Yano can annotate genetic variants using public databases and assist users in interpreting the functional impact of these variants.",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Annotating genetic variants"
    ]
  },
  {
    "objectID": "Yano_anno.html#predict-the-consequence-of-genetic-variants",
    "href": "Yano_anno.html#predict-the-consequence-of-genetic-variants",
    "title": "Annotating and prioritizing genetic variants for single cell RNA sequencing",
    "section": "1. Predict the consequence of genetic variants",
    "text": "1. Predict the consequence of genetic variants\nLoad the object which generated from allele specific gene expression from scRNA-seq. In that case, we used annoVAR to annotate the gene and approximate gene region type for the variants. In this section, we will go further, to predict the consequence of genetic variants. Note that, different from genetic annotation at DNA level, strand information is also consdiered here, so antisense terms will also be generated.\nThe predicted consequences were derived from transcript annotations. However, gencode annotations, generated as part of the ENCODE project, contain numerous truncated transcript records that are not fully consistent with the reference genome, which can introduce bias when predicting amino acid changes. For gene expression analysis, such as scRNA-seq, it’s more common to use gencode, consider the good coverage. But for clinical research, validated annotations like RefSeq are preferred for genetic variant annotation. In this analysis, RefSeq annotations were downloaded from the UCSC server to provide more accurate and reliable predictions. Furthermore, the human genome reference is also need for the prediction.\nwget -c https://hgdownload.soe.ucsc.edu/goldenPath/archive/hg38/ncbiRefSeq/110/hg38.110.ncbiRefSeq.gtf.gz\nwget -c https://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_32/GRCh38.p13.genome.fa.gz\nunzip GRCh38.p13.genome.fa.gz\n\n# FASTA need to be indexed\nsamtools faidx GRCh38.p13.genome.fa\n\nrequire(Yano)\n\nLoading required package: Yano\n\n\n── Attaching packages ────────────────────────────────────────────── Yano 1.1 ──\n✔ dplyr   1.1.4     ✔ Seurat  5.3.0\n✔ ggplot2 3.5.2     \n\nobj &lt;- readRDS(\"glioblastoma5k.rds\")\n\ngtf &lt;- gtf2db(\"hg38.110.ncbiRefSeq.gtf.gz\")\n\n[2025-06-02 15:59:53] GTF loading..\n[2025-06-02 16:00:23] Load 66991 genes.\n\nDefaultAssay(obj) &lt;- \"var\"\nobj &lt;- annoVAR(obj, gtf = gtf, fasta = \"./GRCh38.p13.genome.fa\")\n\nParse names ..\n\n\nCDS region of transcript NM_001261418.2 cannot translate to codons properly.\nCDS region of transcript XM_047433500.1 cannot translate to codons properly.\nCDS region of transcript XM_005271283.4 cannot translate to codons properly.\nCDS region of transcript XM_017002563.2 cannot translate to codons properly.\nCDS region of transcript XM_047432264.1 cannot translate to codons properly.\nCDS region of transcript XM_017002566.2 cannot translate to codons properly.\nCDS region of transcript NM_001350238.2 cannot translate to codons properly.\nCDS region of transcript XM_017002570.2 cannot translate to codons properly.\nCDS region of transcript XM_017002567.2 cannot translate to codons properly.\nCDS region of transcript XM_047432272.1 cannot translate to codons properly.\nCDS region of transcript XM_017002562.2 cannot translate to codons properly.\nCDS region of transcript NM_001350241.2 cannot translate to codons properly.\nCDS region of transcript XM_047432255.1 cannot translate to codons properly.\nCDS region of transcript XM_017002560.3 cannot translate to codons properly.\nCDS region of transcript NM_001350239.2 cannot translate to codons properly.\nCDS region of transcript NM_001032291.3 cannot translate to codons properly.\nCDS region of transcript NM_001394005.1 cannot translate to codons properly.\nCDS region of transcript NM_001350240.2 cannot translate to codons properly.\nCDS region of transcript NM_032636.8 cannot translate to codons properly.\nCDS region of transcript XM_047432251.1 cannot translate to codons properly.\nCDS region of transcript XM_047432274.1 cannot translate to codons properly.\nCDS region of transcript XM_017002569.2 cannot translate to codons properly.\nCDS region of transcript XM_017002564.2 cannot translate to codons properly.\nCDS region of transcript NM_001350242.2 cannot translate to codons properly.\nCDS region of transcript NM_001394002.1 cannot translate to codons properly.\nCDS region of transcript NM_001363309.2 cannot translate to codons properly.\nCDS region of transcript XM_047432275.1 cannot translate to codons properly.\nCDS region of transcript NM_001350237.2 cannot translate to codons properly.\nCDS region of transcript NM_001385672.1 cannot translate to codons properly.\nCDS region of transcript XM_047433003.1 cannot translate to codons properly.\nCDS region of transcript NM_001301244.2 cannot translate to codons properly.\nCDS region of transcript XM_006720667.5 cannot translate to codons properly.\nCDS region of transcript NM_001018005.2 cannot translate to codons properly.\nCDS region of transcript NM_001330346.2 cannot translate to codons properly.\nCDS region of transcript XM_005254650.4 cannot translate to codons properly.\nCDS region of transcript NM_004850.5 cannot translate to codons properly.\nCDS region of transcript NM_001321643.2 cannot translate to codons properly.\nCDS region of transcript NM_080794.4 cannot translate to codons properly.\nCDS region of transcript XM_047447996.1 cannot translate to codons properly.\nCDS region of transcript NM_001077654.3 cannot translate to codons properly.\nCDS region of transcript NM_001385620.1 cannot translate to codons properly.\nCDS region of transcript XM_006716181.5 cannot translate to codons properly.\nCDS region of transcript XM_047421050.1 cannot translate to codons properly.\nCDS region of transcript XM_047422695.1 cannot translate to codons properly.\nCDS region of transcript rna-CYTB cannot translate to codons properly.\nCDS region of transcript rna-COX3 cannot translate to codons properly.\nCDS region of transcript rna-ND1 cannot translate to codons properly.\nCDS region of transcript rna-ND2 cannot translate to codons properly.\nCDS region of transcript rna-ND4 cannot translate to codons properly.\n\nobj[['var']][[]] -&gt; df\nhead(df)\n\n                  chr  start ref alt strand         locus gene_name type\nchr1:631862G&gt;A/+ chr1 631862   G   A      + chr1:631862/+  MTCO1P12 utr5\nchr1:633192G=/+  chr1 633192   G   G      + chr1:633192/+  MTCO2P12 utr5\nchr1:634337T&gt;C/+ chr1 634337   T   C      + chr1:634337/+  MTATP6P1 utr5\nchr1:826352C&gt;T/- chr1 826352   C   T      - chr1:826352/- LINC00115 utr5\nchr1:853876T&gt;C/+ chr1 853876   T   C      + chr1:853876/+ LINC01128 utr5\nchr1:944296G&gt;A/- chr1 944296   G   A      - chr1:944296/-     NOC2L utr3\n                 moransi.pval       moransi autocorr.variable locus.t\nchr1:631862G&gt;A/+ 6.218333e-01 -0.0017809088             FALSE      NA\nchr1:633192G=/+  4.642293e-05  0.0162242246              TRUE      NA\nchr1:634337T&gt;C/+ 4.882067e-01 -0.0003760064             FALSE      NA\nchr1:826352C&gt;T/- 6.661973e-01 -0.0023088544             FALSE      NA\nchr1:853876T&gt;C/+ 3.266314e-02  0.0076495861             FALSE      NA\nchr1:944296G&gt;A/- 3.232372e-01  0.0015298954             FALSE      NA\n                 locus.pval locus.padj    consequence\nchr1:631862G&gt;A/+         NA         NA noncoding_exon\nchr1:633192G=/+          NA         NA            ref\nchr1:634337T&gt;C/+         NA         NA noncoding_exon\nchr1:826352C&gt;T/-         NA         NA noncoding_exon\nchr1:853876T&gt;C/+         NA         NA noncoding_exon\nchr1:944296G&gt;A/-         NA         NA           utr3\n\ntable(df$consequence)\n\n\nantisense_downstream_1K          antisense_exon        antisense_intron \n                     71                     543                    4112 \n  antisense_upstream_1K           downstream_1K   frameshift_truncation \n                    188                     445                       3 \n             intergenic                  intron                missense \n                   2459                   11399                     643 \n         noncoding_exon        noncoding_intron noncoding_splice_region \n                    900                     836                       3 \n                    ref         splice_acceptor            splice_donor \n                  11017                       7                       2 \n          splice_region            splice_sites              start_loss \n                     22                      10                       1 \n         start_retained             stop_gained              synonymous \n                      1                       6                     810 \n            upstream_1K                    utr3                    utr5 \n                    171                    4946                     633 \n\nsubset(df, consequence %in% \"stop_gained\")\n\n                      chr     start ref alt strand            locus gene_name\nchr11:62602409G&gt;A/- chr11  62602409   G   A      - chr11:62602409/-      EML3\nchr21:21480040G&gt;A/+ chr21  21480040   G   A      + chr21:21480040/+     NCAM2\nchr3:53865249C&gt;T/+   chr3  53865249   C   T      +  chr3:53865249/+    IL17RB\nchr5:140557175G&gt;T/-  chr5 140557175   G   T      - chr5:140557175/-      SRA1\nchr7:55473014G&gt;A/-   chr7  55473014   G   A      -  chr7:55473014/-     VOPP1\nchr7:74732529C&gt;T/+   chr7  74732529   C   T      +  chr7:74732529/+     GTF2I\n                      type moransi.pval      moransi autocorr.variable locus.t\nchr11:62602409G&gt;A/-   exon  0.032763688 0.0076500533             FALSE      NA\nchr21:21480040G&gt;A/+ intron  0.222451372 0.0027535436             FALSE      NA\nchr3:53865249C&gt;T/+    exon  0.237271085 0.0025496157             FALSE      NA\nchr5:140557175G&gt;T/-   exon  0.388504949 0.0007173673             FALSE      NA\nchr7:55473014G&gt;A/-    exon  0.001314907 0.0127720172              TRUE      NA\nchr7:74732529C&gt;T/+    exon  0.013125243 0.0089092490             FALSE      NA\n                    locus.pval locus.padj consequence\nchr11:62602409G&gt;A/-         NA         NA stop_gained\nchr21:21480040G&gt;A/+         NA         NA stop_gained\nchr3:53865249C&gt;T/+          NA         NA stop_gained\nchr5:140557175G&gt;T/-         NA         NA stop_gained\nchr7:55473014G&gt;A/-          NA         NA stop_gained\nchr7:74732529C&gt;T/+          NA         NA stop_gained\n\n\n\nsel.chrs &lt;- c(1:21, \"X\")\nFbtPlot(obj, val = \"locus.padj\", remove.chr = TRUE, sel.chrs = sel.chrs, col.by = \"consequence\", pt.size = 2)",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Annotating genetic variants"
    ]
  },
  {
    "objectID": "Yano_anno.html#annotate-genetic-variants-with-publish-databases",
    "href": "Yano_anno.html#annotate-genetic-variants-with-publish-databases",
    "title": "Annotating and prioritizing genetic variants for single cell RNA sequencing",
    "section": "2. Annotate genetic variants with publish databases",
    "text": "2. Annotate genetic variants with publish databases\nAnother key advancement in genetic variant studies is the ability to perform annotation using genotype-phenotype and allele frequency databases. For demonstration purposes, we use the ClinVar database for annotation in this vignette.\n# download the database in VCF format\nwget -c  https://ftp.ncbi.nlm.nih.gov/pub/clinvar/vcf_GRCh38/clinvar.vcf.gz\n\n# remeber to index this database, otherwise annoVAR will report error.\nbcftools index clinvar.vcf.gz\nLet’s take a look at the format of the ClinVar database. As noted, the chromosome names are in the NCBI style, meaning they do not include the “chr” prefix. Therefore, we need to generate a new column with chromosome names formatted for annotation.\n\nbcftools view clinvar.vcf.gz| grep -v \"^#\"| head\n\n1   66926   3385321 AG  A   .   .   ALLELEID=3544463;CLNDISDB=Human_Phenotype_Ontology:HP:0000547,MONDO:MONDO:0019200,MeSH:D012174,MedGen:C0035334,OMIM:268000,OMIM:PS268000,Orphanet:791;CLNDN=Retinitis_pigmentosa;CLNHGVS=NC_000001.11:g.66927del;CLNREVSTAT=criteria_provided,_single_submitter;CLNSIG=Uncertain_significance;CLNSIGSCV=SCV005419006;CLNVC=Deletion;CLNVCSO=SO:0000159;GENEINFO=OR4F5:79501;MC=SO:0001627|intron_variant;ORIGIN=0\n1   69134   2205837 A   G   .   .   ALLELEID=2193183;CLNDISDB=MedGen:CN169374;CLNDN=not_specified;CLNHGVS=NC_000001.11:g.69134A&gt;G;CLNREVSTAT=criteria_provided,_single_submitter;CLNSIG=Likely_benign;CLNSIGSCV=SCV003526545;CLNVC=single_nucleotide_variant;CLNVCSO=SO:0001483;CLNVI=ClinGen:CA502008;GENEINFO=OR4F5:79501;MC=SO:0001583|missense_variant;ORIGIN=1\n1   69314   3205580 T   G   .   .   ALLELEID=3374047;CLNDISDB=MedGen:CN169374;CLNDN=not_specified;CLNHGVS=NC_000001.11:g.69314T&gt;G;CLNREVSTAT=criteria_provided,_single_submitter;CLNSIG=Uncertain_significance;CLNSIGSCV=SCV004995495;CLNVC=single_nucleotide_variant;CLNVCSO=SO:0001483;CLNVI=ClinGen:CA338197388;GENEINFO=OR4F5:79501;MC=SO:0001583|missense_variant;ORIGIN=1\n1   69423   3205581 G   A   .   .   ALLELEID=3374048;CLNDISDB=MedGen:CN169374;CLNDN=not_specified;CLNHGVS=NC_000001.11:g.69423G&gt;A;CLNREVSTAT=criteria_provided,_single_submitter;CLNSIG=Uncertain_significance;CLNSIGSCV=SCV004995496;CLNVC=single_nucleotide_variant;CLNVCSO=SO:0001483;CLNVI=ClinGen:CA338197763;GENEINFO=OR4F5:79501;MC=SO:0001583|missense_variant;ORIGIN=1\n1   69581   2252161 C   G   .   .   ALLELEID=2238986;CLNDISDB=MedGen:CN169374;CLNDN=not_specified;CLNHGVS=NC_000001.11:g.69581C&gt;G;CLNREVSTAT=criteria_provided,_single_submitter;CLNSIG=Uncertain_significance;CLNSIGSCV=SCV003584698;CLNVC=single_nucleotide_variant;CLNVCSO=SO:0001483;CLNVI=ClinGen:CA338198277;GENEINFO=OR4F5:79501;MC=SO:0001583|missense_variant;ORIGIN=1\n1   69682   2396347 G   A   .   .   ALLELEID=2386655;CLNDISDB=MedGen:CN169374;CLNDN=not_specified;CLNHGVS=NC_000001.11:g.69682G&gt;A;CLNREVSTAT=criteria_provided,_single_submitter;CLNSIG=Uncertain_significance;CLNSIGSCV=SCV003739621;CLNVC=single_nucleotide_variant;CLNVCSO=SO:0001483;CLNVI=ClinGen:CA502063;GENEINFO=OR4F5:79501;MC=SO:0001583|missense_variant;ORIGIN=1\n1   69731   3205582 T   C   .   .   ALLELEID=3374049;CLNDISDB=MedGen:CN169374;CLNDN=not_specified;CLNHGVS=NC_000001.11:g.69731T&gt;C;CLNREVSTAT=criteria_provided,_single_submitter;CLNSIG=Uncertain_significance;CLNSIGSCV=SCV004995497;CLNVC=single_nucleotide_variant;CLNVCSO=SO:0001483;CLNVI=ClinGen:CA338198606;GENEINFO=OR4F5:79501;MC=SO:0001583|missense_variant;ORIGIN=1\n1   69769   2288999 T   C   .   .   ALLELEID=2278803;CLNDISDB=MedGen:CN169374;CLNDN=not_specified;CLNHGVS=NC_000001.11:g.69769T&gt;C;CLNREVSTAT=criteria_provided,_single_submitter;CLNSIG=Uncertain_significance;CLNSIGSCV=SCV003620560;CLNVC=single_nucleotide_variant;CLNVCSO=SO:0001483;CLNVI=ClinGen:CA338198691;GENEINFO=OR4F5:79501;MC=SO:0001583|missense_variant;ORIGIN=1\n1   69995   2351346 G   C   .   .   ALLELEID=2333177;CLNDISDB=MedGen:CN169374;CLNDN=not_specified;CLNHGVS=NC_000001.11:g.69995G&gt;C;CLNREVSTAT=criteria_provided,_single_submitter;CLNSIG=Uncertain_significance;CLNSIGSCV=SCV003688488;CLNVC=single_nucleotide_variant;CLNVCSO=SO:0001483;CLNVI=ClinGen:CA502093;GENEINFO=OR4F5:79501;MC=SO:0001583|missense_variant;ORIGIN=1\n1   924518  3388928 G   C   .   .   ALLELEID=3548054;CLNDISDB=MedGen:C3661900;CLNDN=not_provided;CLNHGVS=NC_000001.11:g.924518G&gt;C;CLNREVSTAT=criteria_provided,_single_submitter;CLNSIG=Likely_benign;CLNSIGSCV=SCV005435063;CLNVC=single_nucleotide_variant;CLNVCSO=SO:0001483;GENEINFO=SAMD11:148398|LOC107985728:107985728;MC=SO:0001819|synonymous_variant;ORIGIN=1\n\n\nWe need to create new chromosome names that are compatible with the NCBI database format, because chromosome names in Clinvar database are look like ‘1’, ‘2’.\n\nobj[['var']][['chr0']] &lt;- gsub(\"chr(.*)\",\"\\\\1\", obj[['var']][[]]$chr)\nobj[['var']][[]] %&gt;% head\n\n                  chr  start ref alt strand         locus gene_name type\nchr1:631862G&gt;A/+ chr1 631862   G   A      + chr1:631862/+  MTCO1P12 utr5\nchr1:633192G=/+  chr1 633192   G   G      + chr1:633192/+  MTCO2P12 utr5\nchr1:634337T&gt;C/+ chr1 634337   T   C      + chr1:634337/+  MTATP6P1 utr5\nchr1:826352C&gt;T/- chr1 826352   C   T      - chr1:826352/- LINC00115 utr5\nchr1:853876T&gt;C/+ chr1 853876   T   C      + chr1:853876/+ LINC01128 utr5\nchr1:944296G&gt;A/- chr1 944296   G   A      - chr1:944296/-     NOC2L utr3\n                 moransi.pval       moransi autocorr.variable locus.t\nchr1:631862G&gt;A/+ 6.218333e-01 -0.0017809088             FALSE      NA\nchr1:633192G=/+  4.642293e-05  0.0162242246              TRUE      NA\nchr1:634337T&gt;C/+ 4.882067e-01 -0.0003760064             FALSE      NA\nchr1:826352C&gt;T/- 6.661973e-01 -0.0023088544             FALSE      NA\nchr1:853876T&gt;C/+ 3.266314e-02  0.0076495861             FALSE      NA\nchr1:944296G&gt;A/- 3.232372e-01  0.0015298954             FALSE      NA\n                 locus.pval locus.padj    consequence chr0\nchr1:631862G&gt;A/+         NA         NA noncoding_exon    1\nchr1:633192G=/+          NA         NA            ref    1\nchr1:634337T&gt;C/+         NA         NA noncoding_exon    1\nchr1:826352C&gt;T/-         NA         NA noncoding_exon    1\nchr1:853876T&gt;C/+         NA         NA noncoding_exon    1\nchr1:944296G&gt;A/-         NA         NA           utr3    1\n\n# here we annotate RS id and clinical signification for variants, to check the VCF header for all possible tags\nobj &lt;- annoVAR(obj, vcf = \"clinvar.vcf.gz\", chr = \"chr0\", tags = c(\"RS\", \"CLNSIG\"))\n\nParse names ..\n\n# The RS id and CLNSIG tag now created\nobj[['var']][[]] -&gt; df\nhead(df)\n\n                  chr  start ref alt strand         locus gene_name type\nchr1:631862G&gt;A/+ chr1 631862   G   A      + chr1:631862/+  MTCO1P12 utr5\nchr1:633192G=/+  chr1 633192   G   G      + chr1:633192/+  MTCO2P12 utr5\nchr1:634337T&gt;C/+ chr1 634337   T   C      + chr1:634337/+  MTATP6P1 utr5\nchr1:826352C&gt;T/- chr1 826352   C   T      - chr1:826352/- LINC00115 utr5\nchr1:853876T&gt;C/+ chr1 853876   T   C      + chr1:853876/+ LINC01128 utr5\nchr1:944296G&gt;A/- chr1 944296   G   A      - chr1:944296/-     NOC2L utr3\n                 moransi.pval       moransi autocorr.variable locus.t\nchr1:631862G&gt;A/+ 6.218333e-01 -0.0017809088             FALSE      NA\nchr1:633192G=/+  4.642293e-05  0.0162242246              TRUE      NA\nchr1:634337T&gt;C/+ 4.882067e-01 -0.0003760064             FALSE      NA\nchr1:826352C&gt;T/- 6.661973e-01 -0.0023088544             FALSE      NA\nchr1:853876T&gt;C/+ 3.266314e-02  0.0076495861             FALSE      NA\nchr1:944296G&gt;A/- 3.232372e-01  0.0015298954             FALSE      NA\n                 locus.pval locus.padj    consequence chr0   RS CLNSIG\nchr1:631862G&gt;A/+         NA         NA noncoding_exon    1 &lt;NA&gt;   &lt;NA&gt;\nchr1:633192G=/+          NA         NA            ref    1 &lt;NA&gt;   &lt;NA&gt;\nchr1:634337T&gt;C/+         NA         NA noncoding_exon    1 &lt;NA&gt;   &lt;NA&gt;\nchr1:826352C&gt;T/-         NA         NA noncoding_exon    1 &lt;NA&gt;   &lt;NA&gt;\nchr1:853876T&gt;C/+         NA         NA noncoding_exon    1 &lt;NA&gt;   &lt;NA&gt;\nchr1:944296G&gt;A/-         NA         NA           utr3    1 &lt;NA&gt;   &lt;NA&gt;\n\n# We note that there are several pathogenic variants detected\ntable(df[['CLNSIG']])\n\n\n                                             association \n                                                       8 \n                                                  Benign \n                                                    1695 \n                                    Benign/Likely_benign \n                                                      48 \n            Conflicting_classifications_of_pathogenicity \n                                                      10 \nConflicting_classifications_of_pathogenicity|risk_factor \n                                                       3 \n                                           drug_response \n                                                       1 \n                                           Likely_benign \n                                                      50 \n                no_classification_for_the_single_variant \n                                                      12 \n                                            not_provided \n                                                       1 \n                                                   other \n                                                       9 \n                                              Pathogenic \n                                                       1 \n                            Pathogenic/Likely_pathogenic \n                                                       2 \n                                  Pathogenic|risk_factor \n                                                       1 \n                                             risk_factor \n                                                       6 \n                                  Uncertain_significance \n                                                      32 \n\ndf %&gt;% filter(CLNSIG %in% c('Pathogenic', 'Pathogenic/Likely_pathogenic', 'Pathogenic|risk_factor'))\n\n                      chr     start ref alt strand            locus gene_name\nchr1:196690107C=/+   chr1 196690107   C   C      + chr1:196690107/+       CFH\nchr13:50945445G=/+  chr13  50945445   G   G      + chr13:50945445/+  RNASEH2B\nchr13:50945445G&gt;A/+ chr13  50945445   G   A      + chr13:50945445/+  RNASEH2B\nchr15:92992967C=/+  chr15  92992967   C   C      + chr15:92992967/+      CHD2\n                          type moransi.pval      moransi autocorr.variable\nchr1:196690107C=/+  multigenes 3.455725e-76  0.076938465              TRUE\nchr13:50945445G=/+        exon 6.488097e-04  0.013692536              TRUE\nchr13:50945445G&gt;A/+       exon 5.375273e-07  0.021007235              TRUE\nchr15:92992967C=/+        exon 8.592924e-01 -0.005173039             FALSE\n                      locus.t locus.pval locus.padj consequence chr0       RS\nchr1:196690107C=/+  -7.423186  1.0000000          1         ref    1  1061170\nchr13:50945445G=/+  -2.220257  0.9856590          1         ref   13 75184679\nchr13:50945445G&gt;A/+ -1.603578  0.9440036          1    missense   13 75184679\nchr15:92992967C=/+         NA         NA         NA         ref   15  2272457\n                                          CLNSIG\nchr1:196690107C=/+        Pathogenic|risk_factor\nchr13:50945445G=/+  Pathogenic/Likely_pathogenic\nchr13:50945445G&gt;A/+ Pathogenic/Likely_pathogenic\nchr15:92992967C=/+                    Pathogenic\n\n\nIn the selected SNVs, we found some reference alleles are highlighted, such as chr15:92992967C=/+. These reference alelles are more like to be benign allele. Let’s query the orignal record in the clinvar database to check what exactly stituation it should be.\n\nbcftools view clinvar.vcf.gz 15:92992967-92992967\n\n##fileformat=VCFv4.1\n##FILTER=&lt;ID=PASS,Description=\"All filters passed\"&gt;\n##fileDate=2025-02-17\n##source=ClinVar\n##reference=GRCh38\n##ID=&lt;Description=\"ClinVar Variation ID\"&gt;\n##INFO=&lt;ID=AF_ESP,Number=1,Type=Float,Description=\"allele frequencies from GO-ESP\"&gt;\n##INFO=&lt;ID=AF_EXAC,Number=1,Type=Float,Description=\"allele frequencies from ExAC\"&gt;\n##INFO=&lt;ID=AF_TGP,Number=1,Type=Float,Description=\"allele frequencies from TGP\"&gt;\n##INFO=&lt;ID=ALLELEID,Number=1,Type=Integer,Description=\"the ClinVar Allele ID\"&gt;\n##INFO=&lt;ID=CLNDN,Number=.,Type=String,Description=\"ClinVar's preferred disease name for the concept specified by disease identifiers in CLNDISDB\"&gt;\n##INFO=&lt;ID=CLNDNINCL,Number=.,Type=String,Description=\"For included Variant : ClinVar's preferred disease name for the concept specified by disease identifiers in CLNDISDB\"&gt;\n##INFO=&lt;ID=CLNDISDB,Number=.,Type=String,Description=\"Tag-value pairs of disease database name and identifier submitted for germline classifications, e.g. OMIM:NNNNNN\"&gt;\n##INFO=&lt;ID=CLNDISDBINCL,Number=.,Type=String,Description=\"For included Variant: Tag-value pairs of disease database name and identifier for germline classifications, e.g. OMIM:NNNNNN\"&gt;\n##INFO=&lt;ID=CLNHGVS,Number=.,Type=String,Description=\"Top-level (primary assembly, alt, or patch) HGVS expression.\"&gt;\n##INFO=&lt;ID=CLNREVSTAT,Number=.,Type=String,Description=\"ClinVar review status of germline classification for the Variation ID\"&gt;\n##INFO=&lt;ID=CLNSIG,Number=.,Type=String,Description=\"Aggregate germline classification for this single variant; multiple values are separated by a vertical bar\"&gt;\n##INFO=&lt;ID=CLNSIGCONF,Number=.,Type=String,Description=\"Conflicting germline classification for this single variant; multiple values are separated by a vertical bar\"&gt;\n##INFO=&lt;ID=CLNSIGINCL,Number=.,Type=String,Description=\"Germline classification for a haplotype or genotype that includes this variant. Reported as pairs of VariationID:classification; multiple values are separated by a vertical bar\"&gt;\n##INFO=&lt;ID=CLNSIGSCV,Number=.,Type=String,Description=\"SCV accession numbers for the submissions that contribute to the aggregate germline classification in ClinVar; multiple values are separated by a vertical bar\"&gt;\n##INFO=&lt;ID=CLNVC,Number=1,Type=String,Description=\"Variant type\"&gt;\n##INFO=&lt;ID=CLNVCSO,Number=1,Type=String,Description=\"Sequence Ontology id for variant type\"&gt;\n##INFO=&lt;ID=CLNVI,Number=.,Type=String,Description=\"the variant's clinical sources reported as tag-value pairs of database and variant identifier\"&gt;\n##INFO=&lt;ID=DBVARID,Number=.,Type=String,Description=\"nsv accessions from dbVar for the variant\"&gt;\n##INFO=&lt;ID=GENEINFO,Number=1,Type=String,Description=\"Gene(s) for the variant reported as gene symbol:gene id. The gene symbol and id are delimited by a colon (:) and each pair is delimited by a vertical bar (|)\"&gt;\n##INFO=&lt;ID=MC,Number=.,Type=String,Description=\"comma separated list of molecular consequence in the form of Sequence Ontology ID|molecular_consequence\"&gt;\n##INFO=&lt;ID=ONCDN,Number=.,Type=String,Description=\"ClinVar's preferred disease name for the concept specified by disease identifiers in ONCDISDB\"&gt;\n##INFO=&lt;ID=ONCDNINCL,Number=.,Type=String,Description=\"For included variant: ClinVar's preferred disease name for the concept specified by disease identifiers in ONCDISDBINCL\"&gt;\n##INFO=&lt;ID=ONCDISDB,Number=.,Type=String,Description=\"Tag-value pairs of disease database name and identifier submitted for oncogenicity classifications, e.g. MedGen:NNNNNN\"&gt;\n##INFO=&lt;ID=ONCDISDBINCL,Number=.,Type=String,Description=\"For included variant: Tag-value pairs of disease database name and identifier for oncogenicity classifications, e.g. OMIM:NNNNNN\"&gt;\n##INFO=&lt;ID=ONC,Number=.,Type=String,Description=\"Aggregate oncogenicity classification for this single variant; multiple values are separated by a vertical bar\"&gt;\n##INFO=&lt;ID=ONCINCL,Number=.,Type=String,Description=\"Oncogenicity classification for a haplotype or genotype that includes this variant. Reported as pairs of VariationID:classification; multiple values are separated by a vertical bar\"&gt;\n##INFO=&lt;ID=ONCREVSTAT,Number=.,Type=String,Description=\"ClinVar review status of oncogenicity classification for the Variation ID\"&gt;\n##INFO=&lt;ID=ONCSCV,Number=.,Type=String,Description=\"SCV accession numbers for the submissions that contribute to the aggregate oncogenicity classification in ClinVar; multiple values are separated by a vertical bar\"&gt;\n##INFO=&lt;ID=ONCCONF,Number=.,Type=String,Description=\"Conflicting oncogenicity classification for this single variant; multiple values are separated by a vertical bar\"&gt;\n##INFO=&lt;ID=ORIGIN,Number=.,Type=String,Description=\"Allele origin. One or more of the following values may be added: 0 - unknown; 1 - germline; 2 - somatic; 4 - inherited; 8 - paternal; 16 - maternal; 32 - de-novo; 64 - biparental; 128 - uniparental; 256 - not-tested; 512 - tested-inconclusive; 1073741824 - other\"&gt;\n##INFO=&lt;ID=RS,Number=.,Type=String,Description=\"dbSNP ID (i.e. rs number)\"&gt;\n##INFO=&lt;ID=SCIDN,Number=.,Type=String,Description=\"ClinVar's preferred disease name for the concept specified by disease identifiers in SCIDISDB\"&gt;\n##INFO=&lt;ID=SCIDNINCL,Number=.,Type=String,Description=\"For included variant: ClinVar's preferred disease name for the concept specified by disease identifiers in SCIDISDBINCL\"&gt;\n##INFO=&lt;ID=SCIDISDB,Number=.,Type=String,Description=\"Tag-value pairs of disease database name and identifier submitted for somatic clinial impact classifications, e.g. MedGen:NNNNNN\"&gt;\n##INFO=&lt;ID=SCIDISDBINCL,Number=.,Type=String,Description=\"For included variant: Tag-value pairs of disease database name and identifier for somatic clinical impact classifications, e.g. OMIM:NNNNNN\"&gt;\n##INFO=&lt;ID=SCIREVSTAT,Number=.,Type=String,Description=\"ClinVar review status of somatic clinical impact for the Variation ID\"&gt;\n##INFO=&lt;ID=SCI,Number=.,Type=String,Description=\"Aggregate somatic clinical impact for this single variant; multiple values are separated by a vertical bar\"&gt;\n##INFO=&lt;ID=SCIINCL,Number=.,Type=String,Description=\"Somatic clinical impact classification for a haplotype or genotype that includes this variant. Reported as pairs of VariationID:classification; multiple values are separated by a vertical bar\"&gt;\n##INFO=&lt;ID=SCISCV,Number=.,Type=String,Description=\"SCV accession numbers for the submissions that contribute to the aggregate somatic clinical impact in ClinVar; multiple values are separated by a vertical bar\"&gt;\n##contig=&lt;ID=1&gt;\n##contig=&lt;ID=2&gt;\n##contig=&lt;ID=3&gt;\n##contig=&lt;ID=4&gt;\n##contig=&lt;ID=5&gt;\n##contig=&lt;ID=6&gt;\n##contig=&lt;ID=7&gt;\n##contig=&lt;ID=8&gt;\n##contig=&lt;ID=9&gt;\n##contig=&lt;ID=10&gt;\n##contig=&lt;ID=11&gt;\n##contig=&lt;ID=12&gt;\n##contig=&lt;ID=13&gt;\n##contig=&lt;ID=14&gt;\n##contig=&lt;ID=15&gt;\n##contig=&lt;ID=16&gt;\n##contig=&lt;ID=17&gt;\n##contig=&lt;ID=18&gt;\n##contig=&lt;ID=19&gt;\n##contig=&lt;ID=20&gt;\n##contig=&lt;ID=21&gt;\n##contig=&lt;ID=22&gt;\n##contig=&lt;ID=X&gt;\n##contig=&lt;ID=Y&gt;\n##contig=&lt;ID=MT&gt;\n##contig=&lt;ID=NT_113889.1&gt;\n##contig=&lt;ID=NT_187633.1&gt;\n##contig=&lt;ID=NT_187661.1&gt;\n##contig=&lt;ID=NT_187693.1&gt;\n##contig=&lt;ID=NW_009646201.1&gt;\n##bcftools_viewVersion=1.21+htslib-1.21\n##bcftools_viewCommand=view clinvar.vcf.gz 15:92992967-92992967; Date=Mon Jun  2 16:00:32 2025\n#CHROM  POS ID  REF ALT QUAL    FILTER  INFO\n15  92992967    633515  C   G   .   .   ALLELEID=621980;CLNDISDB=MedGen:CN517202;CLNDN=not_provided;CLNHGVS=NC_000015.10:g.92992967C&gt;G;CLNREVSTAT=criteria_provided,_single_submitter;CLNSIG=Pathogenic;CLNSIGSCV=SCV000920484;CLNVC=single_nucleotide_variant;CLNVCSO=SO:0001483;CLNVI=ClinGen:CA393896759;GENEINFO=CHD2:1106;MC=SO:0001587|nonsense;ORIGIN=1;RS=2272457\n15  92992967    257709  C   T   .   .   AF_ESP=0.2485;AF_EXAC=0.22658;AF_TGP=0.19349;ALLELEID=255446;CLNDISDB=MeSH:D030342,MedGen:C0950123|MONDO:MONDO:0014150,MedGen:C3809278,OMIM:615369,Orphanet:1942,Orphanet:2382|MedGen:C3661900|MedGen:CN169374;CLNDN=Inborn_genetic_diseases|Developmental_and_epileptic_encephalopathy_94|not_provided|not_specified;CLNHGVS=NC_000015.10:g.92992967C&gt;T;CLNREVSTAT=criteria_provided,_multiple_submitters,_no_conflicts;CLNSIG=Benign;CLNSIGSCV=SCV000307175|SCV000519223|SCV000841518|SCV000846021|SCV001730597|SCV001806395|SCV005087698|SCV005297510;CLNVC=single_nucleotide_variant;CLNVCSO=SO:0001483;CLNVI=ClinGen:CA7748248;GENEINFO=CHD2:1106;MC=SO:0001819|synonymous_variant;ORIGIN=1;RS=2272457\n\n\nYou can easily observe that the pathogenic allele is G, where the change from C to G leads to a nonsense mutation. However, if we examine the header, we see that the ‘Number’ field of CLNSIG is labeled as ‘.’, which indicates that this term is not allele-specific—an inappropriate type for this record. In fact, this issue extends beyond just CLNSIG; all terms in the ClinVar database are labeled as ‘.’.\nTo correct this, we need to manually change the type from ‘.’ to ‘A’ (allele-specific) for allele-specific tags in the VCF file. For more information, please refer to the VCF specification.\nUnfortunately, many databases distributed in VCF format may contain non-uniformly formatted tags. Apart from manually updating these databases or filter reference allele afterward, there is no straightforward solution to this issue.\nIn addition, the RS tag is annotated, and we can refer to the NCBI SNP database for more information. For example, the mutation chr13:50945445G&gt;A/+ at RS 75184679 can be found at the following link: https://www.ncbi.nlm.nih.gov/snp/rs75184679. This mutation is associated with conditions such as “Abnormality of the nervous system” and other diseases.\n\nFeaturePlot(obj, features = c(\"chr13:50945445G&gt;A/+\", \"chr13:50945445G=/+\", \"RNASEH2B\"), order = TRUE, ncol=3)\n\nWarning: The `slot` argument of `FetchData()` is deprecated as of SeuratObject 5.0.0.\nℹ Please use the `layer` argument instead.\nℹ The deprecated feature was likely used in the Seurat package.\n  Please report the issue at &lt;https://github.com/satijalab/seurat/issues&gt;.\n\n\nWarning: Could not find RNASEH2B in the default search locations, found in\n'RNA' assay instead\n\n\n\n\n\n\n\n\n\nNote that not all reads from this gene cover the SNV, which results in the SNV expression being sparser compared to the overall gene expression. Moreover, it also possible to map the clinical significant labels or other tags to the Manhatten plot.\n\nsel.chrs &lt;- c(1:21, \"X\")\nFbtPlot(obj, val = \"locus.padj\", remove.chr = TRUE, sel.chrs = sel.chrs, col.by = \"CLNSIG\", pt.size = 2, cols = c(\"#131313\",\"blue\",\"#A6CEE3\",\"#1F78B4\",\"#B2DF8A\",\"#33A02C\",\"#FB9A99\",\"#E31A1C\",\"#FDBF6F\",\"#FF7F00\",\"#CAB2D6\",\"#6A3D9A\",\"#FFFF99\",\"#B15928\"))\n\n\n\n\n\n\n\n\n\nCommand(obj)\n\n [1] \"NormalizeData.RNA\"        \"FindVariableFeatures.RNA\"\n [3] \"ScaleData.RNA\"            \"RunPCA.RNA\"              \n [5] \"FindNeighbors.RNA.pca\"    \"FindClusters\"            \n [7] \"RunUMAP.RNA.pca\"          \"NormalizeData.var\"       \n [9] \"RunAutoCorr.var.pca\"      \"SetAutoCorrFeatures.var\" \n[11] \"RunBlockCorr.var\"         \"ParseVarName.var\"        \n[13] \"annoVAR.var\"             \n\nsessionInfo()\n\nR version 4.5.0 (2025-04-11)\nPlatform: aarch64-apple-darwin24.4.0\nRunning under: macOS Sequoia 15.5\n\nMatrix products: default\nBLAS:   /opt/homebrew/Cellar/openblas/0.3.29/lib/libopenblasp-r0.3.29.dylib \nLAPACK: /opt/homebrew/Cellar/r/4.5.0/lib/R/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Asia/Shanghai\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] dplyr_1.1.4        Seurat_5.3.0       SeuratObject_5.1.0 sp_2.2-0          \n[5] ggplot2_3.5.2      Yano_1.1          \n\nloaded via a namespace (and not attached):\n  [1] deldir_2.0-4           pbapply_1.7-2          gridExtra_2.3         \n  [4] rlang_1.1.6            magrittr_2.0.3         RcppAnnoy_0.0.22      \n  [7] spatstat.geom_3.3-6    matrixStats_1.5.0      ggridges_0.5.6        \n [10] compiler_4.5.0         png_0.1-8              vctrs_0.6.5           \n [13] reshape2_1.4.4         stringr_1.5.1          pkgconfig_2.0.3       \n [16] fastmap_1.2.0          labeling_0.4.3         promises_1.3.2        \n [19] rmarkdown_2.29         purrr_1.0.4            xfun_0.52             \n [22] jsonlite_2.0.0         goftest_1.2-3          later_1.4.2           \n [25] spatstat.utils_3.1-4   irlba_2.3.5.1          parallel_4.5.0        \n [28] cluster_2.1.8.1        R6_2.6.1               ica_1.0-3             \n [31] stringi_1.8.7          RColorBrewer_1.1-3     spatstat.data_3.1-6   \n [34] reticulate_1.42.0      spatstat.univar_3.1-3  parallelly_1.44.0     \n [37] lmtest_0.9-40          scattermore_1.2        Rcpp_1.0.14           \n [40] knitr_1.50             tensor_1.5             future.apply_1.11.3   \n [43] zoo_1.8-14             R.utils_2.13.0         sctransform_0.4.2     \n [46] httpuv_1.6.16          Matrix_1.7-3           splines_4.5.0         \n [49] igraph_2.1.4           tidyselect_1.2.1       viridis_0.6.5         \n [52] abind_1.4-8            yaml_2.3.10            spatstat.random_3.3-3 \n [55] codetools_0.2-20       miniUI_0.1.2           spatstat.explore_3.4-2\n [58] listenv_0.9.1          lattice_0.22-6         tibble_3.2.1          \n [61] plyr_1.8.9             withr_3.0.2            shiny_1.10.0          \n [64] ROCR_1.0-11            evaluate_1.0.3         Rtsne_0.17            \n [67] future_1.49.0          fastDummies_1.7.5      survival_3.8-3        \n [70] polyclip_1.10-7        fitdistrplus_1.2-2     pillar_1.10.2         \n [73] KernSmooth_2.23-26     plotly_4.10.4          generics_0.1.4        \n [76] RcppHNSW_0.6.0         scales_1.4.0           gtools_3.9.5          \n [79] globals_0.18.0         xtable_1.8-4           glue_1.8.0            \n [82] lazyeval_0.2.2         tools_4.5.0            data.table_1.17.2     \n [85] RSpectra_0.16-2        RANN_2.6.2             dotCall64_1.2         \n [88] cowplot_1.1.3          grid_4.5.0             tidyr_1.3.1           \n [91] nlme_3.1-168           patchwork_1.3.0        cli_3.6.5             \n [94] spatstat.sparse_3.1-0  spam_2.11-1            viridisLite_0.4.2     \n [97] uwot_0.2.3             gtable_0.3.6           R.methodsS3_1.8.2     \n[100] digest_0.6.37          progressr_0.15.1       ggrepel_0.9.6         \n[103] htmlwidgets_1.6.4      farver_2.1.2           htmltools_0.5.8.1     \n[106] R.oo_1.27.1            lifecycle_1.0.4        httr_1.4.7            \n[109] mime_0.13              MASS_7.3-65",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Annotating genetic variants"
    ]
  },
  {
    "objectID": "test.html",
    "href": "test.html",
    "title": "Spatial dissimilarity analysis for single-cell trajectories and supervised embeddings",
    "section": "",
    "text": "require(Yano)\n\nLoading required package: Yano\n\n\n── Attaching packages ────────────────────────────────────────────── Yano 1.1 ──\n✔ dplyr   1.1.4     ✔ Seurat  5.3.0\n✔ ggplot2 3.5.2     \n\nobj.sel &lt;- readRDS(\"./select.rds\")\nDefaultAssay(obj.sel) &lt;- \"RNA\"\n\ns.genes &lt;- cc.genes$s.genes\ng2m.genes &lt;- cc.genes$g2m.genes\n\nobj.sel[['Group']] &lt;- Idents(obj.sel)\nobj.sel &lt;- CellCycleScoring(obj.sel, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)\n\nWarning: The `slot` argument of `GetAssayData()` is deprecated as of SeuratObject 5.0.0.\nℹ Please use the `layer` argument instead.\nℹ The deprecated feature was likely used in the Seurat package.\n  Please report the issue at &lt;https://github.com/satijalab/seurat/issues&gt;.\n\n\nWarning: The following features are not present in the object: MLF1IP, E2F8,\nnot searching for symbol synonyms\n\n\nWarning: The following features are not present in the object: FAM64A, AURKB,\nHN1, not searching for symbol synonyms\n\n\n\ngtf &lt;- gtf2db(\"./Homo_sapiens.GRCh38.114.chr.gtf.gz\")\n\n[2025-06-02 16:59:13] GTF loading..\n[2025-06-02 17:00:16] Load 78686 genes.\n\nbamfiles &lt;- list(rep1 = \"./donor1_rep1.bam\", rep2 = \"./donor1_rep2.bam\")\ncell.list &lt;- split(obj.sel$Phase, obj.sel$replicate)\n\ncell.list1 &lt;- lapply(cell.list, function(x) {\n  nm &lt;- names(x)\n  names(x) &lt;- gsub(\".*rep[12]-(.*)\",\"\\\\1\",nm)\n  x\n})\nstr(cell.list1)\n\nList of 2\n $ rep1: Named chr [1:954] \"S\" \"S\" \"G2M\" \"S\" ...\n  ..- attr(*, \"names\")= chr [1:954] \"GACAGAGTCATACGGT-1\" \"GCTCCTATCATCGCTC-1\" \"GTAGTCATCCGAACGC-1\" \"TTTCCTCCACTATCTT-1\" ...\n $ rep2: Named chr [1:2023] \"S\" \"S\" \"S\" \"S\" ...\n  ..- attr(*, \"names\")= chr [1:2023] \"GGCTCGACATGTCTCC-1\" \"CCTATTAGTCCAGTAT-1\" \"GTAACGTCACTTACGA-1\" \"AAGGCAGCACGTCTCT-1\" ...\n\nTrackPlot(bamfile = bamfiles, cell.group = cell.list1, gtf = gtf, gene = \"EIF4H\", highlights = c(74196642,74197050), junc=TRUE)\n\n\n\n\n\n\n\n\n\nCommand(obj.sel)\n\n[1] \"NormalizeData.RNA\"        \"FindVariableFeatures.RNA\"\n[3] \"ScaleData.RNA\"            \"RunPCA.RNA\"              \n[5] \"FindNeighbors.RNA.pca\"    \"FindClusters\"            \n[7] \"RunUMAP.RNA.pca\"         \n\nsessionInfo()\n\nR version 4.5.0 (2025-04-11)\nPlatform: aarch64-apple-darwin24.4.0\nRunning under: macOS Sequoia 15.5\n\nMatrix products: default\nBLAS:   /opt/homebrew/Cellar/openblas/0.3.29/lib/libopenblasp-r0.3.29.dylib \nLAPACK: /opt/homebrew/Cellar/r/4.5.0/lib/R/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Asia/Shanghai\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] dplyr_1.1.4        Seurat_5.3.0       SeuratObject_5.1.0 sp_2.2-0          \n[5] ggplot2_3.5.2      Yano_1.1          \n\nloaded via a namespace (and not attached):\n  [1] deldir_2.0-4           pbapply_1.7-2          gridExtra_2.3         \n  [4] rlang_1.1.6            magrittr_2.0.3         RcppAnnoy_0.0.22      \n  [7] spatstat.geom_3.3-6    matrixStats_1.5.0      ggridges_0.5.6        \n [10] compiler_4.5.0         png_0.1-8              vctrs_0.6.5           \n [13] reshape2_1.4.4         stringr_1.5.1          pkgconfig_2.0.3       \n [16] fastmap_1.2.0          labeling_0.4.3         promises_1.3.2        \n [19] rmarkdown_2.29         purrr_1.0.4            xfun_0.52             \n [22] jsonlite_2.0.0         goftest_1.2-3          later_1.4.2           \n [25] spatstat.utils_3.1-4   irlba_2.3.5.1          parallel_4.5.0        \n [28] cluster_2.1.8.1        R6_2.6.1               ica_1.0-3             \n [31] stringi_1.8.7          RColorBrewer_1.1-3     spatstat.data_3.1-6   \n [34] reticulate_1.42.0      spatstat.univar_3.1-3  parallelly_1.44.0     \n [37] lmtest_0.9-40          scattermore_1.2        Rcpp_1.0.14           \n [40] knitr_1.50             tensor_1.5             future.apply_1.11.3   \n [43] zoo_1.8-14             R.utils_2.13.0         sctransform_0.4.2     \n [46] httpuv_1.6.16          Matrix_1.7-3           splines_4.5.0         \n [49] igraph_2.1.4           tidyselect_1.2.1       viridis_0.6.5         \n [52] abind_1.4-8            yaml_2.3.10            spatstat.random_3.3-3 \n [55] codetools_0.2-20       miniUI_0.1.2           spatstat.explore_3.4-2\n [58] listenv_0.9.1          lattice_0.22-6         tibble_3.2.1          \n [61] plyr_1.8.9             withr_3.0.2            shiny_1.10.0          \n [64] ROCR_1.0-11            evaluate_1.0.3         Rtsne_0.17            \n [67] future_1.49.0          fastDummies_1.7.5      survival_3.8-3        \n [70] polyclip_1.10-7        fitdistrplus_1.2-2     pillar_1.10.2         \n [73] KernSmooth_2.23-26     plotly_4.10.4          generics_0.1.4        \n [76] RcppHNSW_0.6.0         scales_1.4.0           gtools_3.9.5          \n [79] globals_0.18.0         xtable_1.8-4           glue_1.8.0            \n [82] lazyeval_0.2.2         tools_4.5.0            data.table_1.17.2     \n [85] RSpectra_0.16-2        RANN_2.6.2             dotCall64_1.2         \n [88] cowplot_1.1.3          grid_4.5.0             tidyr_1.3.1           \n [91] nlme_3.1-168           patchwork_1.3.0        cli_3.6.5             \n [94] spatstat.sparse_3.1-0  spam_2.11-1            viridisLite_0.4.2     \n [97] uwot_0.2.3             gtable_0.3.6           R.methodsS3_1.8.2     \n[100] digest_0.6.37          progressr_0.15.1       ggrepel_0.9.6         \n[103] htmlwidgets_1.6.4      farver_2.1.2           htmltools_0.5.8.1     \n[106] R.oo_1.27.1            lifecycle_1.0.4        httr_1.4.7            \n[109] mime_0.13              MASS_7.3-65           \n\n\n\n\n\n Back to top"
  },
  {
    "objectID": "Visium.html",
    "href": "Visium.html",
    "title": "Perform alternative splicing analysis for multiple Visium samples",
    "section": "",
    "text": "This vignette demonstrates how to analyze alternative splicing across multiple Visium samples. The procedure for spatial transcriptomics follows the same principles as scRNA-seq but requires careful handling of imaging data and spatial coordinates for accurate visualization. Additionally, this example illustrates how to visualize genome tracks from multiple BAM files.",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Analysis multiple Visium samples"
    ]
  },
  {
    "objectID": "Visium.html#prepare-the-data.",
    "href": "Visium.html#prepare-the-data.",
    "title": "Perform alternative splicing analysis for multiple Visium samples",
    "section": "0. Prepare the data.",
    "text": "0. Prepare the data.\nWe will use four Visium slices for 10X data source page. These slices come from two sections, each section contain two slices, one is sagittal anterior, and another one is sagittal posterior of mouse brain. We download the processed BAM files, and annotated them with PISA.\nSection 1, sagittal anterior\nSection 1, sagittal posterior\nSection 2, sagittal anterior\nSection 2, sagittal posterior\nThe following commands run on a terminal.\n# Create directory for each section and slice\nmkdir -p visium/section1/Posterior\nmkdir -p visium/section1/Anterior\nmkdir -p visium/section2/Posterior\nmkdir -p visium/section2/Anterior\n\n# Enter to work directory and download GTF for mouse\ncd visium;\nwget -c https://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_mouse/release_M10/gencode.vM10.annotation.gtf.gz\n\n# Download the bam file and image files to each directory\ncd section1/Posterior\nwget -c https://cf.10xgenomics.com/samples/spatial-exp/1.1.0/V1_Mouse_Brain_Sagittal_Posterior/V1_Mouse_Brain_Sagittal_Posterior_possorted_genome_bam.bam\nwget -c https://cf.10xgenomics.com/samples/spatial-exp/1.1.0/V1_Mouse_Brain_Sagittal_Posterior/V1_Mouse_Brain_Sagittal_Posterior_possorted_genome_bam.bam.bai\nwget -c https://cf.10xgenomics.com/samples/spatial-exp/1.1.0/V1_Mouse_Brain_Sagittal_Posterior/V1_Mouse_Brain_Sagittal_Posterior_spatial.tar.gz\n\n# unpack image files\ntar zxvf V1_Mouse_Brain_Sagittal_Posterior_spatial.tar.gz\n\n# Annotate and count features\nPISA anno -gtf ../../gencode.vM10.annotation.gtf.gz -exon -psi -o anno.bam -t 7 V1_Mouse_Brain_Sagittal_Posterior_possorted_genome_bam.bam\n\nmkdir exp\nmkdir exon\nmkdir junction\nmkdir exclude\nPISA count -tag CB -umi UB -anno-tag GN -outdir exp anno.bam\nPISA count -tag CB -umi UB -anno-tag EX -outdir exon anno.bam\nPISA count -tag CB -umi UB -anno-tag JC -outdir junction anno.bam\nPISA count -tag CB -umi UB -anno-tag ER -outdir exclude anno.bam\n\n## Go back to work directory, and reenter to another slice's directory\ncd -; \ncd section1/Anterior\nwget -c https://s3-us-west-2.amazonaws.com/10x.files/samples/spatial-exp/1.1.0/V1_Mouse_Brain_Sagittal_Anterior/V1_Mouse_Brain_Sagittal_Anterior_possorted_genome_bam.bam\nwget -c https://cf.10xgenomics.com/samples/spatial-exp/1.1.0/V1_Mouse_Brain_Sagittal_Anterior/V1_Mouse_Brain_Sagittal_Anterior_possorted_genome_bam.bam.bai\nwget -c https://cf.10xgenomics.com/samples/spatial-exp/1.1.0/V1_Mouse_Brain_Sagittal_Anterior/V1_Mouse_Brain_Sagittal_Anterior_spatial.tar.gz\n\n# unpack image file\ntar zxvf V1_Mouse_Brain_Sagittal_Anterior_spatial.tar.gz\n\n# Annotate and count features\nPISA anno -gtf ../../gencode.vM10.annotation.gtf.gz -exon -psi -o anno.bam -t 7 V1_Mouse_Brain_Sagittal_Anterior_possorted_genome_bam.bam\n\nmkdir exp\nmkdir exon\nmkdir junction\nmkdir exclude\nPISA count -tag CB -umi UB -anno-tag GN -outdir exp anno.bam\nPISA count -tag CB -umi UB -anno-tag EX -outdir exon anno.bam\nPISA count -tag CB -umi UB -anno-tag JC -outdir junction anno.bam\nPISA count -tag CB -umi UB -anno-tag ER -outdir exclude anno.bam\n\n# Swith to section 2 \ncd -;\ncd section2/Anterior\nwget -c https://s3-us-west-2.amazonaws.com/10x.files/samples/spatial-exp/1.1.0/V1_Mouse_Brain_Sagittal_Anterior_Section_2/V1_Mouse_Brain_Sagittal_Anterior_Section_2_possorted_genome_bam.bam\nwget -c https://cf.10xgenomics.com/samples/spatial-exp/1.1.0/V1_Mouse_Brain_Sagittal_Anterior_Section_2/V1_Mouse_Brain_Sagittal_Anterior_Section_2_possorted_genome_bam.bam.bai\nwget -c https://cf.10xgenomics.com/samples/spatial-exp/1.1.0/V1_Mouse_Brain_Sagittal_Anterior_Section_2/V1_Mouse_Brain_Sagittal_Anterior_Section_2_spatial.tar.gz\n\ntar zxvf V1_Mouse_Brain_Sagittal_Anterior_Section_2_spatial.tar.gz\n\nPISA anno -gtf ../../gencode.vM10.annotation.gtf.gz -exon -psi -o anno.bam -t 7 V1_Mouse_Brain_Sagittal_Anterior_Section_2_possorted_genome_bam.bam\n\nmkdir exp\nmkdir exon\nmkdir junction\nmkdir exclude\nPISA count -tag CB -umi UB -anno-tag GN -outdir exp anno.bam\nPISA count -tag CB -umi UB -anno-tag EX -outdir exon anno.bam\nPISA count -tag CB -umi UB -anno-tag JC -outdir junction anno.bam\nPISA count -tag CB -umi UB -anno-tag ER -outdir exclude anno.bam\n\n\ncd -;\ncd section2/Sagittal\nwget -c https://cf.10xgenomics.com/samples/spatial-exp/1.1.0/V1_Mouse_Brain_Sagittal_Posterior_Section_2/V1_Mouse_Brain_Sagittal_Posterior_Section_2_possorted_genome_bam.bam\nwget -c https://cf.10xgenomics.com/samples/spatial-exp/1.1.0/V1_Mouse_Brain_Sagittal_Posterior_Section_2/V1_Mouse_Brain_Sagittal_Posterior_Section_2_possorted_genome_bam.bam.bai\nwget -c https://cf.10xgenomics.com/samples/spatial-exp/1.1.0/V1_Mouse_Brain_Sagittal_Posterior_Section_2/V1_Mouse_Brain_Sagittal_Posterior_Section_2_spatial.tar.gz\n\ntar zxvf V1_Mouse_Brain_Sagittal_Posterior_Section_2_spatial.tar.gz\n\nPISA anno -gtf ../../gencode.vM10.annotation.gtf.gz -exon -psi -o anno.bam -t 7 V1_Mouse_Brain_Sagittal_Posterior_Section_2_possorted_genome_bam.bam\n\nmkdir exp\nmkdir exon\nmkdir junction\nmkdir exclude\nPISA count -tag CB -umi UB -anno-tag GN -outdir exp anno.bam\nPISA count -tag CB -umi UB -anno-tag EX -outdir exon anno.bam\nPISA count -tag CB -umi UB -anno-tag JC -outdir junction anno.bam\nPISA count -tag CB -umi UB -anno-tag ER -outdir exclude anno.bam\n\n# Now go back to work directory\ncd ../../..",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Analysis multiple Visium samples"
    ]
  },
  {
    "objectID": "Visium.html#preprocess-all-four-slices-and-intergrate-them-into-one-object",
    "href": "Visium.html#preprocess-all-four-slices-and-intergrate-them-into-one-object",
    "title": "Perform alternative splicing analysis for multiple Visium samples",
    "section": "1. Preprocess all four slices and intergrate them into one object",
    "text": "1. Preprocess all four slices and intergrate them into one object\nThis section will perform Seurat pipeline for all the sections. A Seurat workflow for one section can be found here https://satijalab.org/seurat/articles/spatial_vignette. The difference between this workflow with Seurat’s is we use counts generated from PISA, while Seurat use counts generated with CellRanger’s pipeline. For the details of different between PISA and CellRanger, please see our manual.\n\nrequire(Yano)\n\nLoading required package: Yano\n\n\n── Attaching packages ────────────────────────────────────────────── Yano 1.1 ──\n✔ dplyr   1.1.4     ✔ Seurat  5.3.0\n✔ ggplot2 3.5.2     \n\nexp.1 &lt;- ReadPISA(\"./visium/section1/Anterior/exp/\", prefix = \"sec1_ant_\")\nimage.1 &lt;- Read10X_Image(\"./visium/section1/Anterior/spatial/\")\nnew.names &lt;- paste0(\"sec1_ant_\",Cells(image.1))\nimage.1 &lt;- RenameCells(image.1, new.names = new.names)\n\n## QuickRecipe() is actually an integration function of Seurat workflow\nobj.1 &lt;- QuickRecipe(exp.1[, Cells(image.1)], verbose = FALSE)\nobj.1[['slice1']] &lt;- image.1[colnames(obj.1),]\nobj.1$orig.ident &lt;- \"sec1_ant\"\n\nexp.2 &lt;- ReadPISA(\"./visium/section1/Posterior/exp/\", prefix = \"sec1_pos_\")\nimage.2 &lt;- Read10X_Image(\"./visium/section1/Posterior/spatial/\")\nnew.names &lt;- paste0(\"sec1_pos_\",Cells(image.2))\nimage.2 &lt;- RenameCells(image.2, new.names = new.names)\nobj.2 &lt;- QuickRecipe(exp.2[,Cells(image.2)], verbose = FALSE)\nobj.2[['slice2']] &lt;- image.2[colnames(obj.2),]\nobj.2$orig.ident &lt;- \"sec1_pos\"\n\nexp.3 &lt;- ReadPISA(\"./visium/section2/Anterior/exp/\", prefix=\"sec2_ant_\")\nimage.3 &lt;- Read10X_Image(\"./visium/section2/Anterior/spatial/\")\nnew.names &lt;- paste0(\"sec2_ant_\",Cells(image.3))\nimage.3 &lt;- RenameCells(image.3, new.names = new.names)\nobj.3 &lt;- QuickRecipe(exp.3[, Cells(image.3)], verbose = FALSE)\nobj.3[['slice3']] &lt;- image.3[colnames(obj.3),]\nobj.3$orig.ident &lt;- \"sec2_ant\"\n\nexp.4 &lt;- ReadPISA(\"./visium/section2/Posterior/exp/\", prefix=\"sec2_pos_\")\nimage.4 &lt;- Read10X_Image(\"./visium/section2/Posterior/spatial/\")\nnew.names &lt;- paste0(\"sec2_pos_\",Cells(image.4))\nimage.4 &lt;- RenameCells(image.4, new.names = new.names)\nobj.4 &lt;- QuickRecipe(exp.4[, Cells(image.4)], verbose = FALSE)\nobj.4[['slice4']] &lt;- image.4[colnames(obj.4),]\nobj.4$orig.ident &lt;- \"sec2_pos\"\n\n# Merge all processed Seurat object\nobj &lt;- merge(obj.1, y = list(obj.2, obj.3, obj.4))\n\nobj &lt;- QuickRecipe(obj)\n\nSet default assay to RNA\nobject &lt;- NormalizeData(object, normalization.method = \"LogNormalize\", scale.factor = 10000)\nNormalizing layer: counts.1\nNormalizing layer: counts.2\nNormalizing layer: counts.3\nNormalizing layer: counts.4\nobject &lt;- FindVariableFeatures(object, selection.method = \"vst\", nfeatures = 3000)\nFinding variable features for layer counts.1\nFinding variable features for layer counts.2\nFinding variable features for layer counts.3\nFinding variable features for layer counts.4\nobject &lt;- ScaleData(object, features =  @features)\nCentering and scaling data matrix\nobject &lt;- RunPCA(object, features = @features\nPC_ 1 \nPositive:  Trf, Apod, Plekhb1, Mbp, Cnp, Plp1, Mobp, Car2, Mag, Dbi \n       Cryab, Mog, Cldn11, Bcas1, Sept4, Mal, Ndrg1, Ptgds, Gatm, Ermn \n       Qdpr, Ppp1r14a, Sparc, Gsn, Ugt8a, Gfap, Fa2h, Gm20425, Pllp, Tmem88b \nNegative:  Calm2, Ctxn1, Rtn1, Chn1, Nrgn, Syt1, Ppp3r1, Cx3cl1, Ptprn, Gria2 \n       Gpm6a, Sept5, Ptk2b, Gp1bb, Enc1, Calm1, Fbxl16, Basp1, Arf3, Snca \n       Meg3, Camkv, Hpcal4, Syt5, Chst1, Nsg2, Icam5, Ppp3ca, Pld3, Dclk1 \nPC_ 2 \nPositive:  Tmsb4x, Nrgn, Inf2, Ctxn1, Ngef, Gpr88, Gng7, Ddn, Adcy5, Pde1b \n       Camkv, Rgs9, Phactr1, Kcnip2, Klhl2, Ptk2b, Lrrc10b, Ptpn5, Tac1, Cx3cl1 \n       Adora2a, Bcl11b, Efnb3, Crip2, Mal, Pde2a, Ppp1r1a, Tmem158, Basp1, Hpca \nNegative:  Cbln1, Car8, Neurod1, Pcp2, Gm2694, Ppp1r17, Lhx1os, Zic1, Nrep, Shf \n       Rgs8, Kcnc3, Grin2c, Ank1, Inpp5a, Homer3, Grm4, Pvalb, Kcnc1, Il16 \n       Sphkap, Icmt, Calb2, Trim62, Gng13, Il20rb, Chn2, Pagr1a, Dusp5, Atp2a3 \nPC_ 3 \nPositive:  Cck, Stmn1, Gnas, Nrn1, 3110035E14Rik, Slc17a7, Olfm1, Vsnl1, Tbr1, Lingo1 \n       Stx1a, Slc30a3, Ncald, Dkk3, Efhd2, Rtn4r, Neurod6, Miat, 1110008P14Rik, Gm11549 \n       Mpped1, Basp1, Pde1a, Gabbr2, Nsmf, Fxyd7, Syt13, Mical2, E130012A19Rik, Osbpl1a \nNegative:  Penk, Rgs9, Adora2a, Pde10a, Ppp1r1b, Gpr88, Drd1, Syndig1l, Gpr6, Tac1 \n       Lrrc10b, Rxrg, Adcy5, Scn4b, Pde1b, Rasd2, Gng7, Rarb, Slc35d3, Tmem158 \n       Actn2, Serpina9, Strip2, Slc32a1, Ankrd63, Kcnab1, Dmkn, Gnal, Pcp4l1, St8sia3 \nPC_ 4 \nPositive:  Scn4b, Mbp, Slc24a2, Qdpr, Mobp, Mag, Bcas1, Nefm, Plp1, Mal \n       Plekhb1, Vamp1, Nefl, Sept4, Ermn, Tspan2, Mog, Arpp19, Trf, Cnp \n       Cryab, AI593442, Pex5l, Tmem88b, Gpr37, Ppp1r14a, Pllp, Uchl1, Kcnab1, Snap25 \nNegative:  Igf2, Islr, Igfbp2, Slc13a4, Mgp, Fmod, Slc6a20a, Aebp1, Ogn, Nnat \n       Slc6a13, Col1a2, Fabp7, Aldh1a2, Rbp1, Gjb2, Pcolce, Slc22a6, Slc13a3, Bmp7 \n       Dcn, Fn1, Serping1, Col1a1, Crabp2, Ifitm3, Efemp1, Bgn, Vim, Fbln1 \nPC_ 5 \nPositive:  Itpr1, Itpka, Zbtb18, Cplx2, Adcy1, Rnf112, Nptx1, Lmo4, Hpca, Neurod2 \n       Dkk3, Sptbn2, Camk4, Cnr1, Cnksr2, Arpp19, Fbxl16, Tmem132a, Igf2, Prkcb \n       Atp1a1, Dgkz, Lzts3, Mmp17, Ppp1r1b, Neurl1a, Slc8a2, Gas7, Slc13a4, Fam212b \nNegative:  Slc6a11, Gng4, Nrip3, Scg2, Ptpro, Sp8, Dlx1, Hap1, Cdhr1, Th \n       Doc2g, Zcchc12, Pcbp3, Pbx3, Scgn, Dcx, Tshz1, Tuba1a, A230065H16Rik, Tubb3 \n       Cacng5, Pcp4l1, Cpne4, Lgr5, Lgr6, Sp9, Dlx2, Tmem130, Adamts19, Tubb2a \nobject &lt;- FindNeighbors(object, dims = 1:20)\nComputing nearest neighbor graph\nComputing SNN\nobject &lt;- FindClusters(object, resolution = 0.5)\n\n\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 12148\nNumber of edges: 388091\n\nRunning Louvain algorithm...\nMaximum modularity in 10 random starts: 0.9314\nNumber of communities: 16\nElapsed time: 2 seconds\n\n\nobject &lt;- RunUMAP(object, dims = 1:20)\n23:23:39 UMAP embedding parameters a = 0.9922 b = 1.112\n23:23:39 Read 12148 rows and found 20 numeric columns\n23:23:39 Using Annoy for neighbor search, n_neighbors = 30\n23:23:39 Building Annoy index with metric = cosine, n_trees = 50\n0%   10   20   30   40   50   60   70   80   90   100%\n[----|----|----|----|----|----|----|----|----|----|\n**************************************************|\n23:23:42 Writing NN index file to temp file /var/folders/38/qfwf72jx3413kwjx7lgqv3xr0000gn/T//RtmpCwA74Z/filef58e3550ded6\n23:23:42 Searching Annoy index using 1 thread, search_k = 3000\n23:23:48 Annoy recall = 100%\n23:23:50 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30\n23:23:52 Initializing from normalized Laplacian + noise (using RSpectra)\n23:23:54 Commencing optimization for 200 epochs, with 500558 positive edges\n23:23:54 Using rng type: pcg\n23:24:09 Optimization finished\n\np1 &lt;- DimPlot(obj, group.by = \"orig.ident\")\np2 &lt;- DimPlot(obj)\np1 + p2\n\n\n\n\n\n\n\nSpatialPlot(obj, pt.size.factor = 2) \n\n\n\n\n\n\n\nexon.1 &lt;- ReadPISA(\"./visium/section1/Anterior/exon/\", prefix = \"sec1_ant_\", cells = Cells(obj))\nexon.2 &lt;- ReadPISA(\"./visium/section1/Posterior/exon/\", prefix = \"sec1_pos_\", cells = Cells(obj))\nexon.3 &lt;- ReadPISA(\"./visium/section2/Anterior/exon/\", prefix = \"sec2_ant_\", cells = Cells(obj))\nexon.4 &lt;- ReadPISA(\"./visium/section2/Posterior/exon/\", prefix = \"sec2_pos_\", cells = Cells(obj))\nexon &lt;- mergeMatrix(exon.1, exon.2, exon.3, exon.4)\n\n'as(&lt;dgTMatrix&gt;, \"dgCMatrix\")' is deprecated.\nUse 'as(., \"CsparseMatrix\")' instead.\nSee help(\"Deprecated\") and help(\"Matrix-deprecated\").\n\nobj[['exon']] &lt;- CreateAssayObject(exon[, Cells(obj)], min.cells = 20)\nDefaultAssay(obj) &lt;- \"exon\"\nobj &lt;- NormalizeData(obj)\nobj &lt;- ParseExonName(obj)\n\nWorking on assay exon\n\nobj &lt;- RunAutoCorr(obj)\n\nWorking on assay : exon\nRun autocorrelation test for 80178 features.\nRuntime : 8.81576 mins\n38771 autocorrelated features.\n\nobj &lt;- RunBlockCorr(obj, bind.name = \"gene_name\", bind.assay = \"RNA\")\n\nWorking on assay exon.\nWorking on binding assay RNA.\nUse predefined weight matrix \"pca_wm\".\nProcessing 38771 features.\nProcessing 18748 binding features.\nRetrieve binding data from assay RNA.\nUse \"data\" layer for test features and binding features.\nUsing 7 threads.\nRuntime : 2.249563 hours.\n\nFbtPlot(obj, val = \"gene_name.padj\")\n\n\n\n\n\n\n\nobj[['exon']][[]] %&gt;% filter(gene_name.pval&lt;1e-40)\n\n                                   chr     start       end gene_name strand\nchr11:30106785-30109152/-/Sptbn1 chr11  30106785  30109152    Sptbn1      -\nchr11:53548291-53549565/+/Sept8  chr11  53548291  53549565     Sept8      +\nchr12:111806315-111806775/+/Klc1 chr12 111806315 111806775      Klc1      +\nchr12:111806315-111806727/+/Klc1 chr12 111806315 111806727      Klc1      +\nchr12:111806315-111806711/+/Klc1 chr12 111806315 111806711      Klc1      +\nchr12:111806315-111806726/+/Klc1 chr12 111806315 111806726      Klc1      +\nchr17:25717528-25717581/+/Gng13  chr17  25717528  25717581     Gng13      +\nchrX:163926903-163929546/+/Ap1s2  chrX 163926903 163929546     Ap1s2      +\n                                 moransi.pval    moransi autocorr.variable\nchr11:30106785-30109152/-/Sptbn1            0 0.15179115              TRUE\nchr11:53548291-53549565/+/Sept8             0 0.43155054              TRUE\nchr12:111806315-111806775/+/Klc1            0 0.10015685              TRUE\nchr12:111806315-111806727/+/Klc1            0 0.09999613              TRUE\nchr12:111806315-111806711/+/Klc1            0 0.09420489              TRUE\nchr12:111806315-111806726/+/Klc1            0 0.09698562              TRUE\nchr17:25717528-25717581/+/Gng13             0 0.16339114              TRUE\nchrX:163926903-163929546/+/Ap1s2            0 0.14487043              TRUE\n                                 gene_name.t gene_name.pval gene_name.padj\nchr11:30106785-30109152/-/Sptbn1    37.43293   1.516099e-60   5.782097e-56\nchr11:53548291-53549565/+/Sept8     24.71707   1.916837e-44   1.044348e-40\nchr12:111806315-111806775/+/Klc1    29.48552   3.974229e-51   5.682701e-47\nchr12:111806315-111806727/+/Klc1    29.44657   4.470109e-51   5.682701e-47\nchr12:111806315-111806711/+/Klc1    28.69248   4.465602e-50   4.257728e-46\nchr12:111806315-111806726/+/Klc1    28.27741   1.617798e-49   1.233992e-45\nchr17:25717528-25717581/+/Gng13     22.75571   2.042604e-41   9.737603e-38\nchrX:163926903-163929546/+/Ap1s2    25.79267   4.953734e-46   3.148759e-42\n\n\n\nSpatialPlot(obj, features = c(\"chr11:53548291-53549565/+/Sept8\",\"Sept8\"), pt.size.factor = 2)",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Analysis multiple Visium samples"
    ]
  },
  {
    "objectID": "Visium.html#visualize-genome-tracks-of-multiple-samples",
    "href": "Visium.html#visualize-genome-tracks-of-multiple-samples",
    "title": "Perform alternative splicing analysis for multiple Visium samples",
    "section": "2. Visualize genome tracks of multiple samples",
    "text": "2. Visualize genome tracks of multiple samples\nSince the spot/cell names have already been renamed in the Seurat object, we need to define a binding list that maps the new cell names to their original names, which will be used for reading sequences from the BAM files. In this vignette, we use four BAM files, requiring us to define four corresponding cell vectors. Each vector contains group factor values, where the names of the values correspond to the original cell names in the BAM file.\n\ngtf &lt;- gtf2db(\"./visium/gencode.vM10.annotation.gtf.gz\")\n\n[2025-06-03 01:54:20] GTF loading..\n[2025-06-03 01:54:37] Load 48440 genes.\n\nbamfiles &lt;- list(\n  sec1_ant = \"./visium/section1/Anterior/V1_Mouse_Brain_Sagittal_Anterior_possorted_genome_bam.bam\",\n  sec1_pos = \"./visium/section1/Posterior/V1_Mouse_Brain_Sagittal_Posterior_possorted_genome_bam.bam\",\n  sec2_ant = \"./visium/section2/Anterior/V1_Mouse_Brain_Sagittal_Anterior_Section_2_possorted_genome_bam.bam\",\n  sec2_pos = \"./visium/section2/Posterior/V1_Mouse_Brain_Sagittal_Posterior_Section_2_possorted_genome_bam.bam\"\n  )\n\ncell.list &lt;- split(obj$seurat_clusters, obj$orig.ident)\nstr(cell.list)\n\nList of 4\n $ sec1_ant: Factor w/ 16 levels \"0\",\"1\",\"2\",\"3\",..: 10 10 10 5 5 5 5 10 5 10 ...\n  ..- attr(*, \"names\")= chr [1:2695] \"sec1_ant_TTGCCGGTGATCCCTC-1\" \"sec1_ant_CGGTATAGGTATTAGC-1\" \"sec1_ant_CGTTGAGTAATTGCGT-1\" \"sec1_ant_TAAATGCCGTCTCATG-1\" ...\n $ sec1_pos: Factor w/ 16 levels \"0\",\"1\",\"2\",\"3\",..: 10 10 10 10 10 10 10 10 10 10 ...\n  ..- attr(*, \"names\")= chr [1:3342] \"sec1_pos_TGGGACCATTGGGAGT-1\" \"sec1_pos_CCGGTGCGAGTGATAG-1\" \"sec1_pos_TAGCCAGAGGGTCCGG-1\" \"sec1_pos_GAAGGGCATAACCATG-1\" ...\n $ sec2_ant: Factor w/ 16 levels \"0\",\"1\",\"2\",\"3\",..: 10 10 10 10 10 10 10 10 10 5 ...\n  ..- attr(*, \"names\")= chr [1:2823] \"sec2_ant_TTGAGGCATTTAACTC-1\" \"sec2_ant_CACCGGAGATATCTCC-1\" \"sec2_ant_CACGTCTATGATGTGG-1\" \"sec2_ant_TGACCAGCTTCAAAGT-1\" ...\n $ sec2_pos: Factor w/ 16 levels \"0\",\"1\",\"2\",\"3\",..: 10 10 10 10 10 10 10 10 10 10 ...\n  ..- attr(*, \"names\")= chr [1:3288] \"sec2_pos_TCCGCAGCCACCTAGC-1\" \"sec2_pos_GGTCCTTCATACGACT-1\" \"sec2_pos_GTGCCTAGCTATGCTT-1\" \"sec2_pos_GCGAGAAACGGGAGTT-1\" ...\n\ncell.list1 &lt;- lapply(cell.list, function(x) {\n  nm &lt;- names(x)\n  names(x) &lt;- gsub(\".*_(.*)\",\"\\\\1\",nm)\n  x\n})\nstr(cell.list1)\n\nList of 4\n $ sec1_ant: Factor w/ 16 levels \"0\",\"1\",\"2\",\"3\",..: 10 10 10 5 5 5 5 10 5 10 ...\n  ..- attr(*, \"names\")= chr [1:2695] \"TTGCCGGTGATCCCTC-1\" \"CGGTATAGGTATTAGC-1\" \"CGTTGAGTAATTGCGT-1\" \"TAAATGCCGTCTCATG-1\" ...\n $ sec1_pos: Factor w/ 16 levels \"0\",\"1\",\"2\",\"3\",..: 10 10 10 10 10 10 10 10 10 10 ...\n  ..- attr(*, \"names\")= chr [1:3342] \"TGGGACCATTGGGAGT-1\" \"CCGGTGCGAGTGATAG-1\" \"TAGCCAGAGGGTCCGG-1\" \"GAAGGGCATAACCATG-1\" ...\n $ sec2_ant: Factor w/ 16 levels \"0\",\"1\",\"2\",\"3\",..: 10 10 10 10 10 10 10 10 10 5 ...\n  ..- attr(*, \"names\")= chr [1:2823] \"TTGAGGCATTTAACTC-1\" \"CACCGGAGATATCTCC-1\" \"CACGTCTATGATGTGG-1\" \"TGACCAGCTTCAAAGT-1\" ...\n $ sec2_pos: Factor w/ 16 levels \"0\",\"1\",\"2\",\"3\",..: 10 10 10 10 10 10 10 10 10 10 ...\n  ..- attr(*, \"names\")= chr [1:3288] \"TCCGCAGCCACCTAGC-1\" \"GGTCCTTCATACGACT-1\" \"GTGCCTAGCTATGCTT-1\" \"GCGAGAAACGGGAGTT-1\" ...\n\nTrackPlot(bamfile = bamfiles, cell.group = cell.list1, gtf = gtf, gene = \"Sept8\", highlights = c(53548291,53549565), junc=TRUE)",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Analysis multiple Visium samples"
    ]
  },
  {
    "objectID": "Visium.html#optional-build-cell-cell-weight-matrix-by-spatial-coordinates",
    "href": "Visium.html#optional-build-cell-cell-weight-matrix-by-spatial-coordinates",
    "title": "Perform alternative splicing analysis for multiple Visium samples",
    "section": "Optional: Build cell-cell weight matrix by spatial coordinates",
    "text": "Optional: Build cell-cell weight matrix by spatial coordinates\nWe previously used PCA to construct the cell weight matrix, but for spatial transcriptomics data, it is also possible to use the spatial coordinates, the real spot-to-spot distances, to build the weight matrix. Here, we demonstrate how to do this. Note that if we use spatial coordinates, the analysis can only be performed within a single slice.\n\nobj &lt;- subset(obj, orig.ident == \"sec1_ant\")\nobj &lt;- RunAutoCorr(obj, image = \"slice1\")\n\nWorking on assay : exon\n\n\nSet prune distance to 237.901240013582\n\n\nRun autocorrelation test for 61463 features.\n\n\nRuntime : 7.325192 secs\n\n\n18989 autocorrelated features.\n\ngrep(\"_wm\", names(obj), value=TRUE)\n\n[1] \"pca_wm\"     \"spatial_wm\"\n\nobj &lt;- RunBlockCorr(obj, bind.name = \"gene_name\", bind.assay = \"RNA\", wm.name = \"spatial_wm\")\n\nWorking on assay exon.\n\n\nWorking on binding assay RNA.\n\n\nUse predefined weight matrix \"spatial_wm\".\n\n\nProcessing 18989 features.\n\n\nProcessing 18748 binding features.\n\n\nRetrieve binding data from assay RNA.\n\n\nUse \"data\" layer for test features and binding features.\n\n\nUsing 7 threads.\n\n\nRuntime : 1.594298 mins.\n\nFbtPlot(obj, val = \"gene_name.padj\")\n\n\n\n\n\n\n\nMeta(obj) %&gt;% filter(gene_name.padj&lt;1e-7)\n\n                                    chr     start       end gene_name strand\nchr11:30106785-30109152/-/Sptbn1  chr11  30106785  30109152    Sptbn1      -\nchr18:82554320-82558703/+/Mbp     chr18  82554320  82558703       Mbp      +\nchr9:112065091-112066022/-/Arpp21  chr9 112065091 112066022    Arpp21      -\nchr9:112065234-112066022/-/Arpp21  chr9 112065234 112066022    Arpp21      -\n                                   moransi.pval    moransi autocorr.variable\nchr11:30106785-30109152/-/Sptbn1   3.164907e-34 0.13395992              TRUE\nchr18:82554320-82558703/+/Mbp      2.705616e-15 0.08657166              TRUE\nchr9:112065091-112066022/-/Arpp21 5.137313e-287 0.40232379              TRUE\nchr9:112065234-112066022/-/Arpp21 6.239928e-279 0.39656057              TRUE\n                                  gene_name.t gene_name.pval gene_name.padj\nchr11:30106785-30109152/-/Sptbn1     8.659096   4.555108e-14   8.575446e-10\nchr18:82554320-82558703/+/Mbp        8.368805   1.933296e-13   1.819811e-09\nchr9:112065091-112066022/-/Arpp21    7.419374   2.056473e-11   9.678793e-08\nchr9:112065234-112066022/-/Arpp21    7.475056   1.569355e-11   9.678793e-08\n\nSpatialFeaturePlot(obj, features = c(\"chr11:30106785-30109152/-/Sptbn1\",\"Sptbn1\"))",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Analysis multiple Visium samples"
    ]
  },
  {
    "objectID": "PISA.html",
    "href": "PISA.html",
    "title": "PISA User Guide",
    "section": "",
    "text": "PISA [tool] [options] [input-file]"
  },
  {
    "objectID": "PISA.html#synopsis",
    "href": "PISA.html#synopsis",
    "title": "PISA User Guide",
    "section": "",
    "text": "PISA [tool] [options] [input-file]"
  },
  {
    "objectID": "PISA.html#install",
    "href": "PISA.html#install",
    "title": "PISA User Guide",
    "section": "Install",
    "text": "Install\nPISA source code can be downloaded at https://github.com/shiquan/PISA/releases, or the development version from https://github.com/shiquan/PISA/. To compile PISA from sources run make in the source directory.\n$ git clone https://github.com/shiquan/PISA\n$ cd PISA\n$ make"
  },
  {
    "objectID": "PISA.html#get-started",
    "href": "PISA.html#get-started",
    "title": "PISA User Guide",
    "section": "Get Started",
    "text": "Get Started\nThe code snippet below demonstrates how to use the PISA tools to process test data and generate various feature counts. You can find the test data in the PISA/demo directory. This example provides a practical approach to familiarize yourself with the functionality of PISA and to validate its operations with provided sample data.\n$ cd demo\n\n$ ls\naln.sam.gz  barcodes.txt  demo_1.fq.gz  demo_2.fq.gz  demo.gtf.gz  peaks.bed  README.md  var.vcf.gz\n\n$ zcat demo_1.fq.gz|head -n 4\n@A00984:220:HNJ7KDRXX:1:1118:2510:4586\nAAGCATCCACACAGAGCACCCCGTTCTT\n+\nFFFFFFFFFFFFFFFFFFFFFFFFFFFF\n\n$ zcat demo_2.fq.gz|head -n 4\n@A00984:220:HNJ7KDRXX:1:1118:2510:4586\nGCAGTGGTATCAACGCAGAGTACATGGGGAGCCTCATTGCCCAGCGGACCCCAGCCTCTGCCAGGTTCGGTCCGCCATCCTCGTCCCGTCC\n+\nFFFFF:FFFFFF:FFFFFFFFFF,FFFFFFFFF:FFFFFFFFF,FFFF:FFF,FFFFF:FFF:FFFFFFFFFFFFFFFFFFFF:FFFFFFF\n\n# Convert raw FASTQ to FASTQ+ format\n$ PISA parse -rule 'CR,R1:1-16,barcodes.txt,CB,1;UR,R1:17-28;R1,R2' demo_1.fq.gz demo_2.fq.gz -1 demo.fq\nNumber of Fragments,825\nFragments pass QC,825\nFragments with Exactly Matched Barcodes,805\nFragments with Failed Barcodes,0\n[2022-04-22 12:21:35] Real time: 0.003 sec; CPU: 0.009 sec; Peak RSS: 0.010 GB.\n\n$ head -n 4 demo.fq\n@A00984:220:HNJ7KDRXX:1:1118:2510:4586|||CR:Z:AAGCATCCACACAGAG|||CB:Z:AAGCATCCACACAGAG|||UR:Z:CACCCCGTTCTT\nGCAGTGGTATCAACGCAGAGTACATGGGGAGCCTCATTGCCCAGCGGACCCCAGCCTCTGCCAGGTTCGGTCCGCCATCCTCGTCCCGTCC\n+\nFFFFF:FFFFFF:FFFFFFFFFF,FFFFFFFFF:FFFFFFFFF,FFFF:FFF,FFFFF:FFF:FFFFFFFFFFFFFFFFFFFF:FFFFFFF\n\n# Alignment results of FASTQ+ \n$ samtools view aln.sam.gz|head -n 1\nA00984:220:HNJ7KDRXX:1:1118:2510:4586|||CR:Z:AAGCATCCACACAGAG|||CB:Z:AAGCATCCACACAGAG|||UR:Z:CACCCCGTTCTT   0   chr11   35139165    255 26S65M  *   0   0   GCAGTGGTATCAACGCAGAGTACATGGGGAGCCTCATTGCCCAGCGGACCCCAGCCTCTGCCAGGTTCGGTCCGCCATCCTCGTCCCGTCC FFFFF:FFFFFF:FFFFFFFFFF,FFFFFFFFF:FFFFFFFFF,FFFF:FFF,FFFFF:FFF:FFFFFFFFFFFFFFFFFFFF:FFFFFFF NH:i:1  HI:i:1  AS:i:61 nM:i:1\n\n# Convert format alignment records from SAM to BAM\n$ PISA sam2bam aln.sam.gz -o aln.bam\nRaw reads,825\nMapped reads,820 (99.39%)\nPlus strand,820\nMinus strand,0\nMitochondria ratio,0.00%\n[2022-04-22 12:26:31] Real time: 0.005 sec; CPU: 0.009 sec; Peak RSS: 0.010 GB.\n\n$ samtools view aln.bam|head -n 1\nA00984:220:HNJ7KDRXX:1:1118:2510:4586   0   chr11   35139165    255 26S65M  *   0   0   GCAGTGGTATCAACGCAGAGTACATGGGGAGCCTCATTGCCCAGCGGACCCCAGCCTCTGCCAGGTTCGGTCCGCCATCCTCGTCCCGTCC FFFFF:FFFFFF:FFFFFFFFFF,FFFFFFFFF:FFFFFFFFF,FFFF:FFF,FFFFF:FFF:FFFFFFFFFFFFFFFFFFFF:FFFFFFF NH:i:1  HI:i:1  AS:i:61 nM:i:1  CR:Z:AAGCATCCACACAGAG   CB:Z:AAGCATCCACACAGAG   UR:Z:CACCCCGTTCTT\n\n# Annotate gene names for BAM\n$ PISA anno -gtf ./demo.gtf.gz aln.bam -o anno_gtf.bam\n[2022-04-22 12:28:38] GTF loading..\n[2022-04-22 12:28:38] Load 2 genes.\n[2022-04-22 12:28:38] Load time : 0.003 sec\nReads Mapped to Genome (Map Quality &gt;= 0),99.4%\nReads Mapped to Exonic Regions,99.3%\nReads Mapped to Intronic Regions,0.0%\nReads Mapped to both Exonic and Intronic Regions,0.7%\nReads Mapped Antisense to Gene,0.0%\nReads Mapped to Intergenic Regions,0.0%\nReads Mapped to Gene but Failed to Interpret Type,0.0%\n[2022-04-22 12:28:38] Real time: 0.026 sec; CPU: 0.086 sec; Speed : 9528 records/sec; Peak RSS: 0.034 GB.\n\n# Correct UMIs amongst other UMIs from the same cell and mapped to the same gene, and create new tag UB for corrected UMIs\n$ PISA corr -tag UR -new-tag UB -tags-block CB,GN anno_gtf.bam -o corr.bam\n[2022-04-22 12:36:21] Building index ..\n[2022-04-22 12:36:21] Build time : 0.002 sec\n[2022-04-22 12:36:21] Real time: 0.077 sec; CPU: 0.085 sec\n\n$ samtools view corr.bam|head -n 1\nA00984:220:HNJ7KDRXX:1:1118:2510:4586   0   chr11   35139165    255 26S65M  *   0   0   GCAGTGGTATCAACGCAGAGTACATGGGGAGCCTCATTGCCCAGCGGACCCCAGCCTCTGCCAGGTTCGGTCCGCCATCCTCGTCCCGTCC FFFFF:FFFFFF:FFFFFFFFFF,FFFFFFFFF:FFFFFFFFF,FFFF:FFF,FFFFF:FFF:FFFFFFFFFFFFFFFFFFFF:FFFFFFF NH:i:1  HI:i:1  AS:i:61 nM:i:1  CR:Z:AAGCATCCACACAGAG   CB:Z:AAGCATCCACACAGAG   UR:Z:CACCCCGTTCTT   RE:A:E  GX:Z:ENSG00000026508.18 GN:Z:CD44   TX:Z:ENST00000263398.10,ENST00000428726.7,ENST00000526025.2 UB:Z:CACCCCGTTCTT\n\n# Count gene X cell features\n$ mkdir exp\n\n$ PISA count  -cb CB -anno-tag GN -outdir exp -umi UB corr.bam \n[2022-04-22 12:38:44] Real time: 0.033 sec; CPU: 0.013 sec; Peak RSS: 0.010 GB.\n\n# Gene expression matrix generated in the Market Exchange format \n$ ls exp/\nbarcodes.tsv.gz  features.tsv.gz  matrix.mtx.gz\n\n# Not just gene features, we can also annotate variants and functional regions to reads\n$ PISA anno -bed peaks.bed -tag PK -vcf var.vcf.gz -vtag VR  corr.bam -o anno_vcf_bed.bam    \nReads Mapped to Genome (Map Quality &gt;= 0),99.4%\nReads Mapped to BED regions / Peaks,0.0%\n[2022-04-22 12:43:01] Real time: 0.027 sec; CPU: 0.090 sec; Speed : 9085 records/sec; Peak RSS: 0.034 GB.\n\n$ samtools view anno_vcf_bed.bam|grep \"VR:Z\"|grep \"PK:Z\"|head -n 1\nA00984:220:HNJ7KDRXX:1:2266:27597:30843 0   chr11   35229688    255 91M *   0   0   CCCAGGGTTAATAGGGCCTGGTCCCTGGGAGGAAATTTGAATGGGTCCATTTTGCCCTTCCATAGCCTAATCCCGGGGCATTGTTTTCCAC\nFFFF,FFFFFFFFFF,FFFFFFF:,:FFFFFF,FF:FFFFFFFFFFF:,,:F:F:F,F:F:F,FFFF,F:FFFF,FF,FF:FFFFFFF:F: NH:i:1  HI:i:1  AS:i:85 nM:i:2  CR:Z:ATTGTTCCAAGTCCCG   CB:Z:ATTGTTCCAAGTCCCG   UR:Z:TCTTTAAGTCAG   RE:A:E  GX:Z:ENSG00000026508.18 GN:Z:CD44   TX:Z:ENST00000263398.10,ENST00000428726.7,ENST00000425428.6,ENST00000433892.6,ENST00000525469.1 UB:Z:TCTTTAAGTCAG   PK:Z:demo_peak_14a;demo_peak_14b    VR:Z:chr11:35229771C&gt;T\n\n# Summarize the reads, UMIs, genes, peaks, and variants per cell\n$ PISA attrcnt -cb CB -tags UB,GN,PK,VR anno_vcf_bed.bam -dedup |head -n 5\nBARCODE Raw UB  GN  PK  VR\nAAGCATCCACACAGAG    503 132 1   15  1\nATTGTTCCAAGTCCCG    533 124 1   13  1\nAAGCATCCACACNGAG    3   1   1   1   0\nAAGCNTCCACACAGAG    3   1   1   1   0\n\n# Deduplicate BAM file for each cell\n$ PISA rmdup -tags CB corr.bam -o rmdup.bam -nw \n[2022-04-22 12:59:39] Deduplicating chr11\n[2022-04-22 12:59:39] All reads,820\n[2022-04-22 12:59:39] Duplicate reads,125\n[2022-04-22 12:59:39] Duplicate ratio,0.1524\n[2022-04-22 12:59:39] Real time: 0.008 sec; CPU: 0.015 sec; Peak RSS: 0.010 GB.\n\n# Deduplicate BAM file for each molecular\n$ PISA rmdup -tags CB,UR corr.bam -o rmdup1.bam -nw\n[2022-04-22 13:00:35] Deduplicating chr11\n[2022-04-22 13:00:35] All reads,820\n[2022-04-22 13:00:35] Duplicate reads,0\n[2022-04-22 13:00:35] Duplicate ratio,0.0000\n[2022-04-22 13:00:35] Real time: 0.009 sec; CPU: 0.015 sec; Peak RSS: 0.011 GB.\n\n# Select all reads annotated to gene CD44\n# Generate a gene candidate list\n$  echo \"CD44\" &gt; gene.txt\n\n$ PISA pick -tags GN -list gene.txt anno_vcf_bed.bam  -o picked.bam\n[2022-04-22 13:03:01] Real time: 0.009 sec; CPU: 0.016 sec\n\n# Select reads with more features\n$ awk '{printf(\"%s\\tCD44\\n\", $1)}' barcodes.txt &gt; candidates.txt\n\n$ cat candidates.txt \nAAGCATCCACACAGAG    CD44\nATTGTTCCAAGTCCCG    CD44\nGCACATAGTCAGTTTG    CD44\n\n$ PISA pick -tags CB,GN -list candidates.txt anno_vcf_bed.bam -o picked.bam \n[2022-04-22 13:09:28] Real time: 0.007 sec; CPU: 0.013 sec\n\n# Convert BAM to FASTQ+\n$ PISA bam2fq -tags CB,GN picked.bam -o pick.fq\n\n$ head -n 4 pick.fq \n@A00984:220:HNJ7KDRXX:1:1118:2510:4586|||CB:Z:AAGCATCCACACAGAG|||GN:Z:CD44\nGCAGTGGTATCAACGCAGAGTACATGGGGAGCCTCATTGCCCAGCGGACCCCAGCCTCTGCCAGGTTCGGTCCGCCATCCTCGTCCCGTCC\n+\nFFFFF:FFFFFF:FFFFFFFFFF,FFFFFFFFF:FFFFFFFFF,FFFF:FFF,FFFFF:FFF:FFFFFFFFFFFFFFFFFFFF:FFFFFFF\n\n# Sort FASTQ+ reads by CB and GN\n$ PISA fsort -tags CB,GN pick.fq -o fsort.fq.gz\n[2022-04-22 13:22:50] Write 795 records to fsort.fq.gz.0000.bgz.\n[2022-04-22 13:22:50] Unlink fsort.fq.gz.0000.bgz\n[2022-04-22 13:22:50] Create fsort.fq.gz from 1 files.\n[2022-04-22 13:22:50] Real time: 0.021 sec; CPU: 0.020 sec\n\n$ zcat fsort.fq.gz|head -n 8\n@A00984:220:HNJ7KDRXX:1:1118:2510:4586|||CB:Z:AAGCATCCACACAGAG|||GN:Z:CD44\nGCAGTGGTATCAACGCAGAGTACATGGGGAGCCTCATTGCCCAGCGGACCCCAGCCTCTGCCAGGTTCGGTCCGCCATCCTCGTCCCGTCC\n+\nFFFFF:FFFFFF:FFFFFFFFFF,FFFFFFFFF:FFFFFFFFF,FFFF:FFF,FFFFF:FFF:FFFFFFFFFFFFFFFFFFFF:FFFFFFF\n@A00984:220:HNJ7KDRXX:1:2143:21640:21496|||CB:Z:AAGCATCCACACAGAG|||GN:Z:CD44\nCCTGCCCCGCGCCCAGAGATCCTCCAGCTCCTTTCGCCCGCGCCCTACGTTCGCTCCGGACACCATGGACAAGTATTGGTGGAACACAGCC\n+\n,,FFFFFFFF,F,,:F,F,F:FFF,FFFFFF,F::F,FF,F:FF:,,FF:FFF,:FFFF:FFF,::FFFF,F:F,FFFF,,F,FFF,F,::\n\n# Assembly reads mapped to CD44 of the same cell into contigs\n# This step requires Trinity software and seqtk already installed in your environment\n$ PISA stream -tags CB,GN -script 'Trinity --seqType fq --SS_lib_type F --single ${FQ} --max_memory 1G 2&gt;/dev/null 1&gt;/dev/null; seqtk rename trinity_out_dir.Trinity.fasta ${UBI}_ 2&gt;/dev/null' -t 10 -fa  -nw ./fsort.fq.gz -o assem.fa\n[2022-04-22 13:24:21] Real time: 5.607 sec; CPU: 0.010 sec; Peak RSS: 0.010 GB.\n\n$ seqtk seq assem.fa -l 100 |head \n&gt;Z_AAGCATCCACACAGAG_Z_CD44_1|||CB:Z:AAGCATCCACACAGAG|||GN:Z:CD44 len=439 path=[0:0-438]\nGAAATTAGGGCCCAATTAATAATCAGCAAGAATTTGATCGTTCCAGTTCCCACTTGGAGGCCTTTCATCCCTCGGGTGTGCTATGGATGGCTTCTAACAA\nAAACTACACATATGTATTCCTGATCGCCAACCTTTCCCCCACCAGCTAAGGACATTTCCCAGGGTTAATAGGGCCTGGTCCCTGGGAGGAAATTTGAATG\nGGTCCATTTTGCCCTTCCATAGCCTAATCCCTGGGCATTGTTTTCCACTGAGGTTGGGGGTTGGGGTGTACTAGTTACACATCTTCAACAGACCCCCTCT\nAGAAATTTTTCAGATGCTTCTGGGAGACACCCAAAGGGTGAAGCTATTTATCTGTAGTAAACTATTTATCTGTGTTTTTGAAATATTAAACCCTGGATCA\nGTCCTTTGATCAGTATAATTTTTTAAAGTTACTTTGTCA\n&gt;Z_AAGCATCCACACAGAG_Z_CD44_2|||CB:Z:AAGCATCCACACAGAG|||GN:Z:CD44 len=384 path=[0:0-383]\nCCTGGTAGAATTGGCTTTTCTAGCAGAACCTTTCCAAAAGTTTTATATTGAGATTCATAACAACACCAAGAATTGATTTTGTAGCCAACATTCATTCAAT\nACTGTTATATCAGAGGAGTAGGAGAGAGGAAACATTTGACTTATCTGGAAAAGCAAAATGTACTTAAGAATAAGAATAACATGGTCCATTCACCTTTATG\nTTATAGATATGTCTTTGTGTAAATCATTTGTTTTGAGTTTTCAAAGAATAGCCCATTGTTCATTCTTGTGCTGTACAATGACCACTGTTATTGTTACTTT\n\n# Align assembled reads to reference and convert to BAM file\n# Here I use minimap2 for simplicity\n$ minimap2 -x splice -a ~/Documents/datasets/GRCh38/fasta/genome.fasta assem.fa 1&gt; asm_aln.sam\n[M::mm_idx_gen::50.495*1.81] collected minimizers\n[M::mm_idx_gen::71.980*2.16] sorted minimizers\n[M::main::71.980*2.16] loaded/built the index for 194 target sequence(s)\n[M::mm_mapopt_update::75.057*2.11] mid_occ = 767\n[M::mm_idx_stat] kmer size: 15; skip: 5; is_hpc: 0; #seq: 194\n[M::mm_idx_stat::77.004*2.09] distinct minimizers: 167225302 (35.42% are singletons); average occurrences: 6.036; average spacing: 3.071; total length: 3099750718\n[M::worker_pipeline::77.010*2.09] mapped 13 sequences\n[M::main] Version: 2.21-r1071\n[M::main] CMD: minimap2 -x splice -a /home/shiquan/Documents/datasets/GRCh38/fasta/genome.fasta assem.fa\n[M::main] Real time: 77.358 sec; CPU: 161.000 sec; Peak RSS: 18.519 GB\n\n$ PISA sam2bam asm_aln.sam -o asm_aln.bam\nRaw reads,13\nMapped reads,13 (100.00%)\nPlus strand,13\nMinus strand,0\nMitochondria ratio,0.00%\n[2022-04-22 13:30:20] Real time: 0.001 sec; CPU: 0.006 sec; Peak RSS: 0.010 GB.\n\n$ samtools view asm_aln.bam|head -n 1\nZ_AAGCATCCACACAGAG_Z_CD44_1 0   chr11   35229531    60  439M    *   0   0   GAAATTAGGGCCCAATTAATAATCAGCAAGAATTTGATCGTTCCAGTTCCCACTTGGAGGCCTTTCATCCCTCGGGTGTGCTATGGATGGCTTCTAACAA\nAAACTACACATATGTATTCCTGATCGCCAACCTTTCCCCCACCAGCTAAGGACATTTCCCAGGGTTAATAGGGCCTGGTCCCTGGGAGGAAATTTGAATG\nGGTCCATTTTGCCCTTCCATAGCCTAATCCCTGGGCATTGTTTTCCACTGAGGTTGGGGGTTGGGGTGTACTAGTTACACATCTTCAACAGACCCCCTCT\nAGAAATTTTTCAGATGCTTCTGGGAGACACCCAAAGGGTGAAGCTATTTATCTGTAGTAAACTATTTATCTGTGTTTTTGAAATATTAAACCCTGGATCA\nGTCCTTTGATCAGTATAATTTTTTAAAGTTACTTTGTCA *   NM:i:1  ms:i:436    AS:i:436    nn:i:0  tp:A:P  cm:i:137    s1:i:430    s2:i:0  de:f:0.0023 rl:i:0  CB:Z:AAGCATCCACACAGAG   GN:Z:CD44"
  },
  {
    "objectID": "PISA.html#list-of-commands",
    "href": "PISA.html#list-of-commands",
    "title": "PISA User Guide",
    "section": "List of commands",
    "text": "List of commands\n\n\n\n\n\n\n\nTool\nDescription\n\n\n\n\n\nThe following tools are used to process FASTQ/FASTQ+ files.\n\n\nparse\nParse barcodes from FASTQ reads to FASTQ+.\n\n\nfsort\nSort FASTQ+ records by barcodes.\n\n\nstream\nPerform user-defined process for each read block.\n\n\naddtags\nAdd tag string to FASTQ reads.\n\n\n\nThe following tools are used to process BAM files.\n\n\nsam2bam\nParse FASTQ+ read name and convert SAM to BAM.\n\n\nrmdup\nRemove PCR duplicates per molecular.\n\n\npick\nPick alignments with tags.\n\n\nanno\nAnnotate functional regions or gene names.\n\n\ncorr\nCorrect error prone UMIs. 1 mismatch considered.\n\n\nattrcnt\nCount raw reads and tag values per cell.\n\n\nextract\nExtract tag value from BAM.\n\n\ncount\nCount feature X cell matrix from BAMs.\n\n\nbam2fq\nConvert BAM to FASTQ+ file with selected tags.\n\n\nbam2frag\nGenerate fragment file.\n\n\ndepth\nCoverage depth/UMI for target regions.\n\n\naddtags\nAdd tag string to BAM alignments.\n\n\ncallept\nCall expressed peak tags (EPTs) for RNA library.\n\n\n\nThe following tool used to process fragment file.\n\n\ncount2\nCount peak X cell matrix from fragment file.\n\n\n\nThe following tools used to process BED files.\n\n\nmergebed\nMerge BED files.\n\n\nannobed\nAnnotate BED files with genes and functional elements.\n\n\nflatten\nFlatten overlapped regions to nonoverlaps.\n\n\n\nThe following tools used to process GTF files.\n\n\ngtffmt\nFormat and reorder GTF file.\n\n\ngtf2bed\nConvert GTF to BED."
  },
  {
    "objectID": "PISA.html#commands-and-options",
    "href": "PISA.html#commands-and-options",
    "title": "PISA User Guide",
    "section": "Commands and options",
    "text": "Commands and options\n\nCommon options for all tools\n\n\n-h\n\n\nHelp information\n\n\n-o FILE\n\n\nOutput file.\n\n\n-tags tag(s)\n\n\nBarcode tags to group reads, usually be cell barcode tag.\n\n\n-umi tag\n\n\nUMI tag.\n\n\n-t/-@ number\n\n\nMultithreads to process data.\n\n\n-report FILE.csv\n\n\nSummary report in csv format.\n\n\n\n\nparse\nThe parse tool is specifically designed to convert FASTQ files into the extended FASTQ+ format. It utilizes the -rule option to define the library structure, accommodating various sequencing setups. For ease of use, this tool has included predefined common library structures in the release; these can be applied using the -x option. This tool is optimized for speed and supports the correction of barcodes that have up to one mismatch.\n# Parse cell barcode and UMI string from raw FASTQ.\n\n$ PISA parse -rule CB,R1:1-10,whitelist.txt,CB,1;R1,R1:11-60;R2,R2 -report fastq.csv lane1_1.fq.gz,lane02_1.fq.gz lane1_2.fq.gz,lane2_2.fq.gz\n\nOptions :\n -1       [fastq]   Read 1 output.\n -2       [fastq]   Read 2 output.\n -rule    [STRING]  Read structure in line. See Notice.\n -p                 Read 1 and read 2 interleaved in the input file.\n -q       [INT]     Drop reads if average sequencing quality below this value.\n -dropN             Drop reads if N base in sequence or barcode.\n -report  [csv]     Summary report.\n -t       [INT]     Threads. [4]\n -order             Keep input order.\n -x                 Predefined code for specific library.\n          * C4      Library structure for DNBelab C4 RNA kit v1.\nNotice :\n * -rule accept tag rule STRING to parse input fastq following format \"TAG,location,whitelist,corrected TAG,allow mismatch\".\n   For each tag rule, location part should be format like R[12]:start-end. Both start and end location start from 1.\n   TAG and locaion parts are mandatory, and whitelist, corrected TAG and mismatch are optional.\n   Futhermore, multiply tags seperated by ';'. In location part, R1 stands for raw read 1, R2 stands for raw read 2.\n   In tag part, R1 stands for output read 1 while R2 stands for output read 2. Here are some examples.\n\n$ PISA parse -rule 'CR,R1:1-18,barcodes.txt,CB,1;UR,R1:19-30;R1,R2:1-100' -1 read_1.fq raw_read_1.fq raw_read_2.fq\n\n# CR,R1:1-18,barcodes.txt,CB,1  - CR tag start from 1 to 18 in read 1, and barcodes.txt are barcode whitelist,\n#   each barcode per line. Cell barcode will be corrected while hamming distance &lt;= 1.\n#   Corrected cell barcode tag is CB. \n# UR,R1:19-30 - UR tag start from 19-30 in read 1.\n# R1,R2:1-100 - Sequence from 1 to 100 in read 2 output to read 1 file. \n\n$ PISA parse -rule 'CR,R1:1-10,bc1.txt,CB,1;CR,R1:11-20,bc2.txt,CB,1;R1,R2:1-100' -1 read_1.fq raw_read_1.fq raw_read_2.fq\n\n# CR,R1:1-10,bc1.txt,CB,1;CR,R1:11-20,bc2.txt,CB,1 - This cell barcode consist of two segments, first segment start\n#   from 1 to 10 in read 1, and whitelist is bc1.txt, and second segment start from 11 to 20, and whitelist is bc2.txt.\n#   These two segments will be combined after correction, because the corrected tag are the same.\nOption -report can specify a quality control report in CSV format. Here is the explanation of each term in this file.\n\n\n\n\n\n\n\n\nTerms\nDescription\n\n\n\n\nNumber of Fragments\nThe number of records in the FASTQ(s). For paired reads, each pair only count once.\n\n\nFragments pass QC\nReads or paired reads pass QC.\n\n\nFragments with Exactly Matched Barcodes\nBarcodes exactly matched with any barcode in the candidate list.\n\n\nFragments with Failed Barcodes\nNo barcode found in the candidate list with similar search.\n\n\n\n\n\n\nfsort\nThe fsort tool is engineered to order FASTQ+ records based on specified tags, which can be defined using the -tags option. This tool efficiently handles file sorting: for files smaller than 1 gigabyte, it performs the sort directly. However, for larger FASTQ files, where caching the entire file in memory is impractical, fsort employs a different strategy. It splits the large file into smaller segments, sorts each segment individually, and then merges the sorted segments. This method ensures efficient handling of large datasets while maintaining the integrity and order of the FASTQ+ records.\n# Sort reads by tags.\n\n$ PISA fsort -tags CB,UR -list cell_barcodes_top10K.txt -@ 5 -o sorted.fq.gz in.fq\n\nOptions:\n -tags    [TAGS]     Tags, such as CB,UR. Order of these tags is sensitive.\n -@       [INT]      Threads to compress file.\n -o       [fq.gz]    bgzipped output fastq file.\n -m       [mem]      Memory per thread. [1G]\n -p                  Input fastq is smart pairing.\n -T       [prefix]   Write temporary files to PREFIX.nnnn.tmp\n\n\nstream\nThe stream tool is designed as a framework to process FASTQ+ files, where each FASTQ+ block—defined by having identical tags and grouped together in the file—is handled individually. The -script option allows users to specify a custom bash script that processes each block. This user-defined script reads a ‘small’ FASTQ+ file, generating FASTQ or FASTA output that is then sent to stdout. The stream tool captures this output via a pipe and updates the tags to ensure that each block of reads retains its original tags. Finally, it consolidates all outputs into a single file. In essence, this tool efficiently divides and processes each FASTQ+ block through a user-defined method, then seamlessly merges the results.\n# Perform user-defined script for each FASTQ+ block.\n\n$ PISA stream -script run.sh reads.fq.gz\n\nOptions :\n -tags    [TAGS]     Tags to define read blocks.\n -script  [FILE]     User defined bash script, process $FQ and generate results to stdout.\n -min     [INT]      Mininal reads per block to process.  [2]\n -keep               Output unprocessed FASTQ+ records.\n -fa                 Stream FASTQ output instead of FASTQ.\n -tmpdir\n -t                  Threads.\n -o       [FILE]     Path to output file.\n -nw                 Disable warning messages.\n\nWrite a script for PISA stream\nThe PISA stream tool generates a temporary file named _block.fq for each block of reads, storing this file in a designated temporary directory. The path to this file is set in the environment variable ${FQ} for accessibility by subprocesses. Additionally, to ensure the uniqueness of each block, an alias named the ‘unique block index’ is exported to the environment as ${UBI}.\nThe following example script demonstrates how to convert FASTQ+ to FASTA and rename the sequence ID. It is crucial for users to ensure that the script’s final output (either FASTQ+ or FASTA) is directed to stdout. All other script steps should avoid producing output to stdout or stderr, except for the last step. This precaution is necessary because PISA captures the script’s output through a pipe, and any unintended characters could disrupt the data format. Scripts can be written in a bash file or specified inline within the command.\n\n$ cat run.sh\nseqtk rename ${FQ} &gt; test.fa; seqtk rename test.fa ${UBI}\n\n\n\n\naddtags\nThe addtags tool is designed to put the new tags or update tags for FASTQ+ or BAM files.\n# Just add tags to reads.\n\n$ PISA addtags -str CB:Z:CELL1,LB:Z:PoII2 -o out.bam in.bam\n$ PISA addtags -str CB:Z:CELL1,LB:Z:PoII2 -o out.fastq in.fastq\n\nOptions:\n-o    [FILE]    Output file, bam or fastq, depends on input format\n-str  [string]  TAGs.\n-@    [INT]     Threads to pack file.\n-mapq [INT]     Mapping quality score to filter mapped reads.\n\n\nsam2bam\nAfter alignment, the sequence ID from the FASTQ+ records is retained in the RNAME field of the SAM file. Given that the RNAME field is limited to 254 characters, we also restrict the sequence ID and any optional tag fields in FASTQ+ to this length to ensure compatibility. The sam2bam tool processes these details by parsing the tags from the RNAME and appending them to the end of the SAM optional fields.\n# Parse FASTQ+ read name and convert SAM to BAM.\n\n$ PISA sam2bam -report alignment.csv -@ 5 -adjust-mapq -gtf genes.gtf -o aln.bam in.sam[.gz]\n\nOptions :\n -o       [BAM]       Output file [stdout].\n -t       [INT]       Work threads.\n -mito    [string]    Mitochondria name. Used to stat ratio of mitochondria reads.\n -maln    [BAM]       Export mitochondria reads into this file instead of standard output file.\n -@       [INT]       Threads to compress bam file.\n -report  [csv]       Alignment report.\n\nNote :\n* Reads map to multiple loci usually be marked as low quality and filtered at downstream analysis.\n  But for RNAseq library, if reads map to an exonic locus but also align to 1 or more non-exonic loci,\n  the exonic locus can be prioritized as primary alignments, and mapping quality adjusts to 255. Tag\n  MM:i:1 will also be added for this record. Following options used to adjust mapping quality.\n* Input SAM need be sorted by read name, and aligner should output all hits of a read in this SAM.\n -adjust-mapq         Enable adjusts mapping quality score.\n -gtf     [GTF]       GTF annotation file. This file is required to check the exonic regions.\n -qual    [255]       Updated quality score.\nOption -t is to set the threads to parse the SAM records. The -@ option is to set the threads to compress alignments in BGZF format. The default compress level of BGZF is 6 in the htslib, but here PISA has reset this value to 2 to decrease the CPU times. It’s not a good design to have both -t and -@, but will require a lot work to redesign the multithreads strategy, I have put this work in my todo list.\nOption -report can specify a quality control report in CSV format. Here is the explanation of each term in this file.\n\n\n\n\n\n\n\n\nTerms\nDescription\n\n\n\n\nRaw reads\nRaw reads in the BAM files, secondary alignment will be skipped.\n\n\nMapped reads\nReads mapped to reference, and the ratio of raw reads.\n\n\nPlus strand\nReads mapped to forward strand of reference.\n\n\nMinus strand\nReads mapped to backward strand of reference.\n\n\nMitochondria ratio\nRatio of reads mapped to chromosome mitochondria. The default mito name is “chrM”, user should change it by -mito option if reference is different. Otherwise this value will always be 0.\n\n\n\n\n\nMapQ adjust method\nFor RNA libraries, if a read from cDNA maps to an exonic locus but also maps to one or more non-exonic regions, the exonic locus can be prioritized as primary alignments, and mapping quality adjusts to 255. In the below records below, read DP8400008965TLL1C001R0102043364 mapped to three loci, and the aligner random pick one as the primary alignment and others as secondary. Each of these alignments has low mapping quality (MAPQ == 2, is usually filtered at downstream analysis). Our adjustment method will check if only one of these alignments overlaps with exonic regions. In our example, the last alignment overlapped with gene EEF1A1, and the other two hit intergenic regions. After adjustment, the last record has been flagged as a primary hit, and the mapping quality adjusted to 255, and other alignments of the same read are updated as secondary, MAPQ adjust to 0. MM:i:1 tag also is added to the primary record after adjustment. Option -adjust-mapq is reimplemented to mirror the 10X CellRanger’s MAPQ adjustment method (https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/latest/algorithms/overview#alignment).\n#  Output by aligner:\n \nDP8400008965TLL1C001R0102043364 0   9   133020979   2   100M    *   0   0   GTTAATGATAACAATGCATCGTAAAACCTTCAGAAGGAAAGGAGAATGTTTTGTGGACCACTTTGGTTTTCTTGTTTGCGTGTGGCAGTTTTAAGTTTTT    ...\nDP8400008965TLL1C001R0102043364 272 7   22510408    2   100M    *   0   0   AAAAACTTAAAACTGCCACACGCAAACAAGAAAACCAAAGTGGTCCACAAAACATTCTCCTTTCCTTCTGAAGGTTTTACGATGCATTGTTATCATTAAC    ...\nDP8400008965TLL1C001R0102043364 272 6   73517606    2   100M    *   0   0   AAAAACTTAAAACTGCCACACGCAAACAAGAAAACCAAAGTGGTCCACAAAACATTCTCCTTTCCTTCTGAAGGTTTTACGATGCATTGTTATCATTAAC    ...\n\n# After adjustment (Seq and Qual in secondary alignments masked as *):\n\nDP8400008965TLL1C001R0102043364 256 9   133020979   0   100M    *   0   0   *   ...\nDP8400008965TLL1C001R0102043364 272 7   22510408    0   100M    *   0   0   *   ...\nDP8400008965TLL1C001R0102043364 16  6   73517606    255 100M    *   0   0   AAAAACTTAAAACTGCCACACGCAAACAAGAAAACCAAAGTGGTCCACAAAACATTCTCCTTTCCTTCTGAAGGTTTTACGATGCATTGTTATCATTAAC    ... MM:i:1\nAn example list here to show how to enable mapq adjuestment.\nPISA sam2bam -report alignment.csv -o out.bam -adjust-mapq -gtf hg38.gtf in.sam\n\n\n\nrmdup\nTo effectively manage PCR duplication in single-cell experiments, it is essential to consider both cell and molecular barcodes. During the feature counting stage facilitated by PISA count, deduplication is efficiently handled by relying solely on unique UMIs. This reliance makes traditional PCR deduplication unnecessary for libraries that use UMIs. Nonetheless, producing a deduplicated BAM file remains beneficial for other analytical processes, such as variant calling, or simply to reduce file size.\nThe rmdup tool is specifically designed to remove duplicate reads that share identical barcodes, such as UMIs and cell barcodes. This selective deduplication approach ensures that only truly redundant data is removed, thus preserving the integrity and completeness of the dataset for comprehensive downstream analyses.\n# Deduplicate PCR reads with same barcodes.\n\n$ PISA rmdup -tags CB,UR -o rmdup.bam in.bam\n\nOptions :\n   -tags  [TAGS]       Barcode tags to group reads.\n   -@     [INT]        Threads to unpack BAM.\n   -o     [BAM]        Output bam.\n   -q     [INT]        Map Quality Score cutoff.\n   -k                  Keep duplicates, make flag instead of remove them.\n   -nw                 Disable warnings.\nIn this version, PISA rmdup only supports single-end reads. For paired-end reads, such as scATAC data, PCR deduplication can be performed by the PISA bam2frag tool.\n\n\npick\nThe PISA pick tool is designed to select alignments with predefined tags and candidate values.\n$ PISA pick -tags CB,GN -list cell_barcodes.txt in.bam\n\nOptions :\n -tags    [TAGS]       Barcode tags.\n -list    [FILE]       Barcode white list, tag values in related column will be apply.\n -o       [BAM]        Output file.\n -q       [INT]        Map Quality Score cutoff.\n -@       [INT]        Threads to unpack BAM.\nDepending on the number of tags specified by the user, the candidate list for tags can consist of either a single column or multiple columns. If multiple tags are specified but only one column is present in the list, the program will primarily compare the value of the first tag in the alignments with the list.\n\n\nanno\nConnecting alignment results with genomic features is essential in single-cell data analysis. PISA categorizes features into three main types: gene annotation, functional regions, and genetic or sequence variations. For gene annotation, the PISA anno tool efficiently organizes all exons, transcripts, and genes from a GTF database into a sorted hierarchical tree structure.\nBased on their alignment status, reads are then classified into one of nine distinct types, see illustrate below Figure 1. This detailed categorization helps in accurately assessing the transcriptional landscape and understanding the complex genomic architecture within single-cell datasets.\n\n\n\nFigure 1: Read types.\n\n\n\n# annotate strand-specific reads\n$ PISA anno -gtf genes.gtf -o anno.bam in.bam\n\n# annotate non-strand-specific reads, for Smartseq or bulk RNAseq\n$ PISA anno -is -gtf genes.gtf -o anno.bam in.bam\n\n# also label gene name for intronic reads, i.e. RNA velocity analysis\n$ PISA anno -velo -gtf genes.gtf -o anno.bam in.bam\n\n\n# annotate exon, junction, and exon skipped reads\n$ PISA anno -exon -psi -gtf genes.gtf -o anno.bam in.bam\n\n# annotate expressed peaks\n$ PISA anno -bed peak.bed -o anno.bam in.bam\n\n# annotate genetic variants (both reference allele and alternative allele) \n$ PISA anno  -vcf in.vcf.gz -ref-alt -o anno.bam in.bam\nBesides these annotation methods, PISA anno also supports a -chr-species method. This method requires a binding list for chromosome and related label relationships. The software will check the chromosome and add the related tag for each chromosome. This method, combined with PISA attrcnt can help to summarize the mixed two cell lines from different species.\n# A binding list is tab-separated two columns txt file.\n$ cat binding_list.txt\nGRCh38_chr1    Human\nGRCh38_chr21   Human\nmm10_chr21     Mouse\n\n$ PISA anno -chr-species binding.txt -btag SP -o anno_species.bam sorted.bam\nThe full options and descriptions list below.\n# Annotate SAM/BAM records with overlapped function regions. Such as gene, transcript etc.\n\n$ PISA anno -bed peak.bed -tag PK -vcf in.vcf.gz -vtag VF -vcf-ss -ref-alt -o anno.bam in.bam\n$ PISA anno -gtf genes.gtf -o anno.bam in.bam\n$ PISA anno -gtf genes.gtf -o anno.bam -sam in.sam\n\nOptions :\n -o        [BAM]       Output bam file.\n -report   [csv]       Summary report.\n -@        [INT]       Threads to compress bam file.\n -q        [0]         Map Quality Score cutoff. MapQ smaller than this value will not be annotated.\n -t        [INT]       Threads to annotate.\n -chunk    [INT]       Chunk size per thread.\n -anno-only            Export annotated reads only.\n -sam                  Input is SAM file, parse tags from read name.\n -rev                  Annotation in reverse strand; Some probe ligation library for FFPE samples create reverse fragments.\n -is                   Disable strand sensitive annotation of gene, genomic region and genetic variants.\n\nOptions for BED file :\n -bed      [BED]       Function regions. Three or four columns bed file. Col 4 could be empty or names of this region.\n -tag      [TAG]       Attribute tag name. Set with -bed. Default is PK.\n\nOptions for mixed samples.\n -chr-species  [FILE]  Chromosome name and related species binding list.\n -btag     [TAG]       Species tag name. Set with -chr-species. Default is SP.\n\nOptions for GTF file :\n -gtf      [GTF]       GTF annotation file. gene_id,transcript_id is required for each record.\n -tags     [TAGs]      Attribute names, more details see `Notice` below. [TX,GN,GX,RE,EX,JC]\n -splice               Reads covered exon-intron edge (ExonIntron type) will also be annotated with all tags.\n -intron/-velo         Reads covered intron regions will also be annotated with all tags.\n -exon                 Generate exon level and junction annotation. Put exon name (chr:start-end/[[+-]/Gene) in EX tag.\\ \n                       Also generate junction name (chr:exon1_end-exon2_start/[+-]/Gene) in JC tag.\n -flatten              Split overlapped exons into nonoverlapped bins.\n -psi                  Annotate exclude reads tag (ER) for each exon.\n\n -tss                  Annotate reads start from TSS, designed for capped library. **experiment**\n -ctag     [TAG]       Tag name for TSS annotation. Need set with -tss.\n\nOptions for VCF file :\n -vcf      [VCF/BCF]   Varaints file in vcf or bcf format. In default, only annotate alternative alleles.\n -vtag     [TAG]       Tag name for variants. Set with -vcf. Default is VR.\n -ref-alt              Annotate ref allele.\n\nNotice :\n * If input is SAM format, will try to parse the tags in the read name.\n * For GTF mode, this program will set tags in default, you could also reset them by -tags.\n   TX : Transcript id.\n   GN : Gene name.\n   GX : Gene ID.\n   RE : Region type, E (exon), N (intron), C (exon and intron), S (junction reads cover isoforms properly), V (ambiguous reads),\n        I (intergenic), A (antisense or antisense exon), B (antisense intron), X (one or more exons are excluded in transcrpit)\n * The following tags set with -exon.\n   EX : Exon name tag.\n   JC : Isoform junction name.\n   FL : Flatten exon name. Only generate it with -flatten.\n * The following tags set with -psi.\n   ER : Excluded exons.\n * PSI = EX/(EX+ER); EX is the exon tag, which indicate include reads in exon.\n\n\ncorr\nThe diversity of UMIs of each gene in one cell is used to evaluate the gene expression level, but the error of UMI comes from sequencing or PCR may introduce bias. PISA corr is designed to correct the UMI or barcode sequence based on Hamming distance. In default, two groups of UMI from the same gene of one cell with Hamming distance equal to 1, will be considered to originate from the same transcript. The group with high frequency will be selected as a real one, and another one will be corrected to the high one.\nBecause PISA corr does not require a sorted BAM, this tool will first build a correction list by caching all the raw UMIs and barcodes and then correct them in memory. After these steps, this tool will reread the file and update these records by order. This design can avoid potential bias for the same gene from different chromosomes (i.e., the HLA genes in alternative locus). However, this design also required a lot of memory for a big BAM.\nCellRanger also introduces an algorithm to correct reads with the same UMI of one cell but mapping to more than one gene (https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/latest/algorithms/overview). PISA implements this method but does not enable it in default. The -cr option can be used by users to enable this function. The reason for not enable it by default is PISA corr not only is used to correct UMIs, but also can be used to correct any other types of barcodes. The following example shows how to use PISA corr to correct cell barcodes for reads in the same gene.\n// Reads with same gene tag (GN) and UMI (UB) will be grouped and calculate the Hamming distance between each other. \n// Only if Hamming distance == 1 will be corrected.\nPISA corr -tag CR -new-tag CB -tags-block GN,UB -o cell_barcode_corrected.bam in.bam\nFull options of PISA corr list below.\n# Correct similar barcodes (hamming distance == 1).\n\n$ PISA corr -tag UR -new-tag UB -tags-block CB,GN -@ 5 -o corr.bam in.bam\n\nOptions :\n -o        [BAM]       Output bam.\n -tag      [TAG]       Tag to correct.\n -new-tag  [TAG]       Create a new tag for corrected barcodes.\n -tags-block  [TAGS]   Tags to define read group. For example, if set to GN (gene), reads in the same gene will be grouped together.\n -cr                   Enable CellRanger like UMI correction method. See `Examples` for details.\n -e                    Maximal hamming distance to define similar barcode, default is 1.\n -@        [INT]       Thread to compress BAM file.\n\n\nExamples :\n // Two groups of reads have same cell barcode (CB) and gene (GN) but their raw UMIs (UR) differ by only one base. The UMI of less \n // supported is corrected to the UMI with higher support. UB save the checked or corrected UMI.\n$ PISA corr -tag UR -new-tag UB -tags-block CB,GN in.bam -o corr.bam \n\n // Same with above. Besides, if two or more groups of reads have same CB and UB but different GN, the GN with the most supporting reads\n // is kept for UMI counting, and the other read groups are discarded. In case of a tie for maximal read support, all read groups are\n // discarded, as the gene cannot be confidently assigned (Cell Ranger method).\n$ PISA corr -cr -tag UR -new-tag UB -tags-block CB,GN in.bam -o corr.bam \n\n\nattrcnt\nPISA attrcnt is used to summarize the meta information of the library. We start introduce this tool with few examples.\n# Count reads per cell, -cb option is required to specify cell barcode tag\n$ PISA attrcnt -cb CB in.bam\n\n// the summary information output in tsv format\nBARCODE Raw                           // the title\nAGCTATGCTTCTAGTGTAAC-1  38            // cell barcode and raw reads per cell, separated by a tab\nGCCGCTGATCGGCCTGCACA-1  12\nGTCGCGATTCTGCTCAGAAG-1  13\nGTCAGTACCATGCTCAGAAG-1  27\nCAACTCGTCGGTTGTCTGAC-1  23\n\n# Count raw reads and reads in the peaks per cell\n$ PISA attrcnt -cb CB -tags PK             // PK tag is annotated for reads in peak\n             -o summary.tsv              // Summary file\n             example/anno/demo_1.bam \n\n$ head summary.tsv \nBARCODE Raw PK\nGGCATTATCGGCTCGGTATG    2   2\nTGAGTTGTGTATACTCCTAC    2   2\nCCGCGGCACTACACACCAGA    1   1\nATTAGTGGTCTCCTGGTCGG    1   1\nTTATTGGACCACGTTGAATA    1   1\nGGAATGCCACAAGCGCCGTA    1   1\nAGTCTATCGTGGCCTGCACA    5   5\nAGGCACACCTCGCTGAATTC    3   3\nGTCAGGATCGATAACATACG    2   2\n\n# Count UMIs per cell\n$ PISA attrcnt -cb CB -tags UB      // UB is tag of corrected UMIs\n             -dedup               // -dedup option used to remove duplication of tag values, if not set, this \n                                  // command will export reads with UB tag but not the unique UMIs per cell\n             -o summary.tsv anno.bam\n\n# Count UMIs and Genes per cell\n$ PISA attrcnt -cb CB -tags UB,GN  // GN is tag for annotated gene; -tags can accept multiple tag names, and seperated by \",\"\n             -dedup -o summary.tsv anno.bam\n\n$ head summary.tsv\nBARCODE Raw UB  GN\nAGCTATGCTTCTAGTGTAAC-1  38  35  0\nGCCGCTGATCGGCCTGCACA-1  12  12  0\nGTCGCGATTCTGCTCAGAAG-1  13  11  0\nGTCAGTACCATGCTCAGAAG-1  27  26  0\nCAACTCGTCGGTTGTCTGAC-1  23  21  0\nGGTACACCACAGTAGTTACG-1  12  10  0\nGCGCGCCGAGGGACACTCTT-1  1   1   0\nCTCTAAGCATCGAGGTTAAC-1  162 138 50\nTTCGTAGCACCGATACTAGC-1  51  48  46\nFull list of options list below.\n# Count the frequency of tag values.\n\n$ PISA attrcnt -cb CB -tags UR,GN -dedup -all-tags in.bam\n\nOptions :\n -cb       [TAG]      Cell Barcode, or other tag used for grouping reads.\n -list     [FILE]     Cell barcode white list.\n -tags     [TAGS]     Tags to count.\n -dedup               Deduplicate the atrributes in each tag.\n -all-tags            Only records with all tags be count.\n -group    [TAG]      Group tag, count all tags for each group seperately.\n -o        [FILE]     Output count table.\n -q        [INT]      Map Quality to filter bam.\n -no-header           Ignore header in the output.\n -@        [INT]      Thread to unpack bam.\n -ttag     [TAG]      Region type tag. [RE]\n -ttype               Region type used to count. Set `E,S` to count exon enclosed reads. Set `N,C` to count intron overlapped reads.\n\n\nextract\nPISA extract is designed to extract the values of tags from BAM records and generate a tab-separated file.\n# Extract tag values from alignments.\n\n$ PISA extract -tags CB,UR,GN -o tags.tsv in.bam\n\nOptions :\n -tags     [TAGS]     Tags to be extracted.\n -o        [FILE]     Output file. tsv format\n -n                   Print read name.\n -q                   Map Quality Score threshold.\n -all                 Only export if all tags have value.\n\n\ncount\nThe PISA count tool is designed to generate a counts matrix for various features or tags, traditionally outputting a gene-by-cell digit matrix. Starting with version 0.4, this tool now supports the MEX format output, which is highly recommended for use in downstream analyses due to its superior performance. It’s important to note that MEX format consists of three files, so you should use the -outdir option to specify the directory where the output files will be saved.\n# Count reads or fragments matrix for single-cell datasets.\n\n$ PISA count -cb CB -anno-tag GN -umi UB -outdir exp aln.bam\n$ PISA count [options] aln1.bam,aln2.bam\n$ PISA count -cb RG -sample-list bam_files.txt -outdir exp\n$ PISA count -tags Cx,Cy -anno-tag GN -umi UB -outdir exp -velo aln.bam\n\nOptions :\n -tags/-cb [TAGs]     A cell barcode tag or two tags of spatial coordinates for spatial data.\n -anno-tag [TAG]      Annotation tag, gene or peak.\n -genome-bin [INT]    If genome bin size set, genome bin count matrix will be generated, conflict with -anno-tag and -chr.\n -is                  Ignore strand for bin counting.\n -chr                 Count chromosome expression level, conflict with -anno-tag and -genome-bin.\n -list     [FILE]     Barcode white list, used as column names at matrix. If not set, all barcodes will be count.\n -outdir   [DIR]      Output matrix in MEX format into this folder.\n -umi      [TAG]      UMI tag. Count once if more than one record has same UMI in one gene or peak.\n -one-hit             Skip if a read hits more than 1 gene or peak.\n -q        [INT]      Minimal map quality to filter. Default is 20.\n -t        [INT]      Threads.\n -ttag     [TAG]      Region type tag. [RE]\n -velo                Generate spliced and unspliced matrix files for RNA velocity analysis.\n -ttype    [TYPE]     Region type used to count. Set `E,S` to count exon enclosed reads. Set `N,C` to count intron overlapped reads.\n -sample-list [FILE]  A list of bam files. Each path per line.\n\nOptions for Stereoseq:\n -stereoseq           Stereoseq pipeline pack UMI to hex string. Need set this option to decode UMIs.\n -spatial-bin [INT]   Bin size for spatial coordiate. Can be set if -tags specify spatial coordinates.[1]\n -dup                 Do NOT skip duplicate reads.\n\nNotice :\n * Region type (RE), which label functional region reads mapped, is annotated by `PISA anno`. Optional -ttype can be set\n   to one of region types(E/S/C/N) or combination to count reads mapped to these functional regions only.\n * If you want count from more than one bam file, there are two ways to set the parameter. By seperating bam files with ',' or by\n   setting -sample-list option.\n * If -velo set, spliced and unspliced folders will be created at outdir.\n\nFor Smartseq user\nPISA count also support counting gene expression from multiple bam files.\n$ PISA count -file-barcode             // use alias name for each bam file as cell barcode. If this flag is not set -cb must be specified.\n-tags CB                   // Cell barcode\n-sample-list bam_list.txt // bam file path and alias name\n-outdir exp/ -anno-tag GN \n\n# The `-sample-list' specify multiply files, each BAM path per line.\n\n\nDescription of MEX file\nThe Market Exchange (MEX) format (https://math.nist.gov/MatrixMarket/formats.html) is designed for representing the sparse matrix. The -outdir option specifies the output directory for one MEX fold. The MEX format consists of three files, one is cell barcodes, one is feature names (genes or peak names), and the third one defines the expression or signal values.\n$ ls\nbarcodes.tsv.gz  features.tsv.gz  matrix.mtx.gz\n\n$ zcat barcodes.tsv.gz|head\nAACCTGGTGAAGTTGTCGAA\nAAGGAACTAAGCGCAGCACC\nCGATAGAATACTTCTTCGTA\nTACTATCCTCTAGCTGCTAC\nTGACCATCCTACAGTCCACC\nCAGATTCAACTACGAAGTGC\nTTCGTAGCACTCTTCATCTC\nGGCACCTTGCTTAACGTAGG\nACTTCGGATACGTATCGCCT\nGACTCGCTAGTAGTCGGAAT\n\n$ zcat features.tsv.gz|head\nRP11-34P13.7\nRP11-34P13.8\nRP11-34P13.9\nFO538757.3\nFO538757.2\nAP006222.2\nRP4-669L17.10\nRP5-857K21.4\nRP11-206L10.4\nRP11-206L10.9\n\n$ zcat matrix.mtx.gz|head\n%%MatrixMarket matrix coordinate integer general\n% Generated by PISA v0.4-alpha-72-g09c4ded\n23900   782761  11533380\n1   1   2\n1   2   2\n1   3   2\n1   4   1\n1   5   2\n1   6   1\n1   7   2\nThe MEX file can be read by R package Yano::ReadPISA.\n\n\n\nbam2fq\nPISA bam2fq is designed to convert alignment records to FATSQ+ records. Option -tags specify which tags will be kept in the FASTQ+. Full options list below.\n# Convert BAM into fastq.\n$ PISA bam2fq -tags CB,UB,GN -o out.fq aln.bam\n\nOptions :\n -tags     [TAGS]     Export tags in read name.\n -f                   Filter records if specified tags not all exist.\n -fa                  Output fasta instead of fastq.\n -o        [fastq]    Output file.\n -@        [INT]      Threads to unpack BAM.\n\n\nbam2frag\nThe fragment file is a five columns tab-separated flat file which is designed for scATAC-seq. The first column is the chromosome name, the second column is the start location of this fragment (0 based), and the third column is the end position in 1 based of this fragment. The fourth column is the cell barcode of this fragment and the last column is how many duplicates of this fragment.\nPISA bam2frag requires the input BAM file to be sorted by coordinate. This tool will check the cell barcode and the fragment position for each paired reads, duplicates in one cell will only keep one record, and the numeber of copies for this fragment will be updated in column four.\n# Convert sam record to fragment file.\n\n$ PISA bam2frag -cb CB -list cell_barcodes.txt -o out.tsv.gz in.bam\n\nOptions:\n -o       [FILE]    Output file. This file will be bgzipped and indexed.\n -cb      [TAG]     Cell barcode tag.\n -list    [FILE]    Cell barcode white list.\n -q       [20]      Mapping quality score to filter reads.\n -isize   [2000]    Skip if insert size greater than this. [2KB]\n -bed     [BED]     Only convert fragments overlapped with target regions.\n -black-region [BED] Skip convert fragments overlapped with black regions.\n -stat    [FILE]    Transposition events per cell.\n -@       [4]       Thread to unpack and pack files.[4]\n -disable-offset    Disable Tn5 offset for each fragment.\n\n\ndepth\nPISA depth generates coverage information for each position of the predefined region(s). The significant difference between PISA depth and samtools depth (http://www.htslib.org/doc/samtools-depth.html) is that PISA depth use UMI rather than reads. Besides, PISA depth is strand sensitive, and can produce results for target cells.\n# Count coverage depth or unique UMIs for genome locations.\n\nUsage : PISA depth [options] sorted.bam [region]\n\n$ PISA depth -cb CB -umi UB -tags GN -region in.bed -o depth.tsv sorted.bam\n$ PISA depth -cb CB -umi UB sorted.bam chr1:1-2:+\n\nOptions : \n -tag      [TAG]      Tag used for grouping reads.\n -list     [FILE]     Candidate list for -tag.\n -umi      [TAG]      UMI tag. If set, only count unique UMIs for each location.\n -bed      [BED]      Target BED region file. If the strand in column six set, only count reads with the same strand.\n -o        [FILE]     Output depth file. [stdout].\n -q        [INT]      Minimal map quality to filter. [20]\n -@        [INT]      Threads to unpack bam. [4]\n\nNotice :\n * Require sorted and indexed BAM as input.\n * Compare with `samtools depth', PISA depth considers UMIs and strand of reads.\n\n\ncallept\nThe term ‘EPT’ stands for Expressed Peak Tag. EPTs can be identified by PISA within aligned reads from RNA libraries. Once identified, the relationship between each EPT and its corresponding gene can be annotated and analyzed using the Yano package. This analysis helps in understanding the functional implications of EPTs in gene expression regulation.\nThe callept tool is designed to call expressed peak tags (EPTs) for indexed BAM files. The peaks are defined with UMI depth &gt;= cutoff.\n$ PISA cellept -o epts.bed sorted.bam\n$ PISA cellept -tag CB -list cells.txt -umi UB -o epts.bed sorted.bam\n\nOptions :\n -tag      [TAG]      Tag used for grouping reads.\n -list     [FILE]     Candidate list for -tag.\n -umi      [TAG]      UMI tag. If set, only count unique UMIs for each location.\n -is                  Ignore strand.\n -gap      [INT]      Maximum gap to merge nearby peaks. [50]\n -min-length  [INT]   Minimum peak length. [50]\n -cutoff   [INT]      Cutoff of depth. [10]\n -o        [FILE]     Output EPTs in bed format. [stdout].\n -q        [INT]      Minimal map quality to filter. [20]\n -t        [INT]      Threads. [4]\n\nNotice :\n * Requires sorted and indexed BAM as input.\n * Compares with `MACS2` and other peak callers, PISA callept considers UMIs and strand of reads.\n * For paired reads, strand of read 2 will be reversed to revert fragment strand.\n\n\ncount2\nPISA count generates the MEX format matrix for fragments per peak.\n# Count fragments per peak per cell matrix.\n\n$ PISA count2 -bed peaks.bed -t 10 -list barcodes.txt -outdir exp fragments.tsv.gz\n\nOptions :\n -list     [FILE]     Barcode white list, used as column names at matrix. If not set, all barcodes will be count.\n -outdir   [DIR]      Output matrix in MEX format into this fold.\n -prefix   [STR]      Prefix of output files.\n -t        [INT]      Threads.\n\n\nmergebed\nMerge overlapped regions by strand and name.\n$ PISA mergebed -o merged.bed sample1.bed sample2.bed\n$ PISA mergebed -up 500 -down 500 -o flank.bed peaks.bed\n\nOptions:\n-o    [FILE]    Output bed file.\n-s              Ignore strand.\n-up   [INT]     Enlarge regions upstream.\n-down [INT]     Enlarge regions downstream.\n-name           Merge regions by bed name.\n\nNotice :\n * This tool accepts 3 columns or 6 columns bed file(s), strand (+/-) is set in column 6.\n * By default, merging is done with respect to strandness unless -s is set.\n * -up/-down is set respect to strandness, so upstream of plus strand is downstream of minus strand.\n\n\nannobed\nAnnotate the type of region and output in a BED like file. The region type can be defined into.\n$ PISA annobed -gtf genes.gtf -o anno.bed in.bed\n\nOptions:\n-gtf    [GTF]     GTF database.\n-o      [FILE]    Output bed file.\n-report [FILE]    Summary report. Export in STDERR by default.\n-is               Ignore strand.\n-gene-name        Set annatated gene as bed name (column 4).\n-skip-chrs        Skip chromosomes if not exist in GTF. Defa\n-up  [1000]         Annotate intergenic regions at upstream of gene.\n-down  [1000]       Annotate intergenic regions at downstream of gene.\n\nOutput format :\nchromosome,start(0based),end(1based),name,score,strand,number of covered genes, cover gene name(s),type,nearest gene name,distance to nearby gene\n\nNotice :\n * This tool accepts 3 columns or 6 columns bed file(s), strand (+/-) is set in column 6.\n * By default, annotation is done with respect to strandness unless -s is set.\n\n\nflatten\nConvert overlapped into flatten records. If strand exist, the flatten records will be strand sensitive.\n$ PISA flatten -o flatten.bed overlapped.bed\n\nOptions:\n-o    [FILE]    Output bed file.\n\nFor example:\nreg1 ===========\nreg2       ===========\nflattening of regions:\nreg1 ======\nreg2       =====\nreg3            ======\n\n\ngtffmt\nFormat and reorder GTF records.\n$ PISA gtffmt in.gtf\n\nOptions:\n -o      [FILE]    Output GTF file\n -f                Only export gene, transcript, exon and CDS records.\n -key    [all]     Export selected keys in optional fields.\n -report [stderr]  Summary report file.\n\n\ngtf2bed\nConvert GTF file to BED format.\n$ PISA gtf2bed -o merged.bed in.gtf.gz\n\nOptions:\n  -o    [FILE]                          Output bed file.\n  -type [gene|transcript|exon]          Covert to bed.\n  -name [none|gene|transcript|exon]     Set name for bed."
  },
  {
    "objectID": "PISA.html#deprecated-commands",
    "href": "PISA.html#deprecated-commands",
    "title": "PISA User Guide",
    "section": "Deprecated commands",
    "text": "Deprecated commands\n\nparse0\nSince v1.0, the old parse tool has been replaced by parse2, and renamed to parse0 for backup purposes. Due to its lower performance compared to parse, parse0 will be deleted from v2 onwards. The parse0 tool requires a configuration file to describe the library structure, including cell barcode locations, UMI locations, and tag names. Additionally, it generates various quality control reports and outputs cell barcode distributions to stdout. Below is the complete options list and a general workflow for filtering and counting reads.\n$ PISA parse -config read_struct.json -report fastq.csv -cbdis cell_dist.tsv \\\n          -1 out.fq lane1_1.fq.gz,lane02_1.fq.gz  lane1_2.fq.gz,lane2_2.fq.gz\n\nOptions :\n -1       [fastq]   Read 1 output. Default is stdout.\n -2       [fastq]   Read 2 output.\n -config  [json]    Read structure configure file in JSON format. Required.\n -run     [string]  Run code, used for different library.\n -cbdis   [FILE]    Read count per cell barcode.\n -p                 Read 1 and read 2 interleaved in the input file.\n -q       [INT]     Drop reads if average sequencing quality below this value.\n -dropN             Drop reads if N base in sequence or barcode.\n -report  [csv]     Summary report.\n -t       [INT]     Threads. [4]\n-config requires a JSON file to tell software the locations of cell barcodes and/or UMIs. An example configured file can be found at demo/demo.json.\n\n{\n    \"cell barcode tag\":\"CB\",  \n    \"cell barcode\":[\n        {\n            \"location\":\"R1:1-16\" # the location is 1 based\n        }\n    ],\n    \"UMI tag\":\"UR\",\n    \"UMI\":{\n        \"location\":\"R1:17-28\",\n    },\n    \"read 1\":{\n        \"location\":\"R2:1-91\",\n    }\n}\n\nOption -report can specify a quality control report in CSV format. Here is the explanation of each term in this file.\n\n\n\n\n\n\n\n\nTerms\nDescription\n\n\n\n\nNumber of Fragments\nThe number of records in the FASTQ(s). For paired reads, each pair only count once.\n\n\nFragments pass QC\nReads or paired reads pass QC.\n\n\nFragments with Exactly Matched Barcodes\nCell barcode exactly matched with any barcode in the candidate list.\n\n\nFragments with Failed Barcodes\nNo cell barcode found in the candidate list with similar search.\n\n\nFragments Filtered on Low Quality\nMean sequence quality of the records smaller than threshold.\n\n\nFragments Filtered on Unknown Sample Barcodes\nSample barcodes not matched with any barcode in the candidate list.\n\n\nQ30 bases in Cell Barcode\nRatio of bases in cell barcode sequence with quality \\(&gt;=\\) 30.\n\n\nQ30 bases in Sample Barcode\nRatio of bases in sample barcode sequence with quality \\(&gt;=\\) 30.\n\n\nQ30 bases in UMI\nRatio of bases in UMI sequence with quality \\(&gt;=\\) 30.\n\n\nQ30 bases in Reads\nRatio of bases in read sequence with quality \\(&gt;=\\) 30.\n\n\n\n\nHere is an example to parse barcodes and reads with a predefined configure JSON file, the test files can be found at demo directory.\n$ PISA parse0 -config demo/demo.json -report demo/parse.csv demo/demo_1.fq.gz demo/demo_2.fq.gz &gt; demo/demo.fq"
  },
  {
    "objectID": "PISA.html#difference-in-alignment-annotation-between-pisa-and-cellranger",
    "href": "PISA.html#difference-in-alignment-annotation-between-pisa-and-cellranger",
    "title": "PISA User Guide",
    "section": "Difference in alignment annotation between PISA and CellRanger",
    "text": "Difference in alignment annotation between PISA and CellRanger\nIn most cases, PISA annotation produces results similar to CellRanger, but there are two key differences. In CellRanger, exonic reads are defined as those that overlap with an exon by at least 50% of the read length. In PISA, however, reads overlapping with an exon are classified into three distinct categories. Exonic reads are fully enclosed within an exon (E). If a read partially overlaps both an exon and an intron, it is classified as exonintron (C). Junction reads spanning more than one exon are classified as spliced reads (S). By default, only exonic (E) and spliced reads (S) are counted towards gene expression, but exonintronic (C) are skipped unless option -splice or -intron is set. Therefore, PISA anno is more stringent than CellRanger in gene annotation. However, for third-generation sequencing reads, small indels may be introduced during sequencing, causing imperfect alignment at splice sites or gene ends. In these cases, the -vague-edge option can be used to account for such mapping variances.\nThe second difference relates to UMI handling. In CellRanger, if a UMI maps to more than one gene, it is discarded. In contrast, PISA annotates all genes if the read is fully enclosed within the exons of these genes, and the UMI is counted for all of them. However, this type of reads can be skipped in PISA if the -one-hit option is set during the PISA count process.\nFor more information on CellRanger’s counting strategy, you can refer to the official documentation: Cell Ranger Algorithm Overview."
  },
  {
    "objectID": "PISA.html#changelog",
    "href": "PISA.html#changelog",
    "title": "PISA User Guide",
    "section": "Changelog",
    "text": "Changelog\n\n\nv1.6 2025/05/29\n\n\nFix a bug if gene_name or gene_id is empty in GTF, annotation may case segmental fault.\nPISA bin method is introduced.\n\n\n\n\nv1.5 2025/03/17\n\nCheck and label EXACT_MATCH for all cell barcode segments. Previous only check the first segment. Thanks to @lishuangshuang0616 report this bug.\n\n\n\nv1.4 2025/03/15\n\n\nUpdate -anno-tags instead of -anno-tag to allow specify more than one tag. Only count tag 1 if other tags exist in the alignment.\n\n\n\n\nv1.3 2024/10/10\n\n\nRemove -vcf-ss option for PISA anno. Enable strand sensitive mode in default for genetic variant annotation.\n\n\n\n\nv1.2 2024/9/7\n\n\nFix a bug of PISA corr. This bug was caused by the recent update to dict.c. ThePISA corr function was not updated accordingly. This issue will not influence the result.\n\n\n\n\nv1.1 2024/6/11\n\n\n-psi and -flatten added for PISA anno;\nAdd new tools gtf2bed and flatten.\n\n\n\n\nv1.0 2023/12/2\n\n\nEPT calling method added.\nmergebed and annobed for BED file added.\nNew parameters added to anno.\n\n\n\n\nv1.0a 2023/10/20\n\n\nMajor update.\nNew callept method introduced. Check EPT paper for details.\nNew mergebed and annobed methods added.\nNew -vcf-ss and -alt-ref now added to PISA anno\nPISA count can count bin and chromosome expression.\n\n\n\n\nv0.12 2022/06/18\n\n\nFix the number of records in MEX file.\n\n\n\n\nv0.12b 2022/04/26\n\n\nBugs fixed.\nChange compress level of BGZF from 6 to 2, speed up few tools.\nNow accept unorder GTFs\nNew tool gtfmt introduced to format a GTF file.\nAdd manual and FASTQ+ specification.\n\n\n\n\nv0.12a 2022/03/31\n\n\nAdd parse2.\n\n\n\n\nv0.11a 2022/03/13\n\n\nAdd counts2, count peaks X cells matrix from the fragment file.\n\n\n\n\nv0.10 2022/01/06\n\n\nUpdate bam2frag, export a fragment file compatible with 10X cellranger-ATAC.\n\n\n\n\nv0.10b 2021/12/09\n\n\nPISA count now has -velo option to export unspliced and spliced matrix together. For velocity analysis, remember to use -intron to annotate reads.\nPISA parse support multi-threads.\n\n\n\n\nv0.10a 2021/11/06\n\n\nPISA count support count spliced and unspliced reads.\nPISA count support count from multiple bam files.\n\n\n\n\nv0.9 2021/10/14\n\n\nRewrite rmdup. Not support paired reads for now.\n\n\n\n\nv0.8 2021/07/20\n\n\nReduce memory usage of count\nFix region query bug of anno -bed\nAdd anno -vcf method\n\n\n\n\nv0.7 2020/11/20\n\n\nIntroduce the PCR deduplicate method rmdup.\nMask read and qual field as * instead of sequence for secondary alignments in the BAM file.\n\n\n\n\nv0.6 2020/10/29\n\n\nPISA attrcnt, Skip secondary alignments before counting reads\nPISA anno fix segments fault bugs when loading malformed GTF\n\n\n\n\nv0.5 2020/08/27\n\n\nAdd PISA bam2frag function (experimental).\nPISA anno Skip secondary alignments when counting total reads.\n\n\n\n\nv0.4 2020/07/14\n\n\nPISA sam2bam add mapping quality adjustment method;\nRewrite UMI correction index structure to reduce memory use;\nFix bugs.\n\n\n\n\nv0.4alpha 2020/05/2\n\n\nPISA anno use UCSC bin scheme instead of linear search for reads query gene regions. Fix the bug of misannotated antisense reads.\nPISA count use MEX output instead of plain cell vs gene table.\n\n\n\n\nv0.3 2020/03/26\n\nFix bugs and improve preformance.\n\n\n\n0.0.0.9999 2019/05/19\n\nInit version."
  },
  {
    "objectID": "PISA.html#todo-list",
    "href": "PISA.html#todo-list",
    "title": "PISA User Guide",
    "section": "TODO list",
    "text": "TODO list\n\nImprove multi-threads performance.\nSupport Stereo-seq and Visium \nSpeed up PISA count and PISA corr.\nImplement parse strategy for cell hash and CITEseq (frozen).\nAssemble reads original from one molecule;\nImplement new designed and more user-friendly parse;\nSupport loom output (frozen);\nExport unspliced matrix for velocity;\nUpgrade PISA parse for faster process fastqs."
  },
  {
    "objectID": "PISA.html#reporting-issues",
    "href": "PISA.html#reporting-issues",
    "title": "PISA User Guide",
    "section": "Reporting Issues",
    "text": "Reporting Issues\nIf you have any suggestion or report issues, please using Github issues page https://github.com/shiquan/PISA/issues."
  },
  {
    "objectID": "PISA.html#citation",
    "href": "PISA.html#citation",
    "title": "PISA User Guide",
    "section": "Citation",
    "text": "Citation\nShi Q, Liu S, Kristiansen K, Liu L. The FASTQ+ format and PISA. Bioinformatics. 2022 Sep 30;38(19):4639-4642. doi: 10.1093/bioinformatics/btac562. PMID: 35993907."
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "",
    "section": "",
    "text": "This website outlines the key tools and software packages developed from my research:\n\n\nFASTQ+: This format enhances the standard FASTQ file by integrating barcode information directly into the read name. This modification facilitates the harmonization of single-cell sequencing data across various platforms. FASTQ+ can be generated with PISA.\nPISA: A suite of programs specifically designed for preprocessing data from single-cell sequencing and spatial transcriptomics. It efficiently processes FASTQ+, BAM, and BED files, and generates various feature counts and annotations.\nYano: An R package that employs the spatial dissimilarity test method as its core algorithm. Yano is tailored for exploring various biological events in single-cell and spatial transcriptomics data, including alternative splicing, allele-specific gene expression, somatic variants and more, providing comprehensive insights into cellular dynamics. \n\nWorkflows and Short Cases for scRNA-seq and Spatial Transcriptome\n\nFrom raw reads to gene counts (PISA)\nAnnotate various features for alignment (PISA)\nAlternative splicing analysis for scRNA-seq (Yano)\nAllele-specific gene expression analysis for scRNA-seq (Yano)\nAnnotating and prioritizing genetic variants for scRNA-seq (Yano)\nPerform alternative splicing analysis for multiple Visium samples (Yano)\nSelect cells from reduction maps and spatial locations (Yano)\nPerform alternative splicing analysis for cell trajectory and user-defined embeddings (Yano)\n\n\n\n\n Back to top"
  },
  {
    "objectID": "dST_selector.html",
    "href": "dST_selector.html",
    "title": "Select cells from reduction maps and spatial locations",
    "section": "",
    "text": "This vignette demonstrates how to use Yano build functions to interactively select or pick cells/spots from a plot using your mouse and keyboard. While tools like CellxGene are widely used for this purpose, to the best of our knowledge, an efficient solution for performing this task within the R environment is still lacking.",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Select cells from reduction maps"
    ]
  },
  {
    "objectID": "dST_selector.html#prepare-the-data.",
    "href": "dST_selector.html#prepare-the-data.",
    "title": "Select cells from reduction maps and spatial locations",
    "section": "Prepare the data.",
    "text": "Prepare the data.\nWe use demo data from SeuratData for simplity.\n\nrequire(Yano)\nrequire(SeuratData)\n\n#InstallData(\"stxBrain\")\n\nbrain &lt;- LoadData(\"stxBrain\", type = \"anterior1\")\nbrain &lt;- SCTransform(brain, assay = \"Spatial\", verbose = FALSE)\nbrain &lt;- RunPCA(brain, assay = \"SCT\", verbose = FALSE)\nbrain &lt;- FindNeighbors(brain, reduction = \"pca\", dims = 1:30)\nbrain &lt;- FindClusters(brain, verbose = FALSE)\nbrain &lt;- RunUMAP(brain, reduction = \"pca\", dims = 1:30)\n\nSpatialPlot(brain)",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Select cells from reduction maps"
    ]
  },
  {
    "objectID": "dST_selector.html#select-spots-from-spatial-plot",
    "href": "dST_selector.html#select-spots-from-spatial-plot",
    "title": "Select cells from reduction maps and spatial locations",
    "section": "Select spots from spatial plot",
    "text": "Select spots from spatial plot\nsel.1 &lt;- SpatialSelector(brain)\nPress ESC on your keyboard to exist the selection!\n\nNow the selected cells will be exported to sel.1. If you want return a object, try to set return.object=TRUE in the function.",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Select cells from reduction maps"
    ]
  },
  {
    "objectID": "dST_selector.html#select-cells-from-dimension-reduction-plot",
    "href": "dST_selector.html#select-cells-from-dimension-reduction-plot",
    "title": "Select cells from reduction maps and spatial locations",
    "section": "Select cells from dimension reduction plot",
    "text": "Select cells from dimension reduction plot\nWe can also select cells from dimension reduction plot.\n\nDimPlot(brain)\n\n\n\n\n\n\n\n\nsel.1 &lt;- DimSelector(brain)\nPress ESC on your keyboard to exist the selection!",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Select cells from reduction maps"
    ]
  },
  {
    "objectID": "dST_selector.html#select-cells-based-on-a-feature-expression",
    "href": "dST_selector.html#select-cells-based-on-a-feature-expression",
    "title": "Select cells from reduction maps and spatial locations",
    "section": "Select cells based on a feature expression",
    "text": "Select cells based on a feature expression\n\nFeaturePlot(brain, features = c('Ttr'), order=TRUE)\n\nWarning: The `slot` argument of `FetchData()` is deprecated as of SeuratObject 5.0.0.\nℹ Please use the `layer` argument instead.\nℹ The deprecated feature was likely used in the Seurat package.\n  Please report the issue at &lt;https://github.com/satijalab/seurat/issues&gt;.\n\n\n\n\n\n\n\n\n\nFeatureSelector(brain, feature = c('Ttr'), order=TRUE)\nPlease note in FeatureSelector() only one feature is support at each selection. Therefore, I designed the parameter feature instead of orignal features here.",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Select cells from reduction maps"
    ]
  },
  {
    "objectID": "dST_selector.html#select-cells-from-image-based-spatial-data",
    "href": "dST_selector.html#select-cells-from-image-based-spatial-data",
    "title": "Select cells from reduction maps and spatial locations",
    "section": "Select cells from Image-based spatial data",
    "text": "Select cells from Image-based spatial data\nHere we will use 10x Genomics Xenium data, generated from Seurat’s tutorial.\n\nxenium.obj &lt;- readRDS(\"xenium.rds\")\nImageDimPlot(xenium.obj, border.color = \"white\", border.size = 0.1, cols = \"polychrome\")\n\nWarning: No FOV associated with assay 'SCT', using global default FOV\n\n\n\n\n\n\n\n\n\nImageDimSelector(xenium.obj, border.color = \"white\", border.size = 0.1)",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Select cells from reduction maps"
    ]
  },
  {
    "objectID": "dST_selector.html#generate-2d-concave-hull-of-selected-region",
    "href": "dST_selector.html#generate-2d-concave-hull-of-selected-region",
    "title": "Select cells from reduction maps and spatial locations",
    "section": "Generate 2D concave hull of selected region",
    "text": "Generate 2D concave hull of selected region\nIn spatial transcriptomics, it is sometimes necessary to manually define capsule or membrane regions, as these areas are often thin, mixed with neighboring cells, and difficult to identify accurately. Manually specifying these regions can be beneficial for downstream analyses, where precise spatial organization of cells is critical for understanding tissue architecture and functional gradients.\nsel &lt;- SpatialConcaveHull(brain)",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Select cells from reduction maps"
    ]
  },
  {
    "objectID": "dST_selector.html#questions",
    "href": "dST_selector.html#questions",
    "title": "Select cells from reduction maps and spatial locations",
    "section": "Questions?",
    "text": "Questions?\nIf you have any questions regarding this vignette, the usage of Yano or suggestions, please feel free to report them through the discussion forum.\n\nsessionInfo()\n\nR version 4.5.0 (2025-04-11)\nPlatform: aarch64-apple-darwin24.4.0\nRunning under: macOS Sequoia 15.5\n\nMatrix products: default\nBLAS:   /opt/homebrew/Cellar/openblas/0.3.29/lib/libopenblasp-r0.3.29.dylib \nLAPACK: /opt/homebrew/Cellar/r/4.5.0/lib/R/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Asia/Shanghai\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] future_1.49.0             stxBrain.SeuratData_0.1.2\n[3] SeuratData_0.2.2.9002     dplyr_1.1.4              \n[5] Seurat_5.3.0              SeuratObject_5.1.0       \n[7] sp_2.2-0                  ggplot2_3.5.2            \n[9] Yano_1.1                 \n\nloaded via a namespace (and not attached):\n  [1] deldir_2.0-4           pbapply_1.7-2          gridExtra_2.3         \n  [4] rlang_1.1.6            magrittr_2.0.3         RcppAnnoy_0.0.22      \n  [7] spatstat.geom_3.3-6    matrixStats_1.5.0      ggridges_0.5.6        \n [10] compiler_4.5.0         png_0.1-8              vctrs_0.6.5           \n [13] reshape2_1.4.4         stringr_1.5.1          crayon_1.5.3          \n [16] pkgconfig_2.0.3        fastmap_1.2.0          labeling_0.4.3        \n [19] promises_1.3.2         rmarkdown_2.29         purrr_1.0.4           \n [22] xfun_0.52              jsonlite_2.0.0         goftest_1.2-3         \n [25] later_1.4.2            spatstat.utils_3.1-4   irlba_2.3.5.1         \n [28] parallel_4.5.0         cluster_2.1.8.1        R6_2.6.1              \n [31] ica_1.0-3              stringi_1.8.7          RColorBrewer_1.1-3    \n [34] spatstat.data_3.1-6    reticulate_1.42.0      spatstat.univar_3.1-3 \n [37] parallelly_1.44.0      lmtest_0.9-40          scattermore_1.2       \n [40] Rcpp_1.0.14            knitr_1.50             tensor_1.5            \n [43] future.apply_1.11.3    zoo_1.8-14             R.utils_2.13.0        \n [46] sctransform_0.4.2      httpuv_1.6.16          Matrix_1.7-3          \n [49] splines_4.5.0          igraph_2.1.4           tidyselect_1.2.1      \n [52] viridis_0.6.5          abind_1.4-8            yaml_2.3.10           \n [55] spatstat.random_3.3-3  codetools_0.2-20       miniUI_0.1.2          \n [58] spatstat.explore_3.4-2 listenv_0.9.1          lattice_0.22-6        \n [61] tibble_3.2.1           plyr_1.8.9             withr_3.0.2           \n [64] shiny_1.10.0           ROCR_1.0-11            evaluate_1.0.3        \n [67] Rtsne_0.17             fastDummies_1.7.5      survival_3.8-3        \n [70] polyclip_1.10-7        fitdistrplus_1.2-2     pillar_1.10.2         \n [73] KernSmooth_2.23-26     plotly_4.10.4          generics_0.1.4        \n [76] RcppHNSW_0.6.0         scales_1.4.0           gtools_3.9.5          \n [79] globals_0.18.0         xtable_1.8-4           glue_1.8.0            \n [82] lazyeval_0.2.2         tools_4.5.0            data.table_1.17.2     \n [85] RSpectra_0.16-2        RANN_2.6.2             dotCall64_1.2         \n [88] cowplot_1.1.3          grid_4.5.0             tidyr_1.3.1           \n [91] nlme_3.1-168           patchwork_1.3.0        cli_3.6.5             \n [94] rappdirs_0.3.3         spatstat.sparse_3.1-0  spam_2.11-1           \n [97] viridisLite_0.4.2      uwot_0.2.3             gtable_0.3.6          \n[100] R.methodsS3_1.8.2      digest_0.6.37          progressr_0.15.1      \n[103] ggrepel_0.9.6          htmlwidgets_1.6.4      farver_2.1.2          \n[106] htmltools_0.5.8.1      R.oo_1.27.1            lifecycle_1.0.4       \n[109] httr_1.4.7             mime_0.13              MASS_7.3-65",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Select cells from reduction maps"
    ]
  },
  {
    "objectID": "anno.html",
    "href": "anno.html",
    "title": "Count gene, exon, junction and SNV expression from a BAM file",
    "section": "",
    "text": "The following vignette demonstrates how to generate various feature counts from an alignment BAM file. Here we use a 10X demo data of human glioblastoma cells. The description of data can be found at https://www.10xgenomics.com/datasets/human-glioblastoma-multiforme-3-v-3-whole-transcriptome-analysis-3-standard-4-0-0.",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Annotate various features"
    ]
  },
  {
    "objectID": "anno.html#prepare-the-raw-data-and-reference",
    "href": "anno.html#prepare-the-raw-data-and-reference",
    "title": "Count gene, exon, junction and SNV expression from a BAM file",
    "section": "Prepare the raw data and reference",
    "text": "Prepare the raw data and reference\n\nDownload alignment data (BAM). (~14G).\n\n\nThe following file is used for variant calling and allele specific gene expression. It can be skipped for alternative splicing analysis.\n\nBAM Index File (for variant calling): Download BAM index\nHuman Reference Databases and Gene Annotation Files:\n\nGRCh38.p13 genome\nGencode v44 annotation",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Annotate various features"
    ]
  },
  {
    "objectID": "anno.html#programs-we-will-use",
    "href": "anno.html#programs-we-will-use",
    "title": "Count gene, exon, junction and SNV expression from a BAM file",
    "section": "Programs we will use",
    "text": "Programs we will use\n\nPISA (&gt;=v1.3) (https://github.com/shiquan/PISA)\nbcftools (https://github.com/samtools/bcftools)\nsamtools (https://github.com/samtools/samtools)",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Annotate various features"
    ]
  },
  {
    "objectID": "anno.html#step-by-step-tutorial",
    "href": "anno.html#step-by-step-tutorial",
    "title": "Count gene, exon, junction and SNV expression from a BAM file",
    "section": "Step by step tutorial",
    "text": "Step by step tutorial\n\n1. Genetic variants calling\n# Unpack the FASTA file\ngzip -d GRCh38.p13.genome.fa.gz\n\n# Build the FASTA index\nsamtools faidx GRCh38.p13.genome.fa\n\n# Perform variant calling\nbcftools mpileup -Ou -f GRCh38.p13.genome.fa ./Parent_SC3v3_Human_Glioblastoma_possorted_genome_bam.bam  | bcftools call -vmO z -o var.vcf.gz\nNotes:\n\nWhile several new methods for genetic variant calling have been developed, the basic principle remains the same: identifying differences between sequence reads and the reference genome. For simplicity, we are using the ‘traditional’ bcftools approach.\nThere is no need to filter raw genetic variants by sequencing depth or strand bias tests. Since this is strand-specific RNA sequencing data, strand bias is expected in many cases. Instead, the feature expression matrix can be filtered by cells during downstream analysis.\n\n\n\n2. Annotate various features\nThe following command generates gene, transcript, exon, exon skipped reads, junction and genetic variant for each alignment:\nPISA anno -gtf gencode.v44.annotation.gtf.gz -exon -psi -vcf var.vcf.gz -ref-alt -o anno.bam Parent_SC3v3_Human_Glioblastoma_possorted_genome_bam.bam \nThe above command will annotate genes, exons, junctions, and genetic variants all at once. However, it is also possible to annotate different features sequentially. For example, the command below produces the same results as the previous one, but allows for stepwise annotation.\nPISA anno -gtf gencode.v44.annotation.gtf.gz -exon -psi -o anno1.bam Parent_SC3v3_Human_Glioblastoma_possorted_genome_bam.bam \nPISA anno -vcf var.vcf.gz -ref-alt -o anno2.bam anno1.bam\nNotes:\n\n-exon: Generates exon and junction names.\n-psi: Generate labels for exon skipped reads, named after the skipped exons.\n-ref-alt: For genetic variants, both reference allele and alternative allele will be annotated. If not set, reference allele will be ignored. This option is important for alelle-specific gene expression.\n\nComparing raw and annotated records.\n\n# A original record\nsamtools view Parent_SC3v3_Human_Glioblastoma_possorted_genome_bam.bam  |head -n 3000|grep 'A00836:286:HMTMVDMXX:2:2354:8422:1391'\n\nA00836:286:HMTMVDMXX:2:2354:8422:1391   16  chr1    89995   255 56M236N35M  *   0   0   TTGGTCTCTCTTGCTGCCCTGGAGACCAGCTGCCCCACGAAGGAACCAGAGCCAACCTGCTGCTTCCTGGAGGAAGACAGTCCCTCTGTCC FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF,FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF:FFFF NH:i:6  HI:i:3  AS:i:89 nM:i:1  RG:Z:Parent_SC3v3_Human_Glioblastoma:0:1:HMTMVDMXX:2    TX:Z:ENST00000495576,+784,91M   GX:Z:ENSG00000239945    GN:Z:AL627309.3 fx:Z:ENSG00000239945    RE:A:E  MM:i:1  xf:i:25 CR:Z:AGATGAATCTACGCGG   CY:Z:FFFFFFFFFF,FFFFF   CB:Z:AGATGAATCTACGCGG-1 UR:Z:TTTCATGCCTCA   UY:Z:FFFFFFFFFFFF   UB:Z:TTTCATGCCTCA\n\n\n\n# the same record after annotation\nsamtools view anno.bam | head -n 3000|grep 'A00836:286:HMTMVDMXX:2:2354:8422:1391'\n\nA00836:286:HMTMVDMXX:2:2354:8422:1391   16  chr1    89995   255 56M236N35M  *   0   0   TTGGTCTCTCTTGCTGCCCTGGAGACCAGCTGCCCCACGAAGGAACCAGAGCCAACCTGCTGCTTCCTGGAGGAAGACAGTCCCTCTGTCC FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF,FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF:FFFF NH:i:6  HI:i:3  AS:i:89 nM:i:1  RG:Z:Parent_SC3v3_Human_Glioblastoma:0:1:HMTMVDMXX:2    fx:Z:ENSG00000239945    MM:i:1  xf:i:25 CR:Z:AGATGAATCTACGCGG   CY:Z:FFFFFFFFFF,FFFFF   CB:Z:AGATGAATCTACGCGG-1 UR:Z:TTTCATGCCTCA   UY:Z:FFFFFFFFFFFF   UB:Z:TTTCATGCCTCA   RE:A:S  GX:Z:ENSG00000239945.1  GN:Z:ENSG00000239945    TX:Z:ENST00000495576.1  EX:Z:chr1:89551-90050/-/ENSG00000239945,chr1:90287-91105/-/ENSG00000239945  JC:Z:chr1:90050-90287/-/ENSG00000239945\n\n\nNotes:\n\nPISA anno generates GN, TX, RE, and GX tags when the -gtf option is set. Original tag values are replaced, and PISA uses a slightly different annotation strategy than CellRanger, see details here. In the example above, the RE tag has been changed from E (exon) to S (spliced).\nWhen the -exon option is used, EX and JC tags are annotated only if the read has a GN tag.\nWhen the -psi option is used, ER tag is annotated, the label for ER is the exon name which indicate the read skip this exon.\n\n\n\n3. Generate Cell X feature expression matrix\nmkdir exp \nmkdir exon\nmkdir exclude\nmkdir junction\nmkdir var\n\nPISA count -tags CB -anno-tag GN -umi UB -outdir exp anno.bam\nPISA count -tags CB -anno-tag EX -umi UB -outdir exon anno.bam\nPISA count -tags CB -anno-tag ER -umi UB -outdir exclude anno.bam\nPISA count -tags CB -anno-tag JC -umi UB -outdir junction anno.bam\nPISA count -tags CB -anno-tag VR -umi UB -outdir var anno.bam\nNotes: These commands will generate raw counts for all droplets. Although the -list parameter can be used to export only selected cells with PISA anno, cell selection may sometimes lack robustness. Therefore, it is safer to store the raw matrix file for long-term storage.\n\nls exp/\n\nbarcodes.tsv.gz\nfeatures.tsv.gz\nmatrix.mtx.gz\n\n\n\nzless exp/barcodes.tsv.gz|head\n\nTTCCACGGTTCGGCTG-1\nGTGCTTCGTAATGTGA-1\nCACAGGCAGCTGGTGA-1\nTGGCGTGGTGCAACGA-1\nATCTCTAGTCCATAGT-1\nAGCGCCACAAGCGATG-1\nCGAGTTAGTGTCGATT-1\nGTCAAGTCAGGCTCTG-1\nGGGTAGATCCCGTTGT-1\nGGGACAAAGAGGTATT-1\n\n\n\nzless exp/features.tsv.gz|head\n\nMIR1302-2HG\nENSG00000238009\nENSG00000239945\nENSG00000268903\nENSG00000241860\nENSG00000236601\nENSG00000230021\nMTND1P23\nWASH9P\nENSG00000228463\n\n\n\nzless exp/matrix.mtx.gz|head\n\n%%MatrixMarket matrix coordinate integer general\n% Generated by PISA v1.3\n37716   971962  23795359\n1   1   1\n1   2   1\n2   3   1\n2   4   1\n2   5   1\n2   6   1\n2   7   1\n\n\n\nzless exon/features.tsv.gz|head\n\nchr1:29554-30039/+/MIR1302-2HG\nchr1:30564-30667/+/MIR1302-2HG\nchr1:89295-91629/-/ENSG00000238009\nchr1:89551-90050/-/ENSG00000239945\nchr1:90287-91105/-/ENSG00000239945\nchr1:135141-135895/-/ENSG00000268903\nchr1:141474-143011/-/ENSG00000241860\nchr1:146386-149707/-/ENSG00000241860\nchr1:142808-143011/-/ENSG00000241860\nchr1:146386-146509/-/ENSG00000241860\n\n\n\nzless junction/features.tsv.gz|head\n\nchr1:30039-30564/+/MIR1302-2HG\nchr1:90050-90287/-/ENSG00000239945\nchr1:143011-146386/-/ENSG00000241860\nchr1:165942-168100/-/ENSG00000241860\nchr1:168165-168610/-/ENSG00000241860\nchr1:805891-808574/-/ENSG00000290784\nchr1:805891-808574/-/ENSG00000230092\nchr1:827775-829003/+/LINC01128\nchr1:829104-847654/+/LINC01128\nchr1:868530-868627/-/FAM41C\n\n\nThe format for exon and junction names is “chr:pos reference_allele&gt;alternative_allele/strand” for alternative alleles, or “chr:pos=/strand” for reference allele.\n\n# the format of expressed genetic variant is \nzless var/features.tsv.gz|head\n\nchr1:631862G&gt;A/+\nchr1:632403T=/+\nchr1:632403T&gt;C/+\nchr1:632427T&gt;C/+\nchr1:633192G&gt;A/+\nchr1:633192G=/+\nchr1:633236A&gt;G/+\nchr1:633300A=/+\nchr1:633372T&gt;C/+\nchr1:634244T&gt;C/+\n\n\nNotes: By default, the parameters for PISA anno are strand-sensitive. For non-strand-sensitive libraries, such as Smartseq2, the strand should be ignored by using the -is option.\n\n\nQuestions?\nIf you have any questions regarding this workflows, please feel free to report them through the github issues.\nIf you have any ideas or suggestions regarding PISA annotation, please refer to the Yano discussion forum. Since PISA is commonly used alongside Yano, it may not be necessary to host separate forums for each.",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "Annotate various features"
    ]
  },
  {
    "objectID": "fastq.html",
    "href": "fastq.html",
    "title": "The FASTQ+ Format Specification",
    "section": "",
    "text": "The FASTQ+ format is a variant of the FASTQ. It is designed to store more features or annotations for FASTQ records but not change the own property of the FASTQ structure. Each FASTQ+ record consists of four lines.\nThe optional fields of FASTQ+ is consist of numbers of tags in TAG:TYPE:VALUE format. The tag format is inherited from the SAM tag format (https://samtools.github.io/hts-specs/SAMv1.pdf). The TAG is a two-character string that matches /[A-Za-z][A-Za-z0-9]/. TYPE is a single case-sensitive letter, which defines the format of VALUE. Tags in optional fields are separated by three ’’ characters. No space allowed in the sequence identifier and optional fields. The total length of the first line should not exceed 254 characters."
  },
  {
    "objectID": "fastq.html#an-example",
    "href": "fastq.html#an-example",
    "title": "The FASTQ+ Format Specification",
    "section": "An example",
    "text": "An example\nIn the example below, SEQ_ID is the sequence identifier that users can set or generate by software. CB is the recommended tag name for the corrected cell barcode, GN is the recommended tag for gene name, and UB is the recommended tag for UMI.\n\n@SEQ_ID|||CB:Z:ACGT|||GN:Z:BRCA1|||UB:Z:AACG\nGATTTGGGGTTCAAAGCAGTATCGA\n+\n1***-+*''))**5&gt;&gt;CCCCCCC65"
  },
  {
    "objectID": "fastq.html#optional-tag-fields",
    "href": "fastq.html#optional-tag-fields",
    "title": "The FASTQ+ Format Specification",
    "section": "Optional tag fields",
    "text": "Optional tag fields\nAll optional tags for FASTQ+ follow the SAM tag format but add two more restrictions.\n\nSAM tags allow space in type Z, but not allowed in FASTQ+ tags.\nThe length of SAM tags is not limited, but FASTQ+ read identifier and tags are specified to be no longer than 254 characters.\n\n\n\n\n\n\n\n\n\n\nType\nRegexp matching VALUE\nDescription\n\n\n\n\nA\n[!-]\nPrintable character\n\n\ni\n[-+]?[0-9]+\nSigned integer\n\n\nf\n[-+]?[0-9]*.?[0-9]+([eE][-+]?[0-9]+)?\nSigned single-precision floating number\n\n\nZ\n[!-]*\nPrintable string.\n\n\nH\n([0-9A-F][0-9A-F])*\nByte array in the Hex format\n\n\nB\n[cCsSiIf](,[-+]?[0-9]*.?[0-9]+([eE][-+]?[0-9]+)?)*\nInteger or numberic array"
  },
  {
    "objectID": "fastq.html#recommended-tag-names-and-types-for-single-cell-experiments",
    "href": "fastq.html#recommended-tag-names-and-types-for-single-cell-experiments",
    "title": "The FASTQ+ Format Specification",
    "section": "Recommended tag names and types for single cell experiments",
    "text": "Recommended tag names and types for single cell experiments\nThe following tag names and types have been widely used in single-cell experiments. Although it is not required but highly recommended following the exact definition.\n\n\n\n\n\n\n\n\n\nTag name\nType\nDescription\n\n\n\n\nCR\nZ\nRaw cell barcode.\n\n\nCB\nZ\nCell barcode that is confirmed against a list of known-good barcode sequences.\n\n\nUR\nZ\nRaw molecular barcode. Usually be unique molecule indentifer (UMI).\n\n\nUB\nZ\nMolecular barcode that is corrected among other molecule barcodes.\n\n\nGN\nZ\nGene name.\n\n\nTX\nZ\nTranscript id.\n\n\nGX\nZ\nGene id."
  },
  {
    "objectID": "fastq.html#read-block",
    "href": "fastq.html#read-block",
    "title": "The FASTQ+ Format Specification",
    "section": "Read block",
    "text": "Read block\nA combination of tags can define the FASTQ+ block. Reads with the same tags can be selected and manipulated in a group. For example, SEQ1, SEQ2, and SEQ3 share the same cell barcode, and SEQ2 and SEQ3 share the same gene name but not for SEQ1. Using CB to define the block, all these three reads are from the same block. But if using CB and GN to determine the block, SEQ2 and SEQ3 are from the same block, different from SEQ1. Sorting the FASTQ+ file by tags can facilitate downstream analysis, i.e., assembly, for each block to be processed sequentially.\n\n@SEQ1|||CB:Z:ACGT|||GN:Z:BRCA1\nGATTTGGGGTTCAAAGCAGTATCGA\n+\n1***-+*''))**5&gt;&gt;CCCCCCC65\n@SEQ2|||CB:Z:ACGT|||GN:Z:SAA1\nACACTCGAAGATACAGAAATGAGTA\n+\nEEEEEE6/E/EEEAEEEE/E/EEE&lt;\n@SEQ3|||CB:Z:ACGT|||GN:Z:SAA1\nTATCGACAGGAAGAAGGAGGGAGGG\n+\nAE/EE&lt;/AEEEAEEEEE//AA/EEE"
  },
  {
    "objectID": "fastq.html#v1.0-apr-2022",
    "href": "fastq.html#v1.0-apr-2022",
    "title": "The FASTQ+ Format Specification",
    "section": "v1.0 : Apr 2022",
    "text": "v1.0 : Apr 2022\nInitial edition."
  },
  {
    "objectID": "workflow1.html",
    "href": "workflow1.html",
    "title": "From fastq to feature counts with PISA",
    "section": "",
    "text": "The following vignette demonstrates how to parse raw FASTQ files to FASTQ+ format and perform alignment, feature annotation, and counting using PISA. For simplification, we use minimap2 to align reads in this example, but other tools such as STAR can also be used.",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "From FASTQ to counts"
    ]
  },
  {
    "objectID": "workflow1.html#prepare-the-raw-data-and-reference",
    "href": "workflow1.html#prepare-the-raw-data-and-reference",
    "title": "From fastq to feature counts with PISA",
    "section": "Prepare the raw data and reference",
    "text": "Prepare the raw data and reference\n\nDownload raw data: http://cf.10xgenomics.com/samples/cell-exp/3.0.0/pbmc_1k_v3/pbmc_1k_v3_fastqs.tar (5.2G)\nDownload the human reference databases and gene annotation files:\n\nhttps://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_32/GRCh38.p13.genome.fa.gz\nhttps://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_32/gencode.v32.annotation.gtf.gz",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "From FASTQ to counts"
    ]
  },
  {
    "objectID": "workflow1.html#the-third-party-programs-we-will-use",
    "href": "workflow1.html#the-third-party-programs-we-will-use",
    "title": "From fastq to feature counts with PISA",
    "section": "The third-party programs we will use",
    "text": "The third-party programs we will use\n\nminimap2 (https://github.com/lh3/minimap2)\nsamtools (https://github.com/samtools/samtools)",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "From FASTQ to counts"
    ]
  },
  {
    "objectID": "workflow1.html#step-by-step-tutorial",
    "href": "workflow1.html#step-by-step-tutorial",
    "title": "From fastq to feature counts with PISA",
    "section": "Step by step tutorial",
    "text": "Step by step tutorial\n\n1. Parse cell barcode and UMI\n# Unpack the raw fastq\ntar xvf pbmc_1k_v3_fastqs.tar \ngzip -d GRCh38.p13.genome.fa.gz\n\n# Convert raw fastq to fastq+\nPISA parse -rule 'CB,R1:1-16;UR,R1:17-28;R1,R2' pbmc_1k_v3_fastqs/pbmc_1k_v3_S1_L001_R1_001.fastq.gz,pbmc_1k_v3_fastqs/pbmc_1k_v3_S1_L002_R1_001.fastq.gz pbmc_1k_v3_fastqs/pbmc_1k_v3_S1_L001_R2_001.fastq.gz,pbmc_1k_v3_fastqs/pbmc_1k_v3_S1_L002_R2_001.fastq.gz -nw -report fastq_qc.csv -1 reads.fq \n\n# Check the fastq+ records\nhead reads.fq\n\n@A00228:279:HFWFVDMXX:1:1101:8486:1000|||CB:Z:NGTGATTAGCTGTACT|||UR:Z:CGTATGTAAGGT\nNACAAAGTCCCCCCCATAATACAGGGGGAGCCACTTGGGCAGGAGGCAGGGAGGGGTCCATTCCCCCTGGTGGGGCTGGTGGGGAGCTGTA\n+\n#FFFFFFFFFFFFFFF:FFFFFFF:FFFFFFFFFFFFFFFFFFFFFFFFFF:FFFFFFFFFFFFFFFF:FFFFFFFFFFFFFFFFFFFFFF\n@A00228:279:HFWFVDMXX:1:1101:10782:1000|||CB:Z:NTCATGAAGTTTGGCT|||UR:Z:AGTTATGTTCAT\nNTTGCAGCTGAACTGGTAAACTTGTCCCTAAAGAGACATAAGAATGGTCAACTGGAATGTGGATTCATCTGTAACATTACTCAGTGGGCCT\n+\n#FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF\n@A00228:279:HFWFVDMXX:1:1101:12626:1000|||CB:Z:NACCAAAAGGACATCG|||UR:Z:CGGTAGAGGCTT\nGCTCCGTAGCCCTGACTGCCTTGGTGACTGTATCCTCAGAAGAATTTGAAGACAAGTGGTTCAGAAAGATCAAAGACCATTTCTGTCCATT\n\n\n\n# Check the report\ncat fastq_qc.csv\n\nNumber of Fragments,66601887\nFragments pass QC,66601887\nFragments with Exactly Matched Barcodes,0\nFragments with Failed Barcodes,0\n\n\n\n\n2. Align reads with minimap2\nTo get identical results with 10X’s Cell Ranger, you need use 10X’s gtf to index genome and annotate BAM as they modified it from original ENSEMBL gtf.\nminimap2 -t 8 -ax splice GRCh38.p13.genome.fa reads.fq &gt; aln.sam\nNotice : Please do NOT use samtools view to convert the SAM to BAM. Because the barcode information still store in the read name. Using PISA sam2bam instead.\nFASTQ+ aligned SAM records can be look like this.\n\nsamtools view aln.sam|head -n 1\n\nA00228:279:HFWFVDMXX:1:1101:8486:1000|||CB:Z:NGTGATTAGCTGTACT|||UR:Z:CGTATGTAAGGT   0   chr19   12748180    60  1S90M   *   0   0   NACAAAGTCCCCCCCATAATACAGGGGGAGCCACTTGGGCAGGAGGCAGGGAGGGGTCCATTCCCCCTGGTGGGGCTGGTGGGGAGCTGTA #FFFFFFFFFFFFFFF:FFFFFFF:FFFFFFFFFFFFFFFFFFFFFFFFFF:FFFFFFFFFFFFFFFF:FFFFFFFFFFFFFFFFFFFFFF NM:i:0  ms:i:90 AS:i:90 nn:i:0  tp:A:P  cm:i:25 s1:i:85 s2:i:0  de:f:0  rl:i:0\n\n\n\n\n3. Convert SAM to BAM\nThis step will convert the SAM to BAM, while generating the summary of alignments and parse the tags from the read id to SAM optional field. If -adjust-mapq and -gtf parameters set, mapping quality of multi-reads (reads mapped to one gene region and more than one integenic region) will be adjusted.\nPISA sam2bam -report alignment_report.csv -@ 5 -adjust-mapq -gtf gencode.v32.annotation.gtf.gz -o aln.bam aln.sam\nConverted records can be look like this.\n\nsamtools view aln.bam|head -n 1\n\nA00228:279:HFWFVDMXX:1:1101:8486:1000|||CB:Z:NGTGATTAGCTGTACT|||UR:Z:CGTATGTAAGGT   0   chr19   12748180    60  1S90M   *   0   0   NACAAAGTCCCCCCCATAATACAGGGGGAGCCACTTGGGCAGGAGGCAGGGAGGGGTCCATTCCCCCTGGTGGGGCTGGTGGGGAGCTGTA #FFFFFFFFFFFFFFF:FFFFFFF:FFFFFFFFFFFFFFFFFFFFFFFFFF:FFFFFFFFFFFFFFFF:FFFFFFFFFFFFFFFFFFFFFF NM:i:0  ms:i:90 AS:i:90 nn:i:0  tp:A:P  cm:i:25 s1:i:85 s2:i:0  de:f:0  rl:i:0\n\n\nAnd the summary.\n\ncat alignment_report.csv\n\nRaw reads,66601887\nMapped reads,52693779 (79.12%)\nPlus strand,29523622\nMinus strand,23170157\nMitochondria ratio,7.66%\nMapping quality corrected reads,889117\n\n\n\n\n4. Gene annotations\nPISA anno -gtf gencode.v32.annotation.gtf.gz -o anno.bam aln.bam -t 5 -report anno.csv\n\ncat anno.csv\n\nReads Mapped to Genome (Map Quality &gt;= 0),79.1%\nReads Mapped to Exonic Regions,61.9%\nReads Mapped to Intronic Regions,24.2%\nReads Mapped to both Exonic and Intronic Regions,0.0%\nReads Mapped Antisense to Exon,1.0%\nReads Mapped Antisense to Intron,6.3%\nReads Mapped to Intergenic Regions,5.6%\nReads Mapped to Gene but Failed to Interpret Type,0.0%\nReads Mapped to Overlapped genes,1.7%\n\n\n\n\n5. Sort BAM by genomics coordinate (Optional)\nA sorted and indexed BAM file can be useful for many secondary analyses, but it is not mandatory if you only need the gene expression count matrix. The annotation and expression count steps do not require a sorted BAM. However, if two similar UMIs have the same supporting reads, the first one will always be selected, and the second will be corrected during the corr step. If the records are not sorted, this may lead to non-robust results.\n## sambamba can also be used to sort bam for better performance. For simplication, we use samtools here.\nsamtools sort -@ 5 -o sorted.bam anno.bam\n\n\n6. UMIs correction for one cell in one gene\nPISA corr -tag UR -new-tag UB -tags-block CB,GN -cr -o final.bam -@ 5 sorted.bam\n\n\n7. Generate Cell X Gene expression matrix\nmkdir raw_gene_expression\nPISA count -tags CB -anno-tag GN -umi UB -outdir raw_gene_expression -@ 5 final.bam\nPISA count will write the feature counts in MEX format.\n\nls raw_gene_expression\n\nbarcodes.tsv.gz\nfeatures.tsv.gz\nmatrix.mtx.gz\n\n\n\n\n8. Cell selection with DropletUtils\nIn the last step, we generate a raw gene expression matrix. By using R package DropletUtils, we select “valid’ cell barcodes from this raw matrix and generate a filtered gene expression matrix in the end.\n# load required packages\nrequire(DropletUtils)\nrequire(Yano)\n\n# Read raw MEX file into a sparse matrix\ncounts &lt;- ReadPISA(\"raw_gene_expression/\")\n\n# Read sparse matrix as a SingleCellExperiment object\nsce &lt;- SingleCellExperiment(list('counts' = counts))\n\n# Run barcodeRanks function from DropletUtils, see ref for details\nbr.out &lt;- barcodeRanks(sce)\n\n# Get all barcodes above the inflection point\nfilter_bcs &lt;- rownames(br.out)[br.out$total &gt;metadata(br.out)$inflection]\n\n# the filer matrix\nfilter_counts &lt;- counts[,filter_bcs]\n\n# write file to new folder in 10X format for further use\nwrite10xCounts(\"filtered_gene_expression\", filter_counts)",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "From FASTQ to counts"
    ]
  },
  {
    "objectID": "workflow1.html#useful-resorces",
    "href": "workflow1.html#useful-resorces",
    "title": "From fastq to feature counts with PISA",
    "section": "Useful resorces",
    "text": "Useful resorces\n\nhttps://bioconductor.org/packages/release/bioc/vignettes/DropletUtils/inst/doc/DropletUtils.html\nhttps://support.10xgenomics.com/single-cell-gene-expression/datasets/3.0.0/pbmc_1k_v3",
    "crumbs": [
      "Overview",
      "Workflows & Short cases",
      "From FASTQ to counts"
    ]
  }
]